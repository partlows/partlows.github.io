{"version":3,"file":"InstantReactAbstractDatabase.js","sourceRoot":"","sources":["../../src/InstantReactAbstractDatabase.tsx"],"names":[],"mappings":"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","sourcesContent":["'use client';\nimport {\n  // types\n  Auth,\n  Storage,\n  txInit,\n  type AuthState,\n  type User,\n  type ConnectionStatus,\n  type TransactionChunk,\n  type RoomSchemaShape,\n  type InstaQLOptions,\n  type InstantConfig,\n  type PageInfoResponse,\n  InstantCoreDatabase,\n  init as core_init,\n  InstaQLLifecycleState,\n  InstaQLResponse,\n  RoomsOf,\n  InstantSchemaDef,\n  IInstantDatabase,\n  InstantError,\n  ValidQuery,\n} from '@instantdb/core';\nimport {\n  ReactNode,\n  useCallback,\n  useEffect,\n  useRef,\n  useState,\n  useSyncExternalStore,\n} from 'react';\nimport { useQueryInternal } from './useQuery.ts';\nimport { InstantReactRoom, rooms } from './InstantReactRoom.ts';\n\nconst defaultAuthState = {\n  isLoading: true,\n  user: undefined,\n  error: undefined,\n};\n\nexport default abstract class InstantReactAbstractDatabase<\n  // need to pull this schema out to another generic for query params, not sure why\n  Schema extends InstantSchemaDef<any, any, any>,\n  UseDates extends boolean = false,\n  Config extends InstantConfig<Schema, boolean> = InstantConfig<\n    Schema,\n    UseDates\n  >,\n  Rooms extends RoomSchemaShape = RoomsOf<Schema>,\n> implements IInstantDatabase<Schema>\n{\n  public tx = txInit<Schema>();\n\n  public auth: Auth;\n  public storage: Storage;\n  public core: InstantCoreDatabase<Schema, UseDates>;\n\n  /** @deprecated use `core` instead */\n  public _core: InstantCoreDatabase<Schema, UseDates>;\n\n  static Store?: any;\n  static NetworkListener?: any;\n  static EventSourceImpl?: any;\n\n  constructor(\n    config: Omit<InstantConfig<Schema, UseDates>, 'useDateObjects'> & {\n      useDateObjects?: UseDates;\n    },\n    versions?: { [key: string]: string },\n  ) {\n    this.core = core_init<Schema, UseDates>(\n      config,\n      // @ts-expect-error because TS can't resolve subclass statics\n      config.Store || this.constructor.Store,\n      // @ts-expect-error because TS can't resolve subclass statics\n      this.constructor.NetworkListener,\n      versions,\n      // @ts-expect-error because TS can't resolve subclass statics\n      this.constructor.EventSourceImpl,\n    );\n    this._core = this.core;\n    this.auth = this.core.auth;\n    this.storage = this.core.storage;\n  }\n\n  /**\n   * Returns a unique ID for a given `name`. It's stored in local storage,\n   * so you will get the same ID across sessions.\n   *\n   * This is useful for generating IDs that could identify a local device or user.\n   *\n   * @example\n   *  const deviceId = await db.getLocalId('device');\n   */\n  getLocalId = (name: string): Promise<string> => {\n    return this.core.getLocalId(name);\n  };\n\n  /**\n   * A hook that returns a unique ID for a given `name`. localIds are\n   * stored in local storage, so you will get the same ID across sessions.\n   *\n   * Initially returns `null`, and then loads the localId.\n   *\n   * @example\n   * const deviceId = db.useLocalId('device');\n   * if (!deviceId) return null; // loading\n   * console.log('Device ID:', deviceId)\n   */\n  useLocalId = (name: string): string | null => {\n    const [localId, setLocalId] = useState<string | null>(null);\n\n    useEffect(() => {\n      let mounted = true;\n      const f = async () => {\n        const id = await this.getLocalId(name);\n        if (!mounted) return;\n        setLocalId(id);\n      };\n      f();\n      return;\n    }, [name]);\n\n    return localId;\n  };\n\n  /**\n   * Obtain a handle to a room, which allows you to listen to topics and presence data\n   *\n   * If you don't provide a `type` or `id`, Instant will default to `_defaultRoomType` and `_defaultRoomId`\n   * as the room type and id, respectively.\n   *\n   * @see https://instantdb.com/docs/presence-and-topics\n   *\n   * @example\n   *  const room = db.room('chat', roomId);\n   *  const { peers } = db.rooms.usePresence(room);\n   */\n  room<RoomType extends keyof Rooms>(\n    type: RoomType = '_defaultRoomType' as RoomType,\n    id: string = '_defaultRoomId',\n  ) {\n    return new InstantReactRoom<Schema, Rooms, RoomType>(this.core, type, id);\n  }\n\n  /**\n   * Hooks for working with rooms\n   *\n   * @see https://instantdb.com/docs/presence-and-topics\n   *\n   * @example\n   *  const room = db.room('chat', roomId);\n   *  const { peers } = db.rooms.usePresence(room);\n   *  const publish = db.rooms.usePublishTopic(room, 'emoji');\n   *  // ...\n   */\n  rooms = rooms;\n\n  /**\n   * Use this to write data! You can create, update, delete, and link objects\n   *\n   * @see https://instantdb.com/docs/instaml\n   *\n   * @example\n   *   // Create a new object in the `goals` namespace\n   *   const goalId = id();\n   *   db.transact(db.tx.goals[goalId].update({title: \"Get fit\"}))\n   *\n   *   // Update the title\n   *   db.transact(db.tx.goals[goalId].update({title: \"Get super fit\"}))\n   *\n   *   // Delete it\n   *   db.transact(db.tx.goals[goalId].delete())\n   *\n   *   // Or create an association:\n   *   todoId = id();\n   *   db.transact([\n   *    db.tx.todos[todoId].update({ title: 'Go on a run' }),\n   *    db.tx.goals[goalId].link({todos: todoId}),\n   *  ])\n   */\n  transact = (\n    chunks: TransactionChunk<any, any> | TransactionChunk<any, any>[],\n  ) => {\n    return this.core.transact(chunks);\n  };\n\n  /**\n   * Use this to query your data!\n   *\n   * @see https://instantdb.com/docs/instaql\n   *\n   * @example\n   *   // listen to all goals\n   *   const { isLoading, error, data } = db.useQuery({ goals: {} });\n   *\n   *   // goals where the title is \"Get Fit\"\n   *   const { isLoading, error, data } = db.useQuery({\n   *     goals: { $: { where: { title: 'Get Fit' } } },\n   *   });\n   *\n   *   // all goals, _alongside_ their todos\n   *   const { isLoading, error, data } = db.useQuery({\n   *     goals: { todos: {} },\n   *   });\n   *\n   *   // skip if `user` is not logged in\n   *   const { isLoading, error, data } = db.useQuery(\n   *     auth.user ? { goals: {} } : null,\n   *   );\n   */\n  useQuery = <Q extends ValidQuery<Q, Schema>>(\n    query: null | Q,\n    opts?: InstaQLOptions,\n  ): InstaQLLifecycleState<Schema, Q, UseDates> => {\n    return useQueryInternal<Q, Schema, UseDates>(this.core, query, opts).state;\n  };\n\n  /**\n   * Listen for the logged in state. This is useful\n   * for deciding when to show a login screen.\n   *\n   * Check out the docs for an example `Login` component too!\n   *\n   * @see https://instantdb.com/docs/auth\n   * @example\n   *  function App() {\n   *    const { isLoading, user, error } = db.useAuth()\n   *    if (isLoading) {\n   *      return <div>Loading...</div>\n   *    }\n   *    if (error) {\n   *      return <div>Uh oh! {error.message}</div>\n   *    }\n   *    if (user) {\n   *      return <Main user={user} />\n   *    }\n   *    return <Login />\n   *  }\n   *\n   */\n  useAuth = (): AuthState => {\n    return this._useAuth();\n  };\n\n  protected _useAuth(): AuthState {\n    // We use a ref to store the result of the query.\n    // This is becuase `useSyncExternalStore` uses `Object.is`\n    // to compare the previous and next state.\n    // If we don't use a ref, the state will always be considered different, so\n    // the component will always re-render.\n    const resultCacheRef = useRef<AuthState>(\n      this.core._reactor._currentUserCached,\n    );\n\n    // Similar to `resultCacheRef`, `useSyncExternalStore` will unsubscribe\n    // if `subscribe` changes, so we use `useCallback` to memoize the function.\n    const subscribe = useCallback((cb: Function) => {\n      const unsubscribe = this.core.subscribeAuth((auth) => {\n        resultCacheRef.current = { isLoading: false, ...auth };\n        cb();\n      });\n\n      return unsubscribe;\n    }, []);\n\n    const state = useSyncExternalStore<AuthState>(\n      subscribe,\n      () => resultCacheRef.current,\n      () => defaultAuthState,\n    );\n    return state;\n  }\n\n  /**\n   * Subscribe to the currently logged in user.\n   * If the user is not logged in, this hook with throw an Error.\n   * You will want to protect any calls of this hook with a\n   * <db.SignedIn> component, or your own logic based on db.useAuth()\n   *\n   * @see https://instantdb.com/docs/auth\n   * @throws Error indicating user not signed in\n   * @example\n   *  function UserDisplay() {\n   *    const user = db.useUser()\n   *    return <div>Logged in as: {user.email}</div>\n   *  }\n   *\n   *  <db.SignedIn>\n   *    <UserDisplay />\n   *  </db.SignedIn>\n   *\n   */\n  useUser = (): User => {\n    const { user } = this.useAuth();\n    if (!user) {\n      throw new InstantError(\n        'useUser must be used within an auth-protected route',\n      );\n    }\n    return user;\n  };\n\n  /**\n   * One time query for the logged in state. This is useful\n   * for scenarios where you want to know the current auth\n   * state without subscribing to changes.\n   *\n   * @see https://instantdb.com/docs/auth\n   * @example\n   *   const user = await db.getAuth();\n   *   console.log('logged in as', user.email)\n   */\n  getAuth(): Promise<User | null> {\n    return this.core.getAuth();\n  }\n\n  /**\n   * Listen for connection status changes to Instant. Use this for things like\n   * showing connection state to users\n   *\n   * @see https://www.instantdb.com/docs/patterns#connection-status\n   * @example\n   *  function App() {\n   *    const status = db.useConnectionStatus()\n   *    const connectionState =\n   *      status === 'connecting' || status === 'opened'\n   *        ? 'authenticating'\n   *      : status === 'authenticated'\n   *        ? 'connected'\n   *      : status === 'closed'\n   *        ? 'closed'\n   *      : status === 'errored'\n   *        ? 'errored'\n   *      : 'unexpected state';\n   *\n   *    return <div>Connection state: {connectionState}</div>\n   *  }\n   */\n  useConnectionStatus = (): ConnectionStatus => {\n    const statusRef = useRef<ConnectionStatus>(\n      this.core._reactor.status as ConnectionStatus,\n    );\n\n    const subscribe = useCallback((cb: Function) => {\n      const unsubscribe = this.core.subscribeConnectionStatus((newStatus) => {\n        if (newStatus !== statusRef.current) {\n          statusRef.current = newStatus;\n          cb();\n        }\n      });\n\n      return unsubscribe;\n    }, []);\n\n    const status = useSyncExternalStore<ConnectionStatus>(\n      subscribe,\n      () => statusRef.current,\n      // For SSR, always return 'connecting' as the initial state\n      () => 'connecting',\n    );\n\n    return status;\n  };\n\n  /**\n   * Use this for one-off queries.\n   * Returns local data if available, otherwise fetches from the server.\n   * Because we want to avoid stale data, this method will throw an error\n   * if the user is offline or there is no active connection to the server.\n   *\n   * @see https://instantdb.com/docs/instaql\n   *\n   * @example\n   *\n   *  const resp = await db.queryOnce({ goals: {} });\n   *  console.log(resp.data.goals)\n   */\n  queryOnce = <Q extends ValidQuery<Q, Schema>>(\n    query: Q,\n    opts?: InstaQLOptions,\n  ): Promise<{\n    data: InstaQLResponse<Schema, Q, UseDates>;\n    pageInfo: PageInfoResponse<Q>;\n  }> => {\n    return this.core.queryOnce(query, opts);\n  };\n\n  /**\n   * Only render children if the user is signed in.\n   * @see https://instantdb.com/docs/auth\n   *\n   * @example\n   *  <db.SignedIn>\n   *    <MyComponent />\n   *  </db.SignedIn>\n   *\n   */\n  SignedIn: React.FC<{\n    children: ReactNode;\n  }> = ({ children }) => {\n    const auth = this.useAuth();\n    if (auth.isLoading || auth.error || !auth.user) return null;\n\n    return <>{children}</>;\n  };\n\n  /**\n   * Only render children if the user is signed out.\n   * @see https://instantdb.com/docs/auth\n   *\n   * @example\n   *  <db.SignedOut>\n   *    <MyComponent />\n   *  </db.SignedOut>\n   *\n   */\n  SignedOut: React.FC<{\n    children: ReactNode;\n  }> = ({ children }) => {\n    const auth = this.useAuth();\n    if (auth.isLoading || auth.error || auth.user) return null;\n    return <>{children}</>;\n  };\n}\n"]}