{"version":3,"file":"InstantSuspenseProvider.js","sourceRoot":"","sources":["../../../src/next-ssr/InstantSuspenseProvider.tsx"],"names":[],"mappings":"AAAA,YAAY,CAAC;;AACb,oIAAoI;AAEpI,OAAO,EACL,eAAe,GAQhB,MAAM,iBAAiB,CAAC;AAEzB,OAAO,EACL,6BAA6B,EAC7B,QAAQ,GACT,MAAM,8BAA+B,CAAC;AACvC,OAAO,EAAE,aAAa,EAAE,UAAU,EAAE,MAAM,EAAE,QAAQ,EAAE,MAAM,OAAO,CAAC;AAepE,MAAM,MAAM,GAAG,6BAA6B,EAAO,CAAC;AAOpD,MAAM,CAAC,MAAM,qBAAqB,GAChC,aAAa,CAAmC,IAAI,CAAC,CAAC;AAExD,mCAAmC;AACnC,MAAM,CAAC,MAAM,sBAAsB,GAAG,CAIpC,GAA8C,EAS7C,EAAE;IACH,OAAO,CAAkC,CAAM,EAAE,IAAS,EAAE,EAAE;QAC5D,MAAM,GAAG,GAAG,UAAU,CAAC,qBAAqB,CAAC,CAAC;QAC9C,IAAI,CAAC,GAAG,EAAE,CAAC;YACT,MAAM,IAAI,KAAK,CACb,8DAA8D,CAC/D,CAAC;QACJ,CAAC;QACD,OAAO,GAAG,CAAC,gBAAgB,CAAC,CAAC,EAAE,IAAI,CAAQ,CAAC;IAC9C,CAAC,CAAC;AACJ,CAAC,CAAC;AAMF,MAAM,CAAC,MAAM,uBAAuB,GAAG,CACrC,KAAwC,EACxC,EAAE;IACF,MAAM,SAAS,GAAG,MAAM,CAAyB,IAAI,CAAC,CAAC;IAEvD,IAAI,CAAC,KAAK,CAAC,EAAE,EAAE,CAAC;QACd,MAAM,IAAI,KAAK,CACb,+DAA+D,CAChE,CAAC;IACJ,CAAC;IAED,MAAM,EAAE,GAAG,MAAM,CAAyC,KAAK,CAAC,EAAE,CAAC,CAAC;IAEpE,MAAM,CAAC,WAAW,CAAC,GAAG,QAAQ,CAAC,GAAG,EAAE,CAAC,IAAI,GAAG,EAAU,CAAC,CAAC;IAExD,IAAI,CAAC,SAAS,CAAC,OAAO,EAAE,CAAC;QACvB,IAAI,KAAK,CAAC,IAAI,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,aAAa,EAAE,CAAC;YAC5C,MAAM,IAAI,KAAK,CACb,kDAAkD;gBAChD,IAAI,CAAC,SAAS,CAAC,KAAK,CAAC,IAAI,EAAE,IAAI,EAAE,CAAC,CAAC,CACtC,CAAC;QACJ,CAAC;QACD,SAAS,CAAC,OAAO,GAAG,IAAI,eAAe,CAAC;YACtC,KAAK,EAAE,KAAK,CAAC,IAAI,EAAE,aAAa;YAChC,EAAE,EAAE,EAAE,CAAC,OAAO,CAAC,IAAI;SACpB,CAAC,CAAC;IACL,CAAC;IAED,IAAI,QAAQ,EAAE,CAAC;QACb,SAAS,CAAC,OAAO,CAAC,SAAS,CAAC,CAAC,MAAM,EAAE,EAAE;YACrC,MAAM,EAAE,SAAS,EAAE,GAAG,MAAM,CAAC;YAC7B,WAAW,CAAC,GAAG,CAAC,SAAS,CAAC,CAAC;QAC7B,CAAC,CAAC,CAAC;IACL,CAAC;IAED,MAAM,gBAAgB,GAAG,CAAC,KAAU,EAAE,IAAuB,EAAE,EAAE;QAC/D,MAAM,iBAAiB,GAAG,EAAE,CAAC,OAAO,CAAC,QAAQ,CAAC,KAAK,EAAE;YACnD,GAAG,IAAI;SACR,CAAC,CAAC;QAEH,IAAI,iBAAiB,CAAC,IAAI,EAAE,CAAC;YAC3B,OAAO;gBACL,IAAI,EAAE,iBAAiB,CAAC,IAAI;gBAC5B,QAAQ,EAAE,iBAAiB,CAAC,QAAQ;aACrC,CAAC;QACJ,CAAC;QAED,kCAAkC;QAClC,IAAI,CAAC,SAAS,CAAC,OAAO,EAAE,CAAC;YACvB,MAAM,IAAI,KAAK,CAAC,uBAAuB,CAAC,CAAC;QAC3C,CAAC;QAED,IAAI,KAAK,GAAG,SAAS,CAAC,OAAO,CAAC,yBAAyB,CAAC,KAAK,EAAE;YAC7D,UAAU,EAAE,IAAI,EAAE,UAAU;SAC7B,CAAC,CAAC;QAEH,IAAI,CAAC,KAAK,EAAE,CAAC;YACX,KAAK,GAAG,SAAS,CAAC,OAAQ,CAAC,KAAK,CAAC,KAAK,EAAE,IAAI,CAAC,CAAC;QAChD,CAAC;QAED,IAAI,KAAK,CAAC,MAAM,KAAK,SAAS,EAAE,CAAC;YAC/B,MAAM,KAAK,CAAC,OAAO,CAAC;QACtB,CAAC;QAED,IAAI,KAAK,CAAC,MAAM,KAAK,OAAO,EAAE,CAAC;YAC7B,MAAM,KAAK,CAAC,KAAK,CAAC;QACpB,CAAC;QAED,IAAI,KAAK,CAAC,MAAM,KAAK,SAAS,IAAI,KAAK,CAAC,IAAI,KAAK,SAAS,EAAE,CAAC;YAC3D,OAAO,KAAK,CAAC,IAAI,CAAC;QACpB,CAAC;QAED,IAAI,KAAK,CAAC,MAAM,KAAK,SAAS,EAAE,CAAC;YAC/B,MAAM,IAAI,GAAG,KAAK,CAAC,IAAI,CAAC;YACxB,MAAM,MAAM,GAAG,SAAS,CAAC,OAAO,CAAC,kBAAkB,CACjD,KAAK,EACL,IAAI,CAAC,OAAO,EACZ,IAAI,CAAC,KAAK,EACV,IAAI,CAAC,QAAQ,CACd,CAAC;YAEF,OAAO,MAAM,CAAC;QAChB,CAAC;IACH,CAAC,CAAC;IAEF,OAAO,CACL,KAAC,qBAAqB,CAAC,QAAQ,IAC7B,KAAK,EAAE,EAAE,gBAAgB,EAAE,OAAO,EAAE,KAAK,CAAC,IAAI,EAAE,YAEhD,KAAC,MAAM,CAAC,QAAQ,IACd,KAAK,EAAE,KAAK,CAAC,KAAK,EAClB,OAAO,EAAE,GAAG,EAAE;gBACZ,MAAM,MAAM,GAAuC,EAAE,CAAC;gBACtD,KAAK,MAAM,CAAC,GAAG,EAAE,KAAK,CAAC,IAAI,SAAS,CAAC,OAAQ,CAAC,SAAS,CAAC,OAAO,EAAE,EAAE,CAAC;oBAClE,IAAI,WAAW,CAAC,GAAG,CAAC,GAAG,CAAC,IAAI,KAAK,CAAC,MAAM,KAAK,SAAS,EAAE,CAAC;wBACvD,MAAM,CAAC,IAAI,CAAC;4BACV,QAAQ,EAAE,GAAG;4BACb,KAAK,EAAE,KAAK,CAAC,IAAI;yBAClB,CAAC,CAAC;oBACL,CAAC;gBACH,CAAC;gBAED,WAAW,CAAC,KAAK,EAAE,CAAC;gBACpB,OAAO,MAAM,CAAC;YAChB,CAAC,EACD,SAAS,EAAE,CAAC,OAAO,EAAE,EAAE;gBACrB,OAAO,CAAC,OAAO,CAAC,CAAC,KAAK,EAAE,EAAE;oBACxB,SAAS,CAAC,OAAQ,CAAC,cAAc,CAAC,KAAK,CAAC,QAAQ,EAAE,KAAK,CAAC,KAAK,CAAC,CAAC;gBACjE,CAAC,CAAC,CAAC;YACL,CAAC,YAEA,KAAK,CAAC,QAAQ,GACC,GACa,CAClC,CAAC;AACJ,CAAC,CAAC","sourcesContent":["'use client';\n// InstantSuspenseProvider can only be used in a client context so this prevents errors from trying to use it in a server component.\n\nimport {\n  FrameworkClient,\n  InstantConfig,\n  InstantSchemaDef,\n  InstaQLResponse,\n  PageInfoResponse,\n  RuleParams,\n  User,\n  ValidQuery,\n} from '@instantdb/core';\nimport InstantReactWebDatabase from '../InstantReactWebDatabase.ts';\nimport {\n  createHydrationStreamProvider,\n  isServer,\n} from './HydrationStreamProvider.tsx';\nimport { createContext, useContext, useRef, useState } from 'react';\nimport { InstantReactAbstractDatabase } from '@instantdb/react-common';\n\ntype InstantSuspenseProviderProps<\n  Schema extends InstantSchemaDef<any, any, any>,\n> = {\n  nonce?: string;\n  children: React.ReactNode;\n  db?: InstantReactWebDatabase<Schema, any>;\n  config?: Omit<InstantConfig<any, any>, 'schema'> & {\n    schema: string;\n  };\n  user?: User | null;\n};\n\nconst stream = createHydrationStreamProvider<any>();\n\ntype SuspenseQueryContextValue = {\n  useSuspenseQuery: (query: any, opts?: SuspenseQueryOpts) => any;\n  ssrUser: User | null | undefined;\n};\n\nexport const SuspsenseQueryContext =\n  createContext<SuspenseQueryContextValue | null>(null);\n\n// Creates a typed useSuspense hook\nexport const createUseSuspenseQuery = <\n  Schema extends InstantSchemaDef<any, any, any>,\n  UseDates extends boolean,\n>(\n  _db: InstantReactWebDatabase<Schema, UseDates>,\n): (<Q extends ValidQuery<Q, Schema>>(\n  q: Q,\n  opts?: {\n    ruleParams: RuleParams;\n  },\n) => {\n  data: InstaQLResponse<Schema, Q, NonNullable<UseDates>>;\n  pageInfo?: PageInfoResponse<Q>;\n}) => {\n  return <Q extends ValidQuery<Q, Schema>>(q: any, opts: any) => {\n    const ctx = useContext(SuspsenseQueryContext);\n    if (!ctx) {\n      throw new Error(\n        'useSuspenseQuery must be used within a SuspenseQueryProvider',\n      );\n    }\n    return ctx.useSuspenseQuery(q, opts) as any;\n  };\n};\n\ntype SuspenseQueryOpts = {\n  ruleParams: RuleParams;\n};\n\nexport const InstantSuspenseProvider = (\n  props: InstantSuspenseProviderProps<any>,\n) => {\n  const clientRef = useRef<FrameworkClient | null>(null);\n\n  if (!props.db) {\n    throw new Error(\n      'Must provide either a db or config to InstantSuspenseProvider',\n    );\n  }\n\n  const db = useRef<InstantReactAbstractDatabase<any, any>>(props.db);\n\n  const [trackedKeys] = useState(() => new Set<string>());\n\n  if (!clientRef.current) {\n    if (props.user && !props.user.refresh_token) {\n      throw new Error(\n        'User must have a refresh_token field. Recieved: ' +\n          JSON.stringify(props.user, null, 2),\n      );\n    }\n    clientRef.current = new FrameworkClient({\n      token: props.user?.refresh_token,\n      db: db.current.core,\n    });\n  }\n\n  if (isServer) {\n    clientRef.current.subscribe((result) => {\n      const { queryHash } = result;\n      trackedKeys.add(queryHash);\n    });\n  }\n\n  const useSuspenseQuery = (query: any, opts: SuspenseQueryOpts) => {\n    const nonSuspenseResult = db.current.useQuery(query, {\n      ...opts,\n    });\n\n    if (nonSuspenseResult.data) {\n      return {\n        data: nonSuspenseResult.data,\n        pageInfo: nonSuspenseResult.pageInfo,\n      };\n    }\n\n    // should never happen (typeguard)\n    if (!clientRef.current) {\n      throw new Error('Client ref not set up');\n    }\n\n    let entry = clientRef.current.getExistingResultForQuery(query, {\n      ruleParams: opts?.ruleParams,\n    });\n\n    if (!entry) {\n      entry = clientRef.current!.query(query, opts);\n    }\n\n    if (entry.status === 'pending') {\n      throw entry.promise;\n    }\n\n    if (entry.status === 'error') {\n      throw entry.error;\n    }\n\n    if (entry.status === 'success' && entry.type === 'session') {\n      return entry.data;\n    }\n\n    if (entry.status === 'success') {\n      const data = entry.data;\n      const result = clientRef.current.completeIsomorphic(\n        query,\n        data.triples,\n        data.attrs,\n        data.pageInfo,\n      );\n\n      return result;\n    }\n  };\n\n  return (\n    <SuspsenseQueryContext.Provider\n      value={{ useSuspenseQuery, ssrUser: props.user }}\n    >\n      <stream.Provider\n        nonce={props.nonce}\n        onFlush={() => {\n          const toSend: { queryKey: string; value: any }[] = [];\n          for (const [key, value] of clientRef.current!.resultMap.entries()) {\n            if (trackedKeys.has(key) && value.status === 'success') {\n              toSend.push({\n                queryKey: key,\n                value: value.data,\n              });\n            }\n          }\n\n          trackedKeys.clear();\n          return toSend;\n        }}\n        onEntries={(entries) => {\n          entries.forEach((entry) => {\n            clientRef.current!.addQueryResult(entry.queryKey, entry.value);\n          });\n        }}\n      >\n        {props.children}\n      </stream.Provider>\n    </SuspsenseQueryContext.Provider>\n  );\n};\n"]}