{"version":3,"file":"instaml.js","sourceRoot":"","sources":["../../src/instaml.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n  allMapValues,\n  AttrsStore,\n  AttrsStoreClass,\n  getAttrByFwdIdentName,\n  getAttrByReverseIdentName,\n  Store,\n} from './store.ts';\nimport { getOps, isLookup, parseLookup } from './instatx.ts';\nimport { immutableRemoveUndefined } from './utils/object.js';\nimport { coerceToDate } from './utils/dates.ts';\nimport uuid from './utils/id.ts';\nimport {\n  EntitiesWithLinks,\n  IContainEntitiesAndLinks,\n  LinkDef,\n} from './schemaTypes.ts';\nimport { InstantDBAttr, InstantDBIdent } from './attrTypes.ts';\n\nexport type AttrMapping = {\n  attrIdMap: Record<string, string>;\n  refSwapAttrIds: Set<string>;\n};\n\ntype TXStep = any[];\n\n// Rewrites optimistic attrs with the attrs we get back from the server.\nexport function rewriteStep(attrMapping: AttrMapping, txStep: TXStep): TXStep {\n  const { attrIdMap, refSwapAttrIds } = attrMapping;\n  const rewritten: TXStep = [];\n  for (const part of txStep) {\n    const newValue = attrIdMap[part];\n\n    if (newValue) {\n      // Rewrites attr id\n      rewritten.push(newValue);\n    } else if (Array.isArray(part) && part.length == 2 && attrIdMap[part[0]]) {\n      // Rewrites attr id in lookups\n      const [aid, value] = part;\n      rewritten.push([attrIdMap[aid], value]);\n    } else {\n      rewritten.push(part);\n    }\n  }\n  const [action] = txStep;\n  if (\n    (action === 'add-triple' || action === 'retract-triple') &&\n    refSwapAttrIds.has(txStep[2])\n  ) {\n    // Reverse links if the optimistic link attr is backwards\n    const tmp = rewritten[1];\n    rewritten[1] = rewritten[3];\n    rewritten[3] = tmp;\n  }\n  return rewritten;\n}\n\nfunction explodeLookupRef(eid) {\n  if (Array.isArray(eid)) {\n    return eid;\n  }\n  const entries = Object.entries(eid);\n  if (entries.length !== 1) {\n    throw new Error(\n      'lookup must be an object with a single unique attr and value.',\n    );\n  }\n  return entries[0];\n}\n\nfunction isRefLookupIdent(attrs: AttrsStore, etype: string, identName: string) {\n  return (\n    identName.indexOf('.') !== -1 &&\n    // attr names can have `.` in them, so use the attr we find with a `.`\n    // before assuming it's a ref lookup.\n    !getAttrByFwdIdentName(attrs, etype, identName)\n  );\n}\n\nfunction extractRefLookupFwdName(identName) {\n  const [fwdName, idIdent, ...rest] = identName.split('.');\n  if (rest.length > 0 || idIdent !== 'id') {\n    throw new Error(`${identName} is not a valid lookup attribute.`);\n  }\n\n  return fwdName;\n}\n\nfunction lookupIdentToAttr(\n  attrs: AttrsStore,\n  etype: string,\n  identName: string,\n) {\n  if (!isRefLookupIdent(attrs, etype, identName)) {\n    return getAttrByFwdIdentName(attrs, etype, identName);\n  }\n\n  const fwdName = extractRefLookupFwdName(identName);\n\n  const refAttr =\n    getAttrByFwdIdentName(attrs, etype, fwdName) ||\n    getAttrByReverseIdentName(attrs, etype, fwdName);\n  if (refAttr && refAttr['value-type'] !== 'ref') {\n    throw new Error(`${identName} does not reference a valid link attribute.`);\n  }\n  return refAttr;\n}\n\n// Returns [attr, value] for the eid if the eid is a lookup.\n// If it's a regular eid, returns null\nfunction lookupPairOfEid(eid) {\n  if (typeof eid === 'string' && !isLookup(eid)) {\n    return null;\n  }\n  return typeof eid === 'string' && isLookup(eid)\n    ? parseLookup(eid)\n    : explodeLookupRef(eid);\n}\n\nfunction extractLookup(attrs: AttrsStore, etype: string, eid: string) {\n  const lookupPair = lookupPairOfEid(eid);\n\n  if (lookupPair === null) {\n    return eid;\n  }\n\n  const [identName, value] = lookupPair;\n  const attr = lookupIdentToAttr(attrs, etype, identName);\n  if (!attr || !attr['unique?']) {\n    throw new Error(`${identName} is not a unique attribute.`);\n  }\n  return [attr.id, value];\n}\n\nfunction withIdAttrForLookup(\n  attrs: AttrsStore,\n  etype: string,\n  eidA: string,\n  txSteps: TXStep[],\n) {\n  const lookup = extractLookup(attrs, etype, eidA);\n  if (!Array.isArray(lookup)) {\n    return txSteps;\n  }\n  const idTuple = [\n    'add-triple',\n    lookup,\n    getAttrByFwdIdentName(attrs, etype, 'id')?.id,\n    lookup,\n  ];\n  return [idTuple].concat(txSteps);\n}\n\nfunction expandLink({ attrsStore }: Ctx, [etype, eidA, obj]) {\n  const addTriples = Object.entries(obj).flatMap(([label, eidOrEids]) => {\n    const eids = Array.isArray(eidOrEids) ? eidOrEids : [eidOrEids];\n    const fwdAttr = getAttrByFwdIdentName(attrsStore, etype, label);\n    const revAttr = getAttrByReverseIdentName(attrsStore, etype, label);\n    return eids.map((eidB) => {\n      const txStep = fwdAttr\n        ? [\n            'add-triple',\n            extractLookup(attrsStore, etype, eidA),\n            fwdAttr.id,\n            // Uses `!` because if we get here, we should have created the attr if it doesn't\n            // already exist\n            extractLookup(attrsStore, fwdAttr['reverse-identity']![1], eidB),\n          ]\n        : [\n            'add-triple',\n            // Uses `!` because if we get here, we should have created the attr if it doesn't\n            // already exist\n            extractLookup(attrsStore, revAttr!['forward-identity']![1], eidB),\n            revAttr?.id,\n            extractLookup(attrsStore, etype, eidA),\n          ];\n      return txStep;\n    });\n  });\n  return withIdAttrForLookup(attrsStore, etype, eidA, addTriples);\n}\n\nfunction expandUnlink({ attrsStore }: Ctx, [etype, eidA, obj]) {\n  const retractTriples = Object.entries(obj).flatMap(([label, eidOrEids]) => {\n    const eids = Array.isArray(eidOrEids) ? eidOrEids : [eidOrEids];\n    const fwdAttr = getAttrByFwdIdentName(attrsStore, etype, label);\n    const revAttr = getAttrByReverseIdentName(attrsStore, etype, label);\n    return eids.map((eidB) => {\n      const txStep = fwdAttr\n        ? [\n            'retract-triple',\n            extractLookup(attrsStore, etype, eidA),\n            fwdAttr.id,\n            // Uses `!` because if we get here, we should have created the attr if it doesn't\n            // already exist\n            extractLookup(attrsStore, fwdAttr!['reverse-identity']![1], eidB),\n          ]\n        : [\n            'retract-triple',\n            // Uses `!` because if we get here, we should have created the attr if it doesn't\n            // already exist\n            extractLookup(attrsStore, revAttr!['forward-identity'][1], eidB),\n            revAttr!.id,\n            extractLookup(attrsStore, etype, eidA),\n          ];\n      return txStep;\n    });\n  });\n  return withIdAttrForLookup(attrsStore, etype, eidA, retractTriples);\n}\n\nfunction checkEntityExists(\n  stores: (Store | undefined)[] | undefined,\n  attrsStore: AttrsStore,\n  etype: string,\n  eid: string,\n) {\n  if (Array.isArray(eid)) {\n    // lookup ref\n    const [entity_a, entity_v] = eid;\n    for (const store of stores || []) {\n      const ev = store?.aev.get(entity_a);\n      if (ev) {\n        // This would be a lot more efficient with a ave index\n        for (const [_e, _a, v] of allMapValues(ev, 2)) {\n          if (v === entity_v) {\n            return true;\n          }\n        }\n      }\n    }\n  } else {\n    // eid\n    for (const store of stores || []) {\n      const av = store?.eav.get(eid);\n      if (av) {\n        for (const attr_id of av.keys()) {\n          if (attrsStore.getAttr(attr_id)?.['forward-identity'][1] == etype) {\n            return true;\n          }\n        }\n      }\n    }\n  }\n  return false;\n}\n\ntype Ctx = {\n  stores?: (Store | undefined)[];\n  attrsStore: AttrsStore;\n  schema?: Schema;\n  useDateObjects?: boolean | null;\n};\n\nfunction convertOpts({ stores, attrsStore }: Ctx, [etype, eid, obj_, opts]) {\n  return opts?.upsert === false\n    ? { mode: 'update' }\n    : opts?.upsert === true\n      ? null\n      : checkEntityExists(stores, attrsStore, etype, eid)\n        ? { mode: 'update' }\n        : null; // auto mode chooses between update and upsert, not update and create, just in case\n}\n\nfunction expandCreate(ctx: Ctx, step) {\n  const { attrsStore } = ctx;\n  const [etype, eid, obj_, opts] = step;\n  const obj = immutableRemoveUndefined(obj_);\n  const lookup = extractLookup(attrsStore, etype, eid);\n  // id first so that we don't clobber updates on the lookup field\n  const attrTuples = [['id', lookup]]\n    .concat(Object.entries(obj))\n    .map(([identName, value]: [string, any]) => {\n      // Uses `!` because we should have optimistically created the attr if it doesn't exist\n      const attr = getAttrByFwdIdentName(attrsStore, etype, identName)!;\n\n      if (attr['checked-data-type'] === 'date' && ctx.useDateObjects) {\n        value = coerceToDate(value);\n      }\n\n      return ['add-triple', lookup, attr.id, value, { mode: 'create' }];\n    });\n  return attrTuples;\n}\n\nfunction expandUpdate(ctx: Ctx, step) {\n  const { attrsStore } = ctx;\n  const [etype, eid, obj_, opts] = step;\n  const obj = immutableRemoveUndefined(obj_);\n  const lookup = extractLookup(attrsStore, etype, eid);\n  const serverOpts = convertOpts(ctx, [etype, lookup, obj_, opts]);\n  // id first so that we don't clobber updates on the lookup field\n  const attrTuples = [['id', lookup]]\n    .concat(Object.entries(obj))\n    .map(([identName, value]: [string, any]) => {\n      const attr = getAttrByFwdIdentName(attrsStore, etype, identName)!;\n\n      if (attr['checked-data-type'] === 'date' && ctx.useDateObjects) {\n        value = coerceToDate(value);\n      }\n\n      return [\n        'add-triple',\n        lookup,\n        attr.id,\n        value,\n        ...(serverOpts ? [serverOpts] : []),\n      ];\n    });\n  return attrTuples;\n}\n\nfunction expandDelete({ attrsStore }: Ctx, [etype, eid]) {\n  const lookup = extractLookup(attrsStore, etype, eid);\n  return [['delete-entity', lookup, etype]];\n}\n\nfunction expandDeepMerge(ctx: Ctx, step) {\n  const { attrsStore } = ctx;\n  const [etype, eid, obj_, opts] = step;\n  const obj = immutableRemoveUndefined(obj_);\n  const lookup = extractLookup(attrsStore, etype, eid);\n  const serverOpts = convertOpts(ctx, [etype, lookup, obj_, opts]);\n  const attrTuples = Object.entries(obj).map(([identName, value]) => {\n    const attr = getAttrByFwdIdentName(attrsStore, etype, identName)!;\n    return [\n      'deep-merge-triple',\n      lookup,\n      attr.id,\n      value,\n      ...(serverOpts ? [serverOpts] : []),\n    ];\n  });\n\n  const idTuple = [\n    'add-triple',\n    lookup,\n    getAttrByFwdIdentName(attrsStore, etype, 'id')!.id,\n    lookup,\n    ...(serverOpts ? [serverOpts] : []),\n  ];\n\n  // id first so that we don't clobber updates on the lookup field\n  return [idTuple].concat(attrTuples);\n}\n\nfunction expandRuleParams({ attrsStore }: Ctx, [etype, eid, ruleParams]) {\n  const lookup = extractLookup(attrsStore, etype, eid);\n  return [['rule-params', lookup, etype, ruleParams]];\n}\n\nfunction removeIdFromArgs(step) {\n  const [op, etype, eid, obj, opts] = step;\n  if (!obj) {\n    return step;\n  }\n  const newObj = { ...obj };\n  delete newObj.id;\n  return [op, etype, eid, newObj, ...(opts ? [opts] : [])];\n}\n\nfunction toTxSteps(ctx: Ctx, step) {\n  const [action, ...args] = removeIdFromArgs(step);\n  switch (action) {\n    case 'merge':\n      return expandDeepMerge(ctx, args);\n    case 'create':\n      return expandCreate(ctx, args);\n    case 'update':\n      return expandUpdate(ctx, args);\n    case 'link':\n      return expandLink(ctx, args);\n    case 'unlink':\n      return expandUnlink(ctx, args);\n    case 'delete':\n      return expandDelete(ctx, args);\n    case 'ruleParams':\n      return expandRuleParams(ctx, args);\n    default:\n      throw new Error(`unsupported action ${action}`);\n  }\n}\n\n// ---------\n// transform\n\nfunction checkedDataTypeOfValueType(valueType) {\n  switch (valueType) {\n    case 'string':\n    case 'date':\n    case 'boolean':\n    case 'number':\n      return valueType;\n    default:\n      return undefined;\n  }\n}\n\nfunction objectPropsFromSchema(schema, etype, label) {\n  const attr = schema.entities[etype]?.attrs?.[label];\n  if (label === 'id') return null;\n  if (!attr) {\n    throw new Error(`${etype}.${label} does not exist in your schema`);\n  }\n  const { unique, indexed } = attr?.config;\n  const checkedDataType = checkedDataTypeOfValueType(attr?.valueType);\n\n  return {\n    'index?': indexed,\n    'unique?': unique,\n    'checked-data-type': checkedDataType,\n  };\n}\n\nfunction createObjectAttr(schema, etype, label, props) {\n  const schemaObjectProps = schema\n    ? objectPropsFromSchema(schema, etype, label)\n    : null;\n  const attrId = uuid();\n  const fwdIdentId = uuid();\n  const fwdIdent = [fwdIdentId, etype, label];\n  return {\n    id: attrId,\n    'forward-identity': fwdIdent,\n    'value-type': 'blob',\n    cardinality: 'one',\n    'unique?': false,\n    'index?': false,\n    isUnsynced: true,\n    ...(schemaObjectProps || {}),\n    ...(props || {}),\n  };\n}\n\ntype Link = LinkDef<any, any, any, any, any, any, any>;\ntype Schema = IContainEntitiesAndLinks<any, any>;\n\nfunction findSchemaLink(schema: Schema, etype, label): Link | undefined {\n  const links: Link[] = Object.values(schema.links);\n  const found = links.find((x: Link) => {\n    return (\n      (x.forward.on === etype && x.forward.label === label) ||\n      (x.reverse.on === etype && x.reverse.label === label)\n    );\n  });\n  return found;\n}\n\nfunction refPropsFromSchema(schema: Schema, etype, label) {\n  const found = findSchemaLink(schema, etype, label);\n  if (!found) {\n    throw new Error(`Couldn't find the link ${etype}.${label} in your schema`);\n  }\n  const { forward, reverse } = found;\n  return {\n    'forward-identity': [uuid(), forward.on, forward.label],\n    'reverse-identity': [uuid(), reverse.on, reverse.label],\n    cardinality: forward.has === 'one' ? 'one' : 'many',\n    'unique?': reverse.has === 'one',\n    'on-delete': forward.onDelete,\n    'on-delete-reverse': reverse.onDelete,\n  };\n}\n\nfunction createRefAttr(\n  schema: Schema | undefined,\n  etype: string,\n  label: string,\n  props?: Partial<InstantDBAttr> | undefined,\n): InstantDBAttr {\n  const schemaRefProps = schema\n    ? refPropsFromSchema(schema, etype, label)\n    : null;\n  const attrId = uuid();\n  const fwdIdent: InstantDBIdent = [uuid(), etype, label];\n  const revIdent: InstantDBIdent = [uuid(), label, etype];\n  return {\n    id: attrId,\n    // @ts-ignore: ts thinks it's any[]\n    'forward-identity': fwdIdent,\n    // @ts-ignore: ts thinks it's any[]\n    'reverse-identity': revIdent,\n    'value-type': 'ref',\n    // @ts-ignore: ts thinks it's type string\n    cardinality: 'many',\n    'unique?': false,\n    'index?': false,\n    isUnsynced: true,\n    ...(schemaRefProps || {}),\n    ...(props || {}),\n  };\n}\n\n// Actions that have an object, e.g. not delete\nconst OBJ_ACTIONS = new Set(['create', 'update', 'merge', 'link', 'unlink']);\nconst REF_ACTIONS = new Set(['link', 'unlink']);\nconst UPDATE_ACTIONS = new Set(['create', 'update', 'merge']);\nconst SUPPORTS_LOOKUP_ACTIONS = new Set([\n  'link',\n  'unlink',\n  'create',\n  'update',\n  'merge',\n  'delete',\n  'ruleParams',\n]);\n\nconst lookupProps: Partial<InstantDBAttr> = { 'unique?': true, 'index?': true };\nconst refLookupProps: Partial<InstantDBAttr> = {\n  ...lookupProps,\n  cardinality: 'one',\n};\n\nfunction lookupPairsOfOp(op) {\n  const res: { etype: string; lookupPair: any; linkLabel?: string }[] = [];\n  const [action, etype, eid, obj] = op;\n  if (!SUPPORTS_LOOKUP_ACTIONS.has(action)) {\n    return res;\n  }\n\n  const eidLookupPair = lookupPairOfEid(eid);\n  if (eidLookupPair) {\n    res.push({ etype: etype, lookupPair: eidLookupPair });\n  }\n  if (action === 'link') {\n    for (const [label, eidOrEids] of Object.entries(obj)) {\n      const eids = Array.isArray(eidOrEids) ? eidOrEids : [eidOrEids];\n      for (const linkEid of eids) {\n        const linkEidLookupPair = lookupPairOfEid(linkEid);\n        if (linkEidLookupPair) {\n          res.push({\n            etype: etype,\n            lookupPair: linkEidLookupPair,\n            linkLabel: label,\n          });\n        }\n      }\n    }\n  }\n  return res;\n}\n\nfunction createMissingAttrs(\n  { attrsStore, schema }: Ctx,\n  ops,\n): [AttrsStore, TXStep[]] {\n  const addedIds = new Set();\n  const localAttrs: InstantDBAttr[] = [];\n  const addOps: TXStep[] = [];\n\n  function attrByFwdIdent(etype, label): InstantDBAttr | undefined {\n    return (\n      getAttrByFwdIdentName(attrsStore, etype, label) ||\n      localAttrs.find(\n        (x) =>\n          x['forward-identity'][1] === etype &&\n          x['forward-identity'][2] === label,\n      )\n    );\n  }\n\n  function attrByRevIdent(etype, label): InstantDBAttr | undefined {\n    return (\n      getAttrByReverseIdentName(attrsStore, etype, label) ||\n      localAttrs.find(\n        (x) =>\n          x['reverse-identity']?.[1] === etype &&\n          x['reverse-identity']?.[2] === label,\n      )\n    );\n  }\n\n  function addAttr(attr: InstantDBAttr) {\n    localAttrs.push(attr);\n    addOps.push(['add-attr', attr]);\n    addedIds.add(attr.id);\n  }\n  function addUnsynced(\n    attr:\n      | (InstantDBAttr & { isUnsynced?: boolean })\n      | InstantDBAttr\n      | undefined,\n  ) {\n    if (\n      attr &&\n      'isUnsynced' in attr &&\n      attr.isUnsynced &&\n      !addedIds.has(attr.id)\n    ) {\n      localAttrs.push(attr);\n      addOps.push(['add-attr', attr]);\n      addedIds.add(attr.id);\n    }\n  }\n\n  function isRefLookupIdentLocal(etype: string, identName: string) {\n    return (\n      identName.indexOf('.') !== -1 &&\n      // attr names can have `.` in them, so use the attr we find with a `.`\n      // before assuming it's a ref lookup.\n      !attrByFwdIdent(etype, identName)\n    );\n  }\n\n  // Adds attrs needed for a ref lookup\n  function addForRef(etype, label) {\n    const fwdAttr = attrByFwdIdent(etype, label);\n    const revAttr = attrByRevIdent(etype, label);\n    addUnsynced(fwdAttr);\n    addUnsynced(revAttr);\n    if (!fwdAttr && !revAttr) {\n      addAttr(createRefAttr(schema, etype, label, refLookupProps));\n    }\n  }\n\n  // Create attrs for lookups if we need to\n  // Do these first because otherwise we might add a non-unique attr\n  // before we get to it\n  for (const op of ops) {\n    for (const { etype, lookupPair, linkLabel } of lookupPairsOfOp(op)) {\n      const identName = lookupPair[0];\n      // We got a link eid that's a lookup, linkLabel is the label of the ident,\n      // e.g. `posts` in `link({posts: postIds})`\n      if (linkLabel) {\n        // Add our ref attr, e.g. users.posts\n        addForRef(etype, linkLabel);\n\n        // Figure out the link etype so we can make sure we have the attrs\n        // for the link lookup\n        const fwdAttr = attrByFwdIdent(etype, linkLabel);\n        const revAttr = attrByRevIdent(etype, linkLabel);\n        addUnsynced(fwdAttr);\n        addUnsynced(revAttr);\n        const linkEtype =\n          fwdAttr?.['reverse-identity']?.[1] ||\n          revAttr?.['forward-identity']?.[1] ||\n          linkLabel;\n        if (isRefLookupIdentLocal(linkEtype, identName)) {\n          addForRef(linkEtype, extractRefLookupFwdName(identName));\n        } else {\n          const attr = attrByFwdIdent(linkEtype, identName);\n          if (!attr) {\n            addAttr(\n              createObjectAttr(schema, linkEtype, identName, lookupProps),\n            );\n          }\n          addUnsynced(attr);\n        }\n      } else if (isRefLookupIdentLocal(etype, identName)) {\n        addForRef(etype, extractRefLookupFwdName(identName));\n      } else {\n        const attr = attrByFwdIdent(etype, identName);\n        if (!attr) {\n          addAttr(createObjectAttr(schema, etype, identName, lookupProps));\n        }\n        addUnsynced(attr);\n      }\n    }\n  }\n\n  // Create object and ref attrs\n  for (const op of ops) {\n    const [action, etype, eid, obj] = op;\n    if (OBJ_ACTIONS.has(action)) {\n      const idAttr = attrByFwdIdent(etype, 'id');\n      addUnsynced(idAttr);\n      if (!idAttr) {\n        addAttr(createObjectAttr(schema, etype, 'id', { 'unique?': true }));\n      }\n\n      for (const label of Object.keys(obj)) {\n        const fwdAttr = attrByFwdIdent(etype, label);\n        addUnsynced(fwdAttr);\n        if (UPDATE_ACTIONS.has(action)) {\n          if (!fwdAttr) {\n            addAttr(\n              createObjectAttr(\n                schema,\n                etype,\n                label,\n                label === 'id' ? { 'unique?': true } : null,\n              ),\n            );\n          }\n        }\n        if (REF_ACTIONS.has(action)) {\n          const revAttr = attrByRevIdent(etype, label);\n          if (!fwdAttr && !revAttr) {\n            addAttr(createRefAttr(schema, etype, label));\n          }\n          addUnsynced(revAttr);\n        }\n      }\n    }\n  }\n\n  if (localAttrs.length) {\n    const nextAttrs = { ...attrsStore.attrs };\n    for (const attr of localAttrs) {\n      nextAttrs[attr.id] = attr;\n    }\n    return [new AttrsStoreClass(nextAttrs, attrsStore.linkIndex), addOps];\n  }\n  return [attrsStore, addOps];\n}\n\nexport function transform(ctx: Ctx, inputChunks) {\n  const chunks = Array.isArray(inputChunks) ? inputChunks : [inputChunks];\n  const ops = chunks.flatMap((tx) => getOps(tx));\n  const [newAttrs, addAttrTxSteps] = createMissingAttrs(ctx, ops);\n  const newCtx = { ...ctx, attrsStore: newAttrs };\n  const txSteps = ops.flatMap((op) => toTxSteps(newCtx, op));\n  return [...addAttrTxSteps, ...txSteps];\n}\n"]}