{"version":3,"file":"SyncTable.js","sourceRoot":"","sources":["../../src/SyncTable.ts"],"names":[],"mappings":"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","sourcesContent":["import { PersistedObject } from './utils/PersistedObject.ts';\nimport * as s from './store.ts';\nimport weakHash from './utils/weakHash.ts';\nimport uuid from './utils/id.ts';\nimport { Logger } from './Reactor.js';\nimport instaql, { compareOrder } from './instaql.ts';\nimport { InstaQLResponse, ValidQuery } from './queryTypes.ts';\nimport { EntitiesDef, IContainEntitiesAndLinks } from './schemaTypes.ts';\nimport { StoreInterface } from './index.ts';\n\ntype SubState = {\n  txId?: number;\n  subscriptionId: string;\n  token: string;\n};\n\ntype SubEntity = {\n  entity: any;\n  store: s.Store;\n  serverCreatedAt: number;\n};\n\ntype SubValues = {\n  attrsStore: s.AttrsStore;\n  entities: Array<SubEntity>;\n};\n\ntype Sub = {\n  query: any;\n  hash: string;\n  table: string;\n  orderField: string;\n  orderDirection: 'asc' | 'desc';\n  orderFieldType?: 'string' | 'number' | 'date' | 'boolean' | null;\n  state?: SubState;\n  values?: SubValues;\n  createdAt: number;\n  updatedAt: number;\n};\n\ntype SubEntityInStorage = {\n  entity: any;\n  store: s.StoreJson;\n  serverCreatedAt: number;\n};\n\ntype SubValuesInStorage = {\n  attrsStore: s.AttrsStoreJson;\n  entities: Array<SubEntityInStorage>;\n};\n\n// We could make a better type for this if we had a return type for s.toJSON\ntype SubInStorage = Omit<Sub, 'values'> & {\n  values: SubValuesInStorage;\n};\n\ntype StartMsg = {\n  op: 'start-sync';\n  q: string;\n};\n\ntype EndMsg = {\n  op: 'remove-sync';\n  'subscription-id': string;\n  'keep-subscription': boolean;\n};\n\ntype ResyncMsg = {\n  op: 'resync-table';\n  'subscription-id': string;\n  'tx-id': number;\n  token: string;\n};\n\ntype SendMsg = StartMsg | EndMsg | ResyncMsg;\n\ntype StartSyncOkMsg = {\n  'subscription-id': string;\n  'client-event-id': string;\n  q: string;\n  token: string;\n};\n\ntype Triple = [string, string, any, number];\n\ntype SyncLoadBatchMsg = {\n  'subscription-id': string;\n  'join-rows': Array<Triple[]>;\n};\n\ntype SyncInitFinishMsg = {\n  'subscription-id': string;\n  'tx-id': number;\n};\n\ntype SyncUpdateTriplesMsg = {\n  'subscription-id': string;\n  txes: {\n    'tx-id': number;\n    changes: { action: 'added' | 'removed'; triple: Triple }[];\n  }[];\n};\n\ntype TrySend = (eventId: string, msg: SendMsg) => void;\n\ntype Config = { useDateObjects: boolean };\n\n// Modifies the data in place because it comes directly from storage\nfunction syncSubFromStorage(sub: SubInStorage, useDateObjects: boolean): Sub {\n  const values = sub.values;\n  if (values) {\n    const attrsStore = s.attrsStoreFromJSON(values.attrsStore, null);\n    if (attrsStore) {\n      for (const e of values.entities || []) {\n        e.store.useDateObjects = useDateObjects;\n        (e as unknown as SubEntity).store = s.fromJSON(attrsStore, e.store);\n      }\n      (values as unknown as SubValues).attrsStore = attrsStore;\n    }\n  }\n\n  return sub as unknown as Sub;\n}\n\nfunction syncSubToStorage(_k: string, sub: Sub): SubInStorage {\n  if (sub.values) {\n    const entities: SubEntityInStorage[] = [];\n    for (const e of sub.values?.entities) {\n      const store = s.toJSON(e.store);\n      entities.push({ ...e, store });\n    }\n    return {\n      ...sub,\n      values: { attrsStore: sub.values.attrsStore.toJSON(), entities },\n    };\n  } else {\n    return sub as unknown as SubInStorage;\n  }\n}\n\nfunction onMergeSub(\n  _key: string,\n  storageSub: Sub,\n  inMemorySub: Sub | null,\n): Sub {\n  const storageTxId = storageSub?.state?.txId;\n  const memoryTxId = inMemorySub?.state?.txId;\n\n  if (storageTxId && (!memoryTxId || storageTxId > memoryTxId)) {\n    return storageSub;\n  }\n\n  if (memoryTxId && (!storageTxId || memoryTxId > storageTxId)) {\n    return inMemorySub;\n  }\n\n  return storageSub || inMemorySub;\n}\n\nfunction queryEntity(sub: Sub, store: s.Store, attrsStore: s.AttrsStore) {\n  const res = instaql(\n    { store, attrsStore, pageInfo: null, aggregate: null },\n    sub.query,\n  );\n  return res.data[sub.table][0];\n}\n\nfunction getServerCreatedAt(\n  sub: Sub,\n  store: s.Store,\n  attrsStore: s.AttrsStore,\n  entityId: string,\n): number {\n  const aid = s.getAttrByFwdIdentName(attrsStore, sub.table, 'id')?.id;\n  if (!aid) {\n    return -1;\n  }\n  const t = s.getInMap(store.eav, [entityId, aid, entityId]);\n  if (!t) {\n    return -1;\n  }\n  return t[3];\n}\n\nfunction applyChangesToStore(\n  store: s.Store,\n  attrsStore: s.AttrsStore,\n  changes: SyncUpdateTriplesMsg['txes'][number]['changes'],\n): void {\n  for (const { action, triple } of changes) {\n    switch (action) {\n      case 'added':\n        s.addTriple(store, attrsStore, triple);\n        break;\n      case 'removed':\n        s.retractTriple(store, attrsStore, triple);\n        break;\n    }\n  }\n}\n\ntype ChangedFieldsOfChanges = {\n  [eid: string]: { [field: string]: { oldValue: unknown; newValue: unknown } };\n};\n\nfunction changedFieldsOfChanges(\n  store: s.Store,\n  attrsStore: s.AttrsStore,\n  changes: SyncUpdateTriplesMsg['txes'][number]['changes'],\n): ChangedFieldsOfChanges {\n  // This will be more complicated when we include links, we can either add a\n  // changedLinks field or we can have something like 'bookshelves.title`\n  const changedFields: ChangedFieldsOfChanges = {};\n  for (const { action, triple } of changes) {\n    const [e, a, v] = triple;\n    const field = attrsStore.getAttr(a)?.['forward-identity']?.[2];\n    if (!field) continue;\n\n    const fields = changedFields[e] ?? {};\n    changedFields[e] = fields;\n\n    const oldNew = fields[field] ?? {};\n\n    switch (action) {\n      case 'added':\n        oldNew.newValue = v;\n        break;\n      case 'removed':\n        // Only take the first thing that was removed, in case we modified things in the middle\n        if (oldNew.oldValue === undefined) {\n          oldNew.oldValue = v;\n        }\n        break;\n    }\n\n    fields[field] = oldNew;\n  }\n\n  for (const [_eid, fields] of Object.entries(changedFields)) {\n    for (const [k, { oldValue, newValue }] of Object.entries(fields)) {\n      if (oldValue === newValue) {\n        delete fields[k];\n      }\n    }\n  }\n  return changedFields;\n}\n\nfunction subData(sub: Sub, entities: NonNullable<Sub['values']>['entities']) {\n  return { [sub.table]: entities.map((e) => e.entity) };\n}\n\ntype CreateStore = (triples: Triple[]) => s.Store;\n\n// Updates the sub order field type if it hasn't been set\n// and returns the type. We have to wait until the attrs\n// are loaded before we can determine the type.\nfunction orderFieldTypeMutative(sub: Sub, getAttrs: () => s.AttrsStore) {\n  if (sub.orderFieldType) {\n    return sub.orderFieldType;\n  }\n  const orderFieldType =\n    sub.orderField === 'serverCreatedAt'\n      ? 'number'\n      : s.getAttrByFwdIdentName(getAttrs(), sub.table, sub.orderField)?.[\n          'checked-data-type'\n        ];\n\n  sub.orderFieldType = orderFieldType;\n  return orderFieldType;\n}\n\nfunction sortEntitiesInPlace(\n  sub: Sub,\n  orderFieldType: NonNullable<Sub['orderFieldType']>,\n  entities: NonNullable<Sub['values']>['entities'],\n) {\n  const dataType = orderFieldType;\n  if (sub.orderField === 'serverCreatedAt') {\n    entities.sort(\n      sub.orderDirection === 'asc'\n        ? function compareEntities(a, b) {\n            return compareOrder(\n              a.entity.id,\n              a.serverCreatedAt,\n              b.entity.id,\n              b.serverCreatedAt,\n              dataType,\n            );\n          }\n        : function compareEntities(b, a) {\n            return compareOrder(\n              a.entity.id,\n              a.serverCreatedAt,\n              b.entity.id,\n              b.serverCreatedAt,\n              dataType,\n            );\n          },\n    );\n    return;\n  }\n\n  const field = sub.orderField;\n\n  entities.sort(\n    sub.orderDirection === 'asc'\n      ? function compareEntities(a, b) {\n          return compareOrder(\n            a.entity.id,\n            a.entity[field],\n            b.entity.id,\n            b.entity[field],\n            dataType,\n          );\n        }\n      : function compareEntities(b, a) {\n          return compareOrder(\n            a.entity.id,\n            a.entity[field],\n            b.entity.id,\n            b.entity[field],\n            dataType,\n          );\n        },\n  );\n}\n\nexport enum CallbackEventType {\n  InitialSyncBatch = 'InitialSyncBatch',\n  InitialSyncComplete = 'InitialSyncComplete',\n  LoadFromStorage = 'LoadFromStorage',\n  SyncTransaction = 'SyncTransaction',\n  Error = 'Error',\n}\n\ntype QueryEntities<\n  Schema extends IContainEntitiesAndLinks<EntitiesDef, any>,\n  Q extends ValidQuery<Q, Schema>,\n  UseDates extends boolean,\n> = InstaQLResponse<Schema, Q, UseDates>[keyof InstaQLResponse<\n  Schema,\n  Q,\n  UseDates\n>];\n\ntype QueryEntity<\n  Schema extends IContainEntitiesAndLinks<EntitiesDef, any>,\n  Q extends ValidQuery<Q, Schema>,\n  UseDates extends boolean,\n> = QueryEntities<Schema, Q, UseDates> extends (infer E)[] ? E : never;\n\ntype ChangedFields<Entity> = {\n  [K in keyof Entity]?: {\n    oldValue: Entity[K];\n    newValue: Entity[K];\n  };\n};\n\nexport interface BaseCallbackEvent<\n  Schema extends IContainEntitiesAndLinks<EntitiesDef, any>,\n  Q extends ValidQuery<Q, Schema>,\n  UseDates extends boolean,\n> {\n  type: CallbackEventType;\n  data: InstaQLResponse<Schema, Q, UseDates>;\n}\n\nexport interface InitialSyncBatch<\n  Schema extends IContainEntitiesAndLinks<EntitiesDef, any>,\n  Q extends ValidQuery<Q, Schema>,\n  UseDates extends boolean,\n> extends BaseCallbackEvent<Schema, Q, UseDates> {\n  type: CallbackEventType.InitialSyncBatch;\n  batch: QueryEntities<Schema, Q, UseDates>;\n}\n\nexport interface InitialSyncComplete<\n  Schema extends IContainEntitiesAndLinks<EntitiesDef, any>,\n  Q extends ValidQuery<Q, Schema>,\n  UseDates extends boolean,\n> extends BaseCallbackEvent<Schema, Q, UseDates> {\n  type: CallbackEventType.InitialSyncComplete;\n}\n\nexport interface SyncTransaction<\n  Schema extends IContainEntitiesAndLinks<EntitiesDef, any>,\n  Q extends ValidQuery<Q, Schema>,\n  UseDates extends boolean,\n> extends BaseCallbackEvent<Schema, Q, UseDates> {\n  type: CallbackEventType.SyncTransaction;\n  added: QueryEntities<Schema, Q, UseDates>;\n  removed: QueryEntities<Schema, Q, UseDates>;\n  updated: {\n    oldEntity: QueryEntity<Schema, Q, UseDates>;\n    newEntity: QueryEntity<Schema, Q, UseDates>;\n    changedFields: ChangedFields<QueryEntity<Schema, Q, UseDates>>;\n  }[];\n}\n\nexport interface LoadFromStorage<\n  Schema extends IContainEntitiesAndLinks<EntitiesDef, any>,\n  Q extends ValidQuery<Q, Schema>,\n  UseDates extends boolean,\n> extends BaseCallbackEvent<Schema, Q, UseDates> {\n  type: CallbackEventType.LoadFromStorage;\n}\n\nexport interface SetupError<\n  Schema extends IContainEntitiesAndLinks<EntitiesDef, any>,\n  Q extends ValidQuery<Q, Schema>,\n  UseDates extends boolean,\n> extends BaseCallbackEvent<Schema, Q, UseDates> {\n  type: CallbackEventType.Error;\n  error: { message: string; hint?: any; type: string; status: number };\n}\n\nexport type CallbackEvent<\n  Schema extends IContainEntitiesAndLinks<EntitiesDef, any>,\n  Q extends ValidQuery<Q, Schema>,\n  UseDates extends boolean,\n> =\n  | InitialSyncBatch<Schema, Q, UseDates>\n  | InitialSyncComplete<Schema, Q, UseDates>\n  | SyncTransaction<Schema, Q, UseDates>\n  | LoadFromStorage<Schema, Q, UseDates>\n  | SetupError<Schema, Q, UseDates>;\n\nexport type SyncTableCallback<\n  Schema extends IContainEntitiesAndLinks<EntitiesDef, any>,\n  Q extends ValidQuery<Q, Schema>,\n  UseDates extends boolean,\n> = (event: CallbackEvent<Schema, Q, UseDates>) => void;\n\nexport class SyncTable {\n  private trySend: TrySend;\n  private subs: PersistedObject<string, Sub, SubInStorage>;\n  // Using any for the SyncCallback because we'd need Reactor to be typed\n  private callbacks: { [hash: string]: SyncTableCallback<any, any, any>[] } =\n    {};\n  private config: Config;\n  private idToHash: { [subscriptionId: string]: string } = {};\n  private log: Logger;\n  private createStore: CreateStore;\n  private getAttrs: () => s.AttrsStore;\n\n  constructor(\n    trySend: TrySend,\n    storage: StoreInterface,\n    config: Config,\n    log: Logger,\n    createStore: CreateStore,\n    getAttrs: () => s.AttrsStore,\n  ) {\n    this.trySend = trySend;\n    this.config = config;\n    this.log = log;\n    this.createStore = createStore;\n    this.getAttrs = getAttrs;\n\n    this.subs = new PersistedObject<string, Sub, SubInStorage>({\n      persister: storage,\n      merge: onMergeSub,\n      serialize: syncSubToStorage,\n      parse: (_key, x) => syncSubFromStorage(x, this.config.useDateObjects),\n      objectSize: (sub) => sub.values?.entities.length || 0,\n      logger: log,\n      gc: {\n        maxAgeMs: 1000 * 60 * 60 * 24 * 7 * 52, // 1 year\n        maxEntries: 1000,\n        // Size of each sub is the number of entity\n        maxSize: 1_000_000, // 1 million entities\n      },\n    });\n  }\n\n  public beforeUnload() {\n    this.subs.flush();\n  }\n\n  public subscribe(\n    q: any,\n    cb: SyncTableCallback<any, any, any>,\n  ): (\n    opts?: { keepSubscription?: boolean | null | undefined } | null | undefined,\n  ) => void {\n    const hash = weakHash(q);\n    this.callbacks[hash] = this.callbacks[hash] || [];\n    this.callbacks[hash].push(cb);\n\n    this.initSubscription(q, hash, cb);\n\n    return (opts?: { keepSubscription?: boolean | null | undefined }) => {\n      this.unsubscribe(hash, cb, opts?.keepSubscription);\n    };\n  }\n\n  private unsubscribe(\n    hash: string,\n    cb: SyncTableCallback<any, any, any>,\n    keepSubscription: boolean | null | undefined,\n  ) {\n    const cbs = (this.callbacks[hash] || []).filter((x) => x !== cb);\n    this.callbacks[hash] = cbs;\n\n    if (!cbs.length) {\n      delete this.callbacks[hash];\n      const sub = this.subs.currentValue[hash];\n      if (sub?.state) {\n        this.clearSubscriptionData(\n          sub.state.subscriptionId,\n          !!keepSubscription,\n        );\n      }\n      if (!keepSubscription) {\n        this.subs.updateInPlace((prev) => {\n          delete prev[hash];\n        });\n      }\n    }\n  }\n\n  private sendStart(query: string) {\n    this.trySend(uuid(), {\n      op: 'start-sync',\n      q: query,\n    });\n  }\n\n  private sendResync(sub: Sub, state: SubState, txId: number) {\n    // Make sure we can find the hash from the subscriptionId\n    this.idToHash[state.subscriptionId] = sub.hash;\n    this.trySend(state.subscriptionId, {\n      op: 'resync-table',\n      'subscription-id': state.subscriptionId,\n      'tx-id': txId,\n      token: state.token,\n    });\n  }\n\n  private sendRemove(state: SubState, keepSubscription: boolean) {\n    this.trySend(uuid(), {\n      op: 'remove-sync',\n      'subscription-id': state.subscriptionId,\n      'keep-subscription': keepSubscription,\n    });\n  }\n\n  private async initSubscription(\n    query: any,\n    hash: string,\n    cb?: SyncTableCallback<any, any, any>,\n  ) {\n    // Wait for storage to load so that we know if we already have an existing subscription\n    await this.subs.waitForKeyToLoad(hash);\n    const existingSub = this.subs.currentValue[hash];\n\n    if (existingSub && existingSub.state && existingSub.state.txId) {\n      this.sendResync(existingSub, existingSub.state, existingSub.state.txId);\n\n      if (existingSub.values?.entities && cb) {\n        cb({\n          type: CallbackEventType.LoadFromStorage,\n          data: subData(existingSub, existingSub.values?.entities),\n        });\n      }\n\n      return;\n    }\n\n    const table = Object.keys(query)[0];\n    const orderBy = query[table]?.$?.order || { serverCreatedAt: 'asc' };\n    const [orderField, orderDirection] = Object.entries(orderBy)[0] as [\n      string,\n      'asc' | 'desc',\n    ];\n\n    this.subs.updateInPlace((prev) => {\n      prev[hash] = {\n        query,\n        hash: hash,\n        table,\n        orderDirection,\n        orderField,\n        createdAt: Date.now(),\n        updatedAt: Date.now(),\n      };\n    });\n\n    this.sendStart(query);\n  }\n\n  public async flushPending() {\n    for (const hash of Object.keys(this.callbacks)) {\n      await this.subs.waitForKeyToLoad(hash);\n      const sub = this.subs.currentValue[hash];\n      if (sub) {\n        await this.initSubscription(sub.query, sub.hash);\n      } else {\n        this.log.error('Missing sub for hash in flushPending', hash);\n      }\n    }\n  }\n\n  public onStartSyncOk(msg: StartSyncOkMsg) {\n    const subscriptionId = msg['subscription-id'];\n    const q = msg.q;\n    const hash = weakHash(q);\n\n    this.idToHash[subscriptionId] = hash;\n\n    this.subs.updateInPlace((prev) => {\n      const sub = prev[hash];\n      if (!sub) {\n        this.log.error(\n          'Missing sub for hash',\n          hash,\n          'subscription-id',\n          subscriptionId,\n          'query',\n          q,\n        );\n        return prev;\n      }\n\n      sub.state = {\n        subscriptionId: subscriptionId,\n        token: msg.token,\n      };\n    });\n  }\n\n  private notifyCbs(hash: string, event: CallbackEvent<any, any, any>) {\n    for (const cb of this.callbacks[hash] || []) {\n      cb(event);\n    }\n  }\n\n  public onSyncLoadBatch(msg: SyncLoadBatchMsg) {\n    const subscriptionId = msg['subscription-id'];\n    const joinRows = msg['join-rows'];\n    const hash = this.idToHash[subscriptionId];\n    if (!hash) {\n      this.log.error('Missing hash for subscription', msg);\n      return;\n    }\n\n    const batch: any[] = [];\n    const sub = this.subs.currentValue[hash];\n    if (!sub) {\n      this.log.error('Missing sub for hash', hash, msg);\n      return;\n    }\n\n    const values: SubValues = sub.values ?? {\n      entities: [],\n      attrsStore: this.getAttrs(),\n    };\n    sub.values = values;\n    const entities = values.entities;\n\n    for (const entRows of joinRows) {\n      const store = this.createStore(entRows);\n      const entity = queryEntity(sub, store, values.attrsStore);\n      entities.push({\n        store,\n        entity,\n        serverCreatedAt: getServerCreatedAt(\n          sub,\n          store,\n          values.attrsStore,\n          entity.id,\n        ),\n      });\n      batch.push(entity);\n    }\n\n    this.subs.updateInPlace((prev) => {\n      prev[hash] = sub;\n      // Make sure we write a field or mutative won't\n      // see the change because sub === prev[hash]\n      prev[hash].updatedAt = Date.now();\n    });\n\n    if (sub.values) {\n      this.notifyCbs(hash, {\n        type: CallbackEventType.InitialSyncBatch,\n        data: subData(sub, sub.values.entities),\n        batch,\n      });\n    }\n  }\n\n  public onSyncInitFinish(msg: SyncInitFinishMsg) {\n    const subscriptionId = msg['subscription-id'];\n    const hash = this.idToHash[subscriptionId];\n    if (!hash) {\n      this.log.error('Missing hash for subscription', msg);\n      return;\n    }\n    this.subs.updateInPlace((prev) => {\n      const sub = prev[hash];\n      if (!sub) {\n        this.log.error('Missing sub for hash', hash, msg);\n        return;\n      }\n      const state = sub.state;\n      if (!state) {\n        this.log.error('Sub never set init, missing result', sub, msg);\n        return prev;\n      }\n      state.txId = msg['tx-id'];\n      sub.updatedAt = Date.now();\n    });\n\n    const sub = this.subs.currentValue[hash];\n\n    if (sub) {\n      this.notifyCbs(hash, {\n        type: CallbackEventType.InitialSyncComplete,\n        data: subData(sub, sub.values?.entities || []),\n      });\n    }\n  }\n\n  public onSyncUpdateTriples(msg: SyncUpdateTriplesMsg) {\n    const subscriptionId = msg['subscription-id'];\n    const hash = this.idToHash[subscriptionId];\n    if (!hash) {\n      this.log.error('Missing hash for subscription', msg);\n      return;\n    }\n\n    const sub = this.subs.currentValue[hash];\n    if (!sub) {\n      this.log.error('Missing sub for hash', hash, msg);\n      return;\n    }\n\n    const state = sub.state;\n    if (!state) {\n      this.log.error('Missing state for sub', sub, msg);\n      return;\n    }\n\n    for (const tx of msg.txes) {\n      if (state.txId && state.txId >= tx['tx-id']) {\n        continue;\n      }\n      state.txId = tx['tx-id'];\n      const idxesToDelete: number[] = [];\n      // Note: this won't work as well when links are involved\n      const byEid: {\n        [eid: string]: SyncUpdateTriplesMsg['txes'][number]['changes'];\n      } = {};\n      for (const change of tx.changes) {\n        const eidChanges = byEid[change.triple[0]] ?? [];\n        byEid[change.triple[0]] = eidChanges;\n        eidChanges.push(change);\n      }\n\n      const values: SubValues = sub.values ?? {\n        entities: [],\n        attrsStore: this.getAttrs(),\n      };\n      const entities = values.entities;\n      sub.values = values;\n\n      const updated: SyncTransaction<any, any, any>['updated'] = [];\n      // Update the existing stores, if we already know about this entity\n      eidLoop: for (const [eid, changes] of Object.entries(byEid)) {\n        for (let i = 0; i < entities.length; i++) {\n          const ent = entities[i];\n          if (s.hasEntity(ent.store, eid)) {\n            applyChangesToStore(ent.store, values.attrsStore, changes);\n            const entity = queryEntity(sub, ent.store, values.attrsStore);\n            const changedFields = changedFieldsOfChanges(\n              ent.store,\n              values.attrsStore,\n              changes,\n            )[eid];\n            if (entity) {\n              updated.push({\n                oldEntity: ent.entity,\n                newEntity: entity,\n                changedFields: (changedFields || {}) as SyncTransaction<\n                  any,\n                  any,\n                  any\n                >['updated'][number]['changedFields'],\n              });\n              ent.entity = entity;\n            } else {\n              idxesToDelete.push(i);\n            }\n            delete byEid[eid];\n            continue eidLoop;\n          }\n        }\n      }\n\n      const added: any[] = [];\n      // If we have anything left in byEid, then this must be a new entity we don't know about\n      for (const [_eid, changes] of Object.entries(byEid)) {\n        const store = this.createStore([]);\n        applyChangesToStore(store, values.attrsStore, changes);\n        const entity = queryEntity(sub, store, values.attrsStore);\n        if (!entity) {\n          this.log.error('No entity found after applying change', {\n            sub,\n            changes,\n            store,\n          });\n          continue;\n        }\n        entities.push({\n          store,\n          entity,\n          serverCreatedAt: getServerCreatedAt(\n            sub,\n            store,\n            values.attrsStore,\n            entity.id,\n          ),\n        });\n        added.push(entity);\n      }\n\n      const removed: any[] = [];\n\n      for (const idx of idxesToDelete.sort().reverse()) {\n        removed.push(entities[idx].entity);\n        entities.splice(idx, 1);\n      }\n\n      const orderFieldType = orderFieldTypeMutative(sub, this.getAttrs);\n\n      sortEntitiesInPlace(sub, orderFieldType!, entities);\n      this.notifyCbs(hash, {\n        type: CallbackEventType.SyncTransaction,\n        data: subData(sub, sub.values?.entities),\n        added,\n        removed,\n        updated,\n      });\n    }\n    this.subs.updateInPlace((prev) => {\n      prev[hash] = sub;\n      // Make sure we write a field or mutative won't\n      // see the change because sub === prev[hash]\n      prev[hash].updatedAt = Date.now();\n    });\n  }\n\n  private clearSubscriptionData(\n    subscriptionId: string,\n    keepSubscription: boolean,\n  ) {\n    const hash = this.idToHash[subscriptionId];\n    if (hash) {\n      delete this.idToHash[subscriptionId];\n      const sub = this.subs.currentValue[hash];\n      if (sub.state) {\n        this.sendRemove(sub.state, keepSubscription);\n      }\n      if (keepSubscription) {\n        this.subs.unloadKey(hash);\n      } else {\n        this.subs.updateInPlace((prev) => {\n          delete prev[hash];\n        });\n      }\n      if (sub) {\n        return sub;\n      }\n    }\n  }\n\n  public onStartSyncError(msg: {\n    op: 'error';\n    'original-event': StartMsg;\n    'client-event-id': string;\n    status: number;\n    type: string;\n    message?: string;\n    hint?: any;\n  }) {\n    const hash = weakHash(msg['original-event']['q']);\n    const error = {\n      message: msg.message || 'Uh-oh, something went wrong. Ping Joe & Stopa.',\n      status: msg.status,\n      type: msg.type,\n      hint: msg.hint,\n    };\n\n    const k = Object.keys(msg['original-event']['q'])[0];\n    this.notifyCbs(hash, {\n      type: CallbackEventType.Error,\n      data: { [k]: [] },\n      error,\n    });\n  }\n\n  public onResyncError(msg: {\n    op: 'error';\n    'original-event': ResyncMsg;\n    status: number;\n    type: string;\n  }) {\n    // Clear the subscription and start from scrath on any resync error\n    // This can happen if the auth changed and we need to refetch with the\n    // new auth or if the subscription is too far behind.\n    const subscriptionId = msg['original-event']['subscription-id'];\n    const removedSub = this.clearSubscriptionData(subscriptionId, false);\n    if (removedSub) {\n      this.initSubscription(removedSub.query, removedSub.hash);\n    }\n  }\n}\n"]}