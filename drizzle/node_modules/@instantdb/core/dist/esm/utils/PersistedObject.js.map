{"version":3,"file":"PersistedObject.js","sourceRoot":"","sources":["../../../src/utils/PersistedObject.ts"],"names":[],"mappings":"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","sourcesContent":["// PersistedObjects save data outside of memory.\n//\n// When we load a persisted object, it's possible we call `set`\n// before we finish loading. To address we handle set in two ways:\n//\n// 1. Before load\n// We simply update currentValue in memory\n//\n// 2. After load\n// We update currentValue in memory and in storage\n//\n// Each PersistedObject provides it's own `onMerge`\n// function to handle the merge of data from storage and memory\n// on load\n\n// Uses `requestIdleCallback` if available, otherwise calls the\n// callback immediately\n\nimport { create } from 'mutative';\nimport type { Logger } from './log.ts';\n\nfunction safeIdleCallback(cb, timeout: number) {\n  if (typeof requestIdleCallback === 'undefined') {\n    cb();\n  } else {\n    requestIdleCallback(cb, { timeout });\n  }\n}\n\nexport const META_KEY = '__meta';\n\nexport type ObjectMeta = { createdAt: number; updatedAt: number; size: number };\n\nexport type Meta<K extends string> = {\n  objects: Record<K, ObjectMeta>;\n};\n\nexport type StoreInterfaceStoreName = 'kv' | 'querySubs' | 'syncSubs';\n\nexport abstract class StoreInterface {\n  constructor(appId: string, storeName: StoreInterfaceStoreName) {}\n  abstract getItem(key: string): Promise<any>;\n  abstract removeItem(key: string): Promise<void>;\n  abstract multiSet(keyValuePairs: Array<[string, any]>): Promise<void>;\n  abstract getAllKeys(): Promise<string[]>;\n}\n\nexport type StoreInterfaceClass = new (\n  appId: string,\n  storeName: StoreInterfaceStoreName,\n) => StoreInterface;\n\nexport type GCOpts = {\n  maxSize: number;\n  maxAgeMs: number;\n  maxEntries: number;\n};\n\nexport type Opts<K, T, SerializedT> = {\n  persister: StoreInterface;\n  /**\n   * Merges data from storage with in-memory value on load.\n   * The value returned from merge will become the current value.\n   */\n  merge: (\n    key: K,\n    fromStorage: T | null | undefined,\n    inMemoryValue: T | null | undefined,\n  ) => T;\n  serialize: (key: K, input: T) => SerializedT;\n  parse: (key: K, value: SerializedT) => T;\n  objectSize: (x: SerializedT) => number;\n  logger: Logger;\n  gc: GCOpts | null | undefined;\n  saveThrottleMs?: number | null | undefined;\n  idleCallbackMaxWaitMs?: number | null | undefined;\n  preloadEntryCount?: number | null | undefined;\n};\n\nexport class PersistedObject<K extends string, T, SerializedT> {\n  currentValue: Record<K, T>;\n  private _subs: ((value: Record<K, T>) => void)[] = [];\n  private _persister: StoreInterface;\n  private _merge: (key: K, fromStorage: T, inMemoryValue: T) => T;\n  private serialize: (key: K, input: T) => SerializedT;\n  private parse: (key: K, value: SerializedT) => T;\n  private _saveThrottleMs: number;\n  private _idleCallbackMaxWaitMs: number;\n  private _nextSave: null | NodeJS.Timeout = null;\n  private _nextGc: null | NodeJS.Timeout = null;\n  private _pendingSaveKeys: Set<K> = new Set();\n  private _loadedKeys: Set<K> = new Set();\n  private _loadingKeys: Record<K, Promise<T>>;\n  private _objectSize: (serializedObject: SerializedT) => number;\n  private _log: Logger;\n\n  onKeyLoaded: (key: string) => void | null | undefined;\n  private _version = 0;\n  private _meta: {\n    isLoading: boolean;\n    onLoadCbs: Array<() => void>;\n    value: null | Meta<K>;\n    error: null | Error;\n    attempts: number;\n    loadingPromise?: Promise<Meta<K>> | null | undefined;\n  } = {\n    isLoading: true,\n    onLoadCbs: [],\n    value: null,\n    error: null,\n    attempts: 0,\n  };\n  private _gcOpts: GCOpts | null | undefined;\n\n  constructor(opts: Opts<K, T, SerializedT>) {\n    this._persister = opts.persister;\n    this._merge = opts.merge;\n    this.serialize = opts.serialize;\n    this.parse = opts.parse;\n    this._objectSize = opts.objectSize;\n    this._log = opts.logger;\n    this._saveThrottleMs = opts.saveThrottleMs ?? 100;\n    this._idleCallbackMaxWaitMs = opts.idleCallbackMaxWaitMs ?? 1000;\n    this._gcOpts = opts.gc;\n    this.currentValue = {} as Record<K, T>;\n    this._loadedKeys = new Set();\n    this._loadingKeys = {} as Record<K, Promise<T>>;\n    this._initMeta();\n    if (opts.preloadEntryCount) {\n      this._preloadEntries(opts.preloadEntryCount);\n    }\n  }\n\n  private async _initMeta() {\n    if (this._meta.loadingPromise) {\n      await this._meta.loadingPromise;\n    }\n    try {\n      const p = this._persister.getItem(META_KEY);\n      this._meta.loadingPromise = p;\n      const v = await p;\n      this._meta.isLoading = false;\n      this._meta.error = null;\n      this._meta.loadingPromise = null;\n      this._meta.attempts = 0;\n      const existingObjects = this._meta.value?.objects ?? {};\n      const value = v ?? {};\n      const objects = value.objects ?? {};\n      // Merge the values from storage with in-memory values\n      this._meta.value = {\n        ...value,\n        objects: { ...existingObjects, ...objects },\n      } as Meta<K>;\n    } catch (e) {\n      this._meta.error = e;\n      this._meta.attempts++;\n      this._meta.loadingPromise = null;\n    }\n  }\n\n  private async _getMeta(): Promise<Meta<K> | null> {\n    if (this._meta.value) {\n      return this._meta.value;\n    }\n    if (this._meta.loadingPromise) {\n      await this._meta.loadingPromise;\n      return this._meta.value;\n    }\n    this._initMeta();\n    await this._meta.loadingPromise;\n    return this._meta.value;\n  }\n\n  private async _refreshMeta(): Promise<Meta<K> | null> {\n    await this._initMeta();\n    return this._meta.value;\n  }\n\n  private async _preloadEntries(n: number) {\n    const meta = await this.waitForMetaToLoad();\n    if (!meta) return;\n    const entries = Object.entries(meta.objects) as Array<[K, ObjectMeta]>;\n    entries.sort(([_k_a, a_meta], [_k_b, b_meta]) => {\n      return b_meta.updatedAt - a_meta.updatedAt;\n    });\n    for (const [k] of entries.slice(0, n)) {\n      this._loadKey(k);\n    }\n  }\n\n  private async _getFromStorage(key: K) {\n    try {\n      const data = await this._persister.getItem(key);\n      if (!data) {\n        return data;\n      }\n      const parsed = this.parse(key, data as SerializedT);\n      return parsed;\n    } catch (e) {\n      console.error(`Unable to read from storage for key=${key}`, e);\n      return null;\n    }\n  }\n\n  public async waitForKeyToLoad(k: K) {\n    if (this._loadedKeys.has(k)) {\n      return this.currentValue[k];\n    }\n    await (this._loadingKeys[k] || this._loadKey(k));\n    return this.currentValue[k];\n  }\n\n  // Used for tests\n  public async waitForMetaToLoad() {\n    return this._getMeta();\n  }\n\n  // Unloads the key so that it can be garbage collected, but does not\n  // delete it. Removes the key from currentValue.\n  public unloadKey(k: K) {\n    this._loadedKeys.delete(k);\n    delete this._loadingKeys[k];\n    delete this.currentValue[k];\n  }\n\n  private async _loadKey(k: K) {\n    if (this._loadedKeys.has(k) || k in this._loadingKeys) return;\n    const p = this._getFromStorage(k);\n    this._loadingKeys[k] = p;\n    const value = await p;\n    delete this._loadingKeys[k];\n    this._loadedKeys.add(k);\n\n    if (value) {\n      const merged = this._merge(k, value, this.currentValue[k]);\n      if (merged) {\n        this.currentValue[k] = merged;\n      }\n    }\n    this.onKeyLoaded && this.onKeyLoaded(k);\n  }\n\n  // Returns a promise with a number so that we can wait for flush\n  // to finish in the tests. The number is the number of operations\n  // it performed, but it's mostly there so that typescript will warn\n  // us if we forget to retun the promise from the function.\n  private _writeToStorage(opts?: {\n    skipGc?: boolean | null | undefined;\n    attempts?: number | null | undefined;\n  }): Promise<number> {\n    const promises: Promise<number>[] = [];\n    const skipGc = opts?.skipGc;\n    if (this._meta.isLoading) {\n      // Wait for meta to load and try again, give it a delay so that\n      // we don't spend too much time retrying\n      const p: Promise<number> = new Promise((resolve, reject) => {\n        setTimeout(\n          () =>\n            this._enqueuePersist(\n              opts\n                ? { ...opts, attempts: (opts.attempts || 0) + 1 }\n                : { attempts: 1 },\n            )\n              .then(resolve)\n              .catch(reject),\n          10 + (opts?.attempts ?? 0) * 1000,\n        );\n      });\n      promises.push(p);\n      return Promise.all(promises).then((vs) =>\n        vs.reduce((acc, x) => acc + x, 0),\n      );\n    }\n    const metaValue = this._meta.value;\n    if (!metaValue) {\n      // If it's not loading and we don't have the data, then there\n      // must be an error and we're not going to be able to save until\n      // the error is resolved elsewhere.\n      return Promise.resolve(0);\n    }\n    const keysToDelete: K[] = [];\n    const keysToUpdate: K[] = [];\n    for (const k of this._pendingSaveKeys) {\n      if (!(k in this.currentValue)) {\n        keysToDelete.push(k);\n        delete metaValue.objects[k];\n      } else {\n        keysToUpdate.push(k);\n      }\n    }\n\n    for (const k of keysToDelete) {\n      const p = this._persister.removeItem(k);\n      promises.push(p.then(() => 1));\n      this._loadedKeys.delete(k);\n      this._pendingSaveKeys.delete(k);\n    }\n\n    const keysToLoad: K[] = [];\n\n    const kvPairs: Array<[string, any]> = [[META_KEY, metaValue]];\n    const metaObjects: Meta<K>['objects'] =\n      metaValue.objects ?? ({} as Meta<K>['objects']);\n    metaValue.objects = metaObjects;\n    for (const k of keysToUpdate) {\n      if (this._loadedKeys.has(k)) {\n        const serializedV = this.serialize(k, this.currentValue[k]);\n        kvPairs.push([k, serializedV]);\n        const size = this._objectSize(serializedV);\n        const m = metaObjects[k] ?? {\n          createdAt: Date.now(),\n          updatedAt: Date.now(),\n          size,\n        };\n        m.updatedAt = Date.now();\n        m.size = size;\n        metaObjects[k] = m;\n        this._pendingSaveKeys.delete(k);\n      } else {\n        keysToLoad.push(k);\n      }\n    }\n\n    const p = this._persister.multiSet(kvPairs);\n    promises.push(p.then(() => 1));\n\n    // For the keys that haven't loaded, load the key then try\n    // persisting again. We don't want to do any async work here\n    // or else we might end up saving older copies of the data to\n    // the store.\n    for (const k of keysToLoad) {\n      const p = this._loadKey(k).then(() => this._enqueuePersist(opts));\n      promises.push(p);\n    }\n\n    if (!skipGc) {\n      this.gc();\n    }\n\n    return Promise.all(promises).then((vs) => {\n      return vs.reduce((acc, x) => acc + x, 0);\n    });\n  }\n\n  async flush() {\n    if (!this._nextSave) {\n      return;\n    }\n    clearTimeout(this._nextSave);\n    this._nextSave = null;\n    const p = this._writeToStorage();\n    return p;\n  }\n\n  private async _gc() {\n    if (!this._gcOpts) {\n      return;\n    }\n    const keys = new Set(await this._persister.getAllKeys());\n    keys.delete(META_KEY);\n\n    // Keys we can't delete\n    const sacredKeys = new Set(Object.keys(this.currentValue));\n    for (const k of Object.keys(this._loadingKeys)) {\n      sacredKeys.add(k);\n    }\n    for (const k of this._loadedKeys) {\n      sacredKeys.add(k);\n    }\n\n    // Refresh meta from the store so that we're less likely to\n    // clobber data from other tabs\n    const meta = await this._refreshMeta();\n    if (!meta) {\n      this._log.info('Could not gc because we were not able to load meta');\n      return;\n    }\n\n    const promises: Promise<any>[] = [];\n\n    const deets = {\n      gcOpts: this._gcOpts,\n      keys,\n      sacredKeys,\n      removed: [] as string[],\n      metaRemoved: [],\n      removedMissingCount: 0,\n      removedOldCount: 0,\n      removedThresholdCount: 0,\n      removedSizeCount: 0,\n    };\n\n    // First, remove all keys we don't know about\n    for (const key of keys) {\n      if (sacredKeys.has(key) || key in meta.objects) {\n        continue;\n      }\n      this._log.info('Lost track of key in meta', key);\n      promises.push(this._persister.removeItem(key));\n      deets.removed.push(key);\n      deets.removedMissingCount++;\n    }\n\n    // Remove anything over the max age\n    const now = Date.now();\n    for (const [k, m] of Object.entries(meta.objects)) {\n      if (\n        !sacredKeys.has(k) &&\n        (m as ObjectMeta).updatedAt < now - this._gcOpts.maxAgeMs\n      ) {\n        promises.push(this._persister.removeItem(k));\n        delete meta.objects[k];\n        deets.removed.push(k);\n        deets.removedOldCount++;\n      }\n    }\n\n    // Keep queries under max queries\n    const maxEntries = Object.entries(meta.objects) as Array<[K, ObjectMeta]>;\n    maxEntries.sort(([_k_a, a_meta], [_k_b, b_meta]) => {\n      return a_meta.updatedAt - b_meta.updatedAt;\n    });\n\n    const deletableMaxEntries = maxEntries.filter(([x]) => !sacredKeys.has(x));\n    if (maxEntries.length > this._gcOpts.maxEntries) {\n      for (const [k] of deletableMaxEntries.slice(\n        0,\n        maxEntries.length - this._gcOpts.maxEntries,\n      )) {\n        promises.push(this._persister.removeItem(k));\n        delete meta.objects[k];\n        deets.removed.push(k);\n        deets.removedThresholdCount++;\n      }\n    }\n\n    // Remove oldest entries until we are under max size\n    const delEntries = Object.entries(meta.objects) as Array<[K, ObjectMeta]>;\n    delEntries.sort(([_k_a, a_meta], [_k_b, b_meta]) => {\n      return a_meta.updatedAt - b_meta.updatedAt;\n    });\n    const deletableDelEntries = delEntries.filter(([x]) => !sacredKeys.has(x));\n\n    let currentSize = delEntries.reduce((acc, [_k, m]) => {\n      return acc + m.size;\n    }, 0);\n\n    while (\n      currentSize > 0 &&\n      currentSize > this._gcOpts.maxSize &&\n      deletableDelEntries.length\n    ) {\n      const [[k, m]] = deletableDelEntries.splice(0, 1);\n      currentSize -= m.size;\n      promises.push(this._persister.removeItem(k));\n      delete meta.objects[k];\n      deets.removed.push(k);\n      deets.removedSizeCount++;\n    }\n\n    // Update meta to remove keys that are no longer in the store\n    for (const k of Object.keys(meta.objects)) {\n      if (!keys.has(k) && !sacredKeys.has(k)) {\n        delete meta.objects[k];\n      }\n    }\n\n    if (deets.removed.length || deets.metaRemoved.length) {\n      // Trigger a flush of the meta\n      promises.push(this._enqueuePersist({ skipGc: true }));\n    }\n\n    this._log.info('Completed GC', deets);\n\n    await Promise.all(promises);\n    return deets;\n  }\n\n  // Schedules a GC to run in one minute (unless it is already scheduled)\n  gc() {\n    if (this._nextGc) {\n      return;\n    }\n    this._nextGc = setTimeout(\n      () => {\n        safeIdleCallback(() => {\n          this._nextGc = null;\n          this._gc();\n        }, 30 * 1000);\n      },\n      // 1 minute + some jitter to keep multiple tabs from running at same time\n      1000 * 60 + Math.random() * 500,\n    );\n  }\n\n  private _enqueuePersist(opts?: {\n    skipGc?: boolean | null | undefined;\n    attempts?: number | null | undefined;\n  }): Promise<number> {\n    return new Promise((resolve, reject) => {\n      if (this._nextSave) {\n        resolve(0);\n        return;\n      }\n\n      this._nextSave = setTimeout(() => {\n        safeIdleCallback(() => {\n          this._nextSave = null;\n          this._writeToStorage(opts).then(resolve).catch(reject);\n        }, this._idleCallbackMaxWaitMs);\n      }, this._saveThrottleMs);\n    });\n  }\n\n  version() {\n    return this._version;\n  }\n\n  // Takes a function that updates the store in place.\n  // Uses `mutative` to get a list of keys that were changed\n  // so that we know which entries we need to persist to the store.\n  public updateInPlace(f: (prev: Record<string, T>) => void) {\n    this._version++;\n    const [state, patches] = create(this.currentValue, f, {\n      enablePatches: true,\n    });\n    for (const patch of patches) {\n      const k = patch.path[0];\n      if (k && typeof k === 'string') {\n        this._pendingSaveKeys.add(k as K);\n        if (!this._loadedKeys.has(k as K)) {\n          this._loadKey(k as K);\n        }\n      }\n    }\n\n    this.currentValue = state;\n    this._enqueuePersist();\n    for (const cb of this._subs) {\n      cb(this.currentValue);\n    }\n    return state;\n  }\n\n  public subscribe(cb: (value: Record<K, T>) => void) {\n    this._subs.push(cb);\n    cb(this.currentValue);\n\n    return () => {\n      this._subs = this._subs.filter((x) => x !== cb);\n    };\n  }\n}\n"]}