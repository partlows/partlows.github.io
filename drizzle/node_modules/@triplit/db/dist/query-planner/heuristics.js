import { isFilterStatement, isIdFilterEqualityStatement, isSubQueryFilter, } from '../filters.js';
import { isValueVariable } from '../variables.js';
export function hasIdFilter(query) {
    if (!query.where)
        return false;
    // Very naive approach: if the top-level where includes an ID filter, choose ID plan
    return query.where.some((f) => isFilterStatement(f) && isIdFilterEqualityStatement(f));
}
export function getIdFilter(query) {
    if (!query.where)
        return [null, -1];
    // TODO support searching in nested filter groups like AND and OR
    const idFilterIndex = query.where.findIndex((f) => isFilterStatement(f) && isIdFilterEqualityStatement(f));
    if (idFilterIndex === -1)
        return [null, -1];
    return [query.where[idFilterIndex], idFilterIndex];
}
// This gets some basic info about the selectivity of a query
// NOTE: it intentionally doesn't consider subqueries
function getQuerySelectivity(query) {
    const selectivity = {};
    if (query.limit !== undefined) {
        selectivity.limit = query.limit;
    }
    if (query.where?.some((f) => isFilterStatement(f) &&
        isIdFilterEqualityStatement(f) &&
        !isValueVariable(f[2]))) {
        selectivity.hasIdFilter = true;
    }
    return selectivity;
}
function compareSelectivity(selectivity1, selectivity2) {
    if (selectivity1.hasIdFilter && !selectivity2.hasIdFilter)
        return -1;
    if (!selectivity1.hasIdFilter && selectivity2.hasIdFilter)
        return 1;
    if (selectivity1.limit !== undefined && selectivity2.limit === undefined)
        return -1;
    if (selectivity1.limit === undefined && selectivity2.limit !== undefined)
        return 1;
    if (selectivity1.limit !== undefined && selectivity2.limit !== undefined) {
        if (selectivity1.limit < selectivity2.limit)
            return -1;
        if (selectivity1.limit > selectivity2.limit)
            return 1;
    }
    return 0;
}
export function subQueryIsLikelyMoreSelectiveThanRoot(query) {
    // TODO handle AND/OR
    if (!query.where?.some(isSubQueryFilter))
        return false;
    const selectivityOfRoot = getQuerySelectivity(query);
    // Check to see if any of the immediate subQuery filters has greater selectivity
    return query.where.some((f) => isSubQueryFilter(f) &&
        compareSelectivity(getQuerySelectivity(f.exists), selectivityOfRoot) < 0);
}
//# sourceMappingURL=heuristics.js.map