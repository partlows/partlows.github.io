var lg=Object.create;var vs=Object.defineProperty;var fg=Object.getOwnPropertyDescriptor;var dg=Object.getOwnPropertyNames;var hg=Object.getPrototypeOf,pg=Object.prototype.hasOwnProperty;var oc=(t=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(t,{get:(e,r)=>(typeof require<"u"?require:e)[r]}):t)(function(t){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+t+'" is not supported')});var yg=(t,e)=>()=>(t&&(e=t(t=0)),e);var h=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports),ac=(t,e)=>{for(var r in e)vs(t,r,{get:e[r],enumerable:!0})},mg=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of dg(e))!pg.call(t,i)&&i!==r&&vs(t,i,{get:()=>e[i],enumerable:!(n=fg(e,i))||n.enumerable});return t};var ft=(t,e,r)=>(r=t!=null?lg(hg(t)):{},mg(e||!t||!t.__esModule?vs(r,"default",{value:t,enumerable:!0}):r,t));var B=h((Ss,mc)=>{"use strict";var fr=function(t){return t&&t.Math===Math&&t};mc.exports=fr(typeof globalThis=="object"&&globalThis)||fr(typeof window=="object"&&window)||fr(typeof self=="object"&&self)||fr(typeof global=="object"&&global)||fr(typeof Ss=="object"&&Ss)||function(){return this}()||Function("return this")()});var ne=h((EA,gc)=>{"use strict";gc.exports=function(t){try{return!!t()}catch{return!0}}});var ge=h((CA,vc)=>{"use strict";var Ag=ne();vc.exports=!Ag(function(){return Object.defineProperty({},1,{get:function(){return 7}})[1]!==7})});var mn=h((IA,wc)=>{"use strict";var kg=ne();wc.exports=!kg(function(){var t=function(){}.bind();return typeof t!="function"||t.hasOwnProperty("prototype")})});var P=h((OA,bc)=>{"use strict";var Ng=mn(),gn=Function.prototype.call;bc.exports=Ng?gn.bind(gn):function(){return gn.apply(gn,arguments)}});var Cc=h(Ec=>{"use strict";var Sc={}.propertyIsEnumerable,xc=Object.getOwnPropertyDescriptor,qg=xc&&!Sc.call({1:2},1);Ec.f=qg?function(e){var r=xc(this,e);return!!r&&r.enumerable}:Sc});var vn=h((TA,Ic)=>{"use strict";Ic.exports=function(t,e){return{enumerable:!(t&1),configurable:!(t&2),writable:!(t&4),value:e}}});var ie=h((PA,Tc)=>{"use strict";var Oc=mn(),Rc=Function.prototype,xs=Rc.call,_g=Oc&&Rc.bind.bind(xs,xs);Tc.exports=Oc?_g:function(t){return function(){return xs.apply(t,arguments)}}});var wn=h((AA,Ac)=>{"use strict";var Pc=ie(),Mg=Pc({}.toString),Fg=Pc("".slice);Ac.exports=function(t){return Fg(Mg(t),8,-1)}});var Nc=h((kA,kc)=>{"use strict";var jg=ie(),Dg=ne(),$g=wn(),Es=Object,Lg=jg("".split);kc.exports=Dg(function(){return!Es("z").propertyIsEnumerable(0)})?function(t){return $g(t)==="String"?Lg(t,""):Es(t)}:Es});var bn=h((NA,qc)=>{"use strict";qc.exports=function(t){return t==null}});var Sn=h((qA,_c)=>{"use strict";var Vg=bn(),Bg=TypeError;_c.exports=function(t){if(Vg(t))throw new Bg("Can't call method on "+t);return t}});var dr=h((_A,Mc)=>{"use strict";var Ug=Nc(),Qg=Sn();Mc.exports=function(t){return Ug(Qg(t))}});var U=h((MA,Fc)=>{"use strict";var Cs=typeof document=="object"&&document.all;Fc.exports=typeof Cs>"u"&&Cs!==void 0?function(t){return typeof t=="function"||t===Cs}:function(t){return typeof t=="function"}});var Z=h((FA,jc)=>{"use strict";var zg=U();jc.exports=function(t){return typeof t=="object"?t!==null:zg(t)}});var ve=h((jA,Dc)=>{"use strict";var Is=B(),Wg=U(),Kg=function(t){return Wg(t)?t:void 0};Dc.exports=function(t,e){return arguments.length<2?Kg(Is[t]):Is[t]&&Is[t][e]}});var ht=h((DA,$c)=>{"use strict";var Gg=ie();$c.exports=Gg({}.isPrototypeOf)});var Uc=h(($A,Bc)=>{"use strict";var Hg=B(),Lc=Hg.navigator,Vc=Lc&&Lc.userAgent;Bc.exports=Vc?String(Vc):""});var Yc=h((LA,Hc)=>{"use strict";var Gc=B(),Os=Uc(),Qc=Gc.process,zc=Gc.Deno,Wc=Qc&&Qc.versions||zc&&zc.version,Kc=Wc&&Wc.v8,be,xn;Kc&&(be=Kc.split("."),xn=be[0]>0&&be[0]<4?1:+(be[0]+be[1]));!xn&&Os&&(be=Os.match(/Edge\/(\d+)/),(!be||be[1]>=74)&&(be=Os.match(/Chrome\/(\d+)/),be&&(xn=+be[1])));Hc.exports=xn});var Rs=h((VA,Xc)=>{"use strict";var Jc=Yc(),Yg=ne(),Jg=B(),Xg=Jg.String;Xc.exports=!!Object.getOwnPropertySymbols&&!Yg(function(){var t=Symbol("symbol detection");return!Xg(t)||!(Object(t)instanceof Symbol)||!Symbol.sham&&Jc&&Jc<41})});var Ts=h((BA,Zc)=>{"use strict";var Zg=Rs();Zc.exports=Zg&&!Symbol.sham&&typeof Symbol.iterator=="symbol"});var Ps=h((UA,eu)=>{"use strict";var ev=ve(),tv=U(),rv=ht(),nv=Ts(),iv=Object;eu.exports=nv?function(t){return typeof t=="symbol"}:function(t){var e=ev("Symbol");return tv(e)&&rv(e.prototype,iv(t))}});var Pt=h((QA,tu)=>{"use strict";var sv=String;tu.exports=function(t){try{return sv(t)}catch{return"Object"}}});var Q=h((zA,ru)=>{"use strict";var ov=U(),av=Pt(),cv=TypeError;ru.exports=function(t){if(ov(t))return t;throw new cv(av(t)+" is not a function")}});var Se=h((WA,nu)=>{"use strict";var uv=Q(),lv=bn();nu.exports=function(t,e){var r=t[e];return lv(r)?void 0:uv(r)}});var su=h((KA,iu)=>{"use strict";var As=P(),ks=U(),Ns=Z(),fv=TypeError;iu.exports=function(t,e){var r,n;if(e==="string"&&ks(r=t.toString)&&!Ns(n=As(r,t))||ks(r=t.valueOf)&&!Ns(n=As(r,t))||e!=="string"&&ks(r=t.toString)&&!Ns(n=As(r,t)))return n;throw new fv("Can't convert object to primitive value")}});var z=h((GA,ou)=>{"use strict";ou.exports=!1});var En=h((HA,cu)=>{"use strict";var au=B(),dv=Object.defineProperty;cu.exports=function(t,e){try{dv(au,t,{value:e,configurable:!0,writable:!0})}catch{au[t]=e}return e}});var hr=h((YA,fu)=>{"use strict";var hv=z(),pv=B(),yv=En(),uu="__core-js_shared__",lu=fu.exports=pv[uu]||yv(uu,{});(lu.versions||(lu.versions=[])).push({version:"3.41.0",mode:hv?"pure":"global",copyright:"\xA9 2014-2025 Denis Pushkarev (zloirock.ru)",license:"https://github.com/zloirock/core-js/blob/v3.41.0/LICENSE",source:"https://github.com/zloirock/core-js"})});var qs=h((JA,hu)=>{"use strict";var du=hr();hu.exports=function(t,e){return du[t]||(du[t]=e||{})}});var At=h((XA,pu)=>{"use strict";var mv=Sn(),gv=Object;pu.exports=function(t){return gv(mv(t))}});var ue=h((ZA,yu)=>{"use strict";var vv=ie(),wv=At(),bv=vv({}.hasOwnProperty);yu.exports=Object.hasOwn||function(e,r){return bv(wv(e),r)}});var Cn=h((ek,mu)=>{"use strict";var Sv=ie(),xv=0,Ev=Math.random(),Cv=Sv(1 .toString);mu.exports=function(t){return"Symbol("+(t===void 0?"":t)+")_"+Cv(++xv+Ev,36)}});var G=h((tk,vu)=>{"use strict";var Iv=B(),Ov=qs(),gu=ue(),Rv=Cn(),Tv=Rs(),Pv=Ts(),kt=Iv.Symbol,_s=Ov("wks"),Av=Pv?kt.for||kt:kt&&kt.withoutSetter||Rv;vu.exports=function(t){return gu(_s,t)||(_s[t]=Tv&&gu(kt,t)?kt[t]:Av("Symbol."+t)),_s[t]}});var xu=h((rk,Su)=>{"use strict";var kv=P(),wu=Z(),bu=Ps(),Nv=Se(),qv=su(),_v=G(),Mv=TypeError,Fv=_v("toPrimitive");Su.exports=function(t,e){if(!wu(t)||bu(t))return t;var r=Nv(t,Fv),n;if(r){if(e===void 0&&(e="default"),n=kv(r,t,e),!wu(n)||bu(n))return n;throw new Mv("Can't convert object to primitive value")}return e===void 0&&(e="number"),qv(t,e)}});var Ms=h((nk,Eu)=>{"use strict";var jv=xu(),Dv=Ps();Eu.exports=function(t){var e=jv(t,"string");return Dv(e)?e:e+""}});var js=h((ik,Iu)=>{"use strict";var $v=B(),Cu=Z(),Fs=$v.document,Lv=Cu(Fs)&&Cu(Fs.createElement);Iu.exports=function(t){return Lv?Fs.createElement(t):{}}});var Ds=h((sk,Ou)=>{"use strict";var Vv=ge(),Bv=ne(),Uv=js();Ou.exports=!Vv&&!Bv(function(){return Object.defineProperty(Uv("div"),"a",{get:function(){return 7}}).a!==7})});var pr=h(Tu=>{"use strict";var Qv=ge(),zv=P(),Wv=Cc(),Kv=vn(),Gv=dr(),Hv=Ms(),Yv=ue(),Jv=Ds(),Ru=Object.getOwnPropertyDescriptor;Tu.f=Qv?Ru:function(e,r){if(e=Gv(e),r=Hv(r),Jv)try{return Ru(e,r)}catch{}if(Yv(e,r))return Kv(!zv(Wv.f,e,r),e[r])}});var $s=h((ak,Pu)=>{"use strict";var Xv=ge(),Zv=ne();Pu.exports=Xv&&Zv(function(){return Object.defineProperty(function(){},"prototype",{value:42,writable:!1}).prototype!==42})});var I=h((ck,Au)=>{"use strict";var ew=Z(),tw=String,rw=TypeError;Au.exports=function(t){if(ew(t))return t;throw new rw(tw(t)+" is not an object")}});var Pe=h(Nu=>{"use strict";var nw=ge(),iw=Ds(),sw=$s(),In=I(),ku=Ms(),ow=TypeError,Ls=Object.defineProperty,aw=Object.getOwnPropertyDescriptor,Vs="enumerable",Bs="configurable",Us="writable";Nu.f=nw?sw?function(e,r,n){if(In(e),r=ku(r),In(n),typeof e=="function"&&r==="prototype"&&"value"in n&&Us in n&&!n[Us]){var i=aw(e,r);i&&i[Us]&&(e[r]=n.value,n={configurable:Bs in n?n[Bs]:i[Bs],enumerable:Vs in n?n[Vs]:i[Vs],writable:!1})}return Ls(e,r,n)}:Ls:function(e,r,n){if(In(e),r=ku(r),In(n),iw)try{return Ls(e,r,n)}catch{}if("get"in n||"set"in n)throw new ow("Accessors not supported");return"value"in n&&(e[r]=n.value),e}});var pt=h((lk,qu)=>{"use strict";var cw=ge(),uw=Pe(),lw=vn();qu.exports=cw?function(t,e,r){return uw.f(t,e,lw(1,r))}:function(t,e,r){return t[e]=r,t}});var Fu=h((fk,Mu)=>{"use strict";var Qs=ge(),fw=ue(),_u=Function.prototype,dw=Qs&&Object.getOwnPropertyDescriptor,zs=fw(_u,"name"),hw=zs&&function(){}.name==="something",pw=zs&&(!Qs||Qs&&dw(_u,"name").configurable);Mu.exports={EXISTS:zs,PROPER:hw,CONFIGURABLE:pw}});var Ks=h((dk,ju)=>{"use strict";var yw=ie(),mw=U(),Ws=hr(),gw=yw(Function.toString);mw(Ws.inspectSource)||(Ws.inspectSource=function(t){return gw(t)});ju.exports=Ws.inspectSource});var Lu=h((hk,$u)=>{"use strict";var vw=B(),ww=U(),Du=vw.WeakMap;$u.exports=ww(Du)&&/native code/.test(String(Du))});var On=h((pk,Bu)=>{"use strict";var bw=qs(),Sw=Cn(),Vu=bw("keys");Bu.exports=function(t){return Vu[t]||(Vu[t]=Sw(t))}});var Rn=h((yk,Uu)=>{"use strict";Uu.exports={}});var Nt=h((mk,Wu)=>{"use strict";var xw=Lu(),zu=B(),Ew=Z(),Cw=pt(),Gs=ue(),Hs=hr(),Iw=On(),Ow=Rn(),Qu="Object already initialized",Ys=zu.TypeError,Rw=zu.WeakMap,Tn,yr,Pn,Tw=function(t){return Pn(t)?yr(t):Tn(t,{})},Pw=function(t){return function(e){var r;if(!Ew(e)||(r=yr(e)).type!==t)throw new Ys("Incompatible receiver, "+t+" required");return r}};xw||Hs.state?(xe=Hs.state||(Hs.state=new Rw),xe.get=xe.get,xe.has=xe.has,xe.set=xe.set,Tn=function(t,e){if(xe.has(t))throw new Ys(Qu);return e.facade=t,xe.set(t,e),e},yr=function(t){return xe.get(t)||{}},Pn=function(t){return xe.has(t)}):(yt=Iw("state"),Ow[yt]=!0,Tn=function(t,e){if(Gs(t,yt))throw new Ys(Qu);return e.facade=t,Cw(t,yt,e),e},yr=function(t){return Gs(t,yt)?t[yt]:{}},Pn=function(t){return Gs(t,yt)});var xe,yt;Wu.exports={set:Tn,get:yr,has:Pn,enforce:Tw,getterFor:Pw}});var Zs=h((gk,Hu)=>{"use strict";var Xs=ie(),Aw=ne(),kw=U(),An=ue(),Js=ge(),Nw=Fu().CONFIGURABLE,qw=Ks(),Gu=Nt(),_w=Gu.enforce,Mw=Gu.get,Ku=String,kn=Object.defineProperty,Fw=Xs("".slice),jw=Xs("".replace),Dw=Xs([].join),$w=Js&&!Aw(function(){return kn(function(){},"length",{value:8}).length!==8}),Lw=String(String).split("String"),Vw=Hu.exports=function(t,e,r){Fw(Ku(e),0,7)==="Symbol("&&(e="["+jw(Ku(e),/^Symbol\(([^)]*)\).*$/,"$1")+"]"),r&&r.getter&&(e="get "+e),r&&r.setter&&(e="set "+e),(!An(t,"name")||Nw&&t.name!==e)&&(Js?kn(t,"name",{value:e,configurable:!0}):t.name=e),$w&&r&&An(r,"arity")&&t.length!==r.arity&&kn(t,"length",{value:r.arity});try{r&&An(r,"constructor")&&r.constructor?Js&&kn(t,"prototype",{writable:!1}):t.prototype&&(t.prototype=void 0)}catch{}var n=_w(t);return An(n,"source")||(n.source=Dw(Lw,typeof e=="string"?e:"")),t};Function.prototype.toString=Vw(function(){return kw(this)&&Mw(this).source||qw(this)},"toString")});var qt=h((vk,Yu)=>{"use strict";var Bw=U(),Uw=Pe(),Qw=Zs(),zw=En();Yu.exports=function(t,e,r,n){n||(n={});var i=n.enumerable,s=n.name!==void 0?n.name:e;if(Bw(r)&&Qw(r,s,n),n.global)i?t[e]=r:zw(e,r);else{try{n.unsafe?t[e]&&(i=!0):delete t[e]}catch{}i?t[e]=r:Uw.f(t,e,{value:r,enumerable:!1,configurable:!n.nonConfigurable,writable:!n.nonWritable})}return t}});var Xu=h((wk,Ju)=>{"use strict";var Ww=Math.ceil,Kw=Math.floor;Ju.exports=Math.trunc||function(e){var r=+e;return(r>0?Kw:Ww)(r)}});var Nn=h((bk,Zu)=>{"use strict";var Gw=Xu();Zu.exports=function(t){var e=+t;return e!==e||e===0?0:Gw(e)}});var tl=h((Sk,el)=>{"use strict";var Hw=Nn(),Yw=Math.max,Jw=Math.min;el.exports=function(t,e){var r=Hw(t);return r<0?Yw(r+e,0):Jw(r,e)}});var nl=h((xk,rl)=>{"use strict";var Xw=Nn(),Zw=Math.min;rl.exports=function(t){var e=Xw(t);return e>0?Zw(e,9007199254740991):0}});var qn=h((Ek,il)=>{"use strict";var eb=nl();il.exports=function(t){return eb(t.length)}});var al=h((Ck,ol)=>{"use strict";var tb=dr(),rb=tl(),nb=qn(),sl=function(t){return function(e,r,n){var i=tb(e),s=nb(i);if(s===0)return!t&&-1;var o=rb(n,s),a;if(t&&r!==r){for(;s>o;)if(a=i[o++],a!==a)return!0}else for(;s>o;o++)if((t||o in i)&&i[o]===r)return t||o||0;return!t&&-1}};ol.exports={includes:sl(!0),indexOf:sl(!1)}});var to=h((Ik,ul)=>{"use strict";var ib=ie(),eo=ue(),sb=dr(),ob=al().indexOf,ab=Rn(),cl=ib([].push);ul.exports=function(t,e){var r=sb(t),n=0,i=[],s;for(s in r)!eo(ab,s)&&eo(r,s)&&cl(i,s);for(;e.length>n;)eo(r,s=e[n++])&&(~ob(i,s)||cl(i,s));return i}});var _n=h((Ok,ll)=>{"use strict";ll.exports=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"]});var dl=h(fl=>{"use strict";var cb=to(),ub=_n(),lb=ub.concat("length","prototype");fl.f=Object.getOwnPropertyNames||function(e){return cb(e,lb)}});var pl=h(hl=>{"use strict";hl.f=Object.getOwnPropertySymbols});var ml=h((Pk,yl)=>{"use strict";var fb=ve(),db=ie(),hb=dl(),pb=pl(),yb=I(),mb=db([].concat);yl.exports=fb("Reflect","ownKeys")||function(e){var r=hb.f(yb(e)),n=pb.f;return n?mb(r,n(e)):r}});var wl=h((Ak,vl)=>{"use strict";var gl=ue(),gb=ml(),vb=pr(),wb=Pe();vl.exports=function(t,e,r){for(var n=gb(e),i=wb.f,s=vb.f,o=0;o<n.length;o++){var a=n[o];!gl(t,a)&&!(r&&gl(r,a))&&i(t,a,s(e,a))}}});var Sl=h((kk,bl)=>{"use strict";var bb=ne(),Sb=U(),xb=/#|\.prototype\./,mr=function(t,e){var r=Cb[Eb(t)];return r===Ob?!0:r===Ib?!1:Sb(e)?bb(e):!!e},Eb=mr.normalize=function(t){return String(t).replace(xb,".").toLowerCase()},Cb=mr.data={},Ib=mr.NATIVE="N",Ob=mr.POLYFILL="P";bl.exports=mr});var O=h((Nk,xl)=>{"use strict";var Mn=B(),Rb=pr().f,Tb=pt(),Pb=qt(),Ab=En(),kb=wl(),Nb=Sl();xl.exports=function(t,e){var r=t.target,n=t.global,i=t.stat,s,o,a,c,u,l;if(n?o=Mn:i?o=Mn[r]||Ab(r,{}):o=Mn[r]&&Mn[r].prototype,o)for(a in e){if(u=e[a],t.dontCallGetSet?(l=Rb(o,a),c=l&&l.value):c=o[a],s=Nb(n?a:r+(i?".":"#")+a,t.forced),!s&&c!==void 0){if(typeof u==typeof c)continue;kb(u,c)}(t.sham||c&&c.sham)&&Tb(u,"sham",!0),Pb(o,a,u,t)}}});var ro=h((qk,El)=>{"use strict";var qb=ht(),_b=TypeError;El.exports=function(t,e){if(qb(e,t))return t;throw new _b("Incorrect invocation")}});var Il=h((_k,Cl)=>{"use strict";var Mb=ne();Cl.exports=!Mb(function(){function t(){}return t.prototype.constructor=null,Object.getPrototypeOf(new t)!==t.prototype})});var _t=h((Mk,Rl)=>{"use strict";var Fb=ue(),jb=U(),Db=At(),$b=On(),Lb=Il(),Ol=$b("IE_PROTO"),no=Object,Vb=no.prototype;Rl.exports=Lb?no.getPrototypeOf:function(t){var e=Db(t);if(Fb(e,Ol))return e[Ol];var r=e.constructor;return jb(r)&&e instanceof r?r.prototype:e instanceof no?Vb:null}});var Pl=h((Fk,Tl)=>{"use strict";var Bb=to(),Ub=_n();Tl.exports=Object.keys||function(e){return Bb(e,Ub)}});var kl=h(Al=>{"use strict";var Qb=ge(),zb=$s(),Wb=Pe(),Kb=I(),Gb=dr(),Hb=Pl();Al.f=Qb&&!zb?Object.defineProperties:function(e,r){Kb(e);for(var n=Gb(r),i=Hb(r),s=i.length,o=0,a;s>o;)Wb.f(e,a=i[o++],n[a]);return e}});var ql=h((Dk,Nl)=>{"use strict";var Yb=ve();Nl.exports=Yb("document","documentElement")});var Mt=h(($k,Ll)=>{"use strict";var Jb=I(),Xb=kl(),_l=_n(),Zb=Rn(),eS=ql(),tS=js(),rS=On(),Ml=">",Fl="<",so="prototype",oo="script",Dl=rS("IE_PROTO"),io=function(){},$l=function(t){return Fl+oo+Ml+t+Fl+"/"+oo+Ml},jl=function(t){t.write($l("")),t.close();var e=t.parentWindow.Object;return t=null,e},nS=function(){var t=tS("iframe"),e="java"+oo+":",r;return t.style.display="none",eS.appendChild(t),t.src=String(e),r=t.contentWindow.document,r.open(),r.write($l("document.F=Object")),r.close(),r.F},Fn,jn=function(){try{Fn=new ActiveXObject("htmlfile")}catch{}jn=typeof document<"u"?document.domain&&Fn?jl(Fn):nS():jl(Fn);for(var t=_l.length;t--;)delete jn[so][_l[t]];return jn()};Zb[Dl]=!0;Ll.exports=Object.create||function(e,r){var n;return e!==null?(io[so]=Jb(e),n=new io,io[so]=null,n[Dl]=e):n=jn(),r===void 0?n:Xb.f(n,r)}});var gr=h((Lk,Gl)=>{"use strict";var zl=B(),Wl=hr(),Kl=U(),iS=Mt(),Dn=_t(),sS=qt(),oS=G(),aS=z(),Vl="USE_FUNCTION_CONSTRUCTOR",Bl=oS("asyncIterator"),Ul=zl.AsyncIterator,Ql=Wl.AsyncIteratorPrototype,Ae,ao;if(Ql)Ae=Ql;else if(Kl(Ul))Ae=Ul.prototype;else if(Wl[Vl]||zl[Vl])try{ao=Dn(Dn(Dn(Function("return async function*(){}()")()))),Dn(ao)===Object.prototype&&(Ae=ao)}catch{}Ae?aS&&(Ae=iS(Ae)):Ae={};Kl(Ae[Bl])||sS(Ae,Bl,function(){return this});Gl.exports=Ae});var Zl=h(()=>{"use strict";var cS=O(),uS=ro(),lS=_t(),Yl=pt(),Jl=ue(),fS=G(),Ze=gr(),Xl=z(),Hl=fS("toStringTag"),dS=TypeError,co=function(){if(uS(this,Ze),lS(this)===Ze)throw new dS("Abstract class AsyncIterator not directly constructable")};co.prototype=Ze;Jl(Ze,Hl)||Yl(Ze,Hl,"AsyncIterator");(Xl||!Jl(Ze,"constructor")||Ze.constructor===Object)&&Yl(Ze,"constructor",co);cS({global:!0,constructor:!0,forced:Xl},{AsyncIterator:co})});var j=h((Uk,ef)=>{"use strict";ef.exports=function(t){return{iterator:t,next:t.next,done:!1}}});var vr=h((Qk,tf)=>{"use strict";var hS=RangeError;tf.exports=function(t){if(t===t)return t;throw new hS("NaN is not allowed")}});var wr=h((zk,rf)=>{"use strict";var pS=Nn(),yS=RangeError;rf.exports=function(t){var e=pS(t);if(e<0)throw new yS("The argument can't be less than 0");return e}});var sf=h((Wk,nf)=>{"use strict";nf.exports=function(t){try{return{error:!1,value:t()}}catch(e){return{error:!0,value:e}}}});var $n=h((Kk,of)=>{"use strict";var mS=qt();of.exports=function(t,e,r){for(var n in e)mS(t,n,e[n],r);return t}});var Ve=h((Gk,af)=>{"use strict";af.exports=function(t,e){return{value:t,done:e}}});var mt=h((Hk,uf)=>{"use strict";var gS=P(),cf=I(),vS=Se();uf.exports=function(t,e,r){var n,i;cf(t);try{if(n=vS(t,"return"),!n){if(e==="throw")throw r;return r}n=gS(n,t)}catch(s){i=!0,n=s}if(e==="throw")throw r;if(i)throw n;return cf(n),r}});var gt=h((Yk,gf)=>{"use strict";var wS=P(),Ln=sf(),lf=I(),bS=Mt(),SS=pt(),xS=$n(),ES=G(),df=Nt(),CS=ve(),IS=Se(),OS=gr(),uo=Ve(),ff=mt(),ke=CS("Promise"),RS=ES("toStringTag"),hf="AsyncIteratorHelper",pf="WrapForValidAsyncIterator",TS=df.set,yf=function(t){var e=!t,r=df.getterFor(t?pf:hf),n=function(i){var s=Ln(function(){return r(i)}),o=s.error,a=s.value;return o||e&&a.done?{exit:!0,value:o?ke.reject(a):ke.resolve(uo(void 0,!0))}:{exit:!1,value:a}};return xS(bS(OS),{next:function(){var s=n(this),o=s.value;if(s.exit)return o;var a=Ln(function(){return lf(o.nextHandler(ke))}),c=a.error,u=a.value;return c&&(o.done=!0),c?ke.reject(u):ke.resolve(u)},return:function(){var i=n(this),s=i.value;if(i.exit)return s;s.done=!0;var o=s.iterator,a,c,u=Ln(function(){if(s.inner)try{ff(s.inner.iterator,"normal")}catch(l){return ff(o,"throw",l)}return IS(o,"return")});return a=c=u.value,u.error?ke.reject(c):a===void 0?ke.resolve(uo(void 0,!0)):(u=Ln(function(){return wS(a,o)}),c=u.value,u.error?ke.reject(c):t?ke.resolve(c):ke.resolve(c).then(function(l){return lf(l),uo(void 0,!0)}))}})},PS=yf(!0),mf=yf(!1);SS(mf,RS,"Async Iterator Helper");gf.exports=function(t,e){var r=function(i,s){s?(s.iterator=i.iterator,s.next=i.next):s=i,s.type=e?pf:hf,s.nextHandler=t,s.counter=0,s.done=!1,TS(this,s)};return r.prototype=e?PS:mf,r}});var wf=h(()=>{"use strict";var AS=O(),kS=P(),lo=I(),NS=j(),qS=vr(),_S=wr(),MS=gt(),vf=Ve(),FS=z(),jS=MS(function(t){var e=this;return new t(function(r,n){var i=function(o){e.done=!0,n(o)},s=function(){try{t.resolve(lo(kS(e.next,e.iterator))).then(function(o){try{lo(o).done?(e.done=!0,r(vf(void 0,!0))):e.remaining?(e.remaining--,s()):r(vf(o.value,!1))}catch(a){i(a)}},i)}catch(o){i(o)}};s()})});AS({target:"AsyncIterator",proto:!0,real:!0,forced:FS},{drop:function(e){lo(this);var r=_S(qS(+e));return new jS(NS(this),{remaining:r})}})});var Sf=h((Zk,bf)=>{"use strict";var DS=TypeError,$S=9007199254740991;bf.exports=function(t){if(t>$S)throw DS("Maximum allowed index exceeded");return t}});var Ft=h((eN,xf)=>{"use strict";var LS=P(),VS=ve(),BS=Se();xf.exports=function(t,e,r,n){try{var i=BS(t,"return");if(i)return VS("Promise").resolve(LS(i,t)).then(function(){e(r)},function(s){n(s)})}catch(s){return n(s)}e(r)}});var vt=h((tN,Ef)=>{"use strict";var US=P(),QS=Q(),fo=I(),zS=Z(),WS=Sf(),KS=ve(),GS=j(),ho=Ft(),br=function(t){var e=t===0,r=t===1,n=t===2,i=t===3;return function(s,o,a){fo(s);var c=o!==void 0;(c||!e)&&QS(o);var u=GS(s),l=KS("Promise"),f=u.iterator,d=u.next,p=0;return new l(function(m,y){var w=function(b){ho(f,y,b,y)},E=function(){try{if(c)try{WS(p)}catch(b){w(b)}l.resolve(fo(US(d,f))).then(function(b){try{if(fo(b).done)e?(a.length=p,m(a)):m(i?!1:n||void 0);else{var re=b.value;try{if(c){var R=o(re,p),Te=function(k){if(r)E();else if(n)k?E():ho(f,m,!1,y);else if(e)try{a[p++]=k,E()}catch(X){w(X)}else k?ho(f,m,i||re,y):E()};zS(R)?l.resolve(R).then(Te,w):Te(R)}else a[p++]=re,E()}catch(k){w(k)}}}catch(k){y(k)}},y)}catch(b){y(b)}};E()})}};Ef.exports={toArray:br(0),forEach:br(1),every:br(2),some:br(3),find:br(4)}});var Cf=h(()=>{"use strict";var HS=O(),YS=vt().every;HS({target:"AsyncIterator",proto:!0,real:!0},{every:function(e){return YS(this,e)}})});var Of=h(()=>{"use strict";var JS=O(),XS=P(),ZS=Q(),po=I(),ex=Z(),tx=j(),rx=gt(),If=Ve(),nx=Ft(),ix=z(),sx=rx(function(t){var e=this,r=e.iterator,n=e.predicate;return new t(function(i,s){var o=function(u){e.done=!0,s(u)},a=function(u){nx(r,o,u,o)},c=function(){try{t.resolve(po(XS(e.next,r))).then(function(u){try{if(po(u).done)e.done=!0,i(If(void 0,!0));else{var l=u.value;try{var f=n(l,e.counter++),d=function(p){p?i(If(l,!1)):c()};ex(f)?t.resolve(f).then(d,a):d(f)}catch(p){a(p)}}}catch(p){o(p)}},o)}catch(u){o(u)}};c()})});JS({target:"AsyncIterator",proto:!0,real:!0,forced:ix},{filter:function(e){return po(this),ZS(e),new sx(tx(this),{predicate:e})}})});var Rf=h(()=>{"use strict";var ox=O(),ax=vt().find;ox({target:"AsyncIterator",proto:!0,real:!0},{find:function(e){return ax(this,e)}})});var Af=h((cN,Pf)=>{"use strict";var cx=G(),ux=cx("toStringTag"),Tf={};Tf[ux]="z";Pf.exports=String(Tf)==="[object z]"});var Bn=h((uN,kf)=>{"use strict";var lx=Af(),fx=U(),Vn=wn(),dx=G(),hx=dx("toStringTag"),px=Object,yx=Vn(function(){return arguments}())==="Arguments",mx=function(t,e){try{return t[e]}catch{}};kf.exports=lx?Vn:function(t){var e,r,n;return t===void 0?"Undefined":t===null?"Null":typeof(r=mx(e=px(t),hx))=="string"?r:yx?Vn(e):(n=Vn(e))==="Object"&&fx(e.callee)?"Arguments":n}});var yo=h((lN,Nf)=>{"use strict";Nf.exports={}});var jt=h((fN,_f)=>{"use strict";var gx=Bn(),qf=Se(),vx=bn(),wx=yo(),bx=G(),Sx=bx("iterator");_f.exports=function(t){if(!vx(t))return qf(t,Sx)||qf(t,"@@iterator")||wx[gx(t)]}});var Sr=h((dN,Uf)=>{"use strict";var Mf=P(),Ff=I(),xx=Mt(),Ex=Se(),Cx=$n(),$f=Nt(),Ix=ve(),Ox=gr(),Lf=Ve(),mo=Ix("Promise"),Vf="AsyncFromSyncIterator",Rx=$f.set,jf=$f.getterFor(Vf),Df=function(t,e,r){var n=t.done;mo.resolve(t.value).then(function(i){e(Lf(i,n))},r)},Bf=function(e){e.type=Vf,Rx(this,e)};Bf.prototype=Cx(xx(Ox),{next:function(){var e=jf(this);return new mo(function(r,n){var i=Ff(Mf(e.next,e.iterator));Df(i,r,n)})},return:function(){var t=jf(this).iterator;return new mo(function(e,r){var n=Ex(t,"return");if(n===void 0)return e(Lf(void 0,!0));var i=Ff(Mf(n,t));Df(i,e,r)})}});Uf.exports=Bf});var go=h((hN,Wf)=>{"use strict";var Tx=P(),Px=U(),Qf=I(),zf=j(),Ax=jt(),kx=Se(),Nx=G(),qx=Sr(),_x=Nx("asyncIterator");Wf.exports=function(t){var e=Qf(t),r=!0,n=kx(e,_x),i;return Px(n)||(n=Ax(e),r=!1),n!==void 0?i=Tx(n,e):(i=e,r=!0),Qf(i),zf(r?i:new qx(zf(i)))}});var Hf=h(()=>{"use strict";var Mx=O(),Kf=P(),Fx=Q(),xr=I(),jx=Z(),Dx=j(),$x=gt(),Gf=Ve(),Lx=go(),Vx=Ft(),Bx=z(),Ux=$x(function(t){var e=this,r=e.iterator,n=e.mapper;return new t(function(i,s){var o=function(l){e.done=!0,s(l)},a=function(l){Vx(r,o,l,o)},c=function(){try{t.resolve(xr(Kf(e.next,r))).then(function(l){try{if(xr(l).done)e.done=!0,i(Gf(void 0,!0));else{var f=l.value;try{var d=n(f,e.counter++),p=function(m){try{e.inner=Lx(m),u()}catch(y){a(y)}};jx(d)?t.resolve(d).then(p,a):p(d)}catch(m){a(m)}}}catch(m){o(m)}},o)}catch(l){o(l)}},u=function(){var l=e.inner;if(l)try{t.resolve(xr(Kf(l.next,l.iterator))).then(function(f){try{xr(f).done?(e.inner=null,c()):i(Gf(f.value,!1))}catch(d){a(d)}},a)}catch(f){a(f)}else c()};u()})});Mx({target:"AsyncIterator",proto:!0,real:!0,forced:Bx},{flatMap:function(e){return xr(this),Fx(e),new Ux(Dx(this),{mapper:e,inner:null})}})});var Yf=h(()=>{"use strict";var Qx=O(),zx=vt().forEach;Qx({target:"AsyncIterator",proto:!0,real:!0},{forEach:function(e){return zx(this,e)}})});var vo=h((vN,Jf)=>{"use strict";var Wx=P(),Kx=gt();Jf.exports=Kx(function(){return Wx(this.next,this.iterator)},!0)});var Xf=h(()=>{"use strict";var Gx=O(),Hx=At(),Yx=ht(),Jx=go(),Xx=gr(),Zx=vo(),eE=z();Gx({target:"AsyncIterator",stat:!0,forced:eE},{from:function(e){var r=Jx(typeof e=="string"?Hx(e):e);return Yx(Xx,r.iterator)?r.iterator:new Zx(r)}})});var bo=h((SN,ed)=>{"use strict";var tE=P(),rE=Q(),wo=I(),nE=Z(),iE=j(),sE=gt(),Zf=Ve(),oE=Ft(),aE=sE(function(t){var e=this,r=e.iterator,n=e.mapper;return new t(function(i,s){var o=function(c){e.done=!0,s(c)},a=function(c){oE(r,o,c,o)};t.resolve(wo(tE(e.next,r))).then(function(c){try{if(wo(c).done)e.done=!0,i(Zf(void 0,!0));else{var u=c.value;try{var l=n(u,e.counter++),f=function(d){i(Zf(d,!1))};nE(l)?t.resolve(l).then(f,a):f(l)}catch(d){a(d)}}}catch(d){o(d)}},o)})});ed.exports=function(e){return wo(this),rE(e),new aE(iE(this),{mapper:e})}});var td=h(()=>{"use strict";var cE=O(),uE=bo(),lE=z();cE({target:"AsyncIterator",proto:!0,real:!0,forced:lE},{map:uE})});var rd=h(()=>{"use strict";var fE=O(),dE=P(),hE=Q(),So=I(),pE=Z(),yE=ve(),mE=j(),gE=Ft(),xo=yE("Promise"),vE=TypeError;fE({target:"AsyncIterator",proto:!0,real:!0},{reduce:function(e){So(this),hE(e);var r=mE(this),n=r.iterator,i=r.next,s=arguments.length<2,o=s?void 0:arguments[1],a=0;return new xo(function(c,u){var l=function(d){gE(n,u,d,u)},f=function(){try{xo.resolve(So(dE(i,n))).then(function(d){try{if(So(d).done)s?u(new vE("Reduce of empty iterator with no initial value")):c(o);else{var p=d.value;if(s)s=!1,o=p,f();else try{var m=e(o,p,a),y=function(w){o=w,f()};pE(m)?xo.resolve(m).then(y,l):y(m)}catch(w){l(w)}}a++}catch(w){u(w)}},u)}catch(d){u(d)}};f()})}})});var nd=h(()=>{"use strict";var wE=O(),bE=vt().some;wE({target:"AsyncIterator",proto:!0,real:!0},{some:function(e){return bE(this,e)}})});var od=h(()=>{"use strict";var SE=O(),id=P(),sd=I(),xE=j(),EE=vr(),CE=wr(),IE=gt(),Eo=Ve(),OE=z(),RE=IE(function(t){var e=this,r=e.iterator,n;if(!e.remaining--){var i=Eo(void 0,!0);return e.done=!0,n=r.return,n!==void 0?t.resolve(id(n,r,void 0)).then(function(){return i}):i}return t.resolve(id(e.next,r)).then(function(s){return sd(s).done?(e.done=!0,Eo(void 0,!0)):Eo(s.value,!1)}).then(null,function(s){throw e.done=!0,s})});SE({target:"AsyncIterator",proto:!0,real:!0,forced:OE},{take:function(e){sd(this);var r=CE(EE(+e));return new RE(xE(this),{remaining:r})}})});var ad=h(()=>{"use strict";var TE=O(),PE=vt().toArray;TE({target:"AsyncIterator",proto:!0,real:!0},{toArray:function(){return PE(this,void 0,[])}})});var Co=h((NN,ud)=>{"use strict";var cd=Zs(),AE=Pe();ud.exports=function(t,e,r){return r.get&&cd(r.get,e,{getter:!0}),r.set&&cd(r.set,e,{setter:!0}),AE.f(t,e,r)}});var fd=h((qN,ld)=>{"use strict";var kE=ge(),NE=Pe(),qE=vn();ld.exports=function(t,e,r){kE?NE.f(t,e,qE(0,r)):t[e]=r}});var Un=h((_N,pd)=>{"use strict";var _E=ne(),ME=U(),FE=Z(),jE=Mt(),dd=_t(),DE=qt(),$E=G(),LE=z(),Ro=$E("iterator"),hd=!1,Be,Io,Oo;[].keys&&(Oo=[].keys(),"next"in Oo?(Io=dd(dd(Oo)),Io!==Object.prototype&&(Be=Io)):hd=!0);var VE=!FE(Be)||_E(function(){var t={};return Be[Ro].call(t)!==t});VE?Be={}:LE&&(Be=jE(Be));ME(Be[Ro])||DE(Be,Ro,function(){return this});pd.exports={IteratorPrototype:Be,BUGGY_SAFARI_ITERATORS:hd}});var bd=h(()=>{"use strict";var BE=O(),UE=B(),QE=ro(),zE=I(),WE=U(),KE=_t(),GE=Co(),HE=fd(),YE=ne(),Ao=ue(),JE=G(),Ne=Un().IteratorPrototype,XE=ge(),ZE=z(),To="constructor",md="Iterator",yd=JE("toStringTag"),gd=TypeError,Po=UE[md],vd=ZE||!WE(Po)||Po.prototype!==Ne||!YE(function(){Po({})}),ko=function(){if(QE(this,Ne),KE(this)===Ne)throw new gd("Abstract class Iterator not directly constructable")},wd=function(t,e){XE?GE(Ne,t,{configurable:!0,get:function(){return e},set:function(r){if(zE(this),this===Ne)throw new gd("You can't redefine this property");Ao(this,t)?this[t]=r:HE(this,t,r)}}):Ne[t]=e};Ao(Ne,yd)||wd(yd,md);(vd||!Ao(Ne,To)||Ne[To]===Object)&&wd(To,ko);ko.prototype=Ne;BE({global:!0,constructor:!0,forced:vd},{Iterator:ko})});var Sd=h(()=>{"use strict";bd()});var wt=h(($N,Rd)=>{"use strict";var eC=P(),tC=Mt(),rC=pt(),nC=$n(),iC=G(),xd=Nt(),sC=Se(),oC=Un().IteratorPrototype,Qn=Ve(),No=mt(),aC=iC("toStringTag"),Ed="IteratorHelper",Cd="WrapForValidIterator",cC=xd.set,Id=function(t){var e=xd.getterFor(t?Cd:Ed);return nC(tC(oC),{next:function(){var n=e(this);if(t)return n.nextHandler();if(n.done)return Qn(void 0,!0);try{var i=n.nextHandler();return n.returnHandlerResult?i:Qn(i,n.done)}catch(s){throw n.done=!0,s}},return:function(){var r=e(this),n=r.iterator;if(r.done=!0,t){var i=sC(n,"return");return i?eC(i,n):Qn(void 0,!0)}if(r.inner)try{No(r.inner.iterator,"normal")}catch(s){return No(n,"throw",s)}return n&&No(n,"normal"),Qn(void 0,!0)}})},uC=Id(!0),Od=Id(!1);rC(Od,aC,"Iterator Helper");Rd.exports=function(t,e,r){var n=function(s,o){o?(o.iterator=s.iterator,o.next=s.next):o=s,o.type=e?Cd:Ed,o.returnHandlerResult=!!r,o.nextHandler=t,o.counter=0,o.done=!1,cC(this,o)};return n.prototype=e?uC:Od,n}});var Pd=h(()=>{"use strict";var lC=O(),Td=P(),qo=I(),fC=j(),dC=vr(),hC=wr(),pC=wt(),yC=z(),mC=pC(function(){for(var t=this.iterator,e=this.next,r,n;this.remaining;)if(this.remaining--,r=qo(Td(e,t)),n=this.done=!!r.done,n)return;if(r=qo(Td(e,t)),n=this.done=!!r.done,!n)return r.value});lC({target:"Iterator",proto:!0,real:!0,forced:yC},{drop:function(e){qo(this);var r=hC(dC(+e));return new mC(fC(this),{remaining:r})}})});var Ad=h(()=>{"use strict";Pd()});var Nd=h((QN,kd)=>{"use strict";var gC=wn(),vC=ie();kd.exports=function(t){if(gC(t)==="Function")return vC(t)}});var _o=h((zN,_d)=>{"use strict";var qd=Nd(),wC=Q(),bC=mn(),SC=qd(qd.bind);_d.exports=function(t,e){return wC(t),e===void 0?t:bC?SC(t,e):function(){return t.apply(e,arguments)}}});var Fd=h((WN,Md)=>{"use strict";var xC=G(),EC=yo(),CC=xC("iterator"),IC=Array.prototype;Md.exports=function(t){return t!==void 0&&(EC.Array===t||IC[CC]===t)}});var zn=h((KN,jd)=>{"use strict";var OC=P(),RC=Q(),TC=I(),PC=Pt(),AC=jt(),kC=TypeError;jd.exports=function(t,e){var r=arguments.length<2?AC(t):e;if(RC(r))return TC(OC(r,t));throw new kC(PC(t)+" is not iterable")}});var bt=h((GN,Vd)=>{"use strict";var NC=_o(),qC=P(),_C=I(),MC=Pt(),FC=Fd(),jC=qn(),Dd=ht(),DC=zn(),$C=jt(),$d=mt(),LC=TypeError,Wn=function(t,e){this.stopped=t,this.result=e},Ld=Wn.prototype;Vd.exports=function(t,e,r){var n=r&&r.that,i=!!(r&&r.AS_ENTRIES),s=!!(r&&r.IS_RECORD),o=!!(r&&r.IS_ITERATOR),a=!!(r&&r.INTERRUPTED),c=NC(e,n),u,l,f,d,p,m,y,w=function(b){return u&&$d(u,"normal",b),new Wn(!0,b)},E=function(b){return i?(_C(b),a?c(b[0],b[1],w):c(b[0],b[1])):a?c(b,w):c(b)};if(s)u=t.iterator;else if(o)u=t;else{if(l=$C(t),!l)throw new LC(MC(t)+" is not iterable");if(FC(l)){for(f=0,d=jC(t);d>f;f++)if(p=E(t[f]),p&&Dd(Ld,p))return p;return new Wn(!1)}u=DC(t,l)}for(m=s?t.next:u.next;!(y=qC(m,u)).done;){try{p=E(y.value)}catch(b){$d(u,"throw",b)}if(typeof p=="object"&&p&&Dd(Ld,p))return p}return new Wn(!1)}});var Bd=h(()=>{"use strict";var VC=O(),BC=bt(),UC=Q(),QC=I(),zC=j();VC({target:"Iterator",proto:!0,real:!0},{every:function(e){QC(this),UC(e);var r=zC(this),n=0;return!BC(r,function(i,s){if(!e(i,n++))return s()},{IS_RECORD:!0,INTERRUPTED:!0}).stopped}})});var Ud=h(()=>{"use strict";Bd()});var Mo=h((ZN,Qd)=>{"use strict";var WC=I(),KC=mt();Qd.exports=function(t,e,r,n){try{return n?e(WC(r)[0],r[1]):e(r)}catch(i){KC(t,"throw",i)}}});var Wd=h(()=>{"use strict";var GC=O(),HC=P(),YC=Q(),zd=I(),JC=j(),XC=wt(),ZC=Mo(),eI=z(),tI=XC(function(){for(var t=this.iterator,e=this.predicate,r=this.next,n,i,s;;){if(n=zd(HC(r,t)),i=this.done=!!n.done,i)return;if(s=n.value,ZC(t,e,[s,this.counter++],!0))return s}});GC({target:"Iterator",proto:!0,real:!0,forced:eI},{filter:function(e){return zd(this),YC(e),new tI(JC(this),{predicate:e})}})});var Kd=h(()=>{"use strict";Wd()});var Gd=h(()=>{"use strict";var rI=O(),nI=bt(),iI=Q(),sI=I(),oI=j();rI({target:"Iterator",proto:!0,real:!0},{find:function(e){sI(this),iI(e);var r=oI(this),n=0;return nI(r,function(i,s){if(e(i,n++))return s(i)},{IS_RECORD:!0,INTERRUPTED:!0}).result}})});var Hd=h(()=>{"use strict";Gd()});var Fo=h((cq,Jd)=>{"use strict";var aI=P(),Yd=I(),cI=j(),uI=jt();Jd.exports=function(t,e){(!e||typeof t!="string")&&Yd(t);var r=uI(t);return cI(Yd(r!==void 0?aI(r,t):t))}});var eh=h(()=>{"use strict";var lI=O(),Xd=P(),fI=Q(),jo=I(),dI=j(),hI=Fo(),pI=wt(),Zd=mt(),yI=z(),mI=pI(function(){for(var t=this.iterator,e=this.mapper,r,n;;){if(n=this.inner)try{if(r=jo(Xd(n.next,n.iterator)),!r.done)return r.value;this.inner=null}catch(i){Zd(t,"throw",i)}if(r=jo(Xd(this.next,t)),this.done=!!r.done)return;try{this.inner=hI(e(r.value,this.counter++),!1)}catch(i){Zd(t,"throw",i)}}});lI({target:"Iterator",proto:!0,real:!0,forced:yI},{flatMap:function(e){return jo(this),fI(e),new mI(dI(this),{mapper:e,inner:null})}})});var th=h(()=>{"use strict";eh()});var rh=h(()=>{"use strict";var gI=O(),vI=bt(),wI=Q(),bI=I(),SI=j();gI({target:"Iterator",proto:!0,real:!0},{forEach:function(e){bI(this),wI(e);var r=SI(this),n=0;vI(r,function(i){e(i,n++)},{IS_RECORD:!0})}})});var nh=h(()=>{"use strict";rh()});var ih=h(()=>{"use strict";var xI=O(),EI=P(),CI=At(),II=ht(),OI=Un().IteratorPrototype,RI=wt(),TI=Fo(),PI=z(),AI=RI(function(){return EI(this.next,this.iterator)},!0);xI({target:"Iterator",stat:!0,forced:PI},{from:function(e){var r=TI(typeof e=="string"?CI(e):e,!0);return II(OI,r.iterator)?r.iterator:new AI(r)}})});var sh=h(()=>{"use strict";ih()});var Do=h((Sq,ah)=>{"use strict";var kI=P(),NI=Q(),oh=I(),qI=j(),_I=wt(),MI=Mo(),FI=_I(function(){var t=this.iterator,e=oh(kI(this.next,t)),r=this.done=!!e.done;if(!r)return MI(t,this.mapper,[e.value,this.counter++],!0)});ah.exports=function(e){return oh(this),NI(e),new FI(qI(this),{mapper:e})}});var ch=h(()=>{"use strict";var jI=O(),DI=Do(),$I=z();jI({target:"Iterator",proto:!0,real:!0,forced:$I},{map:DI})});var uh=h(()=>{"use strict";ch()});var lh=h(()=>{"use strict";var LI=O(),VI=bt(),BI=Q(),UI=I(),QI=j(),zI=TypeError;LI({target:"Iterator",proto:!0,real:!0},{reduce:function(e){UI(this),BI(e);var r=QI(this),n=arguments.length<2,i=n?void 0:arguments[1],s=0;if(VI(r,function(o){n?(n=!1,i=o):i=e(i,o,s),s++},{IS_RECORD:!0}),n)throw new zI("Reduce of empty iterator with no initial value");return i}})});var fh=h(()=>{"use strict";lh()});var dh=h(()=>{"use strict";var WI=O(),KI=bt(),GI=Q(),HI=I(),YI=j();WI({target:"Iterator",proto:!0,real:!0},{some:function(e){HI(this),GI(e);var r=YI(this),n=0;return KI(r,function(i,s){if(e(i,n++))return s()},{IS_RECORD:!0,INTERRUPTED:!0}).stopped}})});var hh=h(()=>{"use strict";dh()});var yh=h(()=>{"use strict";var JI=O(),XI=P(),ph=I(),ZI=j(),eO=vr(),tO=wr(),rO=wt(),nO=mt(),iO=z(),sO=rO(function(){var t=this.iterator;if(!this.remaining--)return this.done=!0,nO(t,"normal",void 0);var e=ph(XI(this.next,t)),r=this.done=!!e.done;if(!r)return e.value});JI({target:"Iterator",proto:!0,real:!0,forced:iO},{take:function(e){ph(this);var r=tO(eO(+e));return new sO(ZI(this),{remaining:r})}})});var mh=h(()=>{"use strict";yh()});var gh=h(()=>{"use strict";var oO=O(),aO=I(),cO=bt(),uO=j(),lO=[].push;oO({target:"Iterator",proto:!0,real:!0},{toArray:function(){var e=[];return cO(uO(aO(this)),lO,{that:e,IS_RECORD:!0}),e}})});var vh=h(()=>{"use strict";gh()});var bh=h(()=>{"use strict";var fO=O(),dO=I(),hO=Sr(),pO=vo(),wh=j(),yO=z();fO({target:"Iterator",proto:!0,real:!0,forced:yO},{toAsync:function(){return new pO(wh(new hO(wh(dO(this)))))}})});var Sh=h(()=>{"use strict";Zl();wf();Cf();Of();Rf();Hf();Yf();Xf();td();rd();nd();od();ad();Sd();Ad();Ud();Kd();Hd();th();nh();sh();uh();fh();hh();mh();vh();bh()});var $o=h((Wq,xh)=>{"use strict";var mO=P(),gO=bo(),vO=function(t,e){return[e,t]};xh.exports=function(){return mO(gO,this,vO)}});var Eh=h(()=>{"use strict";var wO=O(),bO=$o();wO({target:"AsyncIterator",name:"indexed",proto:!0,real:!0,forced:!0},{asIndexedPairs:bO})});var Ch=h(()=>{"use strict";var SO=O(),xO=$o();SO({target:"AsyncIterator",proto:!0,real:!0,forced:!0},{indexed:xO})});var Lo=h((Jq,Ih)=>{"use strict";var EO=P(),CO=Do(),IO=function(t,e){return[e,t]};Ih.exports=function(){return EO(CO,this,IO)}});var Oh=h(()=>{"use strict";var OO=O(),RO=Lo();OO({target:"Iterator",name:"indexed",proto:!0,real:!0,forced:!0},{asIndexedPairs:RO})});var Rh=h(()=>{"use strict";var TO=O(),PO=Lo();TO({target:"Iterator",proto:!0,real:!0,forced:!0},{indexed:PO})});var Th=h(()=>{"use strict";Sh();Eh();Ch();Oh();Rh()});var kh=h((i_,Ah)=>{"use strict";var Ph=Q(),AO=TypeError,kO=function(t){var e,r;this.promise=new t(function(n,i){if(e!==void 0||r!==void 0)throw new AO("Bad Promise constructor");e=n,r=i}),this.resolve=Ph(e),this.reject=Ph(r)};Ah.exports.f=function(t){return new kO(t)}});var Nh=h(()=>{"use strict";var NO=O(),qO=kh();NO({target:"Promise",stat:!0},{withResolvers:function(){var e=qO.f(this);return{promise:e.promise,resolve:e.resolve,reject:e.reject}}})});var qh=h(()=>{"use strict";Nh()});var _h=h(()=>{"use strict";qh()});var Fh=h((f_,Mh)=>{"use strict";var _O=B();Mh.exports=_O});var Kn=h(jh=>{"use strict";var MO=G();jh.f=MO});var Vo=h((h_,$h)=>{"use strict";var Dh=Fh(),FO=ue(),jO=Kn(),DO=Pe().f;$h.exports=function(t){var e=Dh.Symbol||(Dh.Symbol={});FO(e,t)||DO(e,t,{value:jO.f(t)})}});var Lh=h(()=>{"use strict";var $O=B(),LO=Vo(),VO=Pe().f,BO=pr().f,Bo=$O.Symbol;LO("asyncDispose");Bo&&(Er=BO(Bo,"asyncDispose"),Er.enumerable&&Er.configurable&&Er.writable&&VO(Bo,"asyncDispose",{value:Er.value,enumerable:!1,configurable:!1,writable:!1}));var Er});var Bh=h((m_,Vh)=>{"use strict";Lh();var UO=Kn();Vh.exports=UO.f("asyncDispose")});var Uh=h(()=>{"use strict";var QO=B(),zO=Vo(),WO=Pe().f,KO=pr().f,Uo=QO.Symbol;zO("dispose");Uo&&(Cr=KO(Uo,"dispose"),Cr.enumerable&&Cr.configurable&&Cr.writable&&WO(Uo,"dispose",{value:Cr.value,enumerable:!1,configurable:!1,writable:!1}));var Cr});var zh=h((w_,Qh)=>{"use strict";Uh();var GO=Kn();Qh.exports=GO.f("dispose")});var zo=h((b_,Yh)=>{"use strict";var HO=ie(),YO=ne(),Wh=U(),JO=Bn(),XO=ve(),ZO=Ks(),Kh=function(){},Gh=XO("Reflect","construct"),Qo=/^\s*(?:class|function)\b/,eR=HO(Qo.exec),tR=!Qo.test(Kh),Ir=function(e){if(!Wh(e))return!1;try{return Gh(Kh,[],e),!0}catch{return!1}},Hh=function(e){if(!Wh(e))return!1;switch(JO(e)){case"AsyncFunction":case"GeneratorFunction":case"AsyncGeneratorFunction":return!1}try{return tR||!!eR(Qo,ZO(e))}catch{return!0}};Hh.sham=!0;Yh.exports=!Gh||YO(function(){var t;return Ir(Ir.call)||!Ir(Object)||!Ir(function(){t=!0})||t})?Hh:Ir});var Xh=h((S_,Jh)=>{"use strict";var rR=P(),nR=Sr(),iR=I(),sR=zn(),oR=j(),aR=Se(),cR=G(),uR=cR("asyncIterator");Jh.exports=function(t,e){var r=arguments.length<2?aR(t,uR):e;return r?iR(rR(r,t)):new nR(oR(sR(t)))}});var ep=h((x_,Zh)=>{"use strict";var lR=B();Zh.exports=function(t,e){var r=lR[t],n=r&&r.prototype;return n&&n[e]}});var Wo=h((E_,ip)=>{"use strict";var fR=_o(),tp=ie(),dR=At(),hR=zo(),pR=Xh(),yR=zn(),mR=j(),gR=jt(),vR=Se(),wR=ve(),bR=ep(),SR=G(),xR=Sr(),ER=vt().toArray,CR=SR("asyncIterator"),rp=tp(bR("Array","values")),IR=tp(rp([]).next),OR=function(){return new np(this)},np=function(t){this.iterator=rp(t)};np.prototype.next=function(){return IR(this.iterator)};ip.exports=function(e){var r=this,n=arguments.length,i=n>1?arguments[1]:void 0,s=n>2?arguments[2]:void 0;return new(wR("Promise"))(function(o){var a=dR(e);i!==void 0&&(i=fR(i,s));var c=vR(a,CR),u=c?void 0:gR(a)||OR,l=hR(r)?new r:[],f=c?pR(a,c):new xR(mR(yR(a,u)));o(ER(f,i,l))})}});var op=h(()=>{"use strict";var RR=O(),TR=Wo(),PR=ne(),sp=Array.fromAsync,AR=!sp||PR(function(){var t=0;return sp.call(function(){return t++,[]},{length:0}),t!==1});RR({target:"Array",stat:!0,forced:AR},{fromAsync:TR})});var cp=h((O_,ap)=>{"use strict";var kR=zo(),NR=Pt(),qR=TypeError;ap.exports=function(t){if(kR(t))return t;throw new qR(NR(t)+" is not a constructor")}});var lp=h((R_,up)=>{"use strict";up.exports=typeof ArrayBuffer<"u"&&typeof DataView<"u"});var dp=h((T_,fp)=>{"use strict";var _R=ie(),MR=Q();fp.exports=function(t,e,r){try{return _R(MR(Object.getOwnPropertyDescriptor(t,e)[r]))}catch{}}});var pp=h((P_,hp)=>{"use strict";var FR=Z();hp.exports=function(t){return FR(t)||t===null}});var mp=h((A_,yp)=>{"use strict";var jR=pp(),DR=String,$R=TypeError;yp.exports=function(t){if(jR(t))return t;throw new $R("Can't set "+DR(t)+" as a prototype")}});var vp=h((k_,gp)=>{"use strict";var LR=dp(),VR=Z(),BR=Sn(),UR=mp();gp.exports=Object.setPrototypeOf||("__proto__"in{}?function(){var t=!1,e={},r;try{r=LR(Object.prototype,"__proto__","set"),r(e,[]),t=e instanceof Array}catch{}return function(i,s){return BR(i),UR(s),VR(i)&&(t?r(i,s):i.__proto__=s),i}}():void 0)});var Pp=h((N_,Tp)=>{"use strict";var QR=lp(),Yo=ge(),ee=B(),xp=U(),Yn=Z(),tt=ue(),Jo=Bn(),zR=Pt(),WR=pt(),Ko=qt(),KR=Co(),GR=ht(),Jn=_t(),$t=vp(),HR=G(),YR=Cn(),Ep=Nt(),Cp=Ep.enforce,JR=Ep.get,Gn=ee.Int8Array,Go=Gn&&Gn.prototype,wp=ee.Uint8ClampedArray,bp=wp&&wp.prototype,qe=Gn&&Jn(Gn),Ee=Go&&Jn(Go),XR=Object.prototype,Xo=ee.TypeError,Sp=HR("toStringTag"),Ho=YR("TYPED_ARRAY_TAG"),Hn="TypedArrayConstructor",Ue=QR&&!!$t&&Jo(ee.opera)!=="Opera",Ip=!1,se,et,Dt,Qe={Int8Array:1,Uint8Array:1,Uint8ClampedArray:1,Int16Array:2,Uint16Array:2,Int32Array:4,Uint32Array:4,Float32Array:4,Float64Array:8},Zo={BigInt64Array:8,BigUint64Array:8},ZR=function(e){if(!Yn(e))return!1;var r=Jo(e);return r==="DataView"||tt(Qe,r)||tt(Zo,r)},Op=function(t){var e=Jn(t);if(Yn(e)){var r=JR(e);return r&&tt(r,Hn)?r[Hn]:Op(e)}},Rp=function(t){if(!Yn(t))return!1;var e=Jo(t);return tt(Qe,e)||tt(Zo,e)},eT=function(t){if(Rp(t))return t;throw new Xo("Target is not a typed array")},tT=function(t){if(xp(t)&&(!$t||GR(qe,t)))return t;throw new Xo(zR(t)+" is not a typed array constructor")},rT=function(t,e,r,n){if(Yo){if(r)for(var i in Qe){var s=ee[i];if(s&&tt(s.prototype,t))try{delete s.prototype[t]}catch{try{s.prototype[t]=e}catch{}}}(!Ee[t]||r)&&Ko(Ee,t,r?e:Ue&&Go[t]||e,n)}},nT=function(t,e,r){var n,i;if(Yo){if($t){if(r){for(n in Qe)if(i=ee[n],i&&tt(i,t))try{delete i[t]}catch{}}if(!qe[t]||r)try{return Ko(qe,t,r?e:Ue&&qe[t]||e)}catch{}else return}for(n in Qe)i=ee[n],i&&(!i[t]||r)&&Ko(i,t,e)}};for(se in Qe)et=ee[se],Dt=et&&et.prototype,Dt?Cp(Dt)[Hn]=et:Ue=!1;for(se in Zo)et=ee[se],Dt=et&&et.prototype,Dt&&(Cp(Dt)[Hn]=et);if((!Ue||!xp(qe)||qe===Function.prototype)&&(qe=function(){throw new Xo("Incorrect invocation")},Ue))for(se in Qe)ee[se]&&$t(ee[se],qe);if((!Ue||!Ee||Ee===XR)&&(Ee=qe.prototype,Ue))for(se in Qe)ee[se]&&$t(ee[se].prototype,Ee);Ue&&Jn(bp)!==Ee&&$t(bp,Ee);if(Yo&&!tt(Ee,Sp)){Ip=!0,KR(Ee,Sp,{configurable:!0,get:function(){return Yn(this)?this[Ho]:void 0}});for(se in Qe)ee[se]&&WR(ee[se],Ho,se)}Tp.exports={NATIVE_ARRAY_BUFFER_VIEWS:Ue,TYPED_ARRAY_TAG:Ip&&Ho,aTypedArray:eT,aTypedArrayConstructor:tT,exportTypedArrayMethod:rT,exportTypedArrayStaticMethod:nT,getTypedArrayConstructor:Op,isView:ZR,isTypedArray:Rp,TypedArray:qe,TypedArrayPrototype:Ee}});var kp=h((q_,Ap)=>{"use strict";var iT=qn();Ap.exports=function(t,e,r){for(var n=0,i=arguments.length>2?r:iT(e),s=new t(i);i>n;)s[n]=e[n++];return s}});var qp=h(()=>{"use strict";var sT=ve(),oT=cp(),aT=Wo(),Np=Pp(),cT=kp(),uT=Np.aTypedArrayConstructor,lT=Np.exportTypedArrayStaticMethod;lT("fromAsync",function(e){var r=this,n=arguments.length,i=n>1?arguments[1]:void 0,s=n>2?arguments[2]:void 0;return new(sT("Promise"))(function(o){oT(r),o(aT(e,i,s))}).then(function(o){return cT(uT(r),o)})},!0)});var _p=h(()=>{"use strict";op();qp()});var Fp=h((U_,Mp)=>{function fT({sign:t,exponent:e,mantissa:r}){if(t!==0&&t!==1)throw new Error(`Invalid value for sign: ${t}.`);if(typeof e!="number"||e<0||2047<e)throw new Error(`Invalid value for exponent: ${e}.`);if(typeof r!="number"||r<0||0xfffffffffffff<r)throw new Error(`Invalid value for mantissa: ${r}.`);let n=new ArrayBuffer(8),i=new Float64Array(n),s=new Uint8Array(n);return pT(t,s),mT(e,s),vT(r,s),i[0]}function dT(t){if(typeof t!="number")throw new Error(`Value is not of type number: ${t}.`);let e=new ArrayBuffer(8),r=new Float64Array(e),n=new Uint8Array(e);return r[0]=t,{sign:hT(n),exponent:yT(n),mantissa:gT(n)}}function hT(t){return We(t[7],7)}function pT(t,e){e[7]|=ze(t,7)}function yT(t){let e=0;return e+=ze(t[7]&127,4),e+=We(t[6],4),e}function mT(t,e){e[7]|=We(t,4),e[6]|=ze(t&15,4)}function gT(t){let e=0;return e+=ze(t[6]&15,48),e+=ze(t[5],40),e+=ze(t[4],32),e+=ze(t[3],24),e+=ze(t[2],16),e+=ze(t[1],8),e+=t[0],e}function vT(t,e){e[6]|=We(t,48)&255,e[5]|=We(t,40)&255,e[4]|=We(t,32)&255,e[3]|=We(t,24)&255,e[2]|=We(t,16)&255,e[1]|=We(t,8)&255,e[0]|=t&255}function ze(t,e){return t*Math.pow(2,e)}function We(t,e){return Math.floor(t/Math.pow(2,e))}Mp.exports={MAX_EXPONENT:2047,MAX_MANTISSA:0xfffffffffffff,construct:fT,deconstruct:dT}});var Lp=h((Q_,$p)=>{var rt=Fp(),ta=";",jp=">",Dp="<";function wT(t){if(typeof t!="number")throw new Error(`Value is not of type number: ${t}.`);let{sign:e,exponent:r,mantissa:n}=rt.deconstruct(t),i="";return i+=e===1?Dp:jp,i+=ea(e===1?rt.MAX_EXPONENT-r:r),i+=ea(e===1?rt.MAX_MANTISSA-n:n),i}function ea(t){let e="";t>0&&(e+=ta);let r=t.toString();return r.length>1&&(e+=ea(r.length)),e+=r,e}function bT(t){if(typeof t!="string")throw new Error(`Value is not of type string: ${t}.`);let{signLength:e,sign:r}=ST(t,0),{exponentLength:n,exponent:i}=xT(t,r,e),{mantissaLength:s,mantissa:o}=ET(t,r,e+n);return Ke(t.length===e+n+s,t),rt.construct({sign:r,exponent:i,mantissa:o})}function ST(t,e){if(Ke(e<t.length,t),t[e]===jp)return{signLength:1,sign:0};if(t[e]===Dp)return{signLength:1,sign:1};Ke(!1,t)}function xT(t,e,r){if(Ke(r<t.length,t),t[r]==="0")return{exponentLength:1,exponent:e===0?0:rt.MAX_EXPONENT};let n=r,i=0,s,o;for(;t[n]===ta;)i=i+1,n=n+1;for(Ke(i!==0,t),o=1;i>0;)s=o,o=Number.parseInt(t.substr(n,o)),Ke(o>0,t),n=n+s,i=i-1;return{exponentLength:n-r,exponent:e===0?o:rt.MAX_EXPONENT-o}}function ET(t,e,r){if(Ke(r<t.length,t),t[r]==="0")return{mantissaLength:1,mantissa:e===0?0:rt.MAX_MANTISSA};let n=r,i=0,s,o;for(;t[n]===ta;)i=i+1,n=n+1;for(Ke(i!==0,t),o=1;i>0;)s=o,o=Number.parseInt(t.substr(n,o)),Ke(o>0,t),n=n+s,i=i-1;return{mantissaLength:n-r,mantissa:e===0?o:rt.MAX_MANTISSA-o}}function Ke(t,e){if(!t)throw new Error(`Input is not a valid ELEN-encoded number: ${e}.`)}$p.exports={encode:wT,decode:bT}});var uy=h(J=>{"use strict";Object.defineProperty(J,"__esModule",{value:!0});J.uuidv4obj=J.uuidv4=J.uuidv7obj=J.uuidv7=J.V7Generator=J.UUID=void 0;var ti="0123456789abcdef",Tr=class t{constructor(e){this.bytes=e}static ofInner(e){if(e.length!==16)throw new TypeError("not 128-bit length");return new t(e)}static fromFieldsV7(e,r,n,i){if(!Number.isInteger(e)||!Number.isInteger(r)||!Number.isInteger(n)||!Number.isInteger(i)||e<0||r<0||n<0||i<0||e>0xffffffffffff||r>4095||n>1073741823||i>4294967295)throw new RangeError("invalid field value");let s=new Uint8Array(16);return s[0]=e/2**40,s[1]=e/2**32,s[2]=e/2**24,s[3]=e/2**16,s[4]=e/2**8,s[5]=e,s[6]=112|r>>>8,s[7]=r,s[8]=128|n>>>24,s[9]=n>>>16,s[10]=n>>>8,s[11]=n,s[12]=i>>>24,s[13]=i>>>16,s[14]=i>>>8,s[15]=i,new t(s)}static parse(e){var r,n,i,s;let o;switch(e.length){case 32:o=(r=/^[0-9a-f]{32}$/i.exec(e))===null||r===void 0?void 0:r[0];break;case 36:o=(n=/^([0-9a-f]{8})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{12})$/i.exec(e))===null||n===void 0?void 0:n.slice(1,6).join("");break;case 38:o=(i=/^\{([0-9a-f]{8})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{12})\}$/i.exec(e))===null||i===void 0?void 0:i.slice(1,6).join("");break;case 45:o=(s=/^urn:uuid:([0-9a-f]{8})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{12})$/i.exec(e))===null||s===void 0?void 0:s.slice(1,6).join("");break;default:break}if(o){let a=new Uint8Array(16);for(let c=0;c<16;c+=4){let u=parseInt(o.substring(2*c,2*c+8),16);a[c+0]=u>>>24,a[c+1]=u>>>16,a[c+2]=u>>>8,a[c+3]=u}return new t(a)}else throw new SyntaxError("could not parse UUID string")}toString(){let e="";for(let r=0;r<this.bytes.length;r++)e+=ti.charAt(this.bytes[r]>>>4),e+=ti.charAt(this.bytes[r]&15),(r===3||r===5||r===7||r===9)&&(e+="-");return e}toHex(){let e="";for(let r=0;r<this.bytes.length;r++)e+=ti.charAt(this.bytes[r]>>>4),e+=ti.charAt(this.bytes[r]&15);return e}toJSON(){return this.toString()}getVariant(){let e=this.bytes[8]>>>4;if(e<0)throw new Error("unreachable");if(e<=7)return this.bytes.every(r=>r===0)?"NIL":"VAR_0";if(e<=11)return"VAR_10";if(e<=13)return"VAR_110";if(e<=15)return this.bytes.every(r=>r===255)?"MAX":"VAR_RESERVED";throw new Error("unreachable")}getVersion(){return this.getVariant()==="VAR_10"?this.bytes[6]>>>4:void 0}clone(){return new t(this.bytes.slice(0))}equals(e){return this.compareTo(e)===0}compareTo(e){for(let r=0;r<16;r++){let n=this.bytes[r]-e.bytes[r];if(n!==0)return Math.sign(n)}return 0}};J.UUID=Tr;var Pr=class{constructor(e){this.timestamp=0,this.counter=0,this.random=e??AT()}generate(){return this.generateOrResetCore(Date.now(),1e4)}generateOrAbort(){return this.generateOrAbortCore(Date.now(),1e4)}generateOrResetCore(e,r){let n=this.generateOrAbortCore(e,r);return n===void 0&&(this.timestamp=0,n=this.generateOrAbortCore(e,r)),n}generateOrAbortCore(e,r){if(!Number.isInteger(e)||e<1||e>0xffffffffffff)throw new RangeError("`unixTsMs` must be a 48-bit positive integer");if(r<0||r>0xffffffffffff)throw new RangeError("`rollbackAllowance` out of reasonable range");if(e>this.timestamp)this.timestamp=e,this.resetCounter();else if(e+r>=this.timestamp)this.counter++,this.counter>4398046511103&&(this.timestamp++,this.resetCounter());else return;return Tr.fromFieldsV7(this.timestamp,Math.trunc(this.counter/2**30),this.counter&2**30-1,this.random.nextUint32())}resetCounter(){this.counter=this.random.nextUint32()*1024+(this.random.nextUint32()&1023)}generateV4(){let e=new Uint8Array(Uint32Array.of(this.random.nextUint32(),this.random.nextUint32(),this.random.nextUint32(),this.random.nextUint32()).buffer);return e[6]=64|e[6]>>>4,e[8]=128|e[8]>>>2,Tr.ofInner(e)}};J.V7Generator=Pr;var AT=()=>{if(typeof crypto<"u"&&typeof crypto.getRandomValues<"u")return new ca;if(typeof UUIDV7_DENY_WEAK_RNG<"u"&&UUIDV7_DENY_WEAK_RNG)throw new Error("no cryptographically strong RNG available");return{nextUint32:()=>Math.trunc(Math.random()*65536)*65536+Math.trunc(Math.random()*65536)}},ca=class{constructor(){this.buffer=new Uint32Array(8),this.cursor=65535}nextUint32(){return this.cursor>=this.buffer.length&&(crypto.getRandomValues(this.buffer),this.cursor=0),this.buffer[this.cursor++]}},ri,kT=()=>(0,J.uuidv7obj)().toString();J.uuidv7=kT;var NT=()=>(ri||(ri=new Pr)).generate();J.uuidv7obj=NT;var qT=()=>(0,J.uuidv4obj)().toString();J.uuidv4=qT;var _T=()=>(ri||(ri=new Pr)).generateV4();J.uuidv4obj=_T});var dy={};ac(dy,{UUID:()=>Ar,V7Generator:()=>kr,uuidv4:()=>jT,uuidv4obj:()=>fy,uuidv7:()=>FT,uuidv7obj:()=>ly});var ni,Ar,kr,MT,ua,ii,FT,ly,jT,fy,hy=yg(()=>{ni="0123456789abcdef",Ar=class t{constructor(e){this.bytes=e}static ofInner(e){if(e.length!==16)throw new TypeError("not 128-bit length");return new t(e)}static fromFieldsV7(e,r,n,i){if(!Number.isInteger(e)||!Number.isInteger(r)||!Number.isInteger(n)||!Number.isInteger(i)||e<0||r<0||n<0||i<0||e>0xffffffffffff||r>4095||n>1073741823||i>4294967295)throw new RangeError("invalid field value");let s=new Uint8Array(16);return s[0]=e/2**40,s[1]=e/2**32,s[2]=e/2**24,s[3]=e/2**16,s[4]=e/2**8,s[5]=e,s[6]=112|r>>>8,s[7]=r,s[8]=128|n>>>24,s[9]=n>>>16,s[10]=n>>>8,s[11]=n,s[12]=i>>>24,s[13]=i>>>16,s[14]=i>>>8,s[15]=i,new t(s)}static parse(e){var r,n,i,s;let o;switch(e.length){case 32:o=(r=/^[0-9a-f]{32}$/i.exec(e))===null||r===void 0?void 0:r[0];break;case 36:o=(n=/^([0-9a-f]{8})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{12})$/i.exec(e))===null||n===void 0?void 0:n.slice(1,6).join("");break;case 38:o=(i=/^\{([0-9a-f]{8})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{12})\}$/i.exec(e))===null||i===void 0?void 0:i.slice(1,6).join("");break;case 45:o=(s=/^urn:uuid:([0-9a-f]{8})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{12})$/i.exec(e))===null||s===void 0?void 0:s.slice(1,6).join("");break;default:break}if(o){let a=new Uint8Array(16);for(let c=0;c<16;c+=4){let u=parseInt(o.substring(2*c,2*c+8),16);a[c+0]=u>>>24,a[c+1]=u>>>16,a[c+2]=u>>>8,a[c+3]=u}return new t(a)}else throw new SyntaxError("could not parse UUID string")}toString(){let e="";for(let r=0;r<this.bytes.length;r++)e+=ni.charAt(this.bytes[r]>>>4),e+=ni.charAt(this.bytes[r]&15),(r===3||r===5||r===7||r===9)&&(e+="-");return e}toHex(){let e="";for(let r=0;r<this.bytes.length;r++)e+=ni.charAt(this.bytes[r]>>>4),e+=ni.charAt(this.bytes[r]&15);return e}toJSON(){return this.toString()}getVariant(){let e=this.bytes[8]>>>4;if(e<0)throw new Error("unreachable");if(e<=7)return this.bytes.every(r=>r===0)?"NIL":"VAR_0";if(e<=11)return"VAR_10";if(e<=13)return"VAR_110";if(e<=15)return this.bytes.every(r=>r===255)?"MAX":"VAR_RESERVED";throw new Error("unreachable")}getVersion(){return this.getVariant()==="VAR_10"?this.bytes[6]>>>4:void 0}clone(){return new t(this.bytes.slice(0))}equals(e){return this.compareTo(e)===0}compareTo(e){for(let r=0;r<16;r++){let n=this.bytes[r]-e.bytes[r];if(n!==0)return Math.sign(n)}return 0}},kr=class{constructor(e){this.timestamp=0,this.counter=0,this.random=e??MT()}generate(){return this.generateOrResetCore(Date.now(),1e4)}generateOrAbort(){return this.generateOrAbortCore(Date.now(),1e4)}generateOrResetCore(e,r){let n=this.generateOrAbortCore(e,r);return n===void 0&&(this.timestamp=0,n=this.generateOrAbortCore(e,r)),n}generateOrAbortCore(e,r){if(!Number.isInteger(e)||e<1||e>0xffffffffffff)throw new RangeError("`unixTsMs` must be a 48-bit positive integer");if(r<0||r>0xffffffffffff)throw new RangeError("`rollbackAllowance` out of reasonable range");if(e>this.timestamp)this.timestamp=e,this.resetCounter();else if(e+r>=this.timestamp)this.counter++,this.counter>4398046511103&&(this.timestamp++,this.resetCounter());else return;return Ar.fromFieldsV7(this.timestamp,Math.trunc(this.counter/2**30),this.counter&2**30-1,this.random.nextUint32())}resetCounter(){this.counter=this.random.nextUint32()*1024+(this.random.nextUint32()&1023)}generateV4(){let e=new Uint8Array(Uint32Array.of(this.random.nextUint32(),this.random.nextUint32(),this.random.nextUint32(),this.random.nextUint32()).buffer);return e[6]=64|e[6]>>>4,e[8]=128|e[8]>>>2,Ar.ofInner(e)}},MT=()=>{if(typeof crypto<"u"&&typeof crypto.getRandomValues<"u")return new ua;if(typeof UUIDV7_DENY_WEAK_RNG<"u"&&UUIDV7_DENY_WEAK_RNG)throw new Error("no cryptographically strong RNG available");return{nextUint32:()=>Math.trunc(Math.random()*65536)*65536+Math.trunc(Math.random()*65536)}},ua=class{constructor(){this.buffer=new Uint32Array(8),this.cursor=65535}nextUint32(){return this.cursor>=this.buffer.length&&(crypto.getRandomValues(this.buffer),this.cursor=0),this.buffer[this.cursor++]}},FT=()=>ly().toString(),ly=()=>(ii||(ii=new kr)).generate(),jT=()=>fy().toString(),fy=()=>(ii||(ii=new kr)).generateV4()});var nm=h(de=>{"use strict";var UP=de&&de.__extends||function(){var t=function(e,r){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,i){n.__proto__=i}||function(n,i){for(var s in i)Object.prototype.hasOwnProperty.call(i,s)&&(n[s]=i[s])},t(e,r)};return function(e,r){if(typeof r!="function"&&r!==null)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");t(e,r);function n(){this.constructor=e}e.prototype=r===null?Object.create(r):(n.prototype=r.prototype,new n)}}();Object.defineProperty(de,"__esModule",{value:!0});de.EmptyBTree=de.asSet=de.simpleComparator=de.defaultComparator=void 0;function em(t,e){if(Number.isFinite(t)&&Number.isFinite(e))return t-e;var r=typeof t,n=typeof e;if(r!==n)return r<n?-1:1;if(r==="object"){if(t===null)return e===null?0:-1;if(e===null)return 1;if(t=t.valueOf(),e=e.valueOf(),r=typeof t,n=typeof e,r!==n)return r<n?-1:1}return t<e?-1:t>e?1:t===e?0:Number.isNaN(t)?Number.isNaN(e)?0:-1:Number.isNaN(e)?1:Array.isArray(t)?0:Number.NaN}de.defaultComparator=em;function QP(t,e){return t>e?1:t<e?-1:0}de.simpleComparator=QP;var $e=function(){function t(e,r,n){this._root=ka,this._size=0,this._maxNodeSize=n>=4?Math.min(n,256):32,this._compare=r||em,e&&this.setPairs(e)}return Object.defineProperty(t.prototype,"size",{get:function(){return this._size},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"length",{get:function(){return this._size},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isEmpty",{get:function(){return this._size===0},enumerable:!1,configurable:!0}),t.prototype.clear=function(){this._root=ka,this._size=0},t.prototype.forEach=function(e,r){var n=this;return r!==void 0&&(e=e.bind(r)),this.forEachPair(function(i,s){return e(s,i,n)})},t.prototype.forEachPair=function(e,r){var n=this.minKey(),i=this.maxKey();return this.forRange(n,i,!0,e,r)},t.prototype.get=function(e,r){return this._root.get(e,r,this)},t.prototype.set=function(e,r,n){this._root.isShared&&(this._root=this._root.clone());var i=this._root.set(e,r,n,this);return i===!0||i===!1?i:(this._root=new WP([this._root,i]),!0)},t.prototype.has=function(e){return this.forRange(e,e,!0,void 0)!==0},t.prototype.delete=function(e){return this.editRange(e,e,!0,Xy)!==0},t.prototype.with=function(e,r,n){var i=this.clone();return i.set(e,r,n)||n?i:this},t.prototype.withPairs=function(e,r){var n=this.clone();return n.setPairs(e,r)!==0||r?n:this},t.prototype.withKeys=function(e,r){for(var n=this.clone(),i=!1,s=0;s<e.length;s++)i=n.set(e[s],void 0,!1)||i;return r&&!i?this:n},t.prototype.without=function(e,r){return this.withoutRange(e,e,!0,r)},t.prototype.withoutKeys=function(e,r){var n=this.clone();return n.deleteKeys(e)||!r?n:this},t.prototype.withoutRange=function(e,r,n,i){var s=this.clone();return s.deleteRange(e,r,n)===0&&i?this:s},t.prototype.filter=function(e,r){var n=this.greedyClone(),i;return n.editAll(function(s,o,a){if(!e(s,o,a))return i=rm}),!i&&r?this:n},t.prototype.mapValues=function(e){var r={},n=this.greedyClone();return n.editAll(function(i,s,o){return r.value=e(s,i,o),r}),n},t.prototype.reduce=function(e,r){for(var n=0,i=r,s=this.entries(this.minKey(),Hr),o;!(o=s.next()).done;)i=e(i,o.value,n++,this);return i},t.prototype.entries=function(e,r){var n=this.findPath(e);if(n===void 0)return Xt();var i=n.nodequeue,s=n.nodeindex,o=n.leaf,a=r!==void 0?1:0,c=e===void 0?-1:o.indexOf(e,0,this._compare)-1;return Xt(function(){e:for(;;)switch(a){case 0:if(++c<o.keys.length)return{done:!1,value:[o.keys[c],o.values[c]]};a=2;continue;case 1:if(++c<o.keys.length)return r[0]=o.keys[c],r[1]=o.values[c],{done:!1,value:r};a=2;case 2:for(var u=-1;;){if(++u>=i.length){a=3;continue e}if(++s[u]<i[u].length)break}for(;u>0;u--)i[u-1]=i[u][s[u]].children,s[u-1]=0;o=i[0][s[0]],c=-1,a=r!==void 0?1:0;continue;case 3:return{done:!0,value:void 0}}})},t.prototype.entriesReversed=function(e,r,n){if(e===void 0&&(e=this.maxKey(),n=void 0,e===void 0))return Xt();var i=this.findPath(e)||this.findPath(this.maxKey()),s=i.nodequeue,o=i.nodeindex,a=i.leaf;fe(!s[0]||a===s[0][o[0]],"wat!");var c=a.indexOf(e,0,this._compare);!n&&c<a.keys.length&&this._compare(a.keys[c],e)<=0&&c++;var u=r!==void 0?1:0;return Xt(function(){e:for(;;)switch(u){case 0:if(--c>=0)return{done:!1,value:[a.keys[c],a.values[c]]};u=2;continue;case 1:if(--c>=0)return r[0]=a.keys[c],r[1]=a.values[c],{done:!1,value:r};u=2;case 2:for(var l=-1;;){if(++l>=s.length){u=3;continue e}if(--o[l]>=0)break}for(;l>0;l--)s[l-1]=s[l][o[l]].children,o[l-1]=s[l-1].length-1;a=s[0][o[0]],c=a.keys.length,u=r!==void 0?1:0;continue;case 3:return{done:!0,value:void 0}}})},t.prototype.findPath=function(e){var r=this._root,n,i;if(r.isLeaf)n=Zy,i=Zy;else{n=[],i=[];for(var s=0;!r.isLeaf;s++){if(n[s]=r.children,i[s]=e===void 0?0:r.indexOf(e,0,this._compare),i[s]>=n[s].length)return;r=n[s][i[s]]}n.reverse(),i.reverse()}return{nodequeue:n,nodeindex:i,leaf:r}},t.prototype.diffAgainst=function(e,r,n,i){if(e._compare!==this._compare)throw new Error("Tree comparators are not the same.");if(this.isEmpty||e.isEmpty)return this.isEmpty&&e.isEmpty?void 0:this.isEmpty?n===void 0?void 0:t.stepToEnd(t.makeDiffCursor(e),n):r===void 0?void 0:t.stepToEnd(t.makeDiffCursor(this),r);for(var s=this._compare,o=t.makeDiffCursor(this),a=t.makeDiffCursor(e),c=!0,u=!0,l=t.compare(o,a,s);c&&u;){var f=t.compare(o,a,s),d=o.leaf,p=o.internalSpine,m=o.levelIndices,y=a.leaf,w=a.internalSpine,E=a.levelIndices;if(d||y){if(l!==0){if(f===0){if(d&&y&&i){var b=d.values[m[m.length-1]],re=y.values[E[E.length-1]];if(!Object.is(b,re)){var R=i(o.currentKey,b,re);if(R&&R.break)return R.break}}}else if(f>0){if(y&&n){var Te=y.values[E[E.length-1]],R=n(a.currentKey,Te);if(R&&R.break)return R.break}}else if(r&&d&&l!==0){var b=d.values[m[m.length-1]],R=r(o.currentKey,b);if(R&&R.break)return R.break}}}else if(!d&&!y&&f===0){var k=p.length-1,X=w.length-1,ye=p[k][m[k]],T=w[X][E[X]];if(T===ye){l=0,c=t.step(o,!0),u=t.step(a,!0);continue}}l=f,f<0?c=t.step(o):u=t.step(a)}if(c&&r)return t.finishCursorWalk(o,a,s,r);if(u&&n)return t.finishCursorWalk(a,o,s,n)},t.finishCursorWalk=function(e,r,n,i){var s=t.compare(e,r,n);if(s===0){if(!t.step(e))return}else s<0&&fe(!1,"cursor walk terminated early");return t.stepToEnd(e,i)},t.stepToEnd=function(e,r){for(var n=!0;n;){var i=e.leaf,s=e.levelIndices,o=e.currentKey;if(i){var a=i.values[s[s.length-1]],c=r(o,a);if(c&&c.break)return c.break}n=t.step(e)}},t.makeDiffCursor=function(e){var r=e._root,n=e.height;return{height:n,internalSpine:[[r]],levelIndices:[0],leaf:void 0,currentKey:r.maxKey()}},t.step=function(e,r){var n=e.internalSpine,i=e.levelIndices,s=e.leaf;if(r===!0||s){var o=i.length;if(r===!0||i[o-1]===0){var a=n.length;if(a===0)return!1;for(var c=a-1,u=c;u>=0;){if(i[u]>0)return u<o-1&&(e.leaf=void 0,i.pop()),u<c&&(e.internalSpine=n.slice(0,u+1)),e.currentKey=n[u][--i[u]].maxKey(),!0;u--}return!1}else{var l=--i[o-1];return e.currentKey=s.keys[l],!0}}else{var f=n.length,d=f-1,p=n[d][i[d]];if(p.isLeaf){e.leaf=p;var l=i[f]=p.values.length-1;e.currentKey=p.keys[l]}else{var m=p.children;n[f]=m;var y=m.length-1;i[f]=y,e.currentKey=m[y].maxKey()}return!0}},t.compare=function(e,r,n){var i=e.height,s=e.currentKey,o=e.levelIndices,a=r.height,c=r.currentKey,u=r.levelIndices,l=n(c,s);if(l!==0)return l;var f=i<a?i:a,d=o.length-(i-f),p=u.length-(a-f);return d-p},t.prototype.keys=function(e){var r=this.entries(e,Hr);return Xt(function(){var n=r.next();return n.value&&(n.value=n.value[0]),n})},t.prototype.values=function(e){var r=this.entries(e,Hr);return Xt(function(){var n=r.next();return n.value&&(n.value=n.value[1]),n})},Object.defineProperty(t.prototype,"maxNodeSize",{get:function(){return this._maxNodeSize},enumerable:!1,configurable:!0}),t.prototype.minKey=function(){return this._root.minKey()},t.prototype.maxKey=function(){return this._root.maxKey()},t.prototype.clone=function(){this._root.isShared=!0;var e=new t(void 0,this._compare,this._maxNodeSize);return e._root=this._root,e._size=this._size,e},t.prototype.greedyClone=function(e){var r=new t(void 0,this._compare,this._maxNodeSize);return r._root=this._root.greedyClone(e),r._size=this._size,r},t.prototype.toArray=function(e){e===void 0&&(e=2147483647);var r=this.minKey(),n=this.maxKey();return r!==void 0?this.getRange(r,n,!0,e):[]},t.prototype.keysArray=function(){var e=[];return this._root.forRange(this.minKey(),this.maxKey(),!0,!1,this,0,function(r,n){e.push(r)}),e},t.prototype.valuesArray=function(){var e=[];return this._root.forRange(this.minKey(),this.maxKey(),!0,!1,this,0,function(r,n){e.push(n)}),e},t.prototype.toString=function(){return this.toArray().toString()},t.prototype.setIfNotPresent=function(e,r){return this.set(e,r,!1)},t.prototype.nextHigherPair=function(e,r){return r=r||[],e===void 0?this._root.minPair(r):this._root.getPairOrNextHigher(e,this._compare,!1,r)},t.prototype.nextHigherKey=function(e){var r=this.nextHigherPair(e,Hr);return r&&r[0]},t.prototype.nextLowerPair=function(e,r){return r=r||[],e===void 0?this._root.maxPair(r):this._root.getPairOrNextLower(e,this._compare,!1,r)},t.prototype.nextLowerKey=function(e){var r=this.nextLowerPair(e,Hr);return r&&r[0]},t.prototype.getPairOrNextLower=function(e,r){return this._root.getPairOrNextLower(e,this._compare,!0,r||[])},t.prototype.getPairOrNextHigher=function(e,r){return this._root.getPairOrNextHigher(e,this._compare,!0,r||[])},t.prototype.changeIfPresent=function(e,r){return this.editRange(e,e,!0,function(n,i){return{value:r}})!==0},t.prototype.getRange=function(e,r,n,i){i===void 0&&(i=67108863);var s=[];return this._root.forRange(e,r,n,!1,this,0,function(o,a){return s.push([o,a]),s.length>i?KP:void 0}),s},t.prototype.setPairs=function(e,r){for(var n=0,i=0;i<e.length;i++)this.set(e[i][0],e[i][1],r)&&n++;return n},t.prototype.forRange=function(e,r,n,i,s){var o=this._root.forRange(e,r,n,!1,this,s||0,i);return typeof o=="number"?o:o.break},t.prototype.editRange=function(e,r,n,i,s){var o=this._root;o.isShared&&(this._root=o=o.clone());try{var a=o.forRange(e,r,n,!0,this,s||0,i);return typeof a=="number"?a:a.break}finally{for(var c=void 0;o.keys.length<=1&&!o.isLeaf;)c||(c=o.isShared),this._root=o=o.keys.length===0?ka:o.children[0];c&&(o.isShared=!0)}},t.prototype.editAll=function(e,r){return this.editRange(this.minKey(),this.maxKey(),!0,e,r)},t.prototype.deleteRange=function(e,r,n){return this.editRange(e,r,n,Xy)},t.prototype.deleteKeys=function(e){for(var r=0,n=0;r<e.length;r++)this.delete(e[r])&&n++;return n},Object.defineProperty(t.prototype,"height",{get:function(){for(var e=this._root,r=-1;e;)r++,e=e.isLeaf?void 0:e.children[0];return r},enumerable:!1,configurable:!0}),t.prototype.freeze=function(){var e=this;e.clear=e.set=e.editRange=function(){throw new Error("Attempted to modify a frozen BTree")}},t.prototype.unfreeze=function(){delete this.clear,delete this.set,delete this.editRange},Object.defineProperty(t.prototype,"isFrozen",{get:function(){return this.hasOwnProperty("editRange")},enumerable:!1,configurable:!0}),t.prototype.checkValid=function(){var e=this._root.checkValid(0,this,0);fe(e===this.size,"size mismatch: counted ",e,"but stored",this.size)},t}();de.default=$e;function zP(t){return t}de.asSet=zP;Symbol&&Symbol.iterator&&($e.prototype[Symbol.iterator]=$e.prototype.entries);$e.prototype.where=$e.prototype.filter;$e.prototype.setRange=$e.prototype.setPairs;$e.prototype.add=$e.prototype.set;function Xt(t){t===void 0&&(t=function(){return{done:!0,value:void 0}});var e={next:t};return Symbol&&Symbol.iterator&&(e[Symbol.iterator]=function(){return this}),e}var tm=function(){function t(e,r){e===void 0&&(e=[]),this.keys=e,this.values=r||Y,this.isShared=void 0}return Object.defineProperty(t.prototype,"isLeaf",{get:function(){return this.children===void 0},enumerable:!1,configurable:!0}),t.prototype.maxKey=function(){return this.keys[this.keys.length-1]},t.prototype.indexOf=function(e,r,n){for(var i=this.keys,s=0,o=i.length,a=o>>1;s<o;){var c=n(i[a],e);if(c<0)s=a+1;else if(c>0)o=a;else{if(c===0)return a;if(e===e)return i.length;throw new Error("BTree: NaN was used as a key")}a=s+o>>1}return a^r},t.prototype.minKey=function(){return this.keys[0]},t.prototype.minPair=function(e){if(this.keys.length!==0)return e[0]=this.keys[0],e[1]=this.values[0],e},t.prototype.maxPair=function(e){if(this.keys.length!==0){var r=this.keys.length-1;return e[0]=this.keys[r],e[1]=this.values[r],e}},t.prototype.clone=function(){var e=this.values;return new t(this.keys.slice(0),e===Y?e:e.slice(0))},t.prototype.greedyClone=function(e){return this.isShared&&!e?this:this.clone()},t.prototype.get=function(e,r,n){var i=this.indexOf(e,-1,n._compare);return i<0?r:this.values[i]},t.prototype.getPairOrNextLower=function(e,r,n,i){var s=this.indexOf(e,-1,r),o=s<0?~s-1:n?s:s-1;if(o>=0)return i[0]=this.keys[o],i[1]=this.values[o],i},t.prototype.getPairOrNextHigher=function(e,r,n,i){var s=this.indexOf(e,-1,r),o=s<0?~s:n?s:s+1,a=this.keys;if(o<a.length)return i[0]=a[o],i[1]=this.values[o],i},t.prototype.checkValid=function(e,r,n){var i=this.keys.length,s=this.values.length;return fe(this.values===Y?i<=s:i===s,"keys/values length mismatch: depth",e,"with lengths",i,s,"and baseIndex",n),fe(e==0||i>0,"empty leaf at depth",e,"and baseIndex",n),i},t.prototype.set=function(e,r,n,i){var s=this.indexOf(e,-1,i._compare);if(s<0){if(s=~s,i._size++,this.keys.length<i._maxNodeSize)return this.insertInLeaf(s,e,r,i);var o=this.splitOffRightSide(),a=this;return s>this.keys.length&&(s-=this.keys.length,a=o),a.insertInLeaf(s,e,r,i),o}else return n!==!1&&(r!==void 0&&this.reifyValues(),this.keys[s]=e,this.values[s]=r),!1},t.prototype.reifyValues=function(){return this.values===Y?this.values=this.values.slice(0,this.keys.length):this.values},t.prototype.insertInLeaf=function(e,r,n,i){if(this.keys.splice(e,0,r),this.values===Y){for(;Y.length<i._maxNodeSize;)Y.push(void 0);if(n===void 0)return!0;this.values=Y.slice(0,this.keys.length-1)}return this.values.splice(e,0,n),!0},t.prototype.takeFromRight=function(e){var r=this.values;e.values===Y?r!==Y&&r.push(void 0):(r=this.reifyValues(),r.push(e.values.shift())),this.keys.push(e.keys.shift())},t.prototype.takeFromLeft=function(e){var r=this.values;e.values===Y?r!==Y&&r.unshift(void 0):(r=this.reifyValues(),r.unshift(e.values.pop())),this.keys.unshift(e.keys.pop())},t.prototype.splitOffRightSide=function(){var e=this.keys.length>>1,r=this.keys.splice(e),n=this.values===Y?Y:this.values.splice(e);return new t(r,n)},t.prototype.forRange=function(e,r,n,i,s,o,a){var c=s._compare,u,l;if(r===e){if(!n||(l=(u=this.indexOf(e,-1,c))+1,u<0))return o}else u=this.indexOf(e,0,c),l=this.indexOf(r,-1,c),l<0?l=~l:n===!0&&l++;var f=this.keys,d=this.values;if(a!==void 0)for(var p=u;p<l;p++){var m=f[p],y=a(m,d[p],o++);if(y!==void 0){if(i===!0){if(m!==f[p]||this.isShared===!0)throw new Error("BTree illegally changed or cloned in editRange");y.delete?(this.keys.splice(p,1),this.values!==Y&&this.values.splice(p,1),s._size--,p--,l--):y.hasOwnProperty("value")&&(d[p]=y.value)}if(y.break!==void 0)return y}}else o+=l-u;return o},t.prototype.mergeSibling=function(e,r){if(this.keys.push.apply(this.keys,e.keys),this.values===Y){if(e.values===Y)return;this.values=this.values.slice(0,this.keys.length)}this.values.push.apply(this.values,e.reifyValues())},t}(),WP=function(t){UP(e,t);function e(r,n){var i=this;if(!n){n=[];for(var s=0;s<r.length;s++)n[s]=r[s].maxKey()}return i=t.call(this,n)||this,i.children=r,i}return e.prototype.clone=function(){for(var r=this.children.slice(0),n=0;n<r.length;n++)r[n].isShared=!0;return new e(r,this.keys.slice(0))},e.prototype.greedyClone=function(r){if(this.isShared&&!r)return this;for(var n=new e(this.children.slice(0),this.keys.slice(0)),i=0;i<n.children.length;i++)n.children[i]=n.children[i].greedyClone(r);return n},e.prototype.minKey=function(){return this.children[0].minKey()},e.prototype.minPair=function(r){return this.children[0].minPair(r)},e.prototype.maxPair=function(r){return this.children[this.children.length-1].maxPair(r)},e.prototype.get=function(r,n,i){var s=this.indexOf(r,0,i._compare),o=this.children;return s<o.length?o[s].get(r,n,i):void 0},e.prototype.getPairOrNextLower=function(r,n,i,s){var o=this.indexOf(r,0,n),a=this.children;if(o>=a.length)return this.maxPair(s);var c=a[o].getPairOrNextLower(r,n,i,s);return c===void 0&&o>0?a[o-1].maxPair(s):c},e.prototype.getPairOrNextHigher=function(r,n,i,s){var o=this.indexOf(r,0,n),a=this.children,c=a.length;if(!(o>=c)){var u=a[o].getPairOrNextHigher(r,n,i,s);return u===void 0&&o<c-1?a[o+1].minPair(s):u}},e.prototype.checkValid=function(r,n,i){var s=this.keys.length,o=this.children.length;fe(s===o,"keys/children length mismatch: depth",r,"lengths",s,o,"baseIndex",i),fe(s>1||r>0,"internal node has length",s,"at depth",r,"baseIndex",i);for(var a=0,c=this.children,u=this.keys,l=0,f=0;f<o;f++)a+=c[f].checkValid(r+1,n,i+a),l+=c[f].keys.length,fe(a>=l,"wtf",i),fe(f===0||c[f-1].constructor===c[f].constructor,"type mismatch, baseIndex:",i),c[f].maxKey()!=u[f]&&fe(!1,"keys[",f,"] =",u[f],"is wrong, should be ",c[f].maxKey(),"at depth",r,"baseIndex",i),f===0||n._compare(u[f-1],u[f])<0||fe(!1,"sort violation at depth",r,"index",f,"keys",u[f-1],u[f]);var d=l===0;return(d||l>n.maxNodeSize*o)&&fe(!1,d?"too few":"too many","children (",l,a,") at depth",r,"maxNodeSize:",n.maxNodeSize,"children.length:",o,"baseIndex:",i),a},e.prototype.set=function(r,n,i,s){var o=this.children,a=s._maxNodeSize,c=s._compare,u=Math.min(this.indexOf(r,0,c),o.length-1),l=o[u];if(l.isShared&&(o[u]=l=l.clone()),l.keys.length>=a){var f;u>0&&(f=o[u-1]).keys.length<a&&c(l.keys[0],r)<0?(f.isShared&&(o[u-1]=f=f.clone()),f.takeFromRight(l),this.keys[u-1]=f.maxKey()):(f=o[u+1])!==void 0&&f.keys.length<a&&c(l.maxKey(),r)<0&&(f.isShared&&(o[u+1]=f=f.clone()),f.takeFromLeft(l),this.keys[u]=o[u].maxKey())}var d=l.set(r,n,i,s);if(d===!1)return!1;if(this.keys[u]=l.maxKey(),d===!0)return!0;if(this.keys.length<a)return this.insert(u+1,d),!0;var p=this.splitOffRightSide(),m=this;return c(d.maxKey(),this.maxKey())>0&&(m=p,u-=this.keys.length),m.insert(u+1,d),p},e.prototype.insert=function(r,n){this.children.splice(r,0,n),this.keys.splice(r,0,n.maxKey())},e.prototype.splitOffRightSide=function(){var r=this.children.length>>1;return new e(this.children.splice(r),this.keys.splice(r))},e.prototype.takeFromRight=function(r){this.keys.push(r.keys.shift()),this.children.push(r.children.shift())},e.prototype.takeFromLeft=function(r){this.keys.unshift(r.keys.pop()),this.children.unshift(r.children.pop())},e.prototype.forRange=function(r,n,i,s,o,a,c){var u=o._compare,l=this.keys,f=this.children,d=this.indexOf(r,0,u),p=d,m=Math.min(n===r?d:this.indexOf(n,0,u),l.length-1);if(s){if(p<=m)try{for(;p<=m;p++){f[p].isShared&&(f[p]=f[p].clone());var y=f[p].forRange(r,n,i,s,o,a,c);if(l[p]=f[p].maxKey(),typeof y!="number")return y;a=y}}finally{var w=o._maxNodeSize>>1;for(d>0&&d--,p=m;p>=d;p--)f[p].keys.length<=w&&(f[p].keys.length!==0?this.tryMerge(p,o._maxNodeSize):(l.splice(p,1),f.splice(p,1)));f.length!==0&&f[0].keys.length===0&&fe(!1,"emptiness bug")}}else for(;p<=m;p++){var y=f[p].forRange(r,n,i,s,o,a,c);if(typeof y!="number")return y;a=y}return a},e.prototype.tryMerge=function(r,n){var i=this.children;return r>=0&&r+1<i.length&&i[r].keys.length+i[r+1].keys.length<=n?(i[r].isShared&&(i[r]=i[r].clone()),i[r].mergeSibling(i[r+1],n),i.splice(r+1,1),this.keys.splice(r+1,1),this.keys[r]=i[r].maxKey(),!0):!1},e.prototype.mergeSibling=function(r,n){var i=this.keys.length;this.keys.push.apply(this.keys,r.keys);var s=r.children;if(this.children.push.apply(this.children,s),r.isShared&&!this.isShared)for(var o=0;o<s.length;o++)s[o].isShared=!0;this.tryMerge(i-1,n)},e}(tm),Y=[],rm={delete:!0},Xy=function(){return rm},KP={break:!0},ka=function(){var t=new tm;return t.isShared=!0,t}(),Zy=[],Hr=[];function fe(t){for(var e=[],r=1;r<arguments.length;r++)e[r-1]=arguments[r];if(!t)throw e.unshift("B+ tree"),new Error(e.join(" "))}de.EmptyBTree=function(){var t=new $e;return t.freeze(),t}()});var uc=Symbol("Comlink.proxy"),gg=Symbol("Comlink.endpoint"),vg=Symbol("Comlink.releaseProxy"),ws=Symbol("Comlink.finalizer"),fn=Symbol("Comlink.thrown"),lc=t=>typeof t=="object"&&t!==null||typeof t=="function",wg={canHandle:t=>lc(t)&&t[uc],serialize(t){let{port1:e,port2:r}=new MessageChannel;return lr(t,e),[r,[r]]},deserialize(t){return t.start(),Eg(t)}},bg={canHandle:t=>lc(t)&&fn in t,serialize({value:t}){let e;return t instanceof Error?e={isError:!0,value:{message:t.message,name:t.name,stack:t.stack}}:e={isError:!1,value:t},[e,[]]},deserialize(t){throw t.isError?Object.assign(new Error(t.value.message),t.value):t.value}},fc=new Map([["proxy",wg],["throw",bg]]);function Sg(t,e){for(let r of t)if(e===r||r==="*"||r instanceof RegExp&&r.test(e))return!0;return!1}function lr(t,e=globalThis,r=["*"]){e.addEventListener("message",function n(i){if(!i||!i.data)return;if(!Sg(r,i.origin)){console.warn(`Invalid origin '${i.origin}' for comlink proxy`);return}let{id:s,type:o,path:a}=Object.assign({path:[]},i.data),c=(i.data.argumentList||[]).map(dt),u;try{let l=a.slice(0,-1).reduce((d,p)=>d[p],t),f=a.reduce((d,p)=>d[p],t);switch(o){case"GET":u=f;break;case"SET":l[a.slice(-1)[0]]=dt(i.data.value),u=!0;break;case"APPLY":u=f.apply(l,c);break;case"CONSTRUCT":{let d=new f(...c);u=K(d)}break;case"ENDPOINT":{let{port1:d,port2:p}=new MessageChannel;lr(t,p),u=Rg(d,[d])}break;case"RELEASE":u=void 0;break;default:return}}catch(l){u={value:l,[fn]:0}}Promise.resolve(u).catch(l=>({value:l,[fn]:0})).then(l=>{let[f,d]=pn(l);e.postMessage(Object.assign(Object.assign({},f),{id:s}),d),o==="RELEASE"&&(e.removeEventListener("message",n),dc(e),ws in t&&typeof t[ws]=="function"&&t[ws]())}).catch(l=>{let[f,d]=pn({value:new TypeError("Unserializable return value"),[fn]:0});e.postMessage(Object.assign(Object.assign({},f),{id:s}),d)})}),e.start&&e.start()}function xg(t){return t.constructor.name==="MessagePort"}function dc(t){xg(t)&&t.close()}function Eg(t,e){return bs(t,[],e)}function ln(t){if(t)throw new Error("Proxy has been released and is not useable")}function hc(t){return Tt(t,{type:"RELEASE"}).then(()=>{dc(t)})}var dn=new WeakMap,hn="FinalizationRegistry"in globalThis&&new FinalizationRegistry(t=>{let e=(dn.get(t)||0)-1;dn.set(t,e),e===0&&hc(t)});function Cg(t,e){let r=(dn.get(e)||0)+1;dn.set(e,r),hn&&hn.register(t,e,t)}function Ig(t){hn&&hn.unregister(t)}function bs(t,e=[],r=function(){}){let n=!1,i=new Proxy(r,{get(s,o){if(ln(n),o===vg)return()=>{Ig(i),hc(t),n=!0};if(o==="then"){if(e.length===0)return{then:()=>i};let a=Tt(t,{type:"GET",path:e.map(c=>c.toString())}).then(dt);return a.then.bind(a)}return bs(t,[...e,o])},set(s,o,a){ln(n);let[c,u]=pn(a);return Tt(t,{type:"SET",path:[...e,o].map(l=>l.toString()),value:c},u).then(dt)},apply(s,o,a){ln(n);let c=e[e.length-1];if(c===gg)return Tt(t,{type:"ENDPOINT"}).then(dt);if(c==="bind")return bs(t,e.slice(0,-1));let[u,l]=cc(a);return Tt(t,{type:"APPLY",path:e.map(f=>f.toString()),argumentList:u},l).then(dt)},construct(s,o){ln(n);let[a,c]=cc(o);return Tt(t,{type:"CONSTRUCT",path:e.map(u=>u.toString()),argumentList:a},c).then(dt)}});return Cg(i,t),i}function Og(t){return Array.prototype.concat.apply([],t)}function cc(t){let e=t.map(pn);return[e.map(r=>r[0]),Og(e.map(r=>r[1]))]}var pc=new WeakMap;function Rg(t,e){return pc.set(t,e),t}function K(t){return Object.assign(t,{[uc]:!0})}function pn(t){for(let[e,r]of fc)if(r.canHandle(t)){let[n,i]=r.serialize(t);return[{type:"HANDLER",name:e,value:n},i]}return[{type:"RAW",value:t},pc.get(t)||[]]}function dt(t){switch(t.type){case"HANDLER":return fc.get(t.name).deserialize(t.value);case"RAW":return t.value}}function Tt(t,e,r){return new Promise(n=>{let i=Tg();t.addEventListener("message",function s(o){!o.data||!o.data.id||o.data.id!==i||(t.removeEventListener("message",s),n(o.data))}),t.start&&t.start(),t.postMessage(Object.assign({id:i},e),r)})}function Tg(){return new Array(4).fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-")}function Xe(t,e){let r=Pg(t);return r?(e?.split(".")??[]).reduce((s,o)=>{if(s&&s[o])return s[o]},r):void 0}function Pg(t){if(typeof t!="string")return;let e=t.split(".");if(e.length!==3)return;let r=e[1],n=r.replace(/-/g,"+").replace(/_/g,"/").padEnd(Math.ceil(r.length/4)*4,"=");try{let i=typeof atob=="function"?atob(n):Buffer.from(n,"base64").toString("binary"),s=decodeURIComponent(Array.from(i,o=>"%"+o.charCodeAt(0).toString(16).padStart(2,"0")).join(""));return JSON.parse(s)}catch{return}}function yn(t){return t.exp===void 0?!1:t.exp*1e3<Date.now()}var D_=ft(Th(),1),$_=ft(_h(),1),L_=ft(Bh(),1),V_=ft(zh(),1),B_=ft(_p(),1);var Up=ft(Lp(),1),Or=null;var Xn=class extends Error{constructor(e,r){super((r+": "||"Unreachable: ")+e)}};function ra(t){if(t===null||typeof t!="object")return!1;let e=Object.getPrototypeOf(t);return e===Object.prototype||e===null}function Lt(t,e){return t>e?1:t<e?-1:0}var Ge={null:"b",object:"c",array:"d",number:"e",string:"f",boolean:"g"},Vp=new Map(Object.entries(Ge).sort((t,e)=>t[1]<e[1]?-1:1).map(([t],e)=>[t,e]));function Bp(t){if(t===null)return"null";if(t===!0||t===!1)return"boolean";if(typeof t=="string")return"string";if(typeof t=="number")return"number";if(Array.isArray(t))return"array";if(typeof t=="object")return"object";throw new Xn(t,"Unknown value type")}var z_=Object.fromEntries(Object.entries(Ge).map(([t,e])=>[e,t]));function W(t,e){let r=Bp(t),n=Bp(e);if(r===n){if(r==="array")return Vt(t,e);if(r==="object")return t===e?0:ra(t)?ra(e)?CT(t,e):-1:(ra(e),1);if(r==="boolean")return Lt(t,e);if(r==="null")return 0;if(r==="number")return Lt(t,e);if(r==="string")return Lt(t,e);throw new Xn(r)}return Lt(Vp.get(r),Vp.get(n))}function CT(t,e){let r=Object.entries(t).filter(([s,o])=>o!==void 0).sort(([s],[o])=>Lt(s,o)),n=Object.entries(e).filter(([s,o])=>o!==void 0).sort(([s],[o])=>Lt(s,o)),i=Math.min(r.length,n.length);for(let s=0;s<i;s++){let[o,a]=r[s],[c,u]=n[s],l=W(o,c);if(l===0){let f=W(a,u);if(f===0)continue;return f}return l}return r.length>n.length?1:r.length<n.length?-1:0}function Vt(t,e){let r=Math.min(t.length,e.length);for(let n=0;n<r;n++){let i=W(t[n],e[n]);if(i!==0)return i}return t.length>e.length?1:t.length<e.length?-1:0}function na(t){return{type:"string",config:{enum:t?.enum,nullable:t?.nullable,default:t?.default}}}function Qp(t){return{type:"number",config:{nullable:t?.nullable,default:t?.default}}}function zp(t){return{type:"boolean",config:{nullable:t?.nullable,default:t?.default}}}function Wp(t){return{type:"date",config:{nullable:t?.nullable,default:t?.default}}}function ia(t,e){return{type:"record",config:{nullable:e?.nullable},properties:t}}function Kp(t,e){return{type:"set",items:t,config:{nullable:e?.nullable,default:e?.default}}}function Gp(t){return{type:"json",config:{nullable:t?.nullable,default:t?.default}}}var Zn=class{static Id=(e={format:"nanoid"})=>{let r=Yp[e.format];return na({nullable:!1,default:r()})};static String=na;static Number=Qp;static Boolean=zp;static Date=Wp;static Record=ia;static Set=Kp;static Json=Gp;static RelationMany=(e,r)=>({query:{collectionName:e,...r},cardinality:"many"});static RelationOne=(e,r)=>({query:{collectionName:e,...r},cardinality:"one"});static RelationById=(e,r)=>({query:{collectionName:e,where:[["id","=",r]]},cardinality:"one"});static Schema(e){return ia(e)}static get Default(){return IT}static Optional(e){return{...e,config:e.config?{...e.config,optional:!0}:{optional:!0}}}static Collections(e){return e}static Filter(e){return e}},Hp={now:()=>({func:"now",args:null})},Yp={nanoid:t=>({func:"nanoid",args:t?[t]:null}),uuidv4:()=>({func:"uuidv4",args:null}),uuidv7:()=>({func:"uuidv7",args:null})},IT={Set:{empty:()=>({func:"Set.empty",args:null})},Id:Yp,now:Hp.now,Date:Hp};var Jp=Object.freeze(["string","number","boolean","date"]),Xp=new Set(Jp),OT=Object.freeze(["string","number","boolean","date","set","json"]),Zp=new Set(OT),sa=Object.freeze([...Jp,"set","json","record"]),cM=new Set(sa),ey=Object.freeze(["now","nanoid","uuid","uuidv4","uuidv7","Set.empty"]);var A={};ac(A,{assign:()=>gy,collectionKeyDecode:()=>ha,collectionKeyEncode:()=>oi,decode:()=>ci,defaultValue:()=>da,deserialize:()=>fa,encode:()=>ai,equal:()=>pa,hasConfigurableDefault:()=>by,isOptional:()=>it,isPrimitiveType:()=>Nr,serialize:()=>si,struct:()=>my,supportedOperations:()=>wy,validateEncoded:()=>vy});var ty="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict";var oa=(t=21)=>{let e="",r=crypto.getRandomValues(new Uint8Array(t|=0));for(;t--;)e+=ty[r[t]&63];return e};var Bt=["isDefined"],ei=["=","!=","<",">","<=",">="],ry=["has","!has"],ny=["in","nin"],He="SET_",iy=[...Bt,...ei],RT=[...Bt,...ei],sy=[...Bt,...ei,...ny],oy=[...Bt],TT=aa([...Bt,...ry],He),ay=[...Bt,...ei,...ny,"like","nlike"],PT=Array.from(new Set([...iy,...sy,...ay,...oy,...ry])),nt={boolean:iy,date:RT,json:PT,number:sy,record:oy,set:TT,string:ay};function aa(t,e){return t.map(r=>`${e}${r}`)}function cy(t){if(t==="=")return"=";if(t==="!=")return"!=";if(t==="<")return">";if(t===">")return"<";if(t==="<=")return">=";if(t===">=")return"<=";if(t==="in")return"SET_has";if(t==="nin")return"SET_!has";if(t==="SET_has")return"in";if(t==="SET_!has")return"nin";throw new g(`Cannot flip operator ${t}`)}function v(t){return t==null}function Rr(t){return typeof t=="object"&&t!==null&&"func"in t}var la={};function py(t){if(!la[t])throw new Error(`Optional dependency ${t} has not been loaded or does not exist. You may need to install it.`);return la[t]}async function yy(){la.uuidv7=await DT()}async function DT(){if(typeof oc=="function")try{return uy()}catch{return}try{return await Promise.resolve().then(()=>(hy(),dy))}catch{}}function my(t){switch(t.type){case"record":let e={};for(let r in t.properties)e[r]=my(t.properties[r]);return e;default:return}}function da(t){if(by(t))return $T(t.config);if(t.type==="record"){let e={};for(let r in t.properties)e[r]=da(t.properties[r]);return e}}function gy(t,e,r){switch(t.type){case"record":for(let n in t.properties){let i=t.properties[n];if(it(i)&&v(r[n])&&v(i.config?.default)){e[n]=r[n];continue}e[n]=gy(i,e[n],r[n])}return e;default:return r===void 0?da(t):r}}function ai(t,e){if(!(it(t)&&v(e))){switch(t.type){case"boolean":if(typeof e=="boolean")return e;throw new H("boolean",e);case"date":if(e instanceof Date&&!isNaN(e.getTime()))return e.toISOString();if(typeof e=="string"&&!Number.isNaN(Date.parse(e)))return new Date(e).toISOString();if(typeof e=="number"&&!Number.isNaN(e))return new Date(e).toISOString();throw new H("date",e);case"json":if(!v(e))return e;throw new H("json",e);case"number":if(typeof e=="number")return e;throw new H("number",e);case"record":if(typeof e=="object"&&e!==null){for(let r in e){let n=t.properties[r];if(!n)throw new H("record",e,`Unrecognized property: ${r}`);if(!(it(n)&&v(e[r])))try{e[r]=ai(n,e[r])}catch(i){throw i instanceof H?new H("record",e,`Could not encode property: '${r}'. Error: ${i.message}`):i}}return e}throw new H("record",e);case"string":if(typeof e=="string")if(t.config?.enum){if(t.config?.enum.includes(e))return e}else return e;throw new H("string",e);case"set":if(Array.isArray(e))return Object.fromEntries(e.map(r=>[oi(t.items,r),!0]));if(e instanceof Set)return Object.fromEntries(Array.from(e).map(r=>[oi(t.items,r),!0]));if(typeof e=="object"&&e!==null)return e;throw new H(`set<${t.items.type}>`,e)}throw new St(t.type,"Failed to encode value")}}function vy(t,e,r){switch(t.type){case"boolean":return typeof e=="boolean"?{valid:!0}:{valid:!1,error:Ut("boolean",e)};case"date":return typeof e=="string"?{valid:!0}:{valid:!1,error:Ut("date",e)};case"json":return typeof e<"u"?{valid:!0}:{valid:!1,error:Ut("json",e)};case"number":return typeof e=="number"?{valid:!0}:{valid:!1,error:Ut("number",e)};case"record":for(let n in t.properties){let i=t.properties[n];if(it(i)&&v(e[n])||r.partial&&!(n in e))continue;let s=vy(i,e[n],r);if(!s.valid)return{valid:!1,error:`Property ${n} is invalid: ${s.error}`}}return{valid:!0};case"string":return typeof e=="string"?{valid:!0}:{valid:!1,error:Ut("string",e)};case"set":return typeof e=="object"&&e!==null?{valid:!0}:{valid:!1,error:Ut(`set<${t.items.type}>`,e)}}throw new St(t.type,"Failed to validate value")}function ci(t,e){switch(t.type){case"boolean":if(typeof e=="boolean")return e;throw new _e("boolean",e);case"date":if(typeof e=="string")return new Date(e);throw new _e("date",e);case"json":return e;case"number":if(typeof e=="number")return e;throw new _e("number",e);case"record":let r={};for(let n in e){let i=t.properties[n];if(i){if(it(i)&&v(e[n])){e[n]===null&&(r[n]=null);continue}try{r[n]=ci(i,e[n])}catch(s){throw s instanceof _e?new _e("record",e,`Could not decode property: '${n}'. Error: ${s.message}`):s}}}return r;case"string":if(typeof e=="string")return e;throw new _e("string",e);case"set":if(typeof e=="object")return new Set(Object.entries(e).filter(([n,i])=>i).map(([n,i])=>ha(t.items,n)));throw new _e(`set<${t.items.type}>`,e)}throw new St(t.type,"Failed to decode value")}function oi(t,e){if(!Nr(t))throw new g("Cannot encode collection key for non-primitive type");return ai(t,e).toString()}function ha(t,e){if(!Nr(t))throw new g("Cannot decode collection key for non-primitive type");return t.type==="number"?Number(e):t.type==="boolean"?e==="true":ci(t,e)}function pa(t,e){return t.type==="boolean"&&e.type==="boolean"?VT(t,e):t.type==="date"&&e.type==="date"?BT(t,e):t.type==="number"&&e.type==="number"?UT(t,e):t.type==="record"&&e.type==="record"?LT(t,e):t.type==="set"&&e.type==="set"?zT(t,e):t.type==="string"&&e.type==="string"?WT(t,e):t.type==="json"&&e.type==="json"?QT(t,e):!1}function si(t,e,r){if(t.type==="date"){if(r==="encoded")return e;if(r==="decoded")return ai(t,e);throw new g("Invalid data format: "+r)}if(t.type==="record"){let n={};for(let i in e){let s=t.properties[i];if(!s)throw new ui("record",e,`Unrecognized property: ${i}`);it(s)&&v(e[i])||(n[i]=si(s,e[i],r))}return n}if(t.type==="set"){if(r==="encoded")return Object.entries(e).filter(([n,i])=>i).map(([n,i])=>si(t.items,ha(t.items,n),r));if(r==="decoded"){let n=[];for(let i of e)n.push(si(t.items,i,r));return n}throw new g("Invalid data format: "+r)}return e}function fa(t,e,r){if(t.type==="date"){if(r==="encoded")return e;if(r==="decoded")return ci(t,e);throw new g("Invalid data format: "+r)}if(t.type==="record"){for(let n in e){let i=t.properties[n];if(!i)throw new li("record",e,`Unrecognized property: ${n}`);it(i)&&v(e[n])||(e[n]=fa(i,e[n],r))}return e}if(t.type==="set"){if(r==="encoded"){let n={};for(let i of e)n[oi(t.items,i)]=!0;return n}if(r==="decoded"){let n=[];for(let i of e)n.push(fa(t.items,i,r));return new Set(n)}throw new g("Invalid data format: "+r)}return e}function wy(t){if(t.type==="boolean")return nt.boolean;if(t.type==="date")return nt.date;if(t.type==="json")return nt.json;if(t.type==="number")return nt.number;if(t.type==="record")return nt.record;if(t.type==="set")return[...nt.set,...aa(wy(t.items),He)];if(t.type==="string")return nt.string;throw new St(t.type,"Failed to get supported operations")}function by(t){return Zp.has(t.type)}function Nr(t){return Xp.has(t.type)}function $T(t){let e=t.default;if(!v(e)){if(typeof e!="object"||e===null)return e;{let{args:r,func:n}=e;if(n===void 0)return e;if(n==="nanoid"||n==="uuid")return r&&typeof r[0]=="number"?oa(r[0]):oa();if(n==="uuidv4")return crypto.randomUUID();if(n==="uuidv7")return py("uuidv7").uuidv7();if(n==="now")return new Date().toISOString();if(n==="Set.empty")return{}}}}function it(t){return t.config?.optional===!0||t.config?.nullable===!0}function Ut(t,e){return`Encoded value ${e} is not valid for type ${t}.`}function LT(t,e){return!!KT(t.properties,e.properties)}function VT(t,e){return Qt(t.config,e.config)}function BT(t,e){return Qt(t.config,e.config)}function UT(t,e){return Qt(t.config,e.config)}function QT(t,e){return Qt(t.config,e.config)}function zT(t,e){return!(!Qt(t.config,e.config)||!pa(t.items,e.items))}function WT(t,e){if(t.config?.enum&&!e.config?.enum||!t.config?.enum&&e.config?.enum)return!1;if(t.config?.enum&&e.config?.enum){if(t.config.enum.length!==e.config.enum.length)return!1;for(let r of t.config.enum)if(!e.config.enum.includes(r))return!1}return Qt(t.config,e.config)}function KT(t,e){let r=Object.keys(t),n=Object.keys(e);if(r.length!==n.length)return!1;for(let i of r)if(!e[i]||!pa(t[i],e[i]))return!1;return!0}function Qt(t,e){return!(!!t?.optional!=!!e?.optional||!!t?.nullable!=!!e?.nullable||!GT(t?.default,e?.default))}function GT(t,e){return typeof t!=typeof e?!1:Rr(t)&&Rr(e)?HT(t,e):t===e}function HT(t,e){if(t.func!==e.func||t.args?.length!==e.args?.length)return!1;if(t.args&&e.args){for(let r=0;r<t.args.length;r++)if(t.args[r]!==e.args[r])return!1}return!0}function fi(t,e){if(!t)return;let r=t[e];if(r)return r.permissions}function YT(t){return t==="read"}function Sy(t){return!YT(t)}function xy(t,e){if(!t&&!e)return!0;if(!t||!e)return!1;let r=Object.keys(t),n=Object.keys(e);if(r.length!==n.length)return!1;for(let i of r){let s=t[i],o=e[i];if(!JT(s,o))return!1}return!0}function JT(t,e){return!t&&!e?!0:!(!t||!e||!qr(t.read,e.read)||!qr(t.insert,e.insert)||!qr(t.update,e.update)||!qr(t.postUpdate,e.postUpdate)||!qr(t.delete,e.delete))}function qr(t,e){return!t&&!e?!0:!(!t||!e||!XT(t.filter,e.filter))}function XT(t,e){return!t&&!e?!0:!t||!e?!1:JSON.stringify(t)===JSON.stringify(e)}function Ey(t,e){if(!t&&!e)return!0;if(!t||!e)return!1;let r=Object.keys(t),n=Object.keys(e);if(r.length!==n.length)return!1;for(let i of r){let s=t[i],o=e[i];if(!ZT(s,o))return!1}return!0}function ZT(t,e){return!t&&!e?!0:!(!t||!e||!eP(t.match,e.match))}function eP(t,e){if(!t&&!e)return!0;if(!t||!e)return!1;let r=Object.keys(t),n=Object.keys(e);if(r.length!==n.length)return!1;for(let i of r){let s=t[i],o=e[i];if(JSON.stringify(s)!==JSON.stringify(o))return!1}return!0}function N(t,e=2166136261){let r=e;for(let n=0;n<t.length;n++)r^=t.charCodeAt(n),r=Math.imul(r,16777619);return r>>>0}function M(t,e){let r=t^e;return r=Math.imul(r,16777619),r>>>0}function ya(t){function e(n){return typeof n!="object"||n===null?String(n):Array.isArray(n)?"["+n.map(e).join(",")+"]":"{"+Object.keys(n).sort().map(s=>`${s}:${e(n[s])}`).join(",")+"}"}let r=e(t);return N(r)}function Cy(t){return ya(t).toString()}var q=class{static Get(e,r){let n=typeof r=="string"?r.split("."):r,i=e;for(let s of n){if(i===void 0||i[s]===void 0)return;i=i[s]}return i}static Set(e,r,n){let i=Array.isArray(r)?r:r.split("."),s=e;for(let o=0;o<i.length-1;o++){let a=i[o];s[a]===void 0&&(s[a]={}),s=s[a]}s[i[i.length-1]]=n}};var Oy=["TRACE","DEBUG","INFO","WARN","ERROR","FATAL"],Iy=Object.fromEntries(Oy.map((t,e)=>[t,e]));var ma=class{logger;spans;constructor(e,r){this.logger=e,this.spans=r}[Symbol.dispose](){this.logger._endSpans(this.spans)}},ga=class t{handlers;loggerContext;resourceAttributes;exclusiveHandlerMode=!1;constructor(e,r,n="INFO"){this.handlers=e??[],this.resourceAttributes=r||{},this.logLevel=n}registerHandler(e,r){return this.exclusiveHandlerMode?!1:(this.handlers.push(e),r?.exclusive&&(this.exclusiveHandlerMode=!0),!0)}context(e){let r=new t(this.handlers,this.resourceAttributes,this.logLevel);return r.loggerContext=e,r}logLevel="INFO";setLogLevel(e){let r=e.toUpperCase();(Oy.includes(r)||r==="NONE")&&(this.logLevel=r)}_log(e,r,n){if(this.logLevel==="NONE"||Iy[e]<Iy[this.logLevel])return;let i={level:e,message:r,timestamp:Date.now(),context:this.loggerContext,attributes:n,resource:this.resourceAttributes};for(let s of this.handlers)try{s.log(i)}catch(o){console.error("Error in log handler:",o)}}spanTrace(e,r){let n=this.handlers.map(i=>i.startSpan(e,this.loggerContext,{...this.resourceAttributes,...r}));return new ma(this,n)}trace(e,r){this._log("TRACE",e,r)}debug(e,r){this._log("DEBUG",e,r)}log(e,r){this.info(e,r)}info(e,r){this._log("INFO",e,r)}warn(e,r){this._log("WARN",e,r)}error(e,r){this._log("ERROR",e,r)}fatal(e,r){this._log("FATAL",e,r)}metric(e,r,n){for(let i of this.handlers)i.recordMetric(e,r,{...this.resourceAttributes,...n})}_endSpans(e){for(let r=0;r<e.length;r++){let n=e[r],i=this.handlers[r];i&&i.endSpan(n)}}},we=new ga;function*Ry(t,e){for(let r=e;r<t.length;r++)yield t[r]}async function*Ty(t,e){let r=0;for await(let n of t){if(r>=e)return;yield n,r++}}async function*va(t,e){for await(let r of t)await e(r)&&(yield r)}async function*Py(...t){for(let e of t)for await(let r of e)yield r}async function*Ay(t,e){let r=new Set;for await(let n of t){let i=e?e(n):n;r.has(i)||(r.add(i),yield n)}}async function*wa(t,e){for await(let r of t)yield e(r)}var tP=new Set(["$global","$session","$token","$role","$query","$prev"]);function V(t){return typeof t=="string"&&t[0]==="$"}function le(t){let e=t.split(".");if(e.length<1)throw new Error(`Invalid variable: ${t}`);if(e.length===1)return e.unshift(void 0),e[1]=e[1].slice(1),e;let r=rP(e[0]);return r===void 0?(e.unshift(void 0),e[1]=e[1].slice(1),e):(e[0]=r,e)}function rP(t){if(tP.has(t))return t==="$token"?"$session":t;let e=parseInt(t.slice(1),10);if(!isNaN(e))return e}function _r(t){return typeof t=="number"}function Sa(t,e=1){if(!V(t))return t;let r=le(t),n=r[0];return _r(n)?`$${n+e}.${r.slice(1).join(".")}`:t}function ba(t,e=1){let r=[];for(let n of t){if(_(n)){let[i,s,o]=n;o=Sa(o,e),r.push([i,s,o]);continue}if(D(n)){r.push({...n,filters:ba(n.filters,e)});continue}if(F(n)){r.push({exists:xa(n.exists,e)});continue}zt(n)&&r.push({exists:{...n.exists,where:n.exists.where?ba(n.exists.where,e):void 0}}),r.push(n)}return r}function xa(t,e=1){return t.where?{...t,where:ba(t.where,e)}:t}function Mr(t,e){if(t in e)return e[t];let[r,...n]=le(t);if(typeof r=="number"){let s=r;if(!e.entityStack||e.entityStack.length<s)throw new Error(`Variable reference is out of bounds. Tried to find ${t} in stack of size ${e.entityStack?.length}`);return q.Get(e.entityStack[e.entityStack.length-s],n)}if(r===void 0&&n[0].startsWith("view_")){let s=e[n[0]];if(!s)throw new Error(`View ${n[0]} not found in vars`);if(!Array.isArray(s))throw new Error(`View ${n[0]} is not an array`);return s.map(o=>q.Get(o,Ry(n,1)))}return q.Get(e,n)}function xt(t,e){return t.map(r=>nP(r,e))}function nP(t,e){if(D(t))return{mod:t.mod,filters:xt(t.filters,e)};if(_(t)&&V(t[2])){let r=t[2],n=Mr(r,e);if(Array.isArray(n)){let i=new Set;for(let s of n)if(typeof s=="object"&&s!==null)for(let[o,a]of Object.entries(s))a&&i.add(o);else i.add(s);n=i}return[t[0],t[1],n]}return t}async function di(t,e,r){let n=!0,i=aP(e);for(let s of i){let o=e[s];if(n=await iP(t,o,r),!n)break}return n}async function iP(t,e,r){if(D(e)){if(e.mod==="and")return await di(t,e.filters,r);{let n=!1;for(let i of e.filters)if(n=await di(t,[i],r),n)break;return n}}else if(F(e)){let n=await r.fetch(e.exists,{entityStack:[t]});return Array.isArray(n)?n.length>0:!!n}else return st(t,e)}function st(t,e,r=!1){if(Me(e))return e;if(D(e)){let{mod:n,filters:i}=e;return n==="and"?i.every(s=>st(t,s,r)):n==="or"?i.some(s=>st(t,s,r)):!1}if(F(e)){if(r)return!0;throw new Error(`Subquery filters should be filtered out before this point, found ${e}`)}return sP(t,e)}function sP(t,e){let[r,n,i]=e,s=q.Get(t,r);return Ny(s,n,i)}function Ny(t,e,r){if(e.startsWith(He)){if(typeof t!="object"&&t!==null&&t!==void 0)throw new oe(`The operator requires a set value, but got ${t}`);let n=e.slice(He.length);if(n==="has"){if(v(t))return!1;for(let i of Object.keys(t)){if(!t[i])continue;if(Ea(i,r)===r)return!0}return!1}else if(n==="!has"){if(v(t))return!0;for(let i of Object.keys(t)){if(!t[i])continue;if(Ea(i,r)===r)return!1}return!0}else{if(n==="isDefined")return r?!v(t):v(t);if(v(t))return!1;for(let i of Object.keys(t)){if(!t[i])continue;let s=Ea(i,r);if(Ny(s,n,r))return!0}return!1}}switch(e){case"=":return v(t)&&v(r)?!0:W(t??null,r??null)===0;case"!=":return v(t)&&v(r)?!1:W(t??null,r??null)!==0;case">":return v(t)?!1:v(r)?!0:W(t,r)>0;case">=":return v(t)&&v(r)?!0:v(t)?!1:v(r)?!0:W(t,r)>=0;case"<":return v(r)?!1:v(t)?!0:W(t,r)<0;case"<=":return v(t)&&v(r)?!0:v(r)?!1:v(t)?!0:W(t,r)<=0;case"like":return v(r)||v(t)?!1:ky(t,r);case"nlike":return v(r)||v(t)?!0:!ky(t,r);case"in":return v(t)||v(r)?!1:r instanceof Set?r.has(t):r instanceof Array?r.includes(t):r instanceof Object?!!r[t]:(we.warn('Invalid filter value for "in" operator'),!1);case"nin":return v(t)||v(r)?!0:r instanceof Set?!r.has(t):r instanceof Array?r.includes(t):r instanceof Object?!r[t]:(we.warn('Invalid filter value for "in" operator'),!1);case"isDefined":return r?!v(t):v(t);default:throw new oe(`The operator ${e} is not recognized.`)}}function Ea(t,e){return typeof e=="boolean"?t==="true":typeof e=="number"?parseFloat(t):t}function ky(t,e){return e=e.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&"),e=e.replace(/%/g,".*"),e=e.replace(/_/g,"."),new RegExp(`^${e}$`,"i").test(t)}function _(t){return t instanceof Array&&t.length===3&&typeof t[0]=="string"&&typeof t[1]=="string"}function hi(t){return _(t)&&t[0]==="id"}function qy(t){return hi(t)&&(t[1]==="="||t[1]==="in")}function D(t){return t instanceof Object&&"mod"in t}function F(t){return t instanceof Object&&"exists"in t&&"collectionName"in t.exists}function zt(t){return t instanceof Object&&"exists"in t&&"_extends"in t.exists}function Me(t){return typeof t=="boolean"}function _y(t){return _(t)||D(t)||F(t)||zt(t)||Me(t)}function Ca(t){if(!_(t))return!1;let[e,r,n]=t;return!(!V(n)||!["=","<","<=",">",">=","!="].includes(r))}function oP(t){if(_(t))return"basic";if(F(t))return"relational";if(D(t))return"group";if(Me(t))return"boolean";throw new Error(`Filter type could not be determined: ${JSON.stringify(t)}`)}function aP(t){if(!t)return[];let e=[],r=[],n=[],i=[];for(let s=0;s<t.length;s++){let o=t[s];switch(oP(o)){case"boolean":r.push(s);break;case"basic":e.push(s);break;case"group":n.push(s);break;case"relational":i.push(s);break}}return[...r,...e,...n,...i]}function My(t){return{mod:"or",filters:t}}function Fy(t){return{mod:"and",filters:t}}function jy(t,e={}){return{exists:{_extends:t,...e}}}function Dy(t,e){for(let r of Ce(t))if(e(r))return!0;return!1}function*Ce(t){for(let e of t)D(e)?yield*Ce(e.filters):yield e}function Fr(t){if(Me(t)||_(t))return!0;if(D(t)){let{mod:e,filters:r}=t;return r.every(n=>Fr(n))}return!(F(t)||zt(t))}var cP=["after","collectionName","select","include","limit","order","vars","where"];function Et(t){let e=Object.fromEntries(Object.entries(t).filter(([n])=>cP.includes(n)));return ya(e).toString()}var uP=N("C");function ae(t){let e=uP;if(e=M(e,N(t.collectionName)),t.where){let r=Ly(t.where);e=M(e,r)}if(t.order){let r=mP(t.order);e=M(e,r)}if(t.limit!=null){let r=OP(t.limit);e=M(e,r)}if(t.after){let r=CP(t.after);e=M(e,r)}if(t.include){let r=xP(t.include);e=M(e,r)}if(t.select){let r=bP(t.select);e=M(e,r)}return e}var lP=N("B"),fP=N("S"),dP=N("G"),hP=N("Q");function Ia(t){if(Me(t)){let e=lP,r=t.toString();return e=M(e,N(r)),{hash:e,sortKey:`B|${r}`}}else if(_(t)){let e=fP;e=M(e,N(t[0])),e=M(e,N(t[1]));let r=Vy(t[2]);return e=M(e,N(r)),{hash:e,sortKey:`S|${t[0]}|${t[1]}|${r}`}}else if(D(t)){let e=dP;e=M(e,N(t.mod));let r=Ly(t.filters);return e=M(e,r),{hash:e,sortKey:`G|${t.mod}|${r}`}}else if(F(t)){let e=hP,r=ae(t.exists);return e=M(e,r),{hash:e,sortKey:`Q|${e}`}}throw new g("Could not hash filter, it is not a valid filter type")}var pP=N("F");function Ly(t){let e=pP,r=t.map(Ia);r.sort((n,i)=>n.sortKey<i.sortKey?-1:n.sortKey>i.sortKey?1:0);for(let n of r)e=M(e,n.hash);return e}var yP=N("O");function mP(t){let e=yP;for(let r of t)e=M(e,vP(r));return e}var gP=N("o");function vP(t){let e=gP;return e=M(e,N(t[0])),e=M(e,N(t[1])),t[2]&&(e=M(e,ae(t[2].subquery))),e}var wP=N("P");function bP(t){let e=wP,r=[...t].sort();for(let n of r)e=M(e,N(n));return e}var SP=N("I");function xP(t){let e=SP,r=Object.entries(t).sort(([n],[i])=>n<i?-1:n>i?1:0);for(let[n,i]of r)e=M(e,N(n)),e=M(e,N(i.cardinality)),e=M(e,ae(i.subquery));return e}var EP=N("A");function CP(t){let e=EP,[r,n]=t;for(let i of r)e=M(e,N(Vy(i)));return e=M(e,N(n.toString())),e}var IP=N("L");function OP(t){let e=IP;return e=M(e,N(t.toString())),e}var $y={undefined:"a",...Ge};function Vy(t){if(t===void 0)return $y.undefined;if(t===null)return $y.null;if(t===!0||t===!1)return Ge.boolean+t;if(typeof t=="string")return Ge.string+t;if(typeof t=="number")return Ge.number+t;if(Array.isArray(t))return Ge.array+JSON.stringify(t);if(typeof t=="object")return Ge.object+JSON.stringify(t);throw new g(`Failed to encode hash value: ${t}`)}function RP(t){return t._diff==="collectionAttribute"}function By(t,e,r=[]){if(t===void 0&&e===void 0)return[];let n=t?.properties??{},i=e?.properties??{},s=new Set([...Object.keys(n),...Object.keys(i)]),o=[];for(let a of s){if(!(a in n)){let c=[...r,a];o.push({type:"insert",attribute:c,dataType:i[a],isNewCollection:t===void 0});continue}if(!(a in i)){let c=[...r,a];o.push({type:"delete",attribute:c,dataType:n[a]});continue}if(a in n&&a in i){if(A.equal(n[a],i[a]))continue;let c=[...r,a];if(n[a].type==="record"&&i[a].type==="record"){o.push(...By(n[a],i[a],c));continue}let u={type:"update",attribute:c,changes:{config:{}}};n[a].type!==i[a].type&&(u.changes.type=i[a].type),n[a].type==="set"&&i[a].type==="set"&&n[a].items.type!==i[a].items.type&&(u.changes.items={type:i[a].items.type}),u.changes.config=TP(n[a].config??{},i[a].config??{}),o.push(u);continue}}return o}function TP(t,e){let r={};t.nullable!==e.nullable&&(r.nullable=!!e.nullable),t.optional!==e.optional&&(r.optional=!!e.optional),t.default!==e.default&&(r.default=e.default);let n=e.enum&&!t.enum,i=t.enum&&e.enum&&!t.enum?.every(s=>e.enum?.includes(s));return(n||i)&&(r.enum=e.enum),r}function Uy(t,e){let r=new Set([...Object.keys(t.collections),...Object.keys(e.collections)]),n=[];for(let s of r){let o=t.collections[s],a=e.collections[s];n.push(...By(o?.schema,a?.schema).map(l=>({_diff:"collectionAttribute",collection:s,...l}))),!PP(o?.relationships,a?.relationships)&&n.push({_diff:"collectionRelationships",collection:s}),!xy(o?.permissions,a?.permissions)&&n.push({_diff:"collectionPermissions",collection:s})}return!Ey(t.roles,e.roles)&&n.push({_diff:"roles"}),n}function PP(t,e){if(!t&&!e)return!0;if(!t||!e)return!1;let r=Object.keys(t),n=Object.keys(e);if(r.length!==n.length)return!1;for(let i of r){let s=t[i],o=e[i];if(!AP(s,o))return!1}return!0}function AP(t,e){return!t&&!e?!0:!(!t||!e||t.cardinality!==e.cardinality||Et(t.query)!==Et(e.query))}function kP(t){return t.reduce((e,r)=>{if(!RP(r))return e;let n=NP.find(i=>i.matchesDiff(r));return n&&e.push({issue:n.description,dataConstraint:n.dataConstraint,context:r,attributeCure:n.attributeCure}),e},[])}var NP=[{description:"removed an optional attribute",matchesDiff:t=>t.type==="delete"&&A.isOptional(t.dataType),dataConstraint:"attribute_is_empty",attributeCure:()=>null},{description:"removed a required attribute",matchesDiff:t=>t.type==="delete",dataConstraint:"collection_is_empty",attributeCure:(t,e)=>`make '${e.join(".")}' optional`},{description:"changed a attribute from optional to required",matchesDiff:t=>t.type==="update"?t.changes.config?.optional===!1:!1,dataConstraint:"attribute_has_no_undefined",attributeCure:()=>null},{description:"changed the type of an attribute",matchesDiff:t=>t.type==="update"?t.changes.type!==void 0:!1,dataConstraint:"attribute_is_empty",attributeCure:(t,e)=>`revert the change to '${e.join(".")}' and create a different, optional, attribute with the new type`},{description:"changed the type of a set's items",matchesDiff:t=>t.type==="update"?t.changes.items!==void 0:!1,dataConstraint:"attribute_is_empty",attributeCure:(t,e)=>`revert the change to '${e.join(".")}' and create a different, optional, attribute with the new type`},{description:"added an attribute where optional is not set",matchesDiff:t=>t.type==="insert"&&!t.isNewCollection&&!A.isOptional(t.dataType),dataConstraint:"collection_is_empty",attributeCure:(t,e)=>`make '${e.join(".")}' optional`},{description:"changed an attribute from nullable to non-nullable",matchesDiff:t=>t.type==="update"?t.changes.config?.nullable===!1:!1,dataConstraint:"attribute_has_no_null",attributeCure:()=>null},{description:"added an enum to an attribute or removed an option from an existing enum",matchesDiff:t=>t.type==="update"?t.changes.config?.enum!==void 0:!1,dataConstraint:"attribute_satisfies_enum",attributeCure:(t,e,r)=>`revert the change to '${e.join(".")}' and create a different, optional, attribute with the new enum OR ensure all values of '${e.join(".")} are in the new enum: ${r}`}];async function qP(t,e,r){return await _P[r](t,e.collection,e.attribute,e?.type==="update"?e.changes.config?.enum:void 0)}async function Qy(t,e){let r=kP(e);return await Promise.all(r.map(async i=>{let s=!await qP(t,i.context,i.dataConstraint),o=i.dataConstraint&&MP[i.dataConstraint](i.context.collection,i.context.attribute),a=i.attributeCure(i.context.collection,i.context.attribute);return{...i,violatesExistingData:s,cure:a&&o?a+" or "+o:o}}))}var _P={never:async()=>!1,none:async()=>!0,collection_is_empty:LP,attribute_is_empty:DP,attribute_has_no_undefined:jP,attribute_has_no_null:$P,attribute_satisfies_enum:FP},MP={never:()=>"This edit is never allowed",none:()=>"This edit does not violate any data constraints but can cause existing queries that reference this attribute to fail",collection_is_empty:t=>`delete all entities in '${t}' to allow this edit`,attribute_is_empty:(t,e)=>`set all values of '${e.join(".")}' to undefined to allow this edit`,attribute_has_no_undefined:(t,e)=>`ensure all values of '${e.join(".")}' are not undefined to allow this edit`,attribute_has_no_null:(t,e)=>`ensure all values of '${e.join(".")}' are not null to allow this edit`,attribute_satisfies_enum:(t,e)=>`ensure all values of '${e.join(".")}' are in the enum to allow this edit`};async function FP(t,e,r,n){return(await t({collectionName:e,select:["id"],limit:1,where:[[r.join("."),"nin",n]]})).length===0}async function jP(t,e,r){return(await t({collectionName:e,select:["id"],limit:1,where:[[r.join("."),"isDefined",!1]]})).length===0}async function DP(t,e,r){return(await t({collectionName:e,select:["id"],limit:1,where:[[r.join("."),"isDefined",!0]]})).length===0}async function $P(t,e,r){return(await t({collectionName:e,select:["id"],limit:1,where:[[r.join("."),"=",null]]})).length===0}async function LP(t,e){return(await t({collectionName:e,select:["id"],limit:1})).length===0}var x={Success:200,"Bad Request":400,Unauthorized:401,"Payment Required":402,Forbidden:403,"Not Found":404,Conflict:409,"Too Many Requests":429,"Internal Server Error":500,"Service Unavailable":503,"Gateway Timeout":504},g=class t extends Error{status=x["Internal Server Error"];baseMessage;contextMessage;__isTriplitError=!0;constructor(e,...r){super(...r),this.name="TriplitError",this.baseMessage=r[0]||"Triplit Error",this.contextMessage=e}get message(){return this.contextMessage?`${this.baseMessage} | Context: ${this.contextMessage}`:this.baseMessage}toString(){return JSON.stringify(this.toJSON())}toJSON(){return{name:this.name,message:this.message,baseMessage:this.baseMessage,status:this.status,contextMessage:this.contextMessage}}static fromJson(e){let r=new t(e.contextMessage);return e.baseMessage&&(r.baseMessage=e.baseMessage),e.name&&(r.name=e.name),e.status&&(r.status=e.status),r}},pi=class extends g{constructor(e,...r){super(...r),this.name="InvalidQueryInclusionError",this.baseMessage=`An inclusion was provided to a query that is not valid or could not be transformed into a valid inclusion. The inclusion was: ${JSON.stringify(e)}`,this.status=x["Bad Request"]}},jr=class extends g{constructor(e,...r){super(...r),this.name="InvalidQueryLimitError",this.baseMessage=`A limit was provided to a query that is not valid or could not be transformed into a valid limit. The limit was: ${JSON.stringify(e)}`,this.status=x["Bad Request"]}},yi=class extends g{constructor(e,...r){super(...r),this.name="InvalidQueryWhereError",this.baseMessage=`A where clause was provided to a query that is not valid or could not be transformed into a valid where clause. The where clause was: ${JSON.stringify(e)}`,this.status=x["Bad Request"]}},te=class extends g{constructor(e,...r){super(...r),this.name="InvalidQueryAfterError",this.baseMessage=`An after cursor was provided to a query that is not valid or could not be transformed into a valid after cursor. The after cursor was: ${JSON.stringify(e)}`,this.status=x["Bad Request"]}};var mi=class extends g{constructor(...e){super(...e),this.name="TransactionAlreadyCommittedError",this.baseMessage="This transaction has already been committed.",this.status=x["Bad Request"]}},ot=class extends g{constructor(...e){super(...e),this.name="TransactionAlreadyCanceledError",this.baseMessage="This transaction has already been canceled.",this.status=x["Bad Request"]}},gi=class extends g{constructor(...e){super(...e),this.name="QueryNotPreparedError",this.baseMessage="The query has parameters that have not been prepared with the schema. This could indicate that the database does not have a schema or that it is not up-to-date. Run `npx triplit schema diff` to verify that the server\u2019s schema is in sync with the client\u2019s. If it is not, run `npx triplit schema push` to update the server\u2019s schema.",this.status=x["Internal Server Error"]}},Wt=class extends g{constructor(e,r,...n){super(...n),this.name="EntityNotFoundError",this.baseMessage=`Could not find entity with id ${e} in collection ${r}.`,this.status=x["Not Found"]}},Fe=class extends g{constructor(e,...r){super(...r),this.name="InvalidCollectionNameError",this.baseMessage=`${e} is not a valid collection name.`,this.status=x["Bad Request"]}},Dr=class extends g{constructor(...e){super(...e),this.name="InvalidInsertDocumentError",this.baseMessage="The document you are attempting to insert is invalid.",this.status=x["Bad Request"]}},vi=class extends g{constructor(...e){super(...e),this.name="InvalidOperationError",this.baseMessage="You are attempting to perform an operation that is not valid.",this.status=x["Bad Request"]}},wi=class extends g{constructor(e,r,n,i,...s){super(...s),this.name="WritePermissionError",this.baseMessage=`'${n}' permission for the collection '${e}' prevented the ${n==="insert"?"insertion":n==="delete"?"deletion":"update"} of the entity with id '${r}'. The provided session roles were [${i.map(o=>o.key).join(", ")}].`,this.status=x.Unauthorized}},H=class extends g{constructor(e,r,...n){super(...n),this.name="DBSerializationError",this.baseMessage=`There was an error serializing an input to an acceptable format. Could not transform the data: ${r} as type: ${e}`,this.status=x["Bad Request"]}},_e=class extends g{constructor(e,r,...n){super(...n),this.name="DBDeserializationError",this.baseMessage=`There was an error deserializing a database value to JS. Could not transform the data: ${r} as type: ${e}`,this.status=x["Bad Request"]}},ui=class extends g{constructor(e,r,...n){super(...n),this.name="JSONSerializationError",this.baseMessage=`There was an error serializing an input to JSON. Could not transform the data: ${e} as type: ${r}`,this.status=x["Bad Request"]}},li=class extends g{constructor(e,r,...n){super(...n),this.name="JSONDeserializationError",this.baseMessage=`There was an error deserializing a JSON value. Could not transform the data: ${e} as type: ${r}`,this.status=x["Bad Request"]}},St=class extends g{constructor(e,...r){super(...r),this.name="UnrecognizedAttributeTypeError",this.baseMessage=`An attribute in the schema contains an unsupported type: ${e}. Valid types are ${[sa]}`,this.status=x["Bad Request"]}},oe=class extends g{constructor(...e){super(...e),this.name="InvalidFilterError",this.baseMessage="Your query passed a filter that is invalid.",this.status=x["Bad Request"]}};var bi=class extends g{constructor(e,...r){super(...r),this.name="InvalidQueryCardinalityError",this.baseMessage=`The cardinality ${e} is not valid for the query type.`,this.status=x["Bad Request"]}},$r=class extends g{constructor(...e){super(...e),this.name="InvalidOrderClauseError",this.baseMessage="An order clause has been determined to be invalid.",this.status=x["Bad Request"]}};var Lr=class extends g{constructor(...e){super(...e),this.name="InvalidSelectClauseError",this.baseMessage="The select clause of this query has been determined to be invalid.",this.status=x["Bad Request"]}},Si=class extends g{constructor(e,r,n,...i){super(...i),this.name="RelationDoesNotExistError",this.baseMessage=`Your attempt to load '${e}' at alias '${r}' failed because '${e}' does not exist in the schema for the collection '${n}'.`,this.status=x["Bad Request"]}},xi=class extends g{constructor(e,r,n,...i){super(...i),this.name="IncludedNonRelationError",this.baseMessage=`Your attempt to load '${e}' at alias '${r}' failed because '${e}' in the collection '${n}' in not a query type.`,this.status=x["Bad Request"]}},Ei=class extends g{constructor(...e){super(...e),this.name="QueryCacheError",this.baseMessage="An error occurred inside the query cache",this.status=x["Bad Request"]}},Kt=class extends g{constructor(e,r,...n){super(...n),this.name="QueryClauseFormattingError",this.baseMessage=`The ${e} clause is not formatted correctly.
    
    Received: ${JSON.stringify(r)}`,this.status=x["Bad Request"]}},Ci=class extends g{constructor(...e){super(...e),this.name="AfterClauseWithNoOrderError",this.baseMessage="The 'after' clause must be used after an 'order' clause.",this.status=x["Bad Request"]}},Vr=class extends g{constructor(e,r,...n){super(...n),this.name="InvalidResultCardinalityError",this.baseMessage=`Expected cardinality ${e} but got ${r}. This indicates an issue with the query engine. Please report this issue to the Triplit team.`,this.status=x["Internal Server Error"]}},Ii=class extends g{constructor(...e){super(...e),this.name="DBInitializationError",this.baseMessage="An error occurred during the initialization of the database.",this.status=x["Internal Server Error"]}};var je=class{lastPhysicalTimeMs;lastLogicalTime;clientId="";constructor(e){this.clientId=e.clientId,this.lastPhysicalTimeMs=e.lastPhysicalTimeMs||0,this.lastLogicalTime=e.lastLogicalTime||0}get currentPhysicalTimeMs(){return Date.now()}current(){return[this.currentPhysicalTimeMs,this.lastLogicalTime,this.clientId]}next(){let e=this.currentPhysicalTimeMs;return e>this.lastPhysicalTimeMs?(this.lastPhysicalTimeMs=e,this.lastLogicalTime=0):this.lastLogicalTime+=1,[this.lastPhysicalTimeMs,this.lastLogicalTime,this.clientId]}updatePhysicalTimeMs(e){this.lastPhysicalTimeMs=e}static compare(e,r){return e[0]===r[0]?e[1]===r[1]?e[2].localeCompare(r[2]):e[1]-r[1]:e[0]-r[0]}static MIN=Object.freeze([0,0,""])};var Oi=class{storagePrefix;constructor(e=[]){this.storagePrefix=e}async getHighestTimestamp(e){return await e.scope(this.storagePrefix).get(["highestTimestamp"])??je.MIN}async applyChanges(e,r,n){let i=e.scope(this.storagePrefix),s=await this.getHighestTimestamp(e),o=[];for(let[c,u]of Object.entries(r)){let l=[...u.sets.keys(),...u.deletes];for(let f of l){let d={collectionName:c,id:f,delete:u.deletes.has(f),set:u.sets.get(f)};o.push(d)}}if(je.compare(n,s)>0){for(let c of o)await i.set([c.collectionName,c.id],n);return await i.set(["highestTimestamp"],n),r}let a={};for(let c of o){let{collectionName:u,id:l,delete:f,set:d}=c,p=[u,l],m=await i.get(p);(!m||je.compare(n,m)>0)&&(await i.set(p,n),a[u]||(a[u]={sets:new Map,deletes:new Set}),f&&a[u].deletes.add(l),d&&a[u].sets.set(l,d))}return a}async getTimestampForEntity(e,r,n){return e.scope(this.storagePrefix).get([r,n])??null}};function ce(t,...e){if(e.length===0)return t;t=t??{};for(let r of e){if(r===null)return t=null,t;if(r){for(let n in r)if(Object.prototype.hasOwnProperty.call(r,n)){let i=r[n],s=t[n];if(Array.isArray(i)){t[n]=[...i];continue}if(i&&typeof i=="object"&&s&&typeof s=="object"&&!Array.isArray(s)){t[n]=ce({},s,i);continue}t[n]=i}}}return t}var Br=class{_changes={};constructor(){}clear(e){return this._changes={},Promise.resolve()}write(e,r){return Ri(this._changes,r),Promise.resolve()}getChanges(e){return Promise.resolve(this._changes)}getChangesForCollection(e,r){return Promise.resolve(this._changes[r])}getChangesForEntity(e,r,n){let i=this._changes[r];if(!i)return Promise.resolve(void 0);let s=i.sets.get(n);return s?Promise.resolve({update:s,delete:i.deletes.has(n)}):Promise.resolve(void 0)}isEmpty(e){return Promise.resolve(Ye(this._changes))}};function Ri(t,...e){for(let r of e)for(let n of Object.keys(r)){let i=r[n];if(i){t[n]||(t[n]={sets:new Map,deletes:new Set});for(let s of i.deletes)t[n].sets.delete(s),t[n].deletes.add(s);for(let[s,o]of i.sets.entries()){let a=t[n].sets.get(s);a?ce(a,o):t[n].sets.set(s,o)}}}return t}function Ye(t){for(let e in t)if(Object.hasOwn(t,e))return!1;return!0}function Oa(t){for(let e in t)if(Object.hasOwn(t,e))if(typeof t[e]=="object"&&t[e]!==null&&!Array.isArray(t[e])){if(!Oa(t[e]))return!1}else return!1;return!0}var Gt=class{storagePrefix;constructor(e=[]){this.storagePrefix=e}getEntity(e,r,n){return e.scope(this.storagePrefix).get([r,n])}async getCollectionStats(e,r){let n=e.scope(this.storagePrefix),i=new Map;if(r)for(let s of r){let o=await n.count({prefix:[s]});i.set(s,o)}else for await(let[[s]]of n.scan({prefix:[]}))i.set(s,(i.get(s)||0)+1);return i}async applyChanges(e,r,n){let i=e.scope(this.storagePrefix),s={},o=[],a=async(l,f,d)=>{let p=await this.getEntity(e,l,f),m=!!p;return n.entityChangeValidator&&n.entityChangeValidator(l,d,{ignoreRequiredProperties:m}),{collection:l,id:f,...Ht(p,d),operation:m?"upsert":"insert"}},c=async(l,f,d)=>{let p=await this.getEntity(e,l,f);if(!p)return;n.entityChangeValidator&&n.entityChangeValidator(l,d,{ignoreRequiredProperties:!0});let m=Ht(p,d);return{collection:l,id:f,...m,operation:"update"}},u=async(l,f)=>{if(n.checkWritePermission){let d=await this.getEntity(e,l,f);return{collection:l,id:f,prev:d,next:void 0,change:void 0,operation:"delete"}}return{collection:l,id:f,prev:void 0,next:void 0,change:void 0,operation:"delete"}};for(let[l,f]of Object.entries(r)){for(let d of f.deletes){let p=await u(l,d);await i.delete([l,d]),o.push(p)}for(let[d,p]of f.sets.entries()){let y=!!p.id?await a(l,d,p):await c(l,d,p);if(!y)continue;let{prev:w,next:E,change:b}=y;await i.set([l,d],E),o.push(y)}}for(let l of o){if(n.checkWritePermission)if(l.operation==="insert")await n.checkWritePermission(e,l,"insert");else if(l.operation==="update"||l.operation==="upsert")await n.checkWritePermission(e,l,"update"),await n.checkWritePermission(e,l,"postUpdate");else if(l.operation==="delete")await n.checkWritePermission(e,l,"delete");else throw new g("An invalid delta was created and could not finish permission checks.");if(s[l.collection]||(s[l.collection]={deletes:new Set,sets:new Map}),l.operation==="delete")s[l.collection].deletes.add(l.id);else{if(Ye(l.change))continue;s[l.collection].sets.set(l.id,l.change)}}return s}getEntitiesInCollection(e,r){return e.scope(this.storagePrefix).scanValues({prefix:[r]})}};function Ht(t,e,r={clone:!0}){if(!t)return{prev:t,next:e,change:e};let n=r.clone?structuredClone(t):t,i={};for(let[s,o]of Object.entries(e)){let a=n[s];if(typeof a=="object"&&a!=null&&typeof o=="object"&&o!=null&&!Array.isArray(o)){let{next:c,change:u}=Ht(a,o,r);Ye(u)||(i[s]=ce(i[s]??{},u),n[s]=c)}else n[s]!==o&&(i[s]=o,n[s]=o)}return{prev:t,next:n,change:i}}var at=class{storagePrefix;metadataStore;dataStore;constructor(e=[]){this.storagePrefix=e,this.metadataStore=new Oi([...this.storagePrefix,"metadata"]),this.dataStore=new Gt([...this.storagePrefix,"data"])}async applyChanges(e,r,n){return this.dataStore.applyChanges(e,r,n)}async applyChangesWithTimestamp(e,r,n,i){let s=await this.metadataStore.applyChanges(e,r,n);return this.dataStore.applyChanges(e,s,i)}async getEntity(e,r,n){return this.dataStore.getEntity(e,r,n)}getEntitiesInCollection(e,r){return this.dataStore.getEntitiesInCollection(e,r)}getCollectionStats(e,r){return this.dataStore.getCollectionStats(e,r)}};var Je=class{static canCacheQuery(e){return!e.where||e.where.length===0?!0:(e.where??[]).filter(Ca).length!==0}static resolveQueryFromView(e,[r,n,i]){let s,o;if(["=","<","<=",">",">="].includes(n)&&(s=Ti(e,i,a=>a.data[r],"start",Pi),o=Ti(e,i,a=>a.data[r],"end",Pi)),n==="!=")return s=Ti(e,i,c=>c.data[r],"start",Pi),o=Ti(e,i,c=>c.data[r],"end",Pi),[...e.slice(0,s+1),...e.slice(o)];if(s==null||o==null)throw new Ei(`Queries with the operator "${n}" in a where clause can't be stored in the query cache. Currently, supported operators are: ${["=","!=","<","<=",">",">="]}`);return e.slice(s,o+1)}static queryToViews(e){let r=[],n=[],i=[];for(let s of e.where??[]){if(Ca(s)){r.push(s);continue}if(Fr(s)){n.push(s);continue}i.push(s)}return{views:[{collectionName:e.collectionName,where:n,order:[...r.map(s=>[s[0],"ASC"]),...e.order??[]],limit:r.length>0?void 0:e.limit,include:e.include}],variableFilters:r,unusedFilters:i}}};function Ti(t,e,r,n="start",i=(s,o)=>s<o?-1:s>o?1:0){let s=0,o=t.length-1,a=-1;for(;s<=o;){let c=Math.floor((s+o)/2),u=r(t[c]);i(u,e)===0?(a=c,n==="start"?o=c-1:s=c+1):i(u,e)<0?s=c+1:o=c-1}return a}function Pi(t,e){return t===void 0&&e===void 0?0:t===void 0?-1:e===void 0?1:W(t,e)}function Ur(t,e,r){let[n,i]=e;if(!r||r.length!==n.length)throw new gi("The order and after cursor are not compatible");let s=!0;for(let o=0;o<n.length;o++){let a=n[o],c=r[o][0],u=r[o][1],l=q.Get(t,c)??Or,f=W(l,a)*(u==="ASC"?1:-1);if(f<0){s=!1;break}if(f>0){s=!0;break}if(o===n.length-1){s=i;break}}return s}function zy(t){if(!t.where)return[null,-1];let e=t.where.findIndex(r=>_(r)&&qy(r));return e===-1?[null,-1]:[t.where[e],e]}function Wy(t,e){return t.every(e)}function zr(t,e){let r={views:{},rootQuery:t};if(t.where){let{where:n,views:i}=Ra(t.where,e);t.where=n,Object.assign(r.views,i)}if(t.include)for(let[n,i]of Object.entries(t.include)){let{newViews:s,rewrittenQuery:o}=Ky(i.subquery,e);Object.assign(r.views,s),t.include[n]={...t.include[n],subquery:o}}if(t.order)for(let n=0;n<t.order.length;n++){let[i,s,o]=t.order[n];if(o==null)continue;let{newViews:a,rewrittenQuery:c}=Ky(o.subquery,e);Object.assign(r.views,a),t.order[n][2]={...o,subquery:c}}return r}function Ky(t,e){let r=null,n=null,i=t.include&&Object.keys(t.include).length>0;if(Je.canCacheQuery(t)&&!i){let s=e(),o=Je.queryToViews(t),a=zr(o.views[0],e);r={[s]:a.rootQuery,...a.views},n={...t,collectionName:`$view_${s}`,where:o.variableFilters}}else{let s=zr(t,e);r=s.views,n=s.rootQuery}return{newViews:r,rewrittenQuery:n}}function Ra(t,e){let r={},n=[];for(let i of t)if(F(i)){let s=i.exists,o=s.where&&Ta(s.where),a=(s.where??[]).filter(c=>_(c)&&V(c[2])&&le(c[2])[0]===1);if(!o&&a.length<2){let c=e(),u=zr(s,e);r[c]=u.rootQuery,Object.assign(r,u.views),u.rootQuery.where=s.where?.filter(f=>!a.includes(f));let l=a.map(f=>{let[d,...p]=le(f[2]);return[p.join("."),"in",`$view_${c}.${f[0]}`]});n.push(...l)}else if(Je.canCacheQuery(s)){let c=e(),u=Je.queryToViews(s),l=zr(u.views[0],e),{where:f,views:d}=Ra(u.unusedFilters,e);l.rootQuery.where?.concat(f),r[c]=l.rootQuery,Object.assign(r,l.views),Object.assign(r,d),n.push({exists:{...s,collectionName:`$view_${c}`,where:[...u.variableFilters,...f]}})}else n.push(i)}else if(D(i)){let{where:s,views:o}=Ra(i.filters,e);n.push({...i,filters:s}),Object.assign(r,o)}else n.push(i);return{where:n,views:r}}function Ta(t){for(let e of Ce(t))if(_(e)&&V(e[2])){let[r]=le(e[2]);if(typeof r=="number"&&r>1)return!0}else if(F(e)&&Ta(e.exists.where||[]))return!0;return!1}function Gy(t){let e=0,n=zr(t,()=>`${e++}`);return VP(n)}function VP(t){let e={};for(let[i,s]of Object.entries(t.views)){let o=Yt(s);e[i]={steps:o,views:{}}}let r=Yt(t.rootQuery),n=[];return n.push(...r),{steps:n,views:e}}function BP(t,e=new Set){for(let r of Ce(t))_(r)&&Pa(r)&&e.add(r[2]);return e}function Pa(t){return V(t[2])&&t[2].startsWith("$view_")}function Yt(t){let e=[],r=!1,n=!1,i=!1,s=!1,o=[],a=[];if(t.where)for(let f of t.where)if(Fr(f))a.push(f);else if(F(f))o.push(f);else throw new g(`Could not compile query: Unsupported filter type in where clause: ${JSON.stringify(f)}`);let c=t.after?{after:t.after,order:t.order}:void 0,[u,l]=zy(t);if(t.collectionName.startsWith("$view_")){let f=t.collectionName.slice(6);if(!Wy(a,_))throw new g(`Filters on view ${f} must be simple filter statements.`);if(e.push({type:"PREPARE_VIEW",viewId:f}),e.push({type:"RESOLVE_FROM_VIEW",viewId:f,filter:a}),o.length>0){for(let d of o)e.push({type:"ITERATOR_SUBQUERY_FILTER",subPlan:Yt(d.exists)});e.push({type:"COLLECT"})}n=!0,i=!0,s=!0}else if(u){if(typeof u[2]=="string"&&u[2].startsWith("$view_")){let f=u[2].split(".")[0].slice(6);e.push({type:"PREPARE_VIEW",viewId:f})}e.push({type:"ID_LOOK_UP",collectionName:t.collectionName,ids:V(u[2])?u[2]:typeof u[2]=="string"?new Set().add(u[2]):u[2]}),a.splice(l,1)}else e.push({type:"SCAN",collectionName:t.collectionName});if(a.length>0){let f=BP(a);if(f.size>0)for(let d of f){let p=d.split(".")[0].slice(6);e.push({type:"PREPARE_VIEW",viewId:p})}}if(!n){(a.length>0||c)&&(e.push({type:"ITERATOR_FILTER",filter:a,after:c}),i=!0);for(let f of o)e.push({type:"ITERATOR_SUBQUERY_FILTER",subPlan:Yt(f.exists)});t.limit&&!t.order&&(e.push({type:"ITERATOR_LIMIT",count:t.limit}),r=!0),e.push({type:"COLLECT"})}if((a.length>0||c)&&!i&&(e.push({type:"FILTER",filter:a,after:c}),i=!0),t.order&&t.order.length>0&&!s){let f=[];for(let d=0;d<t.order.length;d++){let[p,m,y]=t.order[d];if(y==null){f.push(t.order[d]);continue}let w=`_order_${d}`,E=Yt(y.subquery);y.cardinality==="one"&&E.push({type:"PICK"}),e.push({type:"SUBQUERY",alias:w,subPlan:E});let b=p.split(".").toSpliced(0,1,w).join(".");f.push([b,m,y])}e.push({type:"SORT",fields:f})}if(typeof t.limit=="number"&&!r&&e.push({type:"LIMIT",count:t.limit}),t.include)for(let[f,d]of Object.entries(t.include)){let p=Yt(d.subquery);d.cardinality==="one"&&p.push({type:"PICK"}),e.push({type:"SUBQUERY",alias:f,subPlan:p})}return e}function Wr(t){let e={views:new Map,rewrittenQuery:t};if(t.where){let{where:r,views:n}=Hy(t.where);t.where=r,Qr(e.views,n)}if(t.include)for(let[r,n]of Object.entries(t.include)){let{views:i,rewrittenQuery:s}=Wr(n.subquery);Qr(e.views,i),t.include[r]={...t.include[r],subquery:s}}if(t.order)for(let r=0;r<t.order.length;r++){let[n,i,s]=t.order[r];if(s==null)continue;let{views:o,rewrittenQuery:a}=Wr(s.subquery);Qr(e.views,o),t.order[r][2]={...s,subquery:a}}return e}function Qr(t,e){for(let[r,n]of e.entries())t.has(r)||t.set(r,n)}function Hy(t){let e=new Map,r=[];for(let n of t)if(F(n)){let i=n.exists,s=i.where&&Ta(i.where),o=(i.where??[]).filter(a=>_(a)&&V(a[2])&&le(a[2])[0]===1);if(!s&&o.length<2){let a=Wr(i);a.rewrittenQuery.where=i.where?.filter(l=>!o.includes(l));let c=ae(a.rewrittenQuery);e.set(c,a.rewrittenQuery),Qr(e,a.views);let u=o.map(l=>{let[f,...d]=le(l[2]);return[d.join("."),"in",`$view_${c}.${l[0]}`]});r.push(...u)}else r.push(n)}else if(D(n)){let{where:i,views:s}=Hy(n.filters);r.push({...n,filters:i}),Qr(e,s)}else r.push(n);return{where:r,views:e}}function Kr(t){return{data:t,subqueries:{}}}function Jt(t){if(!t)return t;if(!("data"in t)||!("subqueries"in t))throw new Error('View entity is not properly formatted, expected "data" and "subqueries" keys but instead got: '+Object.keys(t));if(Object.keys(t.subqueries).length===0)return t.data;let e={};for(let[r,n]of Object.entries(t.subqueries))e[r]=Array.isArray(n)?n.map(Jt):Jt(n);return{...t.data,...e}}function Gr(t){return Object.fromEntries(Object.entries(t).map(([r,n])=>[r,Array.isArray(n)?n.map(Jt):Jt(n)]))}var De=class{storage;store;constructor(e,r){this.storage=e,this.store=r}async fetch(e,r={}){let n=Gy(structuredClone(e)),i=await this.executeSteps(n.steps,{vars:r,viewPlans:n.views});if(Array.isArray(i))return i;throw new Vr("many","one")}async executeSteps(e,{vars:r,viewPlans:n,preparedViews:i={}}){r.entityStack=r.entityStack||[];let s=[],o,a;for(let c of e)switch(c.type){case"PREPARE_VIEW":{let u=`view_${c.viewId}`;if(u in i)break;let{steps:l}=n[c.viewId],f=await this.executeSteps(l,{vars:r,viewPlans:n,preparedViews:i});i[u]=f;break}case"RESOLVE_FROM_VIEW":{let u=`view_${c.viewId}`,l=i[u];if(!l)throw new Error(`View ${c.viewId} not found`);if(!Array.isArray(l))throw new Vr("many","one");let f=xt(c.filter,r);s=[...l];for(let d of f)s=Je.resolveQueryFromView(s,d);a=s;break}case"SUBQUERY":{let u=c.subPlan;for(let l of s){c.alias in l.subqueries;let f=await this.executeSteps(u,{vars:{...r,entityStack:(r.entityStack??[]).concat(Jt(l))},viewPlans:n,preparedViews:i});l.subqueries[c.alias]=f}break}case"SCAN":{o=c.collectionName,a=this.getCollectionCandidates({collectionName:o});break}case"ID_LOOK_UP":{let u=c.ids;if(typeof u=="string"){if(!V(u))throw new g("Invalid ID_LOOK_UP input, expected variable or string[]");let l=Mr(u,{...r,...Gr(i)});u=Yy(l)}o=c.collectionName,a=this.getCollectionCandidatesById(o,new Set(u));break}case"COLLECT":{if(!a)throw new Error("No candidate iterator found when trying to COLLECT");s=await Array.fromAsync(a);break}case"ITERATOR_LIMIT":{if(!a)throw new Error("No candidate iterator found when trying to ITERATOR_LIMIT");a=Ty(a,c.count);break}case"ITERATOR_FILTER":{let l=xt(c.filter,{...r,...Gr(i)}).map(f=>d=>st(d.data,f));c.after&&l.push(({data:f})=>!!Ur(f,c.after.after,c.after.order)),a=va(a,f=>{for(let d of l)if(!d(f))return!1;return!0});break}case"ITERATOR_SUBQUERY_FILTER":{let u=c.subPlan;a=va(a,async l=>{let f=await this.executeSteps(u,{vars:{...r,entityStack:(r.entityStack??[]).concat(Jt(l))},viewPlans:n,preparedViews:i});return Array.isArray(f)?f.length>0:f!==null});break}case"FILTER":{if(o==null)throw new Error("No collection name found when trying to FILTER");let u=xt(c.filter,{...r,...i});s=s.filter(l=>{for(let f of u){let d=f;if(!st(l.data,d))return!1}return!(c.after&&!Ur(l.data,c.after.after,c.after.order))});break}case"SORT":{Aa(s,c.fields);break}case"LIMIT":{s=s.slice(0,c.count);break}case"PICK":return s[0]??null;default:throw new Error(`Unknown step type: ${c.type}`)}return s}async*getCollectionCandidates(e){for await(let r of this.store.getEntitiesInCollection(this.storage,e.collectionName))yield Kr(r)}async*getCollectionCandidatesById(e,r){let n=[];for(let i of r){let s=await this.store.getEntity(this.storage,e,i);s&&(yield Kr(s))}return n}};function Yy(t){let e=[];if(typeof t=="string")e=[t];else if(Array.isArray(t))e=t.flatMap(Yy);else if(typeof t=="object"&&t!==null)for(let[r,n]of Object.entries(t))n===!0&&e.push(r);return e}function Aa(t,e){let r=e.map(([n,i,s])=>{let o=n.split(".");if(s){let a=Jy(s.subquery);return[o.slice(0,a+1).flatMap(c=>["subqueries",c]).concat("data",o.slice(-1)),i,s]}return[["data",...o],i]});t.sort((n,i)=>{for(let[s,o]of r){let a=W(q.Get(n,s)??Or,q.Get(i,s)??Or);if(a!==0)return o==="ASC"?a:-a}return 0})}function Jy(t){let e=0;if(!t.include)return e;for(let r in t.include){let n=t.include[r];e=Math.max(e,Jy(n.subquery)+1)}return e}var Ai=ft(nm(),1);var Zt=class t{storage;sets;deletes;_status="open";constructor(e,r,n){this.storage=e,this.sets=r??new he,this.deletes=n??new he}get status(){return this._status}scope(e){return new t(this.storage.scope(e),this.sets.scope(e),this.deletes.scope(e))}async clear(e){this.checkTxStatusBeforeOperation(),await this.sets.clear(e),await this.deletes.clear(e)}async get(e,r){this.checkTxStatusBeforeOperation();let n=await this.deletes.get(e,r)===null,i=await this.sets.get(e,r);if(n)return i;let s=await this.storage.get(e,r);return i===void 0?s:i}async set(e,r,n){return this.checkTxStatusBeforeOperation(),this.sets.set(e,r,n)}async delete(e,r){return this.checkTxStatusBeforeOperation(),await this.sets.delete(e,r),this.deletes.set(e,null,r)}async*scan(e,r){this.checkTxStatusBeforeOperation();for await(let[n,i]of Ay(Py(this.storage.scan(e,r),this.sets.scan(e,r),this.deletes.scan(e,r)),([s])=>JSON.stringify(s))){let s=e.prefix?.length?[...e.prefix,...n]:n,o=await this.sets.get(s,r),a=await this.deletes.get(s,r)===null;if(!a&&o===void 0){yield[n,i];continue}a&&o===void 0||(yield[n,o])}}async*scanValues(e,r){yield*wa(this.scan(e,r),([n,i])=>i)}async count(e,r){this.checkTxStatusBeforeOperation();let n=0;for await(let[i]of this.scan({prefix:e.prefix},r))n++;return Promise.resolve(n)}async commit(){this.checkTxStatusBeforeOperation(),await this.storage.applyEdits(this.sets.scan({prefix:[]}),wa(this.deletes.scan({prefix:[]}),e=>e[0])),this._status="committed"}checkTxStatusBeforeOperation(){if(this._status!=="open"){if(this._status==="committed")throw new mi;if(this._status==="cancelled")throw new ot}}cancel(){this.checkTxStatusBeforeOperation(),this._status="cancelled"}};var er=class t{store;prefix;constructor(e,r){this.store=e,this.prefix=r}scope(e){return new t(this.store,[...this.prefix,...e])}get(e){return this.store.get(e,this.prefix)}set(e,r){return this.store.set(e,r,this.prefix)}delete(e){return this.store.delete(e,this.prefix)}scan(e){return this.store.scan(e,this.prefix)}scanValues(e){return this.store.scanValues(e,this.prefix)}clear(){return this.store.clear(this.prefix)}count(e){return this.store.count(e,this.prefix)}transact(){return new Na(this.store.transact(),this.prefix)}applyEdits(e,r){return this.store.applyEdits(e,r)}},Na=class t{tx;prefix;constructor(e,r){this.tx=e,this.prefix=r}scope(e){return new t(this.tx,[...this.prefix,...e])}get(e){return this.tx.get(e,this.prefix)}set(e,r){return this.tx.set(e,r,this.prefix)}delete(e){return this.tx.delete(e,this.prefix)}scan(e){return this.tx.scan(e,this.prefix)}scanValues(e){return this.tx.scanValues(e,this.prefix)}clear(){return this.tx.clear(this.prefix)}count(e){return this.tx.count(e,this.prefix)}commit(){return this.tx.commit()}cancel(){return this.tx.cancel()}get status(){return this.tx.status}};var GP="default"in Ai.default?Ai.default.default:Ai.default,he=class{data;constructor(e){this.data=e??new GP(void 0,Vt)}get(e,r){let n=r?[...r,...e]:e;return Promise.resolve(this.data.get(n))}set(e,r,n){let i=n?[...n,...e]:e;return this.data.set(i,r),Promise.resolve()}delete(e,r){let n=r?[...r,...e]:e;return this.data.delete(n),Promise.resolve()}*scan(e,r){let n=r?[...r,...e.prefix]:e.prefix,i=[...n,"\uFFFF"],s=[];this.data.forRange(n,i,!1,(o,a)=>{let c=(r?.length??0)+e.prefix.length,u=c>0?o.slice(c):o;u.length!==0&&s.push([u,a])}),yield*s}*scanValues(e,r){let n=r?[...r,...e.prefix]:e.prefix,i=[...n,"\uFFFF"],s=[];this.data.forRange(n,i,!1,(o,a)=>{s.push(a)}),yield*s}count(e,r){let n=r?[...r,...e.prefix]:e.prefix;if(!n.length)return this.data.size;let i=[...n,"\uFFFF"];return this.data.forRange(n,i,!1)}transact(){return new Zt(this)}async clear(e){if(!e?.length){this.data.clear();return}for await(let[r]of this.scan({prefix:e}))await this.delete(r,e)}scope(e){return new er(this,e)}async applyEdits(e,r){for await(let n of r)this.data.delete(n);for await(let[n,i]of e)this.data.set(n,i)}};var tr=class{_buffers;activeBufferIndex=0;constructor(e,r){this._buffers=[e,r]}get activeBuffer(){return this._buffers[this.activeBufferIndex]}get inactiveBuffer(){return this._buffers[1-this.activeBufferIndex]}async getChangesForCollection(e,r){let[n,i]=await Promise.all([this.inactiveBuffer.getChangesForCollection(e,r),this.activeBuffer.getChangesForCollection(e,r)]);if(!(!n&&!i))return n?i?Ri({},{[r]:n},{[r]:i})[r]:n:i}async getChangesForEntity(e,r,n){let i=await this.inactiveBuffer.getChangesForEntity(e,r,n),s=await this.activeBuffer.getChangesForEntity(e,r,n);if(!i&&!s)return;let o=!!(i?.delete||s?.delete);return{update:ce({},i?.update,s?.update),delete:o}}async clear(e){await Promise.all(this._buffers.map(r=>r.clear(e)))}async clearChangesForEntity(e,r,n){await Promise.all(this._buffers.map(i=>i.clearChangesForEntity(e,r,n)))}async write(e,r){await this.activeBuffer.write(e,r)}async isEmpty(e){return(await Promise.all([this.activeBuffer.isEmpty(e),this.inactiveBuffer.isEmpty(e)])).every(r=>r)}async getChanges(e){let r=await Promise.all([this.getLockedBuffer().getChanges(e),this.getUnlockedBuffer().getChanges(e)]);return Ri({},r[0],r[1])}lockAndSwitchBuffers(){this.activeBufferIndex=this.activeBufferIndex===0?1:0}getLockedBuffer(){return this.inactiveBuffer}getUnlockedBuffer(){return this.activeBuffer}};function Yr(t,e=[],r=new Map){if(e.push(t),t.where){for(let n of Ce(t.where))if(F(n))Yr(n.exists,e,r);else if(_(n)&&V(n[2])){let[i,s]=le(n[2]);if(_r(i)){let o=e[e.length-i-1];if(o){let a=ae(o);r.has(a)||r.set(a,new Set),r.get(a)?.add(s)}}}}if(t.include)for(let n in t.include){let{subquery:i}=t.include[n];Yr(i,e,r)}if(t.order)for(let n of t.order){let i=n[2];i&&Yr(i.subquery,e,r)}return e.pop(),r}function Jr(t,e=[],r=new Map){for(let i of e)r.get(i)?.add(t.collectionName);let n=ae(t);if(e.push(n),r.set(n,new Set().add(t.collectionName)),t.where){for(let i of Ce(t.where))if(F(i)){let{exists:s}=i;Jr(s,e,r)}}if(t.include)for(let i in t.include){let{subquery:s}=t.include[i];Jr(s,e,r)}if(t.order)for(let i of t.order){let s=i[2];s&&Jr(s.subquery,e,r)}return e.pop(),r}function Xr(t){if(t.where&&Dy(t.where,F))return!0;if(t.include)for(let e in t.include){let{subquery:r}=t.include[e];if(Xr(r))return!0}if(t.order)for(let e of t.order){let r=e[2];if(r&&Xr(r.subquery))return!0}return!1}function ki(t){if(t.order){for(let e of t.order)if(e[2])return!0}if(t.include)for(let e in t.include){let{subquery:r}=t.include[e];if(ki(r))return!0}return!1}function Zr(t,e,r=!0){if(r&&(t=JSON.parse(JSON.stringify(t))),t.where&&(t.where=im(t.where,e)),t.include)for(let n in t.include)t.include[n].subquery=Zr(t.include[n].subquery,e,!1);if(t.order)for(let n of t.order){let i=n[2];i&&(i.subquery=Zr(i.subquery,e,!1))}return t}function im(t,e){return t.map(r=>HP(r,e))}function HP(t,e){if(D(t))return{mod:t.mod,filters:im(t.filters,e)};if(_(t)&&V(t[2])&&t[2].startsWith("$view_")){let r=t[2],n=Mr(r,e);return Array.isArray(n)&&(n=new Set(n)),[t[0],t[1],n]}return t}function qa(t){let e=structuredClone(t),r=0;if(e.where)for(let n of Ce(e.where))F(n)&&(e.include||(e.include={}),e.include[`_exists-${r}`]={subquery:qa(n.exists),cardinality:"one"},r++);return e}function sm(t){if(!t.order)return t;let e=structuredClone(t);for(let[r,n,i]of e.order)i&&(e.include={...e.include,[r]:i});return e}function en(t,e,r={}){let n=e.collectionName;r[n]||(r[n]={sets:new Map,deletes:new Set});let i=e.include??{};for(let s of t){r[n].sets.set(s.data.id,s.data);for(let[o,{subquery:a}]of Object.entries(i)){let c=s.subqueries[o];c!=null&&en(Array.isArray(c)?c:[c],a,r)}}return r}function _a(t){return{id:ae(t),usedBy:new Set,dependsOn:new Map,results:void 0,query:t,shouldRefetch:Xr(t)||ki(t),hasChanged:!1,cachedBoundQuery:void 0,referencedRelationalVariables:Yr(t),collectionsReferencedInSubqueries:Jr(t)}}function om(t){for(let e of t.values())e.results=void 0,e.cachedBoundQuery=void 0,e.hasChanged=!0}function Ma(t,e,r){if(e.where){for(let n of Ce(e.where))if(_(n)&&Pa(n)){let i=Number(n[2].split(".")[0].split("_")[1]);r.has(i)&&(t.dependsOn.set(n[2],r.get(i)),r.get(i).usedBy.add(t))}}if(e.include)for(let n in e.include){let i=e.include[n].subquery;Ma(t,i,r)}}function am(t){let e=new Set;if(t.usedBy.size>0)return e;e.add(t.id);for(let[r,n]of t.dependsOn.entries()){n.usedBy.delete(t);let i=am(n);for(let s of i)e.add(s)}return e}function cm(t,e){let r=am(t);for(let n of r)e.delete(n);return r}function um(t,e){let r=null,{views:n,rewrittenQuery:i}=Wr(structuredClone(t));return!Xr(i)&&!ki(i)?(r=_a(i),e.set(r.id,r),YP(n,e),Ma(r,i,e)):(r=_a(t),e.set(r.id,r)),r}function YP(t,e){let r=[];for(let[n,i]of t.entries()){if(e.has(n))continue;let s=_a(i);e.set(n,s),r.push(s)}for(let n of r)Ma(n,n.query,e);return e}var JP=function(t,e,r){if(e!=null){if(typeof e!="object"&&typeof e!="function")throw new TypeError("Object expected.");var n,i;if(r){if(!Symbol.asyncDispose)throw new TypeError("Symbol.asyncDispose is not defined.");n=e[Symbol.asyncDispose]}if(n===void 0){if(!Symbol.dispose)throw new TypeError("Symbol.dispose is not defined.");n=e[Symbol.dispose],r&&(i=n)}if(typeof n!="function")throw new TypeError("Object not disposable.");i&&(n=function(){try{i.call(this)}catch(s){return Promise.reject(s)}}),t.stack.push({value:e,dispose:n,async:r})}else r&&t.stack.push({async:!0});return e},XP=function(t){return function(e){function r(o){e.error=e.hasError?new t(o,e.error,"An error was suppressed during disposal."):o,e.hasError=!0}var n,i=0;function s(){for(;n=e.stack.pop();)try{if(!n.async&&i===1)return i=0,e.stack.push(n),Promise.resolve().then(s);if(n.dispose){var o=n.dispose.call(n.value);if(n.async)return i|=2,Promise.resolve(o).then(s,function(a){return r(a),s()})}else i|=1}catch(a){r(a)}if(i===1)return e.hasError?Promise.reject(e.error):Promise.resolve();if(e.hasError)throw e.error}return s()}}(typeof SuppressedError=="function"?SuppressedError:function(t,e,r){var n=new Error(r);return n.name="SuppressedError",n.error=t,n.suppressed=e,n}),Ni=class{db;storage=new he;entityStore=new Gt(["entities"]);doubleBuffer=new tr(new Br,new Br);runningLock;subscribedQueries=new Map;uninitializedQueries=new Set;viewGraph=new Map;constructor(e){this.db=e}subscribe(e,r,n){let i=ae(e);if(!this.subscribedQueries.has(i)){let o=um(e,this.viewGraph),a={query:e,listeners:new Set,errorCallbacks:new Set,uninitializedListeners:new WeakSet,rootNode:o};this.subscribedQueries.set(i,a),this.uninitializedQueries.add(i)}let s=this.subscribedQueries.get(i);return s.listeners.add(r),s.uninitializedListeners.add(r),n&&s.errorCallbacks.add(n),()=>{let o=this.subscribedQueries.get(i);if(!o){we.warn("Query not found",{rootQueryId:i});return}o.listeners.delete(r),o.uninitializedListeners.delete(r),n&&o.errorCallbacks.delete(n),o.listeners.size===0&&(cm(o.rootNode,this.viewGraph),this.subscribedQueries.delete(i))}}async initializeQueryResults(e){if(e.results)return e.results;let r=e.query;if(e.dependsOn.size>0)if(e.cachedBoundQuery)r=e.cachedBoundQuery;else{let i={};for(let[s,o]of e.dependsOn.entries()){let a=await this.initializeQueryResults(o);i[s.split(".")[0].slice(1)]=a}r=Zr(r,Gr(i)),e.cachedBoundQuery=r}let n=await this.db.rawFetch(r);return e.results=n,n}flushChangesToListeners(){for(let e of this.subscribedQueries.keys()){let r=this.subscribedQueries.get(e);for(let n of r.listeners){if(!r.rootNode.results){we.error("Results not found for query",{queryId:e});continue}if(!r.uninitializedListeners.has(n)&&!r.rootNode.hasChanged)continue;let i=r.rootNode.results;r.uninitializedListeners.delete(n),i!=null&&n({results:i})}r.rootNode.hasChanged=!1}}async bufferChanges(e){let r=structuredClone(e);for(let i in r)r[i].sets.size===0&&r[i].deletes.size===0&&delete r[i];if(Ye(r))return;let n=this.storage.transact();try{this.subscribedQueries.size>0&&this.doubleBuffer.write(void 0,r)}finally{await n.commit()}}async acquireRunningLock(){for(;this.runningLock!==void 0;)await this.runningLock?.promise;this.runningLock=Promise.withResolvers();let e=this.runningLock.resolve;return{[Symbol.dispose]:()=>{this.runningLock=void 0,e()}}}async updateViews(){let e={stack:[],error:void 0,hasError:!1};try{let r=JP(e,await this.acquireRunningLock(),!1);this.doubleBuffer.lockAndSwitchBuffers();let n=await this.doubleBuffer.inactiveBuffer.getChanges(this.storage),i=new Set;for(let a of this.uninitializedQueries){let c=this.subscribedQueries.get(a);c&&c.rootNode.results==null&&(await this.initializeQueryResults(c.rootNode),i.add(c.rootNode)),this.uninitializedQueries.delete(a)}let s=this.getAffectedViewsInTopologicalOrder(n);for(let[a,c]of s){if(i.has(a))continue;if(a.shouldRefetch){a.results=await this.db.rawFetch(a.query),a.hasChanged=!0;continue}let u=!1;for(let d of a.dependsOn.values())if(d.hasChanged){u=!0;break}if(!u){if(a.dependsOn.size>0&&!a.cachedBoundQuery)throw new Error("View node has dependencies but no cached bound query");if(!a.results)throw new Error("View node is being updated before it is initialized");let{updatedResults:d,hasChanged:p}=await this.updateQueryResultsInPlace(a.results,c,a.cachedBoundQuery??a.query,a.query,a);a.results=d,a.hasChanged=p;continue}let l={};for(let[d,p]of a.dependsOn.entries()){if(!p.results)throw new Error("view results not found during update: "+p.results);l[d.split(".")[0].slice(1)]=p.results}let f=Zr(a.query,Gr(l));a.cachedBoundQuery=f,a.results=await this.db.rawFetch(f),a.hasChanged=!0}let o=this.storage.transact();this.doubleBuffer.inactiveBuffer.clear(o),await o.commit()}catch(r){e.error=r,e.hasError=!0}finally{XP(e)}}async updateQueryResultsInPlace(e,r,n,i,s,o=[]){let a=r[n.collectionName],c=e,u=new Map,l=new Map,f=new Map,d=new Map,{collectionName:p,where:m,order:y,after:w,limit:E,include:b}=n;if(a){let R=new Set,Te=a.deletes,k=a.sets,X=T=>y&&y.some(([$])=>q.Get(T,$)!==void 0),ye=T=>(!m||ZP(T,m))&&(!w||Ur(T,w,y));if((Te.size>0||k.size>0)&&(c=c.filter(T=>{let $=!0;if(Te.has(T.data.id)&&($=!1),k.has(T.data.id)){let me=k.get(T.data.id);Ht(T.data,me,{clone:!1}),f.set(T.data.id,T.data),$=ye(T.data),$&&(d.set(T.data.id,me),X(me)&&R.add(T.data.id))}return $||u.set(T.data.id,T.data),$}),E&&e.length===E&&(u.size>0||R.size>0&&y)))return{updatedResults:await this.db.rawFetch(n,{entityStack:o}),hasChanged:!0};for(let[T,$]of k){if(f.has(T))continue;if(e0($)){ye($)&&(l.set(T,$),c.push(Kr($)));continue}if(m&&!lm($,m)&&!X($))continue;let me=await this.db.entityStore.getEntity(this.db.kv,p,T);me!=null&&ye(me)&&(l.set(me.id,me),c.push(Kr(me)))}if(y!=null&&!(l.size===0&&R.size===0)&&Aa(c,y),E!=null&&c.length>E){for(let T=E;T<c.length;T++){let $=c[T];l.has($.data.id)&&l.delete($.data.id)}c=c.slice(0,E)}}let re=!1;if(b){let R=new Set;l.keys().forEach(k=>{R.add(k)});let Te=s.referencedRelationalVariables.get(ae(i));if(Te&&d.entries().forEach(([k,X])=>{for(let ye of Te)if(q.Get(X,ye)!==void 0){R.add(k);break}}),c.length>0)for(let k in b){let{subquery:X,cardinality:ye}=b[k],T=i.include?.[k];if(!T)throw new Error("Inclusion is transformed query not found in original query: "+k);let{subquery:$}=T,me=s.collectionsReferencedInSubqueries.get(ae($));if(!me)throw new Error("Subquery not found in collectionsReferencedInSubqueries");let ic=!1;for(let Rt of me)if(r[Rt]){ic=!0;break}if(ic)for(let Rt of c){if(R.has(Rt.data.id))continue;let sc=o.concat(Rt.data),un=Rt.subqueries[k],gs=await this.updateQueryResultsInPlace(Array.isArray(un)?un:un===null?[]:[un],r,{...X,where:X.where?xt(X.where,{entityStack:sc}):void 0},$,s,sc),ug=ye==="one"?gs.updatedResults?.[0]??null:gs.updatedResults;Rt.subqueries[k]=ug,gs.hasChanged&&(re=!0)}}if(R.size>0){let k=[["id","in",R]],X=await this.db.rawFetch({...n,where:m?m.concat(k):k},{entityStack:o});for(let ye of X){let T=c.findIndex($=>$.data.id===ye.data.id);c[T]=ye}}}return{updatedResults:c,hasChanged:u.size>0||l.size>0||f.size>0||re}}getAffectedViewsInTopologicalOrder(e){let r=new Map;for(let o of this.viewGraph.values()){let a={};for(let c in e)o.collectionsReferencedInSubqueries.get(o.id)?.has(c)&&(a[c]=e[c]);Ye(a)||r.set(o,a)}let n=new Set(Array.from(r.keys()));for(;n.size>0;){let o=new Set;for(let a of n)for(let c of a.usedBy)r.has(c)||(r.set(c,{}),o.add(c));n=o}let i=new Map,s=new Set(Array.from(r.keys()));for(;s.size>0;){let o=new Set;for(let a of s)if(a.dependsOn.size===0){i.set(a,r.get(a));continue}else{let c=!0;for(let u of a.dependsOn.values())if(s.has(u)){c=!1;break}if(c){i.set(a,r.get(a));continue}o.add(a)}s=o}return i}resetSubscriptions(){om(this.viewGraph);for(let e of this.subscribedQueries.keys())this.uninitializedQueries.add(e)}async clear(){await this.storage.clear(),this.subscribedQueries.clear(),this.uninitializedQueries.clear(),this.viewGraph.clear()}};function ZP(t,e){return e.every(r=>st(t,r,!0))}function lm(t,e){return e.some(r=>{if(Me(r))return!1;if(D(r))return lm(t,r.filters);if(F(r))throw new Error("Subquery filters are not supported in this context");let n=r[0].split(".");return q.Get(t,n)!==void 0})}function e0(t){return t.id!==void 0}function fm(t,e,r){let n=t0(t,e,r),i=n.next();for(;!i.done;)i=n.next();return i.value}function Fa(t,e,r,n){let i=qi(e,r),s=t.split("."),o=[];for(let a=0;a<s.length;a++){let c=s[a];i=i.get(c),o.push(c);let{valid:u,reason:l}=n(i.current,a,s);if(!u)return{valid:u,path:o.join("."),reason:l}}return{valid:!0}}function t0(t,e,r){let n=qi(e,r),i=t[Symbol.iterator]();return{next(){let{value:s,done:o}=i.next();return o?{done:o,value:n.current}:(n=n.get(s),{done:!1,value:n.current})},[Symbol.iterator](){return this}}}function rr(t,e,r){let n=qi(e,r),i=[],s=t[Symbol.iterator]();return{next(){let{value:o,done:a}=s.next();return a?{done:a,value:[i,n.current]}:(n=n.get(o),i.push(o),{done:!1,value:[i,n.current]})},[Symbol.iterator](){return this}}}function qi(t,e){let r=!0,n=t[e]?.schema,i=s=>{if(n===void 0)return{get:i,current:n};if(pe(n))return qi(t,n.query.collectionName).get(s);let o=n;return r&&s in(t[e].relationships??{})?o=t[e].relationships[s]:n.type==="record"?(o=n.properties[s],r=!1):n.type==="json"?(o=n,r=!1):o=void 0,n=o,{get:i,current:n}};return{get:i,current:t[e]?.schema}}function pe(t){return t!==void 0&&"query"in t}function tn(t){return t.where=r0(t.where),t.include=o0(t.include),t.order=a0(t.order),t}function r0(t){if(!t)return t;if(t=ja(t,"and"),t.length!==0)return t}function ja(t,e){let r=[];for(let n=0;n<t.length;n++){let i=t[n],s=dm(i);if(s!==void 0)if(D(s)&&s.mod===e)for(let o of s.filters)r.push(o);else r.push(s)}return r=s0(r,e),n0(r,e)}function n0(t,e){let r=new Set,n=[];for(let i of t){let{hash:s}=Ia(i);r.has(s)||(r.add(s),n.push(i))}return n.length!==t.length?ja(n,e):n}function dm(t){if(D(t))return i0(t);if(F(t)){let e=tn(t.exists);return e.where&&e.where.length===1&&e.where[0]===!1?!1:{exists:e}}return t}function i0(t){if(t.filters=ja(t.filters,t.mod),t.filters.length!==0)return t.filters.length===1?dm(t.filters[0]):t}function s0(t,e){return e==="and"&&t.some(r=>r===!1)?[!1]:e==="or"&&t.some(r=>r===!0)?[!0]:t}function o0(t){if(!t)return t;let e=Object.keys(t);if(e.length!==0){for(let r of e){let n=t[r];n.subquery=tn(n.subquery)}return t}}function a0(t){if(!t)return t;if(t.length!==0){for(let e=0;e<t.length;e++){let r=t[e];if(r.length===3){let n=r[2];t[e]=[r[0],r[1],{...n,subquery:tn(n.subquery)}]}}return t}}function _i(t){return!nr(t)&&typeof t=="object"&&"subquery"in t}function nr(t){return t===!0||t===null}function Mi(t){return!nr(t)&&typeof t=="object"&&"_extends"in t}function hm(t){return t==="one"||t==="many"}var pm=Object.freeze([!1]);function Ie(t,e,r,n,i){t.vars&&!r.$query&&(r={...r,$query:t.vars});let s=ji(t,e,r,n,{applyPermission:i.applyPermission,isExpandingPermission:!1,permissionStack:[],queryStack:[],replaceStaticVariables:i.replaceStaticVariables??!0});return tn(s)}function ji(t,e,r,n,i){i.queryStack.push(t);let s={collectionName:u0(t,e),select:l0(t,e),include:f0(t,e,r,n,i),where:d0(t,e,r,n,i),order:h0(t,e,r,n,i),limit:p0(t),after:y0(t,e)};return i.queryStack.pop(),s}function c0(t){return t==="_metadata"}function u0(t,e){let r=t.collectionName;if(!r)throw new Fe(r,"Collection name must be provided");if(!(typeof r=="string"))throw new Fe(r,"Collection name must be a string");if(e&&!e[r]&&!c0(r))throw new Fe(r,`Collection '${r}' does not exist in the schema`);return r}function l0(t,e){if(!t.select)return t.select;for(let r of t.select){if(typeof r!="string")throw new Lr(`Select field '${r}' is not a string`);if(e){let{valid:n,path:i,reason:s}=Fa(r,e,t.collectionName,(o,a,c)=>o?pe(o)?{valid:!1,reason:"Cannot select into relationships, please use 'include' instead"}:{valid:!0}:{valid:!1,reason:"Path not found"});if(!n)throw new Lr(`Select field '${r}' is not valid: ${s} at path '${i}'`)}}return[...t.select]}function f0(t,e,r,n,i){if(!t.include)return t.include;let s={};for(let[o,a]of Object.entries(t.include)){if(e){let u,l=null;if(nr(a))u=o;else if(Mi(a)){let{_extends:f,...d}=a;u=f,l=d}if(u){let f=fm(u.split("."),e,t.collectionName);if(f&&pe(f))a={subquery:m0(f.query,l),cardinality:f.cardinality};else throw f?new xi(u,o,t.collectionName):new Si(u,o,t.collectionName)}}if(!_i(a))throw new pi(a);if(!hm(a.cardinality))throw new bi(a.cardinality);let c=ji(a.subquery,e,r,n,i);s[o]={subquery:c,cardinality:a.cardinality}}return s}function d0(t,e,r,n,i){let s=t.where??[];if(!Array.isArray(s))throw new yi(t.where,"Where clause must be an array");s=[...s];let o=Da(s,t,e,r,n,i);if(i.applyPermission&&(!i.isExpandingPermission||!i.permissionStack.includes(t.collectionName))){let c=fi(e,t.collectionName);if(c){let u=[],l=!1;if(n?.roles)for(let d of n.roles){let p=c[d.key]?.[i.applyPermission];if(p?.filter)if(Array.isArray(p.filter))if(l=!0,p.filter.length===0)u.push(pm);else{let m={...i,applyPermission:Sy(i.applyPermission)?"read":i.applyPermission,isExpandingPermission:!0,permissionStack:[...i.permissionStack??[],t.collectionName]},y=ym(p.filter);u.push(Da(y,t,e,{...r,$role:d.roleVars},n,m))}else throw new oe("Invalid permission filter format, expected array")}!l&&i.applyPermission!=="postUpdate"&&(u=[pm]);let f=My(u.map(d=>Fy(d)));o.push(f)}}if(o.length)return o}function ym(t){return t.map(e=>{if(_(e)){let[r,n,i]=e;if(V(i)){let s=le(i);if(s[0]===void 0)return s[0]=0,[r,n,"$"+s.join(".")]}return[r,n,i]}return D(e)?{...e,filters:ym(e.filters)}:e})}function Da(t,e,r,n,i,s){return t.map(o=>Fi(o,e,r,n,i,s))}function Fi(t,e,r,n,i,s){if(Me(t))return t;if(D(t)){if(t.mod!=="and"&&t.mod!=="or")throw new oe(`Invalid filter group mod '${t.mod}'`);return{mod:t.mod,filters:Da(t.filters,e,r,n,i,s)}}if(_(t)){let[o,a,c]=t;if(r){let u=o.split("."),l;for(let[f,d]of rr(u,r,e.collectionName)){if(pe(d)){let p={...d.query},m=u.slice(f.length).join(".");return V(c)&&(c=Sa(c)),p.where=[...p.where??[],[m,a,c]],Fi({exists:p},p,r,n,i,s)}l=d}if(!l)throw new oe(`Could not find property '${o}' in the schema`);if(l.type==="set"&&!a.startsWith(He)&&(a=`${He}${a}`),!A.supportedOperations(l).includes(a))throw new oe(`Operator '${a}' is not valid for property '${o}' of type '${l.type}'`)}if(V(c)){let u=le(c),l=u[0];if(l===void 0&&(u[0]=1,l=u[0],c="$"+u.join(".")),!_r(l))s.replaceStaticVariables&&(c=q.Get(n,u));else if(r){let f=s.queryStack[s.queryStack.length-l-1],d=u.slice(1);for(let[p,m]of rr(d,r,f.collectionName))if(pe(m)){let y={...m.query},w=xa(y,s.queryStack.length-1),E=d.slice(p.length).join("."),b=cy(a),re=`$1.${o}`;return w.where=[...w.where??[],[E,b,re]],Fi({exists:w},y,r,n,i,s)}}}return c instanceof Date&&(c=c.toISOString()),Array.isArray(c)&&(c=new Set(c)),[o,a,c]}if(zt(t)){if(!r)throw new oe("A schema is required to execute an exists filter");let{exists:o}=t,{_extends:a,...c}=o,u=a.split("."),l,f;for(let[y,w]of rr(u,r,e.collectionName))if(l=y,f=w,pe(f))break;if(!f)throw new oe(`Could not find property '${a}' in the schema`);if(!pe(f))throw new oe("Cannot execute an exists filter on a non-relation property");let d={...f.query},m=u.length===l.length?c?.where:[jy(u.slice(l.length).join("."),c)];return d.where=[...f.query.where??[],...m??[]],Fi({exists:d},d,r,n,i,s)}if(F(t)){let{exists:o}=t,a={collectionName:o.collectionName,where:o.where};return{exists:ji(a,r,n,i,s)}}throw new oe("Filter is not valid format")}function h0(t,e,r,n,i){if(!t.order)return t.order;let s=[];for(let[o,a]of t.order){if(a!=="ASC"&&a!=="DESC")throw new $r(`Invalid order direction '${a}'`);if(e){let{valid:c,path:u,reason:l}=Fa(o,e,t.collectionName,(p,m,y)=>p?m===y.length-1&&(pe(p)||p.type==="set"||p.type==="record")?{valid:!1,reason:"Order by field is not sortable"}:pe(p)&&p.cardinality!=="one"?{valid:!1,reason:"Order by field is a query with cardinality not equal to one"}:{valid:!0}:{valid:!1,reason:"Path not found"});if(!c)throw new $r(`Order by field '${o}' is not valid: ${l} at path '${u}'`);let f,d;for(let[p,m]of rr(o.split("."),e,t.collectionName)){let y=p[p.length-1];if(m&&pe(m)){let w={...m.query};f?f.include={...f.include,[y]:{subquery:w,cardinality:m.cardinality}}:(f=w,d=m.cardinality)}else break}if(f){let p=ji(f,e,r,n,i);s.push([o,a,{subquery:p,cardinality:"one"}]);continue}}s.push([o,a])}return s}function p0(t){if(!t.limit)return t.limit;if(typeof t.limit!="number")throw new jr("Limit must be a number");if(t.limit<0)throw new jr("Limit must be a positive number");return t.limit}function y0(t,e){if(!t.after)return t.after;if(!Array.isArray(t.after))throw new te("After clause must be an array");if(t.after.length<2)throw new te("After clause must contain a cursor and inclusive flag");if(t.after.length>2)throw new te("After clause has too many components - it should contain a cursor and inclusive flag");if(!Array.isArray(t.after[0]))throw new te("After clause cursor must be an array");if(!t.order)throw new te("After clause requires an order by clause to be provided");if(t.after[0].length!==t.order.length)throw new te("After clause cursor must match the elements in the order by clause");if(typeof t.after[1]!="boolean")throw new te("After clause inclusive flag must be a boolean");let r=[];for(let n=0;n<t.order.length;n++){let i=t.after[0][n];if(i===void 0)throw new te("Cursor value cannot be undefined");if(e){let s=t.order[n][0].split(".");for(let[o,a]of rr(s,e,t.collectionName)){if(!a)throw new te(`Attribute ${t.order[n][0]} not found in schema`);if(pe(a))throw new te(`Attribute ${t.order[n][0]} is not allowed in after clause because it is relational`);if(o.length===s.length){if(a.type==="set"||pe(a)||a.type==="record")throw new te(`Attribute ${t.order[n][0]} is not allowed in after clause because the type is not sortable`);try{i=A.encode(a,i)}catch(u){throw u instanceof g?new te(`Error converting cursor value for attribute ${t.order[n][0]}: ${u.message}`):u}}}}i instanceof Date&&(i=i.toISOString()),r.push(i)}return[r,t.after[1]]}function m0(t,e){if(!e)return{...t};let r=t.where||e.where?[...t.where??[],...e.where??[]]:void 0,n=t.select||e.select?[...t.select??[],...e.select??[]]:void 0;return{...t,...e,where:r,select:n}}function rn(t,e,r){return!r&&!e?t:t?e?r:ce({},t,r):r}async function*Di(t,e){if(!e){yield*t;return}let r=new Set;for await(let n of t){let i=n.id;r.add(i);let s=rn(n,e.deletes.has(i),e.sets.get(i));s&&(yield s)}for(let[n,i]of e.sets)!r.has(n)&&!e.deletes.has(n)&&(yield i)}var $i=class{kvTx;entityStore;changes={};schema;systemVars;session;typeConverters;skipRules;constructor(e){this.kvTx=e.kvTx,this.entityStore=new $a(e.entityStore,this.changes),this.schema=e.schema,this.systemVars=e.systemVars,this.session=e.session,this.typeConverters=e.typeConverters,this.skipRules=e.skipRules}async fetch(e){let r=Ie(e,this.schema?.collections,this.systemVars,this.session,{applyPermission:this.skipRules?void 0:"read"}),i=await new De(this.kvTx,this.entityStore).fetch(r);return ir(i,r,"many",this.typeConverters)}async fetchOne(e){return(await this.fetch({...e,limit:1}))[0]??null}async fetchById(e,r){let n={collectionName:e,where:[["id","=",r]]};return this.fetchOne(n)}async insert(e,r){if(this.kvTx.status==="cancelled")throw new ot;if(!e)throw new Fe(e,"Collection name must be defined");if(!r)throw new Dr("The document being inserted is undefined");if(typeof r!="object"||Array.isArray(r))throw new Dr("The document being inserted must be an object.");let n=this.schema?.collections[e]?.schema,i=v0(n,r);return i.id||(i.id=A.defaultValue(Zn.Id())),this.getOrCreateCollectionChanges(e).sets.set(i.id,i),n?A.decode(n,i):i}async update(e,r,n){if(!e)throw new Fe(e);if(this.kvTx.status==="cancelled")throw new ot;let i,s=this.schema?.collections[e]?.schema;if(typeof n=="function"){let c=structuredClone(await this.entityStore.getEntity(this.kvTx,e,r));if(!c)throw new Wt(r,e);let u=s?A.decode(s,c):c;i={},await n(Li(u,i,s))}else i=n;if("id"in i)throw new vi(`Attempted to update the id of an entity in the ${e} to ${i.id}. The 'id' attribute of an entity is immutable and cannot be updated.`);let o=this.getOrCreateCollectionChanges(e),a=o.sets.get(r);i=s?A.encode(s,i):i,!Oa(i)&&(a&&(i=ce({},a,i)),o.sets.set(r,i))}async delete(e,r){if(!e)throw new Fe(e);if(this.kvTx.status==="cancelled")throw new ot;let n=this.getOrCreateCollectionChanges(e),i=n.sets.get(r);if(i&&"id"in i){n.sets.delete(r);return}i&&n.sets.delete(r),n.deletes.add(r)}getOrCreateCollectionChanges(e){return this.changes[e]||(this.changes[e]={sets:new Map,deletes:new Set}),this.changes[e]}},$a=class{changes;baseStore;constructor(e,r={}){this.changes=r,this.baseStore=e}async applyChanges(e,r,n){return this.baseStore.applyChanges(e,r,n)}async getEntity(e,r,n){let i=await this.baseStore.getEntity(e,r,n);if(!this.changes[r])return i;let s=this.changes[r],o=s.deletes.has(n);return rn(i,o,s.sets.get(n))}async*getEntitiesInCollection(e,r){yield*Di(this.baseStore.getEntitiesInCollection(e,r),this.changes[r])}async getCollectionStats(e,r){throw new Error("getCollectionStats is not implemented in EntityStoreWithChanges")}};function Li(t,e,r){return new Proxy(t,{get(n,i){let s=r?.type==="record"?r.properties[i]:(r?.type==="json",r);return n[i]instanceof Set?(e[i]||(e[i]={}),g0(n[i],e[i],s)):typeof n[i]=="object"&&!(n[i]instanceof Date)&&n[i]!==null?(e[i]||(e[i]={}),Li(n[i],e[i],s)):Reflect.get(n,i)},set(n,i,s){if(typeof i=="symbol")return!0;let o=s;if(s instanceof Set){let a={};if(n[i]instanceof Set)for(let c of n[i])a[c]=!1;for(let c of s)a[c]=!0;o=a}else if(s===void 0)o=null;else if(s instanceof Date)o=s.toISOString();else if(typeof s=="object"&&s!==null&&!Array.isArray(s)){if(e[i]||(e[i]={}),o={},typeof n[i]=="object"&&n[i]!==null)for(let a in n[i])o[a]=null;for(let a in s)o[a]=s[a]}return e[i]=o,Reflect.set(n,i,s)},deleteProperty(n,i){return typeof i=="symbol"||(e[i]=null,n[i]=null),!0}})}function g0(t,e,r){let n=s=>r?A.encode(r.items,s):s,i={add(s){t.has(s)||(e[n(s)]=!0)},clear(){for(let s of t)e[n(s)]=!1},delete(s){t.has(s)&&(e[n(s)]=!1)}};return new Proxy(t,{get(s,o){return typeof s[o]!="function"?Reflect.get(s,o):function(...a){return i[o]?.(...a),s[o](...a)}}})}function v0(t,e){if(!t)return e;let r=A.struct(t),n=A.assign(t,r,e);return mm(n),A.encode(t,n)}function mm(t){for(let e in t)if(t[e]===void 0)delete t[e];else{if(typeof t[e]!="object")continue;t[e]!==null&&!Array.isArray(t[e])&&!(t[e]instanceof Date)&&!(t[e]instanceof Set)&&mm(t[e])}}function w0(t){return typeof t=="string"&&t.startsWith("$")}function La(t,e){let r={};for(let n in t){let i=t[n],s=e[n];if(s===void 0)return;if(typeof i=="object"){let o=La(i,s);if(o===void 0)return;Object.assign(r,o);continue}if(w0(i)){let o=i.slice(1);r[o]=s;continue}if(i!==s)return}return r}var Va=class{vars;db;_roles;constructor(e,r){this.db=e,this.vars=Object.freeze(r)}get roles(){return Ba(this.db.schema,this.vars)??[]}};function wm(t,e){let r=new Va(t,e);return new Proxy(t,{get(i,s,o){return s==="session"?r:Reflect.get(i,s,o)},set:Reflect.set,deleteProperty:Reflect.deleteProperty})}function Ba(t,e){if(!t)return;let r=t.roles;if(!r)return[];let n=[];for(let[i,s]of Object.entries(r)){let o=La(s.match,e);o!==void 0&&n.push({key:i,roleVars:o})}return n}function gm(t){return!t||t.length===0}function bm(t,e){if(gm(t)&&gm(e))return!0;if(t?.length!==e?.length)return!1;let r=t?.map(({key:o})=>o),n=e?.map(({key:o})=>o);if(r?.some(o=>!n?.includes(o)))return!1;let i=vm(t),s=vm(e);return r?.every(o=>i[o]===s[o])}function vm(t){return t.reduce((e,{key:r,roleVars:n})=>(e[r]=Cy(n),e),{})}function Vi(t){let e={};return"x-triplit-user-id"in t&&(e.SESSION_USER_ID=t["x-triplit-user-id"]),Object.assign(e,t),"scope"in e&&!("_scope"in e)&&typeof e.scope=="string"&&(e._scope=e.scope.split(" ")),e}function Sm(t,e=[],r=[],n=[]){for(let[i,s]of Object.entries(t.properties))s.type==="date"&&r.push([...e,i]),s.type==="set"&&n.push([[...e,i],s.items.type]),s.type==="record"&&Sm(s,[...e,i],r,n);return{datePaths:r,setPaths:n}}function Ua(t){if(!t)return;let e=new Map;for(let[r,n]of Object.entries(t.collections)){let{datePaths:i,setPaths:s}=Sm(n.schema);e.set(r,{fromDB:o=>A.decode(n.schema,o)})}return e}function ct(t){return new nn(t)}var nn=class t{collectionName;select=void 0;where=void 0;limit=void 0;order=void 0;include=void 0;after=void 0;vars=void 0;constructor(e,r){this.collectionName=e,r&&(this.select=r.select,this.where=r.where,this.limit=r.limit,this.order=r.order,this.include=r.include,this.after=r.after,this.vars=r.vars)}Select(e){let r=e;return new t(this.collectionName,{...this,select:r})}Where(...e){let r=Oe().where(this,...e);return new t(this.collectionName,{...this,where:r})}Id(e){let r=this.where?this.where.filter(n=>!hi(n)):[];return r.push(["id","=",e]),new t(this.collectionName,{...this,where:r})}Limit(e){let r=e;return new t(this.collectionName,{...this,limit:r})}Order(...e){let r=Oe().order(this,...e);return new t(this.collectionName,{...this,order:r})}After(e,r){let n=Oe().after(this,e,r);return new t(this.collectionName,{...this,after:n})}Vars(e){let r=e;return new t(this.collectionName,{...this,vars:r})}Include(e,r){typeof r=="function"&&(r=r(xm));let n=Oe().include(this,e,r);return new t(this.collectionName,{...this,include:n})}SubqueryOne(e,r){typeof r=="function"&&(r=r(ct));let n=Oe().include(this,e,{subquery:r,cardinality:"one"});return new t(this.collectionName,{...this,include:n})}SubqueryMany(e,r){typeof r=="function"&&(r=r(ct));let n=Oe().include(this,e,{subquery:r,cardinality:"many"});return new t(this.collectionName,{...this,include:n})}};function xm(t){return new Qa(t)}var Qa=class t{_extends;select=void 0;where=void 0;limit=void 0;order=void 0;include=void 0;constructor(e,r){this._extends=e,r&&(this.select=r.select,this.where=r.where,this.limit=r.limit,this.order=r.order,this.include=r.include)}Select(e){let r=e;return new t(this._extends,{...this,select:r})}Where(...e){let r=Oe().where(this,...e);return new t(this._extends,{...this,where:r})}Id(e){let r=this.where?this.where.filter(n=>!hi(n)):[];return r.push(["id","=",e]),new t(this._extends,{...this,where:r})}Limit(e){let r=e;return new t(this._extends,{...this,limit:r})}Order(...e){let r=Oe().order(this,...e);return new t(this._extends,{...this,order:r})}Include(e,r){typeof r=="function"&&(r=r(xm));let n=Oe().include(this,e,r);return new t(this._extends,{...this,include:n})}SubqueryOne(e,r){typeof r=="function"&&(r=r(ct));let n=Oe().include(this,e,{subquery:r,cardinality:"one"});return new t(this._extends,{...this,include:n})}SubqueryMany(e,r){typeof r=="function"&&(r=r(ct));let n=Oe().include(this,e,{subquery:r,cardinality:"many"});return new t(this._extends,{...this,include:n})}};function b0(t){return Array.isArray(t)&&t[0]===void 0}function S0(t){return _(t)}function Em(t){return Array.isArray(t)&&t.every(e=>_y(e))}function x0(t){return t.length===1&&Em(t[0])}var Oe=()=>({where:(t,...e)=>{let r=[];if(b0(e))return t.where??[];if(S0(e))r=[e];else if(Em(e))r=e;else if(x0(e))r=e[0];else throw new Kt("where",e);return[...t.where??[],...r]},order:(t,...e)=>{if(!e[0])return t.order??[];let r=[];if(e.length===2&&e.every(n=>typeof n=="string"))r=[[...e]];else if(e.length===1&&e[0]instanceof Array&&e[0].every(n=>n instanceof Array))r=e[0];else if(e.every(n=>n instanceof Array))r=e;else throw new Kt("order",e);return[...t.order??[],...r]},include(t,e,r){return{...t.include,[e]:r??null}},after(t,e,r){if(!e)return;if(!t.order)throw new Ci(e);let n=t.order.map(i=>i[0]);if(e instanceof Array)return[e,r??!1];if(typeof e=="object")return[n.map(i=>q.Get(e,i)),r??!1];throw new Kt("after",e)}});function za(t){if(v(t))return"schema is not defined";if(typeof t!="object")return"schema is not an object";let e=E0(t.roles);if(e)return`schema roles definition is invalid: ${e}`;let r=I0(t.collections,t);if(r)return`schema collections definition is invalid: ${r}`}function E0(t){if(!v(t)){if(typeof t!="object")return"roles is not an object";for(let e in t){let r=U0(e);if(r)return`role "${e}" is invalid: ${r}`;let n=t[e],i=C0(n);if(i)return`role "${e}" is invalid: ${i}`}}}function C0(t){if(v(t))return"role is not defined";if(typeof t!="object")return"role is not an object";if(v(t.match))return"matcher is not defined";if(typeof t.match!="object")return"matcher is not an object"}function I0(t,e){if(v(t))return"collections is not defined";if(typeof t!="object")return"collections is not an object";for(let r in t){let n=O0(r);if(n)return`"${r}" is not a valid collection name: ${n}`;let i=t[r],s=R0(i,e);if(s)return`"${r}" is not a valid collection: ${s}`}}function O0(t){if(v(t),typeof t!="string")return"collection name is not a string";if(t.length===0)return"collection name is empty";if(t.startsWith("_"))return"collection name cannot start with an underscore";if(/^[0-9]/.test(t))return"collection name cannot start with a numeric character";if(!/^[a-zA-Z0-9_]+$/.test(t))return"collection name contains invalid characters - only alphanumeric characters and underscores are allowed."}function R0(t,e){if(v(t))return"collection is not defined";if(typeof t!="object")return"collection is not an object";let r=T0(t.schema);if(r)return`collection schema is invalid: ${r}`;if("relationships"in t){let n=D0(t.relationships,t);if(n)return`collection relationships is invalid: ${n}`}if("permissions"in t){let n=V0(t.permissions,e);if(n)return`collection permissions is invalid: ${n}`}}function T0(t){if(v(t))return"schema is not defined";if(typeof t!="object")return"schema is not an object";let e=Im(t);if(e)return`${e}`;if(v(t.properties.id))return'primary key field "id" is not defined';let r=Om(t.properties.id);if(r)return`primary key field "id" is invalid: ${r}`}function Cm(t){return v(t)?"type is not defined":typeof t!="object"?"type is not a DataType":t.type==="boolean"?P0(t):t.type==="date"?A0(t):t.type==="json"?k0(t):t.type==="number"?N0(t):t.type==="record"?Im(t):t.type==="set"?q0(t):t.type==="string"?Om(t):`type "${t.type}" is not recognized`}function P0(t){if(t.type!=="boolean")return"not a boolean type";let e=Ct(t);if(e)return`type boolean is invalid: ${e}`}function A0(t){if(t.type!=="date")return"not a date type";let e=Ct(t);if(e)return`type date is invalid: ${e}`}function k0(t){if(t.type!=="json")return"not a json type";let e=Ct(t);if(e)return`type json is invalid: ${e}`}function N0(t){if(t.type!=="number")return"not a number type";let e=Ct(t);if(e)return`type number is invalid: ${e}`}function Im(t){if(t.type!=="record")return"not a record type";let e=Ct(t);if(e)return`type record is invalid: ${e}`;if(v(t.properties))return"type record is missing properties";if(typeof t.properties!="object")return"type record properties is not an object";for(let r in t.properties){let n=_0(r);if(n)return`type record property "${r}" is invalid: ${n}`;let i=t.properties[r],s=Cm(i);if(s)return`type record property "${r}" is invalid: ${s}`}}function q0(t){if(t.type!=="set")return"not a set type";let e=Ct(t);if(e)return`type set is invalid: ${e}`;if(v(t.items))return"type set is missing items";let r=Cm(t.items);if(r)return`type set items is invalid: ${r}`;if(!Nr(t.items))return"type set items must be a primitive type"}function Om(t){if(t.type!=="string")return"not a string type";let e=Ct(t);if(e)return`type string is invalid: ${e}`;if(!v(t.config?.enum)){if(!Array.isArray(t.config.enum))return"type string enum is not an array";for(let r of t.config.enum)if(typeof r!="string")return"type string enum value is not a string"}}function _0(t){if(v(t))return"property name is not defined";if(typeof t!="string")return"property name is not a string";if(t.length===0)return"property name is empty";if(!/^[a-zA-Z0-9_]+$/.test(t))return"property name contains invalid characters - only alphanumeric characters and underscores are allowed."}function Ct(t){if(v(t.config))return;if(typeof t.config!="object")return"type config is not an object";if(!v(t.config.nullable)&&typeof t.config.nullable!="boolean")return"option nullable is invalid";if(!v(t.config.optional)&&typeof t.config.optional!="boolean")return"option optional is invalid";let e=M0(t);if(e)return`option default is invalid: ${e}`}function M0(t){let e=t.config?.default;if(!v(e)){if(t.type==="record")return"default value cannot be set for record types";if(Rr(e)){let r=F0(t.type,e);if(r)return`default value is invalid: ${r}`}else try{A.encode(t,e)}catch(r){if(r instanceof H)return"default value could not be serialized to type";throw r}}}function F0(t,e){if(typeof e!="object")return"default function format is invalid";if(v(e.func))return"default function is missing func identifier";let r=e.func;if(!j0(r))return`default function ${e.func} is not recognized`;if(r==="now"){if(!v(e.args))return'default function "now" has no args';if(!["date","string"].includes(t))return'default function "now" is not valid for this type'}if(r==="nanoid"||r==="uuid"){if(!v(e.args)){if(!Array.isArray(e.args))return`default function "${r}" args is not an array`;if(e.args.length>0&&typeof e.args[0]!="number")return`default function "${r}" arg[0] is not a number`}if(!["string"].includes(t))return'default function "now" is not valid for this type'}if(r==="Set.empty"){if(!v(e.args))return'default function "Set.empty" has no args';if(!["set"].includes(t))return'default function "Set.empty" is not valid for this type'}}function j0(t){return ey.includes(t)}function D0(t,e){if(!v(t)){if(typeof t!="object")return"relationships is not an object";for(let r in t){let n=$0(r,e);if(n)return`relationship "${r}" is invalid: ${n}`;let i=t[r],s=L0(i);if(s)return`relationship "${r}" is invalid: ${s}`}}}function $0(t,e){if(v(t))return"relationship name is not defined";if(typeof t!="string")return"relationship name is not a string";if(t.length===0)return"relationship name is empty";if(t.startsWith("_"))return"relationship name cannot start with an underscore";if(/^[0-9]/.test(t))return"relationship name cannot start with a numeric character";if(!/^[a-zA-Z0-9_]+$/.test(t))return"relationship name contains invalid characters - only alphanumeric characters and underscores are allowed.";if(e.schema.properties[t])return"relationship name matches a property name"}function L0(t){if(v(t))return"relationship is not defined";if(typeof t!="object")return"relationship is not an object";if(v(t.cardinality))return"cardinality is not defined";if(t.cardinality!=="one"&&t.cardinality!=="many")return"cardinality is invalid";if(v(t.query))return"query is not defined";if(typeof t.query!="object")return"query is not an object"}function V0(t,e){if(!v(t)){if(typeof t!="object")return"permissions is not an object";for(let r in t){let n=t[r],i=B0(n);if(i)return`permissions for role "${r}" is invalid: ${i}`}}}function B0(t){if(!v(t)){if(typeof t!="object")return"not an object";if(t.read){let e=sn(t.read);if(e)return`"read" permission is invalid: ${e}`}if(t.insert){let e=sn(t.insert);if(e)return`insert permission is invalid: ${e}`}if(t.update){let e=sn(t.update);if(e)return`update permission is invalid: ${e}`}if(t.postUpdate){let e=sn(t.postUpdate);if(e)return`postUpdate permission is invalid: ${e}`}if(t.delete){let e=sn(t.delete);if(e)return`delete permission is invalid: ${e}`}}}function sn(t){if(!v(t)){if(typeof t!="object")return"permission is not an object";v(t.filter)}}function U0(t){if(v(t))return"role name is not defined";if(typeof t!="string")return"role name is not a string";if(t.length===0)return"role name is empty";if(t.startsWith("_"))return"role name cannot start with an underscore";if(/^[0-9]/.test(t))return"role name cannot start with a numeric character";if(!/^[a-zA-Z0-9_]+$/.test(t))return"role name contains invalid characters - only alphanumeric characters and underscores are allowed."}var Bi=class{entityStore;clock;session;globalVars;logger;subscribedQueries=new Map;clientId;ivm;schema=void 0;onCommitListeners=new Set;kv;typeConverters;constructor(e={}){if(this.logger=we,this.globalVars=e.variables??{},this.kv=e.kv??new he,this.entityStore=e.entityStore??new at,this.clientId=e.clientId||"test-client",this.clock=new je({clientId:this.clientId}),this.ivm=e.ivm??new Ni(this),e.schema){let r=za(e.schema);if(r)throw new Ii(`Failed to start DB because the current schema is invalid: ${r}`)}this.schema=e.schema,this.typeConverters=Ua(this.schema)}static async getSchemaFromStorage(e){let n=await new at().getEntity(e,"_metadata","_schema");if(Ye(n))return;let i={...n};return delete i.id,i}getSchema(){return this.schema}subscribe(e,r,n,i={}){let s=Ie(e,this.schema?.collections,this.systemVars,this.session,{applyPermission:i.skipRules?void 0:"read"}),o=({results:a})=>{r(ir(a,s,"many",this.typeConverters),i.queryKey)};return this.ivm.subscribe(s,o,n)}subscribeRaw(e,r,n,i={}){let s=({results:o})=>{r(o,i.queryKey)};return this.ivm.subscribe(e,s,n)}subscribeWithChanges(e,r,n,i={}){let s=Ie(e,this.schema?.collections,this.systemVars,this.session,{applyPermission:i.skipRules?void 0:"read"}),o=({results:a,changes:c})=>{r({results:ir(a,s,"many",this.typeConverters),changes:c})};return this.ivm.subscribe(s,o,n)}subscribeChanges(e,r,n={}){let i=Ie(e,this.schema?.collections,this.systemVars,this.session,{applyPermission:n.skipRules?void 0:"read"}),s=!0,o=async({changes:a})=>{let c=a;if(n.queryState&&s){let u={},l={};for(let[f,d]of Object.entries(n.queryState.entityIds))for(let p of d){if(!Q0(a,f,p)){l[f]||(l[f]=new Set),l[f].add(p);continue}let m=await this.entityStore.metadataStore.getTimestampForEntity(this.kv,f,p);m&&je.compare(m,n.queryState.timestamp)<0&&(u[f]||(u[f]=new Set),u[f].add(p))}c={};for(let f in a){c[f]={sets:new Map,deletes:a[f].deletes};for(let[d,p]of a[f].sets)u[f]?.has(d)||c[f].sets.set(d,p)}for(let[f,d]of Object.entries(l)){let p=new Set(d);c[f]||(c[f]={sets:new Map,deletes:new Set});let m=await this.fetchChanges({collectionName:f,where:[["id","in",Array.from(d)]]});for(let[y,w]of m[f].sets)p.delete(y),c[f].sets.set(y,w);for(let y of p)c[f].deletes.add(y)}}r(c,n.queryKey),s=!1};return this.ivm.subscribe(i,o,n.errorCallback)}async fetch(e,r){let n=Ie(e,this.schema?.collections,this.systemVars,this.session,{applyPermission:r?.skipRules?void 0:"read"}),s=await new De(this.kv,this.entityStore).fetch(n);return ir(s,n,"many",this.typeConverters)}async rawFetch(e,r){return new De(this.kv,this.entityStore).fetch(e,r)}async fetchChanges(e,r){let n=Ie(e,this.schema?.collections,this.systemVars,this.session,{applyPermission:r?.skipRules?void 0:"read"}),i=await this.rawFetch(n);return en(i,n)}async fetchOne(e,r){e={...e,limit:1};let i=(await this.fetch(e,r))[0];return i||null}async fetchById(e,r,n){let i=this.query(e).Id(r);return this.fetchOne(i,n)}async insert(e,r,n){return this.transact(async i=>await i.insert(e,r),{skipRules:n?.skipRules??!1})}async update(e,r,n,i){return this.transact(async s=>{await s.update(e,r,n)},{skipRules:i?.skipRules??!1})}async delete(e,r,n){return this.transact(async i=>{await i.delete(e,r)},{skipRules:n?.skipRules??!1})}onCommit(e){return this.onCommitListeners.add(e),()=>{this.onCommitListeners.delete(e)}}updateQueryViews(){return this.ivm.updateViews()}broadcastToQuerySubscribers(){return this.ivm.flushChangesToListeners()}async transact(e,r){let n,i,s=this.kv.transact();try{let o=new $i({schema:this.schema,kvTx:s,entityStore:this.entityStore,systemVars:this.systemVars,session:this.session,typeConverters:this.typeConverters,skipRules:!!r?.skipRules});i=await e(o),n=await this.entityStore.applyChanges(s,o.changes,{checkWritePermission:r?.skipRules?void 0:this.checkWritePermission.bind(this),entityChangeValidator:this.validateEntityChange.bind(this)}),await s.commit()}catch(o){throw s.cancel(),o}await this.ivm.bufferChanges(n);for(let o of this.onCommitListeners)o(n);return i}async applyChanges(e,r){let n=this.kv.transact(),i=await this.entityStore.applyChanges(n,e,{checkWritePermission:r?.skipRules?void 0:this.checkWritePermission.bind(this),entityChangeValidator:this.validateEntityChange.bind(this)});await n.commit(),await this.ivm.bufferChanges(i)}async applyChangesWithTimestamp(e,r,n){let i=this.kv.transact(),s=await this.entityStore.applyChangesWithTimestamp(i,e,r,{checkWritePermission:n?.skipRules?void 0:this.checkWritePermission.bind(this),entityChangeValidator:this.validateEntityChange.bind(this)});await i.commit(),await this.ivm.bufferChanges(s)}async getCollectionStats(){return this.entityStore.getCollectionStats(this.kv,this.schema?Object.keys(this.schema.collections):void 0)}async overrideSchema(e,r){let n=await this._overrideSchema(e,r);for(let i of this.schemaChangeListeners)await i(n);return n}async _overrideSchema(e,{failOnBackwardsIncompatibleChange:r=!1}={}){let n=this.schema,i=za(e);if(i)return{successful:!1,code:"SCHEMA_INVALID",message:i,issues:[],diff:[],oldSchema:n,newSchema:e};if(!n)return await this.updateSchema(e),{successful:!0,code:"SUCCESS",message:"Schema updated successfully",issues:[],diff:[],oldSchema:n,newSchema:e};let s=[],o=Uy(n,e);return o.length===0?{successful:!0,code:"SUCCESS",message:"Schema updated successfully.",issues:s,diff:o,oldSchema:n,newSchema:e}:(s=await Qy(a=>this.fetch.bind(this)(a,{skipRules:!0}),o),s.length>0&&s.some(a=>a.violatesExistingData)?{successful:!1,code:"EXISTING_DATA_MISMATCH",message:"Schema update failed due to existing data violations.",issues:s,diff:o,oldSchema:n,newSchema:e}:r&&s.length>0?{successful:!1,code:"SCHEMA_COMPATIBILITY_MISMATCH",message:"Schema update failed due to backwards incompatible changes.",issues:s,diff:o,oldSchema:n,newSchema:e}:(o.length>0&&this.logger.info(`applying ${o.length} changes to schema`),await this.updateSchema(e),{successful:!0,code:"SUCCESS",message:"Schema updated successfully.",issues:s,diff:o,oldSchema:n,newSchema:e}))}async setMetadata(e,r){let n=this.kv.scope(["_metadata"]),i=this.kv.transact();await n.set(e,r),await i.commit()}async getMetadata(e){return await this.kv.scope(["_metadata"]).get(e)}async updateSchema(e){let r=this.kv.transact();await this.entityStore.dataStore.applyChanges(r,{_metadata:{sets:new Map([["_schema",{id:"_schema",...e}]]),deletes:new Set(["_schema"])}},{checkWritePermission:void 0,entityChangeValidator:void 0}),await r.commit(),this.schema=e,this.typeConverters=Ua(this.schema)}withSessionVars(e){return wm(this,Vi(e))}schemaChangeListeners=[];onSchemaChange(e){return this.schemaChangeListeners.push(e),()=>{this.schemaChangeListeners=this.schemaChangeListeners.filter(r=>r!==e)}}query(e){return new nn(e)}Query(e){return this.query(e)}async clear(e){if(await this.kv.clear(),e?.full){await this.ivm.clear(),this.schema=void 0;return}this.schema&&await this.updateSchema(this.schema),this.ivm.resetSubscriptions()}updateGlobalVariables(e){this.globalVars=e}get systemVars(){return{$global:this.globalVars,$session:this.session?.vars??{}}}validateEntityChange(e,r,{ignoreRequiredProperties:n=!1}){let i=this.schema?.collections;if(!i)return;let s=i[e]?.schema;if(!s)return;let o=A.validateEncoded(s,r,{partial:n});if(!o.valid)throw new H("record",JSON.stringify(r),o.error)}async checkWritePermission(e,r,n){let i,s=r.collection;switch(n){case"insert":i=r.next;break;case"update":i=r.prev;break;case"delete":i=r.prev;break;case"postUpdate":i=r.next;break}if(!fi(this.schema?.collections,s))return;let c=Ie({collectionName:s},this.schema?.collections,{...this.systemVars,$prev:r.prev},this.session,{applyPermission:n}).where;if(!c||c.length===0)return;let u=new De(e,this.entityStore);if(!await di(i,c,u))throw new wi(s,i.id,n,this.session?.roles??[])}};async function Rm(t){let e,r;try{t.kv&&(e=await Bi.getSchemaFromStorage(t.kv)),await yy(),r=new Bi({...t,schema:e});let n;return t.schema?(n=await r.overrideSchema(t.schema,{failOnBackwardsIncompatibleChange:t.failOnBackwardsIncompatibleChange}),n.successful?{db:r,event:{type:"SUCCESS",change:n}}:{db:r,event:{type:"SCHEMA_UPDATE_FAILED",change:n}}):{db:r,event:{type:"SUCCESS",change:void 0}}}catch(n){if(r)return{db:r,event:{type:"ERROR",error:n}};throw new g(`Failed to create a DB instance: ${n.message}`)}}function Q0(t,e,r){return t[e]&&(t[e].sets.has(r)||t[e].deletes.has(r))}function ir(t,e,r,n){if(t===null)return null;let i=n?.get(e.collectionName),s=c=>i?.fromDB(c)??c,o=c=>{if(!e.select)return c;let u={};for(let l of e.select)q.Set(u,l,q.Get(c,l));return u},a=c=>{let u=s(o(c.data)),l=e.include&&Object.entries(e.include).reduce((f,[d,p])=>(c.subqueries[d]!==void 0&&(f[d]=ir(c.subqueries[d],p.subquery,p.cardinality,n)),f),{});return{...u,...l}};return r==="one"?a(t):t.map(a)}function Tm(t,e){return t?A.serialize(t,e,"decoded"):e}function Ui(t,e,r){let n=e?.[t.collectionName],i=n?.schema,s=t.include?Object.keys(t.include):[];function o(a){if(!a)return null;let c={};for(let u of s)c[u]=Ui(z0(n,u,t.include[u],"deserialize"),e,a[u]),delete a[u];a=Qi(i,a);for(let u of s)a[u]=c[u];return a}if(Array.isArray(r))for(let a=0;a<r.length;a++)r[a]=o(r[a]);else r=o(r);return r}function Qi(t,e){return t?A.deserialize(t,e,"decoded"):e}function z0(t,e,r,n){if(nr(r)){if(!t)throw new g(`Cannot ${n} inclusion '${e}' without schema`);let i=t.relationships?.[e];if(!i)throw new g(`Cannot ${n} inclusion '${e}', no relation found for '${e}'`);return i.query}if(Mi(r)){if(!t)throw new g(`Cannot ${n} inclusion '${e}' without schema`);let{_extends:i,...s}=r,o=t.relationships?.[i];if(!o)throw new g(`Cannot ${n} inclusion '${e}', no relation found for '${i}'`);return{...o.query,...s}}if(_i(r))return r.subquery;throw new g(`Failed to ${n} inclusion '${e}': invalid format`)}var on=class{storagePrefix;constructor(e=[]){this.storagePrefix=e}async clear(e){let r=e.scope(this.storagePrefix),n=r.scan({prefix:[]});for await(let[i]of n)await r.delete(i)}async write(e,r){let n=e.scope(this.storagePrefix);for(let i in r){let s=r[i];for(let o of s.deletes){let a=await n.get([i,"sets",o]);a&&(await n.delete([i,"sets",o]),"id"in a)||await n.set([i,"deletes",o],!0)}for(let[o,a]of s.sets){let c=[i,"sets",o],u=await n.get(c),l=a;u&&(l=ce(u,a)),await n.set(c,l)}}}async getChanges(e){let n=e.scope(this.storagePrefix).scan({prefix:[]}),i={};for await(let[s,o]of n){let a=s[1];if(a==="sets"){let[c,u,l]=s;i[c]||(i[c]={sets:new Map,deletes:new Set});let f=o,d=i[c].sets.get(l);d&&(f=ce({},d,o)),i[c].sets.set(l,f)}if(a==="deletes"){let[c,u,l]=s;i[c]||(i[c]={sets:new Map,deletes:new Set}),i[c].deletes.add(l)}}return i||{}}async getChangesForCollection(e,r){let n=e.scope(this.storagePrefix),i={sets:new Map,deletes:new Set};for await(let[s,o]of n.scan({prefix:[r,"sets"]})){let[a]=s;i.sets.set(a,o)}for await(let[s]of n.scan({prefix:[r,"deletes"]})){let[o]=s;i.deletes.add(o)}if(!(i.sets.size===0&&i.deletes.size===0))return i}async getChangesForEntity(e,r,n){let i=e.scope(this.storagePrefix),s=await i.get([r,"sets",n]),o=await i.get([r,"deletes",n]);if(!(s===void 0&&o===void 0))return{update:s,delete:o!==void 0}}async isEmpty(e){let r=await this.getChanges(e);return Object.keys(r).length===0}async clearChangesForEntity(e,r,n){let i=e.scope(this.storagePrefix);await i.delete([r,"sets",n]),await i.delete([r,"deletes",n])}};var zi=class{storage;doubleBuffer;store;constructor(e){this.storage=e,this.doubleBuffer=new tr(new on(["buf0"]),new on(["buf1"])),this.store=new at}get metadataStore(){return this.store.metadataStore}get dataStore(){return this.store.dataStore}async applyChanges(e,r){return await this.doubleBuffer.write(e,r),r}async applyChangesWithTimestamp(e,r,n,i){let s=await this.store.applyChangesWithTimestamp(e,r,n,i),o=await this.doubleBuffer.getChanges(e);for(let a in o){let c=o[a],u=s[a];if(u){for(let l of c.deletes)u.deletes.delete(l),u.sets.delete(l);for(let[l,f]of c.sets){u.deletes.delete(l);let d=u.sets.get(l);d&&u.sets.set(l,{...d,...f})}}}return s}async getEntity(e,r,n){let i=await this.store.getEntity(e,r,n),s=await this.doubleBuffer.getChangesForEntity(e,r,n);return rn(i,!!s?.delete,s?.update)}async getCollectionStats(e){throw new Error("Method not implemented.")}async*getEntitiesInCollection(e,r){yield*Di(this.store.getEntitiesInCollection(e,r),await this.doubleBuffer.getChangesForCollection(e,r))}};var an=class{data=new Map;get(e,r){return r===void 0?this.data.get(e):this.data.get(e)?.get(r)}set(e,r,n){this.data.has(e)||this.data.set(e,new Map),this.data.get(e).set(r,n)}delete(e,r){return this.data.get(e)?.delete(r)??!1}has(e,r){return r===void 0?this.data.has(e):this.data.get(e)?.has(r)??!1}keys(){return this.data.keys()}values(){return this.data.values()}entries(){return this.data.entries()}[Symbol.iterator](){return this.entries()}};var Wi=class extends g{constructor(e,...r){super(...r),this.name="UnrecognizedFetchPolicyError",this.baseMessage="The fetch policy "+e+" is not recognized.",this.status=x["Bad Request"]}};var cn=class extends g{constructor(e,...r){super(...r),this.name="RemoteSyncFailedError",this.baseMessage="Remote sync failed for query: "+JSON.stringify(e,null,2),this.status=x["Internal Server Error"]}};var Ki=class extends g{constructor(...e){super(...e),this.name="IndexedDbUnavailableError",this.baseMessage="IndexedDB is not available in this environment. If you are creating a TriplitClient on the server e.g. prerendering with a SSR framework like Next.js or SvelteKit, you may need to use the `memory` storage provider. Consult our SSR guide (https://triplit.dev/docs/ssr) for more information. If you are running on a non-browser client, like a mobile app, try one of our other storage providers (https://triplit.dev/docs/client/storage).",this.status=x["Service Unavailable"]}},Gi=class extends g{constructor(...e){super(...e),this.name="WebSocketsUnavailableError",this.baseMessage="The TriplitClient syncs over WebSockets, which are not available in this environment. If you are creating a TriplitClient on the server e.g. prerendering with a SSR framework like Next.js or SvelteKit, you should interact with Triplit over HTTP. Consult our SSR guide (https://triplit.dev/docs/ssr) for more information.",this.status=x["Service Unavailable"]}},C=class extends g{constructor(...e){super(...e),this.name="WorkerInternalClientNotInitializedError",this.baseMessage="Attemped to invoke a method on the internal worker client before it was initialized. Ensure that the WorkerClient in the main thread has been initialized before invoking methods on the client inside the worker.",this.status=x["Internal Server Error"]}},Hi=class extends g{constructor(...e){super(...e),this.name="SessionRolesMismatchError",this.baseMessage="Attempted to use `TriplitClient.updateSessionToken` with a token that does not have the same roles as the current session token. `updateSessionToken` should only be used to refresh the session with the server to prevent token expiry. To connect with a new token with new roles, use `TriplitClient.endSession` and then `TriplitClient.startSession(...)` with the new token.",this.status=x.Forbidden}};var Yi=class extends g{constructor(...e){super(...e),this.name="TokenExpiredError",this.baseMessage="The provided token has expired. Please ensure that you are using a fresh token when calling `startSession` or `updateSessionToken`.",this.status=x.Unauthorized}},Ji=class extends g{constructor(...e){super(...e),this.name="NoActiveSessionError",this.baseMessage="Attempted to perform an operation that requires an active session when no session is active. Call `TriplitClient.startSession(...)` to start a new session.",this.status=x.Forbidden}},Xi=class extends g{constructor(e,...r){super(...r),this.name="TokenDecodingError",this.baseMessage=`The provided token ("${e}") could not be decoded. Please ensure that you are using a valid JWT token.`,this.status=x.Unauthorized}};var W0=1024*1024/2;function K0(){return typeof WebSocket<"u"}var Zi=class{constructor(e={}){this.options=e;this.options.messagePayloadSizeLimit=this.options.messagePayloadSizeLimit==null?W0:this.options.messagePayloadSizeLimit}ws=void 0;get isOpen(){return!!this.ws&&this.ws.readyState===this.ws.OPEN}get connectionStatus(){return this.ws?Am(this.ws):"UNINITIALIZED"}onOpen(e){this.ws&&(this.ws.onopen=e)}sendMessage(e){if(!this.ws||!this.isOpen)return!1;let r=JSON.stringify(e),n=G0(r);if(this.options.messagePayloadSizeLimit&&n>this.options.messagePayloadSizeLimit){let i=H0(r,Math.ceil(n/this.options.messagePayloadSizeLimit)),s=(Math.random()+1).toString(36).substring(7);for(let o=0;o<i.length;o++)this.ws.send(JSON.stringify({type:"CHUNK",payload:{data:i[o],total:i.length,index:o,id:s}}));return!0}return this.ws.send(JSON.stringify(e)),!0}connect(e){this.close();let{token:r,schema:n,syncSchema:i,server:s}=e,o=new URLSearchParams;n&&o.set("schema",n.toString()),o.set("sync-schema",String(!!i)),o.set("token",r);let a=s.startsWith("https://"),c=s.slice(a?8:7),u=`${a?"wss":"ws"}://${c}?${o.toString()}`;if(!K0())throw new Gi;this.ws=new WebSocket(u)}onMessage(e){this.ws&&(this.ws.onmessage=e)}onError(e){this.ws&&(this.ws.onerror=e)}close(e){if(this.ws){if(this.ws.readyState===this.ws.OPEN)return this.ws.close(1e3,JSON.stringify(e));if(this.ws.readyState===this.ws.CONNECTING)return this.ws.addEventListener("open",()=>{this.ws?.close(1e3,JSON.stringify(e))},{once:!0})}}onClose(e){this.ws&&(this.ws.onclose=e)}onConnectionChange(e){this.ws&&(this.ws.onconnectionchange=e)}};function G0(t){var e=0;for(let r=0;r<t.length;r++){let n=t.charCodeAt(r);e+=n<128?1:n<2048?2:n<65536?3:4}return e}function H0(t,e){let r=[],n=Math.ceil(t.length/e);for(let i=0;i<t.length;i+=n)r.push(t.slice(i,i+n));return r}function Am(t){switch(t.readyState){case t.CONNECTING:return"CONNECTING";case t.OPEN:return"OPEN";case t.CLOSING:return"CLOSING";case t.CLOSED:default:return"CLOSED"}}typeof globalThis<"u"&&globalThis.WebSocket&&(Pm=new Proxy(globalThis.WebSocket,{construct:function(t,e){let r=new t(...e);function n(){r.dispatchEvent(new Event("connectionchange")),r.onconnectionchange&&typeof r.onconnectionchange=="function"&&r.onconnectionchange(Am(r))}setTimeout(()=>{n()},0);let i=()=>{n()},s=()=>{n(),r.removeEventListener("open",i),r.removeEventListener("close",s)};return r.addEventListener("open",i),r.addEventListener("close",s),r}}),globalThis.WebSocket=Pm);var Pm;var es=class{constructor(){this.keyToValue=new Map,this.valueToKey=new Map}set(e,r){this.keyToValue.set(e,r),this.valueToKey.set(r,e)}getByKey(e){return this.keyToValue.get(e)}getByValue(e){return this.valueToKey.get(e)}clear(){this.keyToValue.clear(),this.valueToKey.clear()}};var sr=class{constructor(e){this.generateIdentifier=e,this.kv=new es}register(e,r){this.kv.getByValue(e)||(r||(r=this.generateIdentifier(e)),this.kv.set(r,e))}clear(){this.kv.clear()}getIdentifier(e){return this.kv.getByValue(e)}getValue(e){return this.kv.getByKey(e)}};var ts=class extends sr{constructor(){super(e=>e.name),this.classToAllowedProps=new Map}register(e,r){typeof r=="object"?(r.allowProps&&this.classToAllowedProps.set(e,r.allowProps),super.register(e,r.identifier)):super.register(e,r)}getAllowedProps(e){return this.classToAllowedProps.get(e)}};function Y0(t){if("values"in Object)return Object.values(t);let e=[];for(let r in t)t.hasOwnProperty(r)&&e.push(t[r]);return e}function km(t,e){let r=Y0(t);if("find"in r)return r.find(e);let n=r;for(let i=0;i<n.length;i++){let s=n[i];if(e(s))return s}}function It(t,e){Object.entries(t).forEach(([r,n])=>e(n,r))}function or(t,e){return t.indexOf(e)!==-1}function Wa(t,e){for(let r=0;r<t.length;r++){let n=t[r];if(e(n))return n}}var rs=class{constructor(){this.transfomers={}}register(e){this.transfomers[e.name]=e}findApplicable(e){return km(this.transfomers,r=>r.isApplicable(e))}findByName(e){return this.transfomers[e]}};var J0=t=>Object.prototype.toString.call(t).slice(8,-1),Ka=t=>typeof t>"u",X0=t=>t===null,Ot=t=>typeof t!="object"||t===null||t===Object.prototype?!1:Object.getPrototypeOf(t)===null?!0:Object.getPrototypeOf(t)===Object.prototype,ns=t=>Ot(t)&&Object.keys(t).length===0,Re=t=>Array.isArray(t),Z0=t=>typeof t=="string",eA=t=>typeof t=="number"&&!isNaN(t),tA=t=>typeof t=="boolean",Nm=t=>t instanceof RegExp,ut=t=>t instanceof Map,lt=t=>t instanceof Set,Ga=t=>J0(t)==="Symbol",qm=t=>t instanceof Date&&!isNaN(t.valueOf()),_m=t=>t instanceof Error,Ha=t=>typeof t=="number"&&isNaN(t),Mm=t=>tA(t)||X0(t)||Ka(t)||eA(t)||Z0(t)||Ga(t),Fm=t=>typeof t=="bigint",jm=t=>t===1/0||t===-1/0,Dm=t=>ArrayBuffer.isView(t)&&!(t instanceof DataView),$m=t=>t instanceof URL;var Ya=t=>t.replace(/\./g,"\\."),is=t=>t.map(String).map(Ya).join("."),ar=t=>{let e=[],r="";for(let i=0;i<t.length;i++){let s=t.charAt(i);if(s==="\\"&&t.charAt(i+1)==="."){r+=".",i++;continue}if(s==="."){e.push(r),r="";continue}r+=s}let n=r;return e.push(n),e};function Le(t,e,r,n){return{isApplicable:t,annotation:e,transform:r,untransform:n}}var Lm=[Le(Ka,"undefined",()=>null,()=>{}),Le(Fm,"bigint",t=>t.toString(),t=>typeof BigInt<"u"?BigInt(t):(console.error("Please add a BigInt polyfill."),t)),Le(qm,"Date",t=>t.toISOString(),t=>new Date(t)),Le(_m,"Error",(t,e)=>{let r={name:t.name,message:t.message};return e.allowedErrorProps.forEach(n=>{r[n]=t[n]}),r},(t,e)=>{let r=new Error(t.message);return r.name=t.name,r.stack=t.stack,e.allowedErrorProps.forEach(n=>{r[n]=t[n]}),r}),Le(Nm,"regexp",t=>""+t,t=>{let e=t.slice(1,t.lastIndexOf("/")),r=t.slice(t.lastIndexOf("/")+1);return new RegExp(e,r)}),Le(lt,"set",t=>[...t.values()],t=>new Set(t)),Le(ut,"map",t=>[...t.entries()],t=>new Map(t)),Le(t=>Ha(t)||jm(t),"number",t=>Ha(t)?"NaN":t>0?"Infinity":"-Infinity",Number),Le(t=>t===0&&1/t===-1/0,"number",()=>"-0",Number),Le($m,"URL",t=>t.toString(),t=>new URL(t))];function ss(t,e,r,n){return{isApplicable:t,annotation:e,transform:r,untransform:n}}var Vm=ss((t,e)=>Ga(t)?!!e.symbolRegistry.getIdentifier(t):!1,(t,e)=>["symbol",e.symbolRegistry.getIdentifier(t)],t=>t.description,(t,e,r)=>{let n=r.symbolRegistry.getValue(e[1]);if(!n)throw new Error("Trying to deserialize unknown symbol");return n}),rA=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array,Uint8ClampedArray].reduce((t,e)=>(t[e.name]=e,t),{}),Bm=ss(Dm,t=>["typed-array",t.constructor.name],t=>[...t],(t,e)=>{let r=rA[e[1]];if(!r)throw new Error("Trying to deserialize unknown typed array");return new r(t)});function Ja(t,e){return t?.constructor?!!e.classRegistry.getIdentifier(t.constructor):!1}var Um=ss(Ja,(t,e)=>["class",e.classRegistry.getIdentifier(t.constructor)],(t,e)=>{let r=e.classRegistry.getAllowedProps(t.constructor);if(!r)return{...t};let n={};return r.forEach(i=>{n[i]=t[i]}),n},(t,e,r)=>{let n=r.classRegistry.getValue(e[1]);if(!n)throw new Error("Trying to deserialize unknown class - check https://github.com/blitz-js/superjson/issues/116#issuecomment-773996564");return Object.assign(Object.create(n.prototype),t)}),Qm=ss((t,e)=>!!e.customTransformerRegistry.findApplicable(t),(t,e)=>["custom",e.customTransformerRegistry.findApplicable(t).name],(t,e)=>e.customTransformerRegistry.findApplicable(t).serialize(t),(t,e,r)=>{let n=r.customTransformerRegistry.findByName(e[1]);if(!n)throw new Error("Trying to deserialize unknown custom value");return n.deserialize(t)}),nA=[Um,Vm,Qm,Bm],Xa=(t,e)=>{let r=Wa(nA,i=>i.isApplicable(t,e));if(r)return{value:r.transform(t,e),type:r.annotation(t,e)};let n=Wa(Lm,i=>i.isApplicable(t,e));if(n)return{value:n.transform(t,e),type:n.annotation}},zm={};Lm.forEach(t=>{zm[t.annotation]=t});var Wm=(t,e,r)=>{if(Re(e))switch(e[0]){case"symbol":return Vm.untransform(t,e,r);case"class":return Um.untransform(t,e,r);case"custom":return Qm.untransform(t,e,r);case"typed-array":return Bm.untransform(t,e,r);default:throw new Error("Unknown transformation: "+e)}else{let n=zm[e];if(!n)throw new Error("Unknown transformation: "+e);return n.untransform(t,r)}};var cr=(t,e)=>{let r=t.keys();for(;e>0;)r.next(),e--;return r.next().value};function Km(t){if(or(t,"__proto__"))throw new Error("__proto__ is not allowed as a property");if(or(t,"prototype"))throw new Error("prototype is not allowed as a property");if(or(t,"constructor"))throw new Error("constructor is not allowed as a property")}var Gm=(t,e)=>{Km(e);for(let r=0;r<e.length;r++){let n=e[r];if(lt(t))t=cr(t,+n);else if(ut(t)){let i=+n,s=+e[++r]==0?"key":"value",o=cr(t,i);switch(s){case"key":t=o;break;case"value":t=t.get(o);break}}else t=t[n]}return t},os=(t,e,r)=>{if(Km(e),e.length===0)return r(t);let n=t;for(let s=0;s<e.length-1;s++){let o=e[s];if(Re(n)){let a=+o;n=n[a]}else if(Ot(n))n=n[o];else if(lt(n)){let a=+o;n=cr(n,a)}else if(ut(n)){if(s===e.length-2)break;let c=+o,u=+e[++s]==0?"key":"value",l=cr(n,c);switch(u){case"key":n=l;break;case"value":n=n.get(l);break}}}let i=e[e.length-1];if(Re(n)?n[+i]=r(n[+i]):Ot(n)&&(n[i]=r(n[i])),lt(n)){let s=cr(n,+i),o=r(s);s!==o&&(n.delete(s),n.add(o))}if(ut(n)){let s=+e[e.length-2],o=cr(n,s);switch(+i==0?"key":"value"){case"key":{let c=r(o);n.set(c,n.get(o)),c!==o&&n.delete(o);break}case"value":{n.set(o,r(n.get(o)));break}}}return t};function Za(t,e,r=[]){if(!t)return;if(!Re(t)){It(t,(s,o)=>Za(s,e,[...r,...ar(o)]));return}let[n,i]=t;i&&It(i,(s,o)=>{Za(s,e,[...r,...ar(o)])}),e(n,r)}function Hm(t,e,r){return Za(e,(n,i)=>{t=os(t,i,s=>Wm(s,n,r))}),t}function Ym(t,e){function r(n,i){let s=Gm(t,ar(i));n.map(ar).forEach(o=>{t=os(t,o,()=>s)})}if(Re(e)){let[n,i]=e;n.forEach(s=>{t=os(t,ar(s),()=>t)}),i&&It(i,r)}else It(e,r);return t}var iA=(t,e)=>Ot(t)||Re(t)||ut(t)||lt(t)||Ja(t,e);function sA(t,e,r){let n=r.get(t);n?n.push(e):r.set(t,[e])}function Jm(t,e){let r={},n;return t.forEach(i=>{if(i.length<=1)return;e||(i=i.map(a=>a.map(String)).sort((a,c)=>a.length-c.length));let[s,...o]=i;s.length===0?n=o.map(is):r[is(s)]=o.map(is)}),n?ns(r)?[n]:[n,r]:ns(r)?void 0:r}var ec=(t,e,r,n,i=[],s=[],o=new Map)=>{let a=Mm(t);if(!a){sA(t,i,e);let p=o.get(t);if(p)return n?{transformedValue:null}:p}if(!iA(t,r)){let p=Xa(t,r),m=p?{transformedValue:p.value,annotations:[p.type]}:{transformedValue:t};return a||o.set(t,m),m}if(or(s,t))return{transformedValue:null};let c=Xa(t,r),u=c?.value??t,l=Re(u)?[]:{},f={};It(u,(p,m)=>{if(m==="__proto__"||m==="constructor"||m==="prototype")throw new Error(`Detected property ${m}. This is a prototype pollution risk, please remove it from your object.`);let y=ec(p,e,r,n,[...i,m],[...s,t],o);l[m]=y.transformedValue,Re(y.annotations)?f[m]=y.annotations:Ot(y.annotations)&&It(y.annotations,(w,E)=>{f[Ya(m)+"."+E]=w})});let d=ns(f)?{transformedValue:l,annotations:c?[c.type]:void 0}:{transformedValue:l,annotations:c?[c.type,f]:f};return a||o.set(t,d),d};function as(t){return Object.prototype.toString.call(t).slice(8,-1)}function tc(t){return as(t)==="Array"}function Xm(t){if(as(t)!=="Object")return!1;let e=Object.getPrototypeOf(t);return!!e&&e.constructor===Object&&e===Object.prototype}function oA(t){return as(t)==="Null"}function aA(t,e,r,n,i){return s=>t(s)||e(s)||!!r&&r(s)||!!n&&n(s)||!!i&&i(s)}function cA(t){return as(t)==="Undefined"}var E$=aA(oA,cA);function uA(t,e,r,n,i){let s={}.propertyIsEnumerable.call(n,e)?"enumerable":"nonenumerable";s==="enumerable"&&(t[e]=r),i&&s==="nonenumerable"&&Object.defineProperty(t,e,{value:r,enumerable:!1,writable:!0,configurable:!0})}function cs(t,e={}){if(tc(t))return t.map(i=>cs(i,e));if(!Xm(t))return t;let r=Object.getOwnPropertyNames(t),n=Object.getOwnPropertySymbols(t);return[...r,...n].reduce((i,s)=>{if(tc(e.props)&&!e.props.includes(s))return i;let o=t[s],a=cs(o,e);return uA(i,s,a,t,e.nonenumerable),i},{})}var S=class{constructor({dedupe:e=!1}={}){this.classRegistry=new ts,this.symbolRegistry=new sr(r=>r.description??""),this.customTransformerRegistry=new rs,this.allowedErrorProps=[],this.dedupe=e}serialize(e){let r=new Map,n=ec(e,r,this,this.dedupe),i={json:n.transformedValue};n.annotations&&(i.meta={...i.meta,values:n.annotations});let s=Jm(r,this.dedupe);return s&&(i.meta={...i.meta,referentialEqualities:s}),i}deserialize(e){let{json:r,meta:n}=e,i=cs(r);return n?.values&&(i=Hm(i,n.values,this)),n?.referentialEqualities&&(i=Ym(i,n.referentialEqualities)),i}stringify(e){return JSON.stringify(this.serialize(e))}parse(e){return this.deserialize(JSON.parse(e))}registerClass(e,r){this.classRegistry.register(e,r)}registerSymbol(e,r){this.symbolRegistry.register(e,r)}registerCustom(e,r){this.customTransformerRegistry.register({name:r,...e})}allowErrorProps(...e){this.allowedErrorProps.push(...e)}};S.defaultInstance=new S;S.serialize=S.defaultInstance.serialize.bind(S.defaultInstance);S.deserialize=S.defaultInstance.deserialize.bind(S.defaultInstance);S.stringify=S.defaultInstance.stringify.bind(S.defaultInstance);S.parse=S.defaultInstance.parse.bind(S.defaultInstance);S.registerClass=S.defaultInstance.registerClass.bind(S.defaultInstance);S.registerSymbol=S.defaultInstance.registerSymbol.bind(S.defaultInstance);S.registerCustom=S.defaultInstance.registerCustom.bind(S.defaultInstance);S.allowErrorProps=S.defaultInstance.allowErrorProps.bind(S.defaultInstance);var N$=S.serialize,q$=S.deserialize,_$=S.stringify,M$=S.parse,F$=S.registerClass,j$=S.registerCustom,D$=S.registerSymbol,$$=S.allowErrorProps;var Zm="query-state";function lA(t){for(let e in t)if(Object.hasOwn(t,e))return!1;return!0}var us=class{transport;client;connectionChangeHandlers=new Set;messageReceivedSubscribers=new Set;messageSentSubscribers=new Set;sessionErrorSubscribers=new Set;entitySyncErrorSubscribers=new an;entitySyncSuccessSubscribers=new an;onFailureToSyncWritesSubscribers=new Set;logger;syncInProgress=!1;reconnectTimeoutDelay=250;reconnectTimeout;serverReady=!1;currentSession=void 0;queries=new Map;clientId=null;constructor(e,r){if(this.client=e,this.logger=r.logger,this.client.onConnectionOptionsChange(n=>{(this.connectionStatus==="OPEN"||this.connectionStatus==="CONNECTING")&&("serverUrl"in n||"token"in n&&!n.tokenRefresh)&&(this.logger.warn("You are updating the connection options while the connection is open. To avoid unexpected behavior the connection will be closed and you should call `connect()` again after the update. To hide this warning, call `disconnect()` before updating the connection options."),this.disconnect())}),this.transport=r.transport??new Zi,this.onConnectionStatusChange(n=>{(n==="CLOSING"||n==="CLOSED")&&this.lastParamsHash!==void 0&&(this.lastParamsHash=void 0)}),r.pingInterval){let n=setInterval(this.ping.bind(this),r.pingInterval*1e3);typeof n=="object"&&"unref"in n&&n.unref()}}ping(){this.connectionStatus==="OPEN"&&this.serverReady&&this.sendMessage({type:"PING",payload:{clientTimestamp:Date.now()}})}async sendChanges(e){this.sendMessage({type:"CHANGES",payload:{changes:S.serialize(e)}})}async assignSessionToken(e,r=!0,n){if(e&&this.currentSession&&this.currentSession.token===e&&this.currentSession.serverUrl===this.client.serverUrl){if(this.currentSession.status==="OPEN"||this.currentSession.status==="CONNECTING")return;await this.connect();return}if(this.currentSession&&(this.resetTokenRefreshHandler(),this.disconnect(),this.resetQueryState(),this.currentSession=void 0),e&&(this.currentSession={serverUrl:this.client.serverUrl,token:e,status:"UNINITIALIZED"}),this.fireConnectionChangeHandlers(this.currentSession),r&&await this.connect(),!n||!e)return;let{interval:i,refreshHandler:s}=n,o=a=>{let c=Xe(a);if(!c||!c.exp&&!i)return;let u=i??c.exp*1e3-Date.now()-1e3;u<1e3&&(this.logger.warn(`The minimum allowed refresh interval is 1000ms, the ${i?"provided interval":"interval determined from the provided token"} was ${Math.round(u)}ms.`),u=1e3),this.tokenRefreshTimer=setTimeout(async()=>{let l=await s();l?(await this.updateSessionToken(l),o(l)):((this.connectionStatus==="OPEN"||this.connectionStatus==="CONNECTING")&&(this.logger.warn("The token refresh handler did not return a new token, disconnecting."),this.disconnect()),o(a))},u)};return o(e),()=>{this.resetTokenRefreshHandler()}}async updateSessionToken(e){if(this.client.awaitReady&&await this.client.awaitReady,!this.currentSession)throw new Ji;let r=Xe(e);if(!r)throw new Xi(r);if(yn(r))throw new Yi;let n=Ba(this.client.db.schema,Vi(r));if(!bm(this.client.db.session?.roles,n))throw new Hi;if(this.client.updateToken(e,!0),!this.updateTokenForSession(e)&&!await new Promise((o,a)=>setTimeout(()=>o(this.updateTokenForSession(e)),1e3)))throw new g("Failed to update the session token for the current session.");this.currentSession.token=e}tokenRefreshTimer=null;resetTokenRefreshHandler(){this.tokenRefreshTimer&&(clearTimeout(this.tokenRefreshTimer),this.tokenRefreshTimer=null)}async syncWrites(){return this.syncInProgress?{didSync:!1,syncFailureReason:"Sync in progress"}:this.connectionStatus!=="OPEN"?{didSync:!1,syncFailureReason:"Connection not open"}:this.serverReady?(this.client.awaitReady&&await this.client.awaitReady,await this.client.db.entityStore.doubleBuffer.getLockedBuffer().isEmpty(this.client.db.kv)&&this.client.db.entityStore.doubleBuffer.lockAndSwitchBuffers(),await this.trySyncLockedBuffer(),{didSync:!0}):{didSync:!1,syncFailureReason:"Server not ready"}}async trySyncLockedBuffer(){this.syncInProgress=!0;try{let e=await this.client.db.entityStore.doubleBuffer.getLockedBuffer().getChanges(this.client.db.kv);if(lA(e))this.syncInProgress=!1;else return this.syncInProgress=!0,this.sendChanges(e)}catch(e){throw this.syncInProgress=!1,e}}async createRollbackBufferFromChanges(e){let r={};for(let[n,{sets:i,deletes:s}]of Object.entries(e)){r[n]={sets:new Map,deletes:new Set};let o=this.client.db.entityStore.dataStore,a=this.client.db.kv;for(let c of s){let u=await o.getEntity(a,n,c);u&&r[n].sets.set(c,u)}for(let c of i.keys()){if(r[n].sets.has(c))continue;let u=await o.getEntity(a,n,c);u?r[n].sets.set(c,u):r[n].deletes.add(c)}}return r}async clearPendingChangesForEntity(e,r){this.client.awaitReady&&await this.client.awaitReady;let n=this.client.db.kv.transact(),i=await this.client.db.entityStore.doubleBuffer.getUnlockedBuffer().getChangesForEntity(n,e,r),s={[e]:{sets:new Map,deletes:new Set}};i&&(i.delete&&s[e].deletes.add(r),i.update&&s[e].sets.set(r,i.update));let o=await this.createRollbackBufferFromChanges(s);return await this.client.db.entityStore.doubleBuffer.getUnlockedBuffer().clearChangesForEntity(n,e,r),await n.commit(),await this.client.db.ivm.bufferChanges(o),await this.client.db.updateQueryViews(),this.client.db.broadcastToQuerySubscribers(),this.syncWrites()}async clearPendingChangesAll(){this.client.awaitReady&&await this.client.awaitReady;let e=this.client.db.kv.transact(),r=await this.client.db.entityStore.doubleBuffer.getUnlockedBuffer().getChanges(this.client.db.kv),n=await this.createRollbackBufferFromChanges(r);await this.client.db.entityStore.doubleBuffer.getUnlockedBuffer().clear(e),await e.commit(),await this.client.db.ivm.bufferChanges(n),await this.client.db.updateQueryViews(),this.client.db.broadcastToQuerySubscribers()}async updateTokenForSession(e){try{return await fetch(`${this.client.serverUrl}/update-token`,{method:"POST",body:JSON.stringify({clientId:this.clientId}),headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`}}),!0}catch(r){return console.error(r),this.logger.error("Failed to update token",r),!1}}onSyncMessageReceived(e){return this.messageReceivedSubscribers.add(e),()=>{this.messageReceivedSubscribers.delete(e)}}onSyncMessageSent(e){return this.messageSentSubscribers.add(e),()=>{this.messageSentSubscribers.delete(e)}}onEntitySyncSuccess(e,r,n){return this.entitySyncSuccessSubscribers.set(e,r,n),()=>{this.entitySyncSuccessSubscribers.delete(e,r)}}onEntitySyncError(e,r,n){return this.entitySyncErrorSubscribers.set(e,r,n),()=>{this.entitySyncErrorSubscribers.delete(e,r)}}onFailureToSyncWrites(e){return this.onFailureToSyncWritesSubscribers.add(e),()=>{this.onFailureToSyncWritesSubscribers.delete(e)}}onSessionError(e){return this.sessionErrorSubscribers.add(e),()=>{this.sessionErrorSubscribers.delete(e)}}async getConnectionParams(){return this.client.awaitReady&&await this.client.awaitReady,{syncSchema:this.client.syncSchema,token:this.client.token,server:this.client.serverUrl}}async isFirstTimeFetchingQuery(e){return this.client.awaitReady&&await this.client.awaitReady,!await this.client.db.getMetadata([Zm,Et(e)])}async markQueryAsSeen(e){return this.client.awaitReady&&await this.client.awaitReady,this.client.db.setMetadata([Zm,e],!0)}async subscribe(e,r={}){let{onQueryFulfilled:n,onQueryError:i,onQuerySyncStateChange:s}=r,o=Et(e),a=this.queries.has(o);a||this.queries.set(o,{params:e,syncState:"NOT_STARTED",syncStateCallbacks:new Set,subCount:0,hasSent:!1,abortController:new AbortController});let c=this.queries.get(o);c.subCount++,s&&c.syncStateCallbacks.add(s);let u;n&&(c.syncState==="FULFILLED"&&n(),u=f=>{f==="FULFILLED"&&n()},c.syncStateCallbacks.add(u));let l;return i&&(l=(f,d)=>{f==="ERROR"&&i(d)},c.syncStateCallbacks.add(l)),a||await this.connectQuery(o),()=>{let f=this.queries.get(o);if(!f){this.disconnectQuery(o);return}if(f.subCount--,u&&f.syncStateCallbacks.delete(u),l&&f.syncStateCallbacks.delete(l),s&&f.syncStateCallbacks.delete(s),f.subCount===0){this.disconnectQuery(o);return}}}async connectQuery(e){if(this.client.awaitReady&&await this.client.awaitReady,!this.queries.has(e))return;let r=this.queries.get(e);if(!r||r.hasSent||r.abortController.signal.aborted||!this.serverReady)return;let n=await this.client.db.getMetadata(["latest_server_timestamp"]),i;if(n){let o=sm(qa(Ie(r.params,this.client.db.schema?.collections,{},void 0,{applyPermission:void 0}))),c=await new De(this.client.db.kv,this.client.db.entityStore.dataStore).fetch(o),u=en(c,o),l=fA(u);i={timestamp:n,entityIds:l}}let s=this.sendMessage({type:"CONNECT_QUERY",payload:{id:e,params:r.params,state:i}});if(s){r.syncState="IN_FLIGHT";for(let o of r.syncStateCallbacks)o("IN_FLIGHT",void 0);r.hasSent=!0}return s}hasServerRespondedForQuery(e){let r=Et(e),n=this.queries.get(r);return(n&&n.syncState==="FULFILLED")??!1}disconnectQuery(e){if(!this.queries.has(e))return;let r=this.queries.get(e);r.hasSent?this.sendMessage({type:"DISCONNECT_QUERY",payload:{id:e}}):r.abortController.abort(),this.queries.delete(e)}lastParamsHash=void 0;async connect(){this.createConnection(this.currentSession)}createConnection(e){if(this.validateSessionWithWarning(e)&&this.currentSession===e&&e.status!=="OPEN"){if(e.status==="CONNECTING"){console.warn("Already connecting, ignoring connect call");return}e.status="CONNECTING",this.fireConnectionChangeHandlers(e),this.transport.connect({token:e.token,server:e.serverUrl,syncSchema:!1,schema:void 0}),this.transport.onMessage(this.onMessageHandler(e).bind(this)),this.transport.onOpen(this.onOpenHandler(e).bind(this)),this.transport.onClose(this.onCloseHandler(e).bind(this)),this.transport.onError(this.onErrorHandler(e).bind(this))}}async initializeSync(){let e=await this.syncWrites();e.didSync||this.logger.warn(`Failed to send changes on initialization: ${e.syncFailureReason}`);for(let[r]of this.queries)this.connectQuery(r)}onMessageHandler(e){return async r=>{let n=JSON.parse(r.data);this.logger.debug("received",n);for(let i of this.messageReceivedSubscribers)i(n);if(n.type==="ERROR"&&await this.handleErrorMessage(n),n.type==="ENTITY_DATA"){let{changes:i,timestamp:s,forQueries:o}=n.payload,a=S.deserialize(i);this.client.awaitReady&&await this.client.awaitReady,await this.client.db.applyChangesWithTimestamp(a,s,{skipRules:!0}),await this.client.db.setMetadata(["latest_server_timestamp"],s);for(let c of o){let u=this.queries.get(c);u&&u.syncState!=="FULFILLED"&&(await this.markQueryAsSeen(c),u.syncState="FULFILLED")}await this.client.db.updateQueryViews(),this.client.db.broadcastToQuerySubscribers();for(let c of o){let u=this.queries.get(c);if(u)for(let l of u.syncStateCallbacks)l("FULFILLED",n.payload)}}if(n.type==="CHANGES_ACK"){this.client.awaitReady&&await this.client.awaitReady;let i=await this.client.db.entityStore.doubleBuffer.getLockedBuffer().getChanges(this.client.db.kv),s=this.client.db.kv.transact();await this.client.db.entityStore.applyChangesWithTimestamp(s,i,n.payload.timestamp,{checkWritePermission:void 0,entityChangeValidator:void 0}),await this.client.db.entityStore.doubleBuffer.getLockedBuffer().clear(s),await s.commit();for(let[o,a]of this.entitySyncSuccessSubscribers){let c=i[o];if(c)for(let[u,l]of a)(c.sets.has(u)||c.deletes.has(u))&&l()}this.syncInProgress=!1,await this.syncWrites()}if(n.type==="CLOSE"){let{payload:i}=n;this.logger.info(`Closing connection${i?.message?`: ${i.message}`:"."}`);let{type:s,retry:o}=i;this.closeConnection({type:s,retry:o})}if(n.type==="SCHEMA_REQUEST"){let i=await this.client.getSchema();this.sendMessage({type:"SCHEMA_RESPONSE",payload:{schema:i}})}if(n.type==="READY"){let{payload:i}=n,{clientId:s}=i;this.clientId=s,this.serverReady||(this.serverReady=!0,await this.initializeSync())}}}onOpenHandler(e){return()=>{e.status="OPEN",this.fireConnectionChangeHandlers(e),this.resetReconnectTimeout(),this.logger.info("sync connection has opened")}}onCloseHandler(e){return r=>{if(this.resetSyncConnectionState(),this.serverReady=!1,r.reason){let i,s;try{let{type:o,retry:a}=JSON.parse(r.reason);i=o,s=a}catch{i="UNKNOWN",s=!0}if(i==="UNAUTHORIZED"&&this.logger.error("The server has closed the connection because the client is unauthorized. Please provide a valid token."),i==="SCHEMA_MISMATCH"&&this.logger.error("The server has closed the connection because the client schema does not match the server schema. Please update your client schema."),i==="TOKEN_EXPIRED"&&this.logger.error("The server has closed the connection because the token has expired. Fetch a new token from your authentication provider and call `TriplitClient.endSession()` and `TriplitClient.startSession(token)` to restart the session."),i==="ROLES_MISMATCH"&&this.logger.error("The server has closed the connection because the client attempted to update the session with a token that has different roles than the existing token. Call `TriplitClient.endSession()` and `TriplitClient.startSession(token)` to restart the session with the new token."),["ROLES_MISMATCH","TOKEN_EXPIRED","SCHEMA_MISMATCH","UNAUTHORIZED"].includes(i))for(let o of this.sessionErrorSubscribers)o(i);if(!s){this.logger.warn("The connection has closed. Based on the signal, the connection will not automatically retry. If you would like to reconnect, please call `connect()`."),e.status="CLOSED",this.fireConnectionChangeHandlers(e);return}}e.status="CLOSED",this.fireConnectionChangeHandlers(e);let n=this.connect.bind(this);this.reconnectTimeout=setTimeout(n,this.reconnectTimeoutDelay),this.reconnectTimeoutDelay=Math.min(3e5,this.reconnectTimeoutDelay*2)}}onErrorHandler(e){return r=>{this.logger.error("An error occurred during the connection to the server. Retrying connection..."),this.closeConnection()}}lastKnownConnectionStatus="UNINITIALIZED";fireConnectionChangeHandlers(e){if(!(!(e===this.currentSession)||!(this.lastKnownConnectionStatus!==this.connectionStatus))){this.lastKnownConnectionStatus=this.connectionStatus;for(let i of this.connectionChangeHandlers)i(this.connectionStatus)}}get connectionStatus(){return this.currentSession?this.currentSession.status:"UNINITIALIZED"}disconnect(){this.currentSession&&(this.currentSession.status="CLOSING",this.fireConnectionChangeHandlers(this.currentSession)),this.closeConnection({type:"MANUAL_DISCONNECT",retry:!1})}resetQueryState(){this.connectionStatus==="OPEN"&&(this.logger.warn("You are resetting the sync engine while the connection is open. To avoid unexpected behavior the connection will be closed and you should call `connect()` again after resetting. To hide this warning, call `disconnect()` before resetting."),this.disconnect()),this.resetSyncConnectionState()}resetSyncConnectionState(){this.syncInProgress=!1;for(let e of this.queries.values())e.hasSent=!1,e.syncState="NOT_STARTED"}async handleErrorMessage(e){let{error:r,metadata:n,messageType:i}=e.payload;switch(this.logger.error(r.name,n),r.name){case"MalformedMessagePayloadError":case"UnrecognizedMessageTypeError":this.logger.warn("You sent a malformed message to the server. This might occur if your client is not up to date with the server. Please ensure your client is updated.");break;case"QuerySyncError":let s=n?.queryKey;if(s){let o=this.queries.get(s);if(o){let a=g.fromJson(r);o.syncState="ERROR";for(let c of o.syncStateCallbacks)await c("ERROR",a)}this.disconnectQuery(s)}}if(i==="CHANGES"){this.client.awaitReady&&await this.client.awaitReady;let s=this.client.db.kv.transact(),o=this.client.db.entityStore.doubleBuffer,a=await o.getLockedBuffer().getChanges(s);await o.getLockedBuffer().write(s,await o.getUnlockedBuffer().getChanges(s)),await o.getUnlockedBuffer().clear(s),await s.commit(),o.lockAndSwitchBuffers(),this.syncInProgress=!1;for(let c of this.onFailureToSyncWritesSubscribers)await c(r,a);for(let c in a)for(let[u,l]of a[c].sets){let f=this.entitySyncErrorSubscribers.get(c,u);f&&await f(n?.failures[0]?.error,l)}}}sendMessage(e){let r=this.transport.sendMessage(e);if(r){this.logger.debug("sent",e);for(let n of this.messageSentSubscribers)n(e)}return r}onConnectionStatusChange(e,r=!1){return this.connectionChangeHandlers.add(e),r&&e(this.connectionStatus),()=>{this.connectionChangeHandlers.delete(e)}}closeConnection(e){this.transport.close(e)}resetReconnectTimeout(){clearTimeout(this.reconnectTimeout),this.reconnectTimeoutDelay=250}async syncQuery(e){try{let r,n,i=new Promise((o,a)=>{r=o,n=a}),s=this.subscribe(e,{onQueryFulfilled:async()=>{let o=await s;r(void 0),o()}});return i}catch(r){throw r instanceof g?r:r instanceof Error?new cn(e,r.message):new cn(e,"An unknown error occurred.")}}validateSessionWithWarning(e){if(!e)return this.logger.warn("You are attempting to connect to the server but no session is defined. Please ensure you are providing a token and serverUrl in the TriplitClient constructor or run startSession(token) to setup a session."),!1;let r=[];return e.token||r.push("token"),e.serverUrl||r.push("serverUrl"),r.length?(this.logger.warn(`You are attempting to connect but the connection cannot be opened because the required parameters are missing: [${r.join(", ")}].`),!1):!0}};function fA(t){let e={};for(let[r,n]of Object.entries(t)){let i=[...n.sets.keys(),...n.deletes];e[r]=i}return e}function dA(t){try{let e=JSON.parse(t);return g.fromJson(e)}catch{return new g(`Failed to parse remote error response: ${t}`)}}var ls=class{constructor(e={}){this.options=e}_schemaInitialized=!1;async schema(){return this._schemaInitialized||(this.options.schema||(this.options.schema=await(this.options.schemaFactory?this.options.schemaFactory():void 0)),this._schemaInitialized=!0),this.options.schema}updateOptions(e){this.options={...this.options,...e}}async sendRequest(e,r,n,i={isFile:!1}){let s=this.options.serverUrl;if(!s)throw new g("No server url provided");if(!this.options.token)throw new g("No token provided");let o={Authorization:"Bearer "+this.options.token,"Content-Type":"application/json"},a=JSON.stringify(n),c;i.isFile&&(c=new FormData,c.append("data",a),delete o["Content-Type"]);let u=await fetch(s+e,{method:r,headers:o,body:i.isFile?c:a});return u.ok?{data:await u.json(),error:void 0}:{data:void 0,error:dA(await u.text())}}async fetch(e){let{data:r,error:n}=await this.sendRequest("/fetch","POST",{query:e});if(n)throw n;return Ui(e,await this.schema(),r)}async fetchOne(e){e={...e,limit:1};let{data:r,error:n}=await this.sendRequest("/fetch","POST",{query:e});if(n)throw n;let s=Ui(e,await this.schema(),r)[0];return s||null}async fetchById(e,r){let n=this.query(e).Id(r);return this.fetchOne(n)}async insert(e,r){let i=(await this.schema())?.[e].schema,s=i?A.serialize(i,r,"decoded"):r,{data:o,error:a}=await this.sendRequest("/insert","POST",{collectionName:e,entity:s});if(a)throw a;return Qi(i,o)}async bulkInsert(e){let r=await this.schema(),n=e;if(r){let a={};for(let c in e){let u=c,l=e[u],f=r?.[u].schema;l&&(a[u]=l.map(d=>Tm(f,d)))}n=a}let{data:i,error:s}=await this.sendRequest("/bulk-insert-file","POST",n,{isFile:!0});if(s)throw s;let o={};for(let a in i){let c=a,u=r?.[c].schema;o[c]=i[a].map(l=>Qi(u,l))}return o}async update(e,r,n){let i,o=(await this.schema())?.[e]?.schema;if(typeof n=="function"){let u=await this.fetchById(e,r);if(!u)throw new Wt(r,e);i={},await n(Li(u,i,o))}else i=n;i=o?A.encode(o,i):i;let{data:a,error:c}=await this.sendRequest("/update","POST",{collectionName:e,entityId:r,changes:i});if(c)throw c;return a}async delete(e,r){let{data:n,error:i}=await this.sendRequest("/delete","POST",{collectionName:e,entityId:r});if(i)throw i;return n}async deleteAll(e){let{data:r,error:n}=await this.sendRequest("/delete-all","POST",{collectionName:e});if(n)throw n;return r}query(e){return ct(e)}};var ds=class{constructor(e){this.formatter=e.formatter??(r=>[r])}formatter;log(e){let{level:r}=e,n=this.formatter(e);(r==="ERROR"||r==="FATAL")&&fs(console.error)?console.error(...n):r==="WARN"&&fs(console.warn)?console.warn(...n):r==="INFO"&&fs(console.info)?console.info(...n):r==="DEBUG"&&fs(console.debug)?console.debug(...n):console.log(...n)}startSpan(e,r,n){return console.log(`Starting span "${e}" in context="${r}"`,n),{name:e,context:r,attributes:n,startTime:Date.now()}}endSpan(e){if(!e)return;let r=Date.now()-e.startTime;console.log(`Ending span "${e.name}". Duration: ${r}ms`)}recordMetric(e,r,n){console.log(`Metric [${e}]: ${r}`,n||"")}};function fs(t){return typeof t=="function"}function eg(){return new ds({formatter:t=>{let{level:e,message:r,timestamp:n,context:i,attributes:s}=t,o=i?[`%c${i}`,"color: #888"]:[];if(e==="DEBUG"&&i==="sync"){if(r==="sent")return["%c OUT ","background: #228; color: #51acff",s?.type,s?.payload];if(r==="received")return["%c IN ","background: #ccc; color: #333",s?.type,s?.payload]}return[...o,r,s||""]}})}var hs=class{logs=[];log(e){this.logs.push(e)}startSpan(e,r,n){return this.logs.push(`Starting span "${e}" in context="${r??""}" ${n?JSON.stringify(n):""}`),{name:e,context:r,attributes:n,startTime:Date.now()}}endSpan(e){if(!e)return;let r=Date.now()-e.startTime;this.logs.push(`Ending span "${e.name}". Duration: ${r}ms`)}recordMetric(e,r,n){this.logs.push(`Metric [${e}]: ${r} ${n?JSON.stringify(n):""}`)}};function tg(t,e){if(!t&&!e)return 0;if(!t)return-1;if(!e)return 1;let r=t[0],n=e[0];return r instanceof Date&&(r=r.getTime()),n instanceof Date&&(n=n.getTime()),W(r,n)}var hA=1,L="triplit",ur=class{db;cache;options;constructor(e,r={useCache:!0}){this.options=r,r.useCache&&(this.cache=new he),this.db=typeof e=="string"?new Promise((n,i)=>{let s=indexedDB.open(e,hA);s.onupgradeneeded=o=>{let a=o.target.result;this.setupSchema(a)},s.onsuccess=async o=>{let a=o.target.result;n(await this.populateCache(a))},s.onerror=o=>{console.error(`Error opening database: ${o.target.error}`),i(o.target.error)}}):e.then(this.populateCache)}async populateCache(e){let n=e.transaction(L,"readonly").objectStore(L),i=await new Promise((o,a)=>{let c=n.getAllKeys();c.onerror=()=>a(c.error),c.onsuccess=()=>o(c.result)}),s=await new Promise((o,a)=>{let c=n.getAll();c.onerror=()=>a(c.error),c.onsuccess=()=>o(c.result)});if(i.length!==s.length)throw new Error("IndexedDB keys and values length mismatch");for(let o=0;o<i.length;o++){let a=i[o],c=s[o];this.cache&&this.cache.data.set(a,c)}return e}setupSchema(e){e.objectStoreNames.contains(L)||e.createObjectStore(L)}async get(e,r){let n=await this.db;if(this.cache)return this.cache.get(e,r);let i=r?[...r,...e]:e;return new Promise((s,o)=>{let u=n.transaction(L,"readonly",{durability:"relaxed"}).objectStore(L).get(i);u.onsuccess=()=>s(u.result),u.onerror=()=>o(u.error)})}async set(e,r,n){let i=await this.db,s=n?[...n,...e]:e;return new Promise((o,a)=>{let l=i.transaction(L,"readwrite",{durability:"relaxed"}).objectStore(L).put(r,s);l.onsuccess=async()=>{this.cache&&await this.cache.set(e,r,n),o()},l.onerror=()=>a(l.error)})}async delete(e,r){let n=await this.db,i=r?[...r,...e]:e;return new Promise((s,o)=>{let u=n.transaction(L,"readwrite",{durability:"relaxed"}).objectStore(L).delete(i);u.onsuccess=async()=>{this.cache&&await this.cache.delete(e,r),s()},u.onerror=()=>o(u.error)})}async*scan(e,r){let n=await this.db;if(this.cache){yield*this.cache.scan(e,r);return}let i=r?[...r,...e.prefix]:e.prefix,s=[...i,"\uFFFF"],a=n.transaction(L,"readonly",{durability:"relaxed"}).objectStore(L),c=this.options.batchSize??1e3,u=i,l=!0;for(;!(Vt(u,s)>=0);){let f=IDBKeyRange.bound(u,s,l,!0),d=await rg(a,f,c);if(!d.length)break;let p=await ng(a,f,c);if(!p.length)break;for(let w=0;w<d.length;w++){let E=(r?.length??0)+e.prefix.length,b=E>0?d[w].slice(E):d[w];if(b.length===0)break;yield[b,p[w]]}if(p.length<c)break;u=d.at(-1)}}async*scanValues(e,r){if(await this.db,this.cache){yield*this.cache.scanValues(e,r);return}let n=await this.db,i=r?[...r,...e.prefix]:e.prefix,s=[...i,"\uFFFF"],a=n.transaction(L,"readonly",{durability:"relaxed"}).objectStore(L),c=this.options.batchSize??1e3,u=i,l=!0;for(;!(Vt(u,s)>=0);){let f=IDBKeyRange.bound(u,s,l,!0),d=await ng(a,f,c);if(!d.length)break;for(let y of d)yield y;if(d.length<c)break;let m=await pA(a,f,c);if(!m)break;u=m,l=!1}}async clear(e){let i=(await this.db).transaction(L,"readwrite",{durability:"relaxed"}).objectStore(L);if(e?.length){let s=e,o=[...s,"\uFFFF"],a=IDBKeyRange.bound(s,o,!1,!0);return new Promise((c,u)=>{let l=i.delete(a);l.onsuccess=async()=>{this.cache&&await this.cache.clear(e),c()},l.onerror=()=>u(l.error)})}else{let s=i.clear();return new Promise((o,a)=>{s.onsuccess=async()=>{this.cache&&await this.cache.clear(e),o()},s.onerror=()=>a(s.error)})}}scope(e){return new er(this,e)}transact(){return new Zt(this)}async count(e,r){let n=await this.db;if(this.cache)return this.cache.count(e,r);let i=r?[...r,...e.prefix]:e.prefix,s=[...i,"\uFFFF"],o=IDBKeyRange.bound(i,s,!1,!0);return new Promise((a,c)=>{let f=n.transaction(L,"readonly",{durability:"relaxed"}).objectStore(L).count(o);f.onsuccess=()=>a(f.result),f.onerror=()=>c(f.error)})}async applyEdits(e,r){let n=await this.db;await new Promise(async(i,s)=>{let a=n.transaction(L,"readwrite",{durability:"relaxed"}).objectStore(L),c=null,u=[],l=[];for await(let f of r)c=a.delete(f),u.push(f);for await(let[f,d]of e)c=a.put(d,f),l.push([f,d]);c?(c.onsuccess=async()=>{this.cache&&await this.cache.applyEdits(l,u),i()},c.onerror=()=>s(c.error)):(this.cache&&await this.cache.applyEdits(l,u),i())})}async getBatchKeys(e,r){let s=(await this.db).transaction(L,"readonly",{durability:"relaxed"}).objectStore(L);return rg(s,e,r)}};function pA(t,e,r=0){return new Promise((n,i)=>{let s=t.openKeyCursor(e,"next"),o=!1;s.onsuccess=a=>{let u=a.target?.result;if(!u){n(void 0);return}if(!o&&r>1){o=!0,u.advance(r);return}n(u.key)},s.onerror=a=>{let c=a.target;i(c.error)}})}function rg(t,e,r){return new Promise((n,i)=>{let s=t.getAllKeys(e,r);s.onerror=()=>i(s.error),s.onsuccess=()=>n(s.result)})}function ng(t,e,r){return new Promise((n,i)=>{let s=t.getAll(e,r);s.onerror=()=>i(s.error),s.onsuccess=()=>n(s.result)})}function yA(t){return typeof t=="string"||"type"in t}function mA(t){return typeof t=="string"&&t==="memory"||typeof t=="object"&&t.type==="memory"}function gA(t){return typeof t=="string"&&t==="indexeddb"||typeof t=="object"&&t.type==="indexeddb"}function ig(t){if(!yA(t))return t;if(mA(t))return new he;if(gA(t)){if(typeof indexedDB>"u")throw new Ki;return typeof t=="object"?t.options?new ur(t.name??"triplit",t.options):new ur(t.name??"triplit"):new ur("triplit")}throw new g("Failed to parse storage input")}var sg="memory";var ag=!0,vA={policy:"local-first",skipRules:ag},ps=class{awaitReady=null;db;syncEngine;_token=void 0;claimsPath=void 0;_serverUrl=void 0;skipRules=ag;statusSubs=new Set;syncSchema;http;defaultFetchOptions;logger;connectOnInitialization;decodedToken=void 0;constructor(e={}){this.connectOnInitialization=e.autoConnect??!0;let r=e.schema?{collections:e.schema,roles:e.roles}:void 0,n=ig(e?.storage??sg);this.syncSchema=e.syncSchema??!1,this.awaitReady=Rm({schema:r,variables:e.variables,entityStore:new zi(n),kv:n,clientId:Math.random().toString(36).substring(7)}).then(async({db:s,event:o})=>{let a=this.token?Xe(this.token,this.claimsPath):void 0;return this.db=a?s.withSessionVars(a):s,this.onConnectionOptionsChange(c=>{if("token"in c){let u=c.token?Xe(c.token,this.claimsPath):{};this.db=u?this.db.withSessionVars(u):this.db}}),this.db.onCommit(wA(async c=>{await this.db.updateQueryViews(),this.db.broadcastToQuerySubscribers(),await this.syncEngine.syncWrites()},20,{leading:!1,trailing:!0})),this.db.onSchemaChange(c=>{c.successful&&this.http.updateOptions({schema:c.newSchema.collections})}),this.syncSchema&&this.subscribeBackground(this.db.query("_metadata").Id("_schema"),{onError:()=>{this.logger.warn("Schema sync disconnected")}}),o.type!=="SUCCESS"&&(o.type==="SCHEMA_UPDATE_FAILED"?this.logger.error("Schema update failed during initialization. The schema will fallback to the value saved in the database (change.oldSchema). For more control, set a callback in experimental.onDatabaseInit.",o):this.logger.error("An error occurred during database initialization",o)),e.experimental?.onDatabaseInit&&await e.experimental?.onDatabaseInit(this.db,o),Promise.resolve().then(()=>{this.awaitReady=null})}),this.logger=e.logger??we,this.logger.registerHandler(eg()),e.logLevel&&this.logger.setLogLevel(e.logLevel),e.logLevel==="debug"&&this.logger.registerHandler(new hs),this.claimsPath=e.claimsPath,this.defaultFetchOptions={fetch:vA,...e.defaultQueryOptions},og(e.serverUrl),this._serverUrl=e.serverUrl,this.http=new ls({serverUrl:this._serverUrl,token:this._token,schemaFactory:async()=>(await this.getSchema())?.collections}),this.onConnectionOptionsChange(s=>{this.http.updateOptions(s)});let i=e.pingInterval||45;this.syncEngine=new us(this,{transport:e.transport,logger:this.logger.context("sync"),pingInterval:i}),e.onSessionError&&this.onSessionError(e.onSessionError),this.startSession(e.token,this.connectOnInitialization,e.refreshOptions).then(()=>{this.connectOnInitialization=!1})}get ready(){return this.awaitReady?this.awaitReady:Promise.resolve()}async getSchema(){return this.awaitReady&&await this.awaitReady,this.db.getSchema()}async transact(e,r={}){this.awaitReady&&await this.awaitReady,this.logger.debug("transact START");let n=await this.db.transact(e,{...r,skipRules:this.skipRules});return this.logger.debug("transact END",{txOutput:n}),n}query(e){return ct(e)}async fetch(e,r){this.awaitReady&&await this.awaitReady,e=rc(e);let n={...this.defaultFetchOptions.fetch,...r??{}};if(n.policy==="local-only")return this.fetchLocal(e,n);if(n.policy==="local-first"){if(!(await this.syncEngine.isFirstTimeFetchingQuery(e)&&this.probablyIntendsToConnect))return await this.fetchLocal(e,n);try{await this.syncEngine.syncQuery(e)}catch(s){this.warnError(s)}return this.fetchLocal(e,n)}if(n.policy==="remote-first"){if(this.probablyIntendsToConnect)try{await this.syncEngine.syncQuery(e)}catch(i){this.warnError(i)}return this.fetchLocal(e,n)}if(n.policy==="remote-only")return this.http.fetch(e);if(n.policy==="local-and-remote"){let i=n.timeout??0;return await Promise.race([this.syncEngine.syncQuery(e),new Promise(s=>setTimeout(s,i))]).catch(this.warnError),this.fetchLocal(e,n)}throw new Wi(n.policy)}async fetchLocal(e,r){this.logger.debug("fetchLocal START",e);let n=await this.db.fetch(e,{skipRules:this.skipRules,...r??{}});return this.logger.debug("fetchLocal END",n),n}async fetchById(e,r,n){this.logger.debug("fetchById START",{collectionName:e,id:r,options:n});let i=this.query(e).Id(r),s=await this.fetchOne(i,n);return this.logger.debug("fetchById END",{collectionName:e,id:r,options:n,result:s}),s}async clear(e={full:!1}){this.awaitReady&&await this.awaitReady,await this.db.clear(e);for(let r of this.statusSubs)r.unsub(),r.unsub=this._subscribeWithStatus(r.query,r.callback,r.options)}async reset(e={}){await this.clear(e)}async fetchOne(e,r){e=rc(e),e={...e,limit:1};let i=[...(await this.fetch(e,r)).values()][0];return i||null}async insert(e,r){this.awaitReady&&await this.awaitReady,this.logger.debug("insert START",{collectionName:e,object:r});let n=await this.db.insert(e,r,{skipRules:this.skipRules});return this.logger.debug("insert END",{txOutput:n}),n}async update(e,r,n){this.awaitReady&&await this.awaitReady,this.logger.debug("update START",{collectionName:e,entityId:r});let i=await this.db.update(e,r,n,{skipRules:this.skipRules});return this.logger.debug("update END",{txOutput:i}),i}async delete(e,r){this.awaitReady&&await this.awaitReady,this.logger.debug("delete START",{collectionName:e,entityId:r});let n=await this.db.delete(e,r,{skipRules:this.skipRules});return this.logger.debug("delete END",{txOutput:n}),n}async entityIsInCache(e,r){return!!this.db.entityStore.doubleBuffer.getChangesForEntity(this.db.kv,e,r)}subscribe(e,r,n,i){let s=!1,o=(async()=>{this.awaitReady&&await this.awaitReady;let a={localOnly:!1,...i??{}};e=rc(e),this.logger.debug("subscribe start",e);let c=r,u=n;r=async d=>{let p=d;s||(i?.syncStatus&&i.syncStatus!=="all"&&(p=await this.filterResultsWithSyncStatus(d,e.collectionName,i.syncStatus)),c(p))},n=u?d=>{s||u(d)}:void 0;let l=this.db.subscribe(e,r,n,{skipRules:this.skipRules,...a});await this.db.updateQueryViews(),this.db.broadcastToQuerySubscribers();let f=Promise.resolve(()=>{});return a.localOnly||(f=this.syncEngine.subscribe(e,{onQueryFulfilled:a.onRemoteFulfilled,onQueryError:n,onQuerySyncStateChange:a.onQuerySyncStateChange})),()=>{s=!0,l(),f.then(d=>d())}})();return()=>{o.then(a=>a())}}get probablyIntendsToConnect(){return this.connectionStatus==="OPEN"||this.connectionStatus==="CONNECTING"||this.connectOnInitialization}subscribeWithStatus(e,r,n){let i={query:e,callback:r,options:n,unsub:this._subscribeWithStatus(e,r,n)};return this.statusSubs.add(i),()=>{i.unsub(),this.statusSubs.delete(i)}}_subscribeWithStatus(e,r,n){let i,s=this.probablyIntendsToConnect&&!n?.localOnly,o=!0,a=!1,c,u=!0,l=()=>o||u&&s;function f(){r({results:i,error:c,fetching:l(),fetchingLocal:o,fetchingRemote:a})}function d(){let y=!1;a&&(a=!1,y=!0),s&&(s=!1,y=!0),y&&f()}f();let p=this.onConnectionStatusChange(y=>{if(y==="CLOSED"){d();return}},!0);this.isFirstTimeFetchingQuery(e).then(y=>{if(u!==y){let w=l();u=y,l()!==w&&f()}});let m=this.subscribe(e,y=>{if(i=y,o=!1,c=void 0,a){let w=this.syncEngine.hasServerRespondedForQuery(e);a=!w,s=!w}f()},y=>{c=y,o=!1,f()},{...n??{},onQuerySyncStateChange:y=>{if(y==="FULFILLED"||y==="ERROR"){d();return}y==="IN_FLIGHT"&&!a&&(a=!0,f())}});return()=>{m(),p()}}async filterResultsWithSyncStatus(e,r,n){let i=await this.db.entityStore.doubleBuffer.getChangesForCollection(this.db.kv,r);return i?n==="pending"?e.filter(s=>i.sets.has(s.id)):e.filter(s=>!i.sets.has(s.id)):n==="pending"?[]:e}subscribeBackground(e,r={}){let n=(async()=>(this.awaitReady&&await this.awaitReady,this.syncEngine.subscribe(e,{onQueryFulfilled:r.onFulfilled,onQueryError:r.onError})))();return()=>{n.then(i=>i())}}subscribeWithPagination(e,r,n,i){e.order&&e.order.length>0&&e.order.at(-1)[0]!=="id"&&(e.order=[...e.order,["id","ASC"]]);let s={},o=e.limit,a=f=>{r(f,{hasNextPage:!1,hasPreviousPage:!1})};s.nextPage=()=>{this.logger.warn("There is no limit set on the query, so nextPage() is a no-op")},s.prevPage=()=>{this.logger.warn("There is no limit set on the query, so prevPage() is a no-op")};let c,u,l="forward";return e.limit&&(e={...e},e.limit=o+1+(e.after?1:0),a=f=>{if(!e.order?.[0]?.[0])throw new g("No cursor attribute found in query order");let p=f.at(0),m=!!e.after&&!!p&&tg(e.after[0],e.order.map(R=>q.Get(p,R[0].split("."))))>-1,y=f.length>=e.limit,w=l==="reversed"?y:m,E=l==="forward"?y:m;f=f.slice(m?1:0,y?-1:void 0);let b=f.at(0),re=f.at(o-1);c=b?e.order.map(R=>q.Get(b,R[0].split("."))):void 0,u=re?e.order.map(R=>q.Get(re,R[0].split("."))):void 0,l==="reversed"&&(f=f.reverse()),!w&&e.after?(s.unsubscribe?.(),e={...e},e.after=void 0,e.limit=o+1,l==="reversed"&&(e.order=nc(e.order)),l="forward",s.unsubscribe=this.subscribe(e,a,n,i)):r(f,{hasNextPage:E,hasPreviousPage:w})},s.nextPage=()=>{s.unsubscribe?.(),e={...e},l==="reversed"?(e.order=nc(e.order),e.after=c?[c,!0]:void 0):(e.after||(e.limit=e.limit+1),e.after=u?[u,!0]:void 0),l="forward",s.unsubscribe=this.subscribe(e,a,n,i)},s.prevPage=()=>{s.unsubscribe?.(),e={...e},l==="forward"?(e.order=nc(e.order),e.after=c?[c,!0]:void 0):e.after=u?[u,!0]:void 0,l="reversed",s.unsubscribe=this.subscribe(e,a,n,i)}),s.unsubscribe=this.subscribe(e,a,n,i),s}subscribeWithExpand(e,r,n,i){let s={},o=a=>{r(a,{hasMore:!1})};if(s.loadMore=()=>{this.logger.warn("There is no limit set on the query, so loadMore is a no-op")},e.limit){(!e.order||e.order.at(-1)?.[0]!=="id")&&(e.order=[...e.order??[],["id","ASC"]]);let a=e.limit;e={...e},e.limit=e.limit+1,o=c=>{let u=c.length>=e.limit;c=Array.from(c),u&&(c=c.slice(0,-1)),r(c,{hasMore:u})},s.loadMore=c=>{s.unsubscribe?.(),e={...e},e.limit=(e.limit??1)+(c??a),s.unsubscribe=this.subscribe(e,o,n,i)}}return s.unsubscribe=this.subscribe(e,o,n,i),s}updateConnectionOptions(e){let{token:r,serverUrl:n,tokenRefresh:i}=e,s=e.hasOwnProperty("token")&&r!==this.token,o=e.hasOwnProperty("serverUrl")&&n!==this.serverUrl,a={};if(s&&(a={...a,token:r,tokenRefresh:i}),o&&(og(n),a={...a,serverUrl:n}),s||o){s&&(this._token=r),o&&(this._serverUrl=n);for(let c of this.connectionOptionsChangeHandlers)c(a)}}async startSession(e,r=!0,n){let i=Xe(e);if(i&&yn(i)&&n?.refreshHandler){let s=await n.refreshHandler();s?(e=s,i=Xe(e)):this.logger.warn("An expired token was passed to startSession, and the refreshHandler was unable to provide a new token. The expired session token will be used and sync issues should be handled with onSessionError().")}return this.decodedToken=i,this.updateToken(e),this.syncEngine.assignSessionToken(e,r,n)}async endSession(){await this.startSession(void 0)}async updateSessionToken(e){return this.syncEngine.updateSessionToken(e)}onSessionError(e){return this.syncEngine.onSessionError(e)}async updateGlobalVariables(e){this.awaitReady&&await this.awaitReady,this.db.updateGlobalVariables(e)}updateToken(e,r){this.updateConnectionOptions({token:e,tokenRefresh:r})}updateServerUrl(e){this.updateConnectionOptions({serverUrl:e})}onConnectionStatusChange(...e){return this.syncEngine.onConnectionStatusChange(...e)}connect(){return this.syncEngine.connect()}disconnect(){return this.syncEngine.disconnect()}ping(){return this.syncEngine.ping()}get token(){return this._token}get serverUrl(){return this._serverUrl}get vars(){return{...this.db.systemVars,$token:this.db.systemVars.$session}}onSyncMessageReceived(...e){return this.syncEngine.onSyncMessageReceived(...e)}onSyncMessageSent(...e){return this.syncEngine.onSyncMessageSent(...e)}onEntitySyncSuccess(...e){return this.syncEngine.onEntitySyncSuccess(...e)}onEntitySyncError(...e){return this.syncEngine.onEntitySyncError(...e)}onFailureToSyncWrites(...e){return this.syncEngine.onFailureToSyncWrites(...e)}syncWrites(...e){return this.syncEngine.syncWrites(...e)}get connectionStatus(){return this.syncEngine.connectionStatus}isFirstTimeFetchingQuery(...e){return this.syncEngine.isFirstTimeFetchingQuery(...e)}async clearPendingChangesForEntity(...e){return this.syncEngine.clearPendingChangesForEntity(...e)}async clearPendingChangesAll(...e){return this.syncEngine.clearPendingChangesAll(...e)}connectionOptionsChangeHandlers=[];onConnectionOptionsChange(e){return this.connectionOptionsChangeHandlers.push(e),()=>{this.connectionOptionsChangeHandlers=this.connectionOptionsChangeHandlers.filter(r=>r!==e)}}warnError(e){e instanceof g?this.logger.warn(e.toJSON()):this.logger.warn(e)}};function rc(t){return{traceId:Math.random().toString().slice(2),...t}}function nc(t){if(t)return t.map(e=>[e[0],e[1]==="ASC"?"DESC":"ASC"])}function wA(t,e,r){let n,i=null;return function(){let s=arguments;n?i=s:(r?.leading!==!1?t(s):i=s,n=!0,setTimeout(()=>{r?.trailing&&i&&(t(i),i=null),n=!1},e))}}function og(t){if(t&&!t.startsWith("http://")&&!t.startsWith("https://"))throw new g('Invalid serverUrl provided. Must start with "http://" or "https://".')}var ms=class{client=null;variableChangeListeners=new Set;constructor(){}init(e,r){if(this.client!=null)return;let{token:n,...i}=e;we.registerHandler(r),this.client=new ps({...i,autoConnect:!1})}async fetch(...e){if(!this.client)throw new C;return await this.client.fetch(...e)}async transact(...e){if(!this.client)throw new C;return await this.client.transact(r=>e[0](K(r)),e[1])}async fetchById(...e){if(!this.client)throw new C;return await this.client.fetchById(...e)}async fetchOne(...e){if(!this.client)throw new C;return await this.client.fetchOne(...e)}async insert(...e){if(!this.client)throw new C;return await this.client.insert(...e)}async update(e,r,n){if(!this.client)throw new C;return await this.client.update(e,r,n)}async getSchema(){if(!this.client)throw new C;return await this.client.getSchema()}async delete(...e){if(!this.client)throw new C;return await this.client.delete(...e)}async subscribe(...e){if(e[3]=await ys(e[3]),!this.client)throw new C;return K(this.client.subscribe(...e))}async subscribeBackground(e,r={}){if(!this.client)throw new C;return K(this.client.subscribeBackground(e,r))}async subscribeWithPagination(...e){if(e[3]=await ys(e[3]),!this.client)throw new C;return K(this.client.subscribeWithPagination(...e))}async subscribeWithExpand(...e){if(e[3]=await ys(e[3]),!this.client)throw new C;return K(this.client.subscribeWithExpand(...e))}async subscribeWithStatus(...e){if(e[2]=await ys(e[2]),!this.client)throw new C;return K(this.client.subscribeWithStatus(...e))}async startSession(...e){if(!this.client)throw new C;let r=await bA(e[2]),n=await this.client.startSession(e[0],e[1],r);if(n!=null)return K(n)}async endSession(...e){if(!this.client)throw new C;return await this.client.endSession(...e)}updateSessionToken(...e){if(!this.client)throw new C;return this.client.updateSessionToken(...e)}onSessionError(...e){if(!this.client)throw new C;return K(this.client.onSessionError(...e))}updateServerUrl(...e){if(!this.client)throw new C;return this.client.updateServerUrl(...e)}onSyncMessageReceived(...e){if(!this.client)throw new C;return K(this.client.onSyncMessageReceived(...e))}onSyncMessageSent(...e){if(!this.client)throw new C;return K(this.client.onSyncMessageSent(...e))}onEntitySyncSuccess(...e){if(!this.client)throw new C;return K(this.client.onEntitySyncSuccess(...e))}onEntitySyncError(...e){if(!this.client)throw new C;return K(this.client.onEntitySyncError(...e))}onFailureToSyncWrites(e){if(!this.client)throw new C;return K(this.client.onFailureToSyncWrites(e))}onConnectionStatusChange(...e){if(!this.client)throw new C;return K(this.client.onConnectionStatusChange(...e))}onVariablesChange(e){if(!this.client)throw new C;let r=this.client.onConnectionOptionsChange(()=>{e(this.client.vars)});this.variableChangeListeners.add(e);let n=!1;return this.client.ready.then(()=>{n||e(this.client.vars)}),K(()=>{n=!0,this.variableChangeListeners.delete(e),r()})}connect(){if(!this.client)throw new C;return this.client.connect()}disconnect(){if(!this.client)throw new C;return this.client.disconnect()}syncWrites(...e){if(!this.client)throw new C;return this.client.syncWrites(...e)}isFirstTimeFetchingQuery(e){if(!this.client)throw new C;return this.client.isFirstTimeFetchingQuery(e)}async updateGlobalVariables(...e){if(!this.client)throw new C;await this.client.updateGlobalVariables(...e);for(let r of this.variableChangeListeners)r(this.client.vars)}async clear(e={}){if(!this.client)throw new C;return await this.client.clear(e)}async reset(e={}){if(!this.client)throw new C;return await this.client.reset(e)}};async function ys(t){return t==null?{}:{localOnly:await t.localOnly,onRemoteFulfilled:await t.onRemoteFulfilled}}async function bA(t){if(t!=null)return{interval:await t.interval,refreshHandler:t.refreshHandler}}var cg=new ms;self.addEventListener("connect",t=>{let e=t.ports[0];lr(cg,e)});lr(cg,self);
/*! Bundled license information:

elen/src/elen.js:
  (***
   * @license
   * https://github.com/ealmansi/elen
   * Copyright (c) 2017 Emilio Almansi
   * Distributed under the MIT software license, see the accompanying
   * file LICENSE or http://www.opensource.org/licenses/mit-license.php.
   *)

uuidv7/dist/index.cjs:
  (**
   * uuidv7: A JavaScript implementation of UUID version 7
   *
   * Copyright 2021-2024 LiosK
   *
   * @license Apache-2.0
   * @packageDocumentation
   *)

uuidv7/dist/index.js:
  (**
   * uuidv7: A JavaScript implementation of UUID version 7
   *
   * Copyright 2021-2024 LiosK
   *
   * @license Apache-2.0
   * @packageDocumentation
   *)

comlink/dist/esm/comlink.mjs:
  (**
   * @license
   * Copyright 2019 Google LLC
   * SPDX-License-Identifier: Apache-2.0
   *)
*/
